# 4 BITCOIN КАК ПЛАТФОРМА

## 4.1 Механизм sidechains

Идея sidechains появилась в 2014 году, когда стал заметен тренд улучшения оригинального протокола Bitcoin. Как правило, эти попытки совершались в ряде других проектов, которые создавали свои собственные валюты, которые должны были работать по другим правилам. Если оставить за кадром желание разбогатеть на росте своей валюты (которое в реальности значительно влияло на ситуацию), то этот тренд, безусловно, имел смысл. К тому моменту уже существовала масса предложений об улучшении протокола и расширении его функциональности, но внедрять все подряд непосредственно в Bitcoin было бы крайне нецелесообразно по многим причинам (в том числе из соображений безопасности). Любые улучшения должны сначала пройти тщательную проверку и лишь затем внедряться. Но как же тогда обеспечить эту проверку, учитывая, что немногие станут тестировать и тем более применять альтернативную цифровую валюту?

Таким образом члены сообщества, которые хотели бы протестировать новый алгоритм анонимизации, смарт-контрактов или механизм достижения консенсуса с высокой пропускной способностью и низкими комиссиями, могли бы использовать уже существующие биткоины во второстепенной учетной системе с возможностью их возвращения в основную. Идеи, предложенные и развитые в проектах по созданию сайдчейнов, оказали большое влияние на будущее Bitcoin, но на данный момент еще не вошли в обиход,, потому что, опять-таки, разработчики стремились создавать собственные независимые валюты.

Принцип работы sidechain в реальном мире очень отдаленно можно сравнить с использованием евро или доллара в государствах, где эти валюты не эмитируются. Их правительства не имеют в этом случае возможности печатать деньги, но могут осуществлять подтверждение транзакций и вести свой внутренний учет. Как пример, для евро такой страной является Черногория, а для доллара – Панама.

_Sidechain_ – отдельная цепочка блоков, в которую добавляются транзакции с монетами, полученными из главной цепочки (_mainchain_), как изображено на рис. 4.1. Правила работы в sidechain могут отличаться от правил в mainchain и определяться новым протоколом (например, может быть другой алгоритм достижения консенсуса, другая структура транзакции и т. д.). Как правило, sidechain не имеет своей собственной валюты, но реализует механизм перевода ценности из основной цепочки блоков. Sidechain применяется для реализации новых правил учета монет (расширение сценариев, смарт-контракты) или для тестирования новых технологий (алгоритмы подписи, модель транзакций). Отметим, что sidechain может быть _активным (active)_ и _неактивным (inactive)_. Об активном состоянии говорят, когда sidechain поддерживается некоторым сообществом валидаторов. Когда участники перестают участвовать в принятии решения и подтверждать транзакции, sidechain считается неактивным (рис. 4.1).

<img width="50%" alt="Рисунок 4.1 – Устройство sidechains" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.1-Sidechains-structure.png"/> 

Впервые идею sidechain предложил Gregory Maxwell. Первым документом, где была описана эта идея, является «Enabling Blockchain Innovations with Pegged Sidechains» [37], опубликованный 22 октября 2014 года группой авторов, одним из которых является Adam Back. Еще один известный труд под названием «Sidechains not a direct means for solving any of the scaling problems Bitcoin has» был опубликован 13 июня 2015 года под авторством Pieter Wuille [72]. 14 июня 2015 года Gregory Maxwell выпустил работу «Security limitations of pegged chains».

### One-way peg и two-way peg sidechains

Привязка _sidechain_ к _mainchain_ для переноса ценности может быть двух типов: _one-way peg_ или _two-way peg_. При использовании one-way peg цифровые активы могут переноситься только в одном направлении – из цепочки блоков основной учетной системы в цепочку второстепенной. Потребность в одностороннем переносе активов встречается редко, поэтому детально рассмотрим другой вариант. В случае two-way peg цифровые активы могут переноситься в обоих направлениях.

Есть несколько вариантов реализации two-way peg, и наиболее распространенные – _federated sidechains_ и _merged-mined sidechains_. Принцип работы sidechain с two-way peg состоит в следующем. Пользователь сначала должен отправить свои активы на специальный адрес основной учетной системы, чтобы заблокировать возможность траты этих активов в mainchain. После этого пользователь подтвердит нужную транзакцию в сети sidechain. Так узлы, обрабатывающие блоки sidechain, узнают, что конкретные монеты основной учетной системы были заморожены. Это позволяет валидаторам sidechain выпустить эквивалентное количество монет во второстепенной учетной системе на адрес, соответствующий открытому ключу пользователя, который он использовал в основной учетной системе. Далее пользователь может распоряжаться своей ценностью уже по новым правилам.

Чтобы перенести учет цифровых активов из sidechain обратно в mainchain, пользователь подобным образом должен заморозить свои активы во второстепенной учетной системе и предоставить доказательства валидаторам основной учетной системы. Они проверяют, что монеты действительно заморожены и соответствующая ценность заблокирована (или уничтожена), и размораживают эквивалентное количество монет в mainchain, отправляя их на адрес пользователя.

Допустим, Алиса и Боб пользователи учетной системы Bitcoin (рис. 4.2). Алиса владеет определенным количеством биткоинов и собирается отправить их Бобу, но по своим причинам не может этого сделать в самом mainchain. Тогда она создает транзакцию, которая замораживает определенное количество биткоинов в mainchain, и создает другую транзакцию в sidechain, благодаря которой создается эквивалентная ценность внутри sidechain, которой Алиса может распоряжаться. Когда валидаторы в mainchain подтвердят транзакцию заморозки, валидаторы sidechain получат доказательства, что средства заморожены в mainchain, и подтвердят транзакцию в sidechain.

<img width="50%" alt="Рисунок 4.2 – Передача ценности из основной цепочки в sidechain" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.2-Transferring-value-from-the-mainchain-to-a-sidechain.png"/> 

Представим, что Алиса отправила монеты Бобу в sidechain, но Боб захотел потратить их в mainchain. Для этого он создает транзакцию, замораживающую монеты, в sidechain, а другую транзакцию в mainchain, то есть в учетной системе Биткоина, о намерении перевести монеты из sidechain. После получения доказательств того, что монеты в sidechain заморожены, транзакция в Биткоине подтверждается, и монеты появляются на счету Боба. Так это работает в самом общем случае.

Наиболее сложной является проблема реализации взаимодействия валидаторов основной сети с валидаторами в сети sidechain для успешной заморозки и разморозки активов. Именно в способах решения этой проблемы и состоит основное отличие между federated и merged-mined sidechains.

### Federated sidechains

Federated sidechains используют multiSig-адреса для заморозки активов в mainchain. Для этого создателями sidechain выбираются члены федерации – доверенные лица, которые определяют, когда монеты, используемые пользователем, замораживаются и освобождаются (рис. 4.3). Для этого они используют специальные адреса и контракты на основе мультиподписи. Надежность этого подхода зависит от вероятности злоумышленного сговора членов федерации.

<img width="50%" alt="Рисунок 4.3 – Устройство federated sidechains" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.3-Federated-sidechains-structure.png"/> 

Такой подход не требует изменений в протоколе mainchain. Если произойдет атака на sidechain либо его работа будет скомпрометирована, то на состоянии mainchain это не отразится, однако это позволит обнаружить и учесть уязвимости в протоколе, по которому работает sidechain. Для этого подхода уже существует практическая реализация, mainchain которой является блокчейн Bitcoin.

### Merged-mined sidechains

Merged-mined sidechain использует технологию merged mining, которая позволяет использовать решение одной и той же задачи PoW для формирования блоков в основном и дополнительном блокчейнах. Принцип работы этой технологии имеет следующие особенности. В процессе создания новых блоков валидатор сначала формирует блок для альтернативной цепи, которая использует merged mining. Заголовок этого блока помещается в свой новый блок для mainchain. Далее, для нового блока mainchain решает задачу PoW. Если валидатор находит решение, которое удовлетворяет сложности в mainchain, то этот блок распространяется среди узлов mainchain. Данные заголовка блока для sidechain игнорируются остальными участниками mainchain. Если найденное решение удовлетворяет сложности в sidechain, тогда в новом блоке для sidechain указывается заголовок нового блока для mainchain и его coinbase-транзакция вместе с SPV-proof. Проверка такого PoW выполняется по правилам протокола для sidechain, которые предусматривают возможность принятия решения задачи PoW для mainchain, если алгоритм хэширования совпадает и решение задачи удовлетворяет сложности в sidechain.

Для реализации такого подхода в скриптовом языке, который используется в mainchain, требуется существование операции, подобной OP_COUNT_ACKS, как в Биткоин. Эта операция связана с проверкой дополнительных условий, которые поступают из внешней учетной системы, для разморозки активов в mainchain. Данные из sidechain через merged mining попадают в mainchain блок, а валидаторы mainchain попадают на эту операцию и проверяют соответствующие данные согласно правилам протокола mainchain. Если монеты разрешается потратить, то они размораживаются в основной учетной системе. Надежность такого подхода зависит от владельцев большинства вычислительной мощности. Чтобы данная операция была добавлена в протокол основной учетной системы, необходимо провести softfork (рис 4.4).

<img width="50%" alt="Рисунок 4.4 – Устройство merged-mined sidechains" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.4-The-structure-of-merged-mined-sidechains.png"/> 

Одним из важных компонентов sidechain является метод SPV (подробнее был описан в первой части учебного пособия и в разделе 2.3), который позволяет удостовериться в подтвержденности определенных транзакций, не загружая всю цепочку блоков.

SPV-узлы в Bitcoin нужны валидаторам второстепенной учетной системы, чтобы проверить, что монеты в Bitcoin заблокированы. Эти данные являются основанием для валидаторов принять решение о разблокировке эквивалентного количества монет в sidechain.

Напомним, что упрощенная проверка предполагает наличие списка заголовков блоков, которые доказывают выполнение работы proof-of-work и тот факт, что непотраченный выход был создан в одном из блоков списка. Но для работы в sidechain доказательство (SPV-proof) должно быть достаточно маленьким, чтобы вписаться в одну coinbase-транзакцию. Любой валидатор, имея SPV-доказательства, может убедиться в подтвержденности транзакции, не выполняя верификацию каждого блока заново.

На сегодняшний день уже существуют проекты, использующие sidechain. Например, компания Blockstream разработала свой sidechain для проекта Liquid, цель которого ускорить переводы биткоинов между биржами. Компания Rootstock разработала sidechain, использующий merged mining, для управления биткоинами с помощью смарт-контрактов, написанных на языке Solidity.

Таким образом, sidechain позволяет разработчикам не только тестировать новые реализации или изменения протокола перед их активацией, а и реализовывать новые инструменты для работы с уже существующей валютой. Существует мнение, что при использовании надежных механизмов привязки (two-way peg) технология sidechain значительно разгрузит основную сеть и позволит обслуживать основную часть пользователей в рамках учетных систем, которые связаны с основной и работают параллельно. В этом случае технология может решить проблему чрезмерной нагрузки, обрабатывая определенные типы транзакций в отдельных учетных системах и сохраняя основные принципы децентрализации.

### Недостатки sidechains

Для реализации надежного взаимодействия на сетевом уровне огромную сложность представляет наличие нескольких децентрализованных учетных систем, поддерживающих переводы между собой. Они должны поддерживать скрипты транзакций, которые позже могут оказаться невалидными из-за последующего изменения доказательств. Это влечет за собой необходимость иметь ПО, которое сможет обнаружить потенциальные атаки и блокировать их. Нужно также учесть, что конфигурация ПО кошелька должна быть изменена для поддержки нескольких цепочек блоков.

В случае two-way peg sidechain, который использует SPV-proofs, перенос ценности из основной учетной системы во второстепенную и обратно является менее безопасным по сравнению с платежами в рамках одной учетной системы. Ведь получатель имеет подтверждение от валидатора, который проверил только SPV-доказательство. Что касается самой ценности, то монеты могут переноситься в любом соотношении и с любым коэффициентом (например, 1:1, 1:10 или 1:100).

### Итоги

Применение подхода sidechain позволяет добавить альтернативные правила учета существующих монет. Неудобство состоит в том, что для использования альтернативных правил учета пользователю, как правило, необходимо поддерживать два полных узла: один для основной учетной системы, второй – для дополнительной.

Тем не менее, ценность применения подхода sidechain в том, что он предлагает механизм, с помощью которого можно внедрять новые технологии, не подвергая риску основную учетную систему. Вероятнее всего, в будущем это позволит найти решения многих проблем, в том числе недостаточной пропускной способности учетной системы.

## 4.2 Устройство Lightning Network

В предыдущей части учебного пособия мы начали рассматривать концепцию под названием Lightning Network. Сейчас мы детальнее рассмотрим, как именно работает эта концепция и за счет чего достигается возможность сторон не доверять друг другу.

### Устройство двунаправленного платежного канала

Для понимания Lightning Network (LN) необходимо предварительное понимание устройства двунаправленных платежных каналов. Фактически LN формируется за счет коммутации таких каналов между собой.

Основное преимущество двунаправленных каналов состоит в том, что участники могут передавать монеты в обе стороны, при этом не доверяя друг другу и не транслируя промежуточные транзакции в сеть. Если одна из сторон попробует смошенничать, то согласно протоколу она теряет все свои монеты. Важно отметить, что при этом не требуется никакого вмешательства третьей стороны: протокол на основе криптографических доказательств позволяет наказать злоумышленника.

В случае использования платежного канала такого типа, взаимодействующие стороны могут обмениваться монетами друг с другом неограниченное количество раз. При этом в сеть будет необходимо опубликовать только две транзакции: _funding_, которая блокирует монеты в сети и открывает канал, и _refunding_, которая возвращает монеты сторонам по результату взаимодействия между ними. В данном случае может быть 3 сценария разблокирования монет участников канала, которые будут рассмотрены далее.

В общем виде схему функционирования платежного канала можно представить, как на рисунке 4.5.

<img width="50%" alt="Рисунок 4.5 – Схема работы двунаправленного платежного канала" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.5-Bidirectional-payment-channel-scheme.png"/> 

> **Внимание!** *Выглядит довольно громоздко, сложно и пугающе, однако ниже мы рассмотрим каждый шаг взаимодействия и детально опишем, что на самом деле происходит, таким образом, что по окончании раздела читатель будет полностью понимать, как работают двунаправленные платежные каналы в Lightning Network.*

### Открытие платежного канала

Для открытия платежного канала Алиса и Боб связываются между собой (взаимодействие в рамках сети lightning-узлов) и обмениваются открытыми ключами для создания multisig адреса. Также стороны обмениваются ссылками на непотраченные выходы с монетами, которые хотят заблокировать в совместном канале. После этого одна из сторон формирует транзакцию, входы которой ссылаются на упомянутые непотраченные выходы. В выход новой транзакции добавляется сформированный multisig адрес. В нашем примере Алиса и Боб изначально имеют по 5 BTC, а выход транзакции содержит сумму в 10 BTC (рис. 4.6).

<img width="40%" alt="Рисунок 4.6 – Схема формирования транзакции для открытия канала" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.6-Channel-opening-and-transaction-generation-scheme.png"/> 

Это и является funding транзакцией, которую стороны должны отправить в сеть для открытия платежного канала. В этом случае транзакция должна быть подписана владельцами обоих входов. Это означает, что каждая сторона доказывает владение своим входом и сообщает, что готова потратить монеты на указанный multisig адрес.

> **_Замечание._** *Необходимо отметить один важный момент. После подтверждения такой транзакции, в случае, если одна из сторон прекращает взаимодействие (по какой-либо причине не подписывает трату монет с совместного адреса), то обе стороны теряют свои монеты. Однако такое поведение не будет выгодным ни одной из сторон, так как это не позволяет завладеть чужими монетами и приводит к потере своих.*

До внедрения Segregated Witness такая проблема могла решаться только путем задания дополнительных условий: если монеты не будут потрачены с multisig-адреса, то через некоторое время стороны могут их разблокировать, используя только свои личные ключи. Однако такой подход, во-первых, ограничивает время жизни канала, а во вторых, стороны должны долго ждать, пока монеты станут доступными для разблокировки (обычно платежный канал открывается на продолжительное время).

Segregated Witness позволил же решить эту задачу более изящно, путем устранения transaction malleability (segwit позволяет не включать значение подписи в tx_id, за счет чего можно строить цепочку неподтвержденных транзакций). Теперь стороны могут создать multisig транзакцию, но не подписывать ее до того момента пока не будут сформированы транзакции, распределяющие монеты в канале обратно их владельцам. 

Поэтому Алисе и Бобу необходимо создать первую транзакцию в канале, которая будет выплачивать монеты обратно их владельцам. Но перед этим каждая сторона должна сгенерировать случайный секрет и передать его хэш-значение другой стороне (рис. 4.7).

<img width="40%" alt="Рисунок 4.7 – Схема генерации секретов и обмен хэш-значениями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.7-Secrets-generation-and-hash-values-exchange-scheme.png"/> 

После этого Алиса и Боб формируют по одной транзакции (рис. 4.8), которые тратят монеты с multisig адреса следующим образом:

1. Алиса формирует транзакцию, первый выход которой содержит 5 монет и может быть потрачен с помощью личного ключа Алисы, а второй выход содержит оставшиеся 5 монет и два взаимоисключающих условия траты: либо по прошествии определенного времени (например через 100 блоков после подтверждения этой транзакции) Боб может потратить с помощью своего личного ключа, либо Алиса может потратить сразу с помощью своего личного ключа и секрета, который сгенерировал Боб (т. к. в условие включено хэш-значение, полученное от Боба).
2. Боб формирует транзакцию с такими же выходными суммами, но противоположными условиями траты: первый выход может потратить Боб с помощью своего личного ключа, а второй выход с двумя взаимоисключающими условиями: либо может потратить Алиса с помощью своего личного ключа по прошествии 100 блоков, либо может потратить Боб с помощью своего личного ключа и секрета, сгенерированного Алисой.

<img width="50%" alt="Рисунок 4.8 – Формирование и обмен commitment-транзакциями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.8-Commitment-transaction-generation-and-exchange.png"/> 

После этого каждый участник канала подписывает транзакцию (добавляет одну из двух необходимых подписей), которую сам сформировал и отправляет ее второй стороне. Далее каждый из участников канала проверяет транзакцию, полученную от своего контрагента. Если на данном этапе все верно, то платежный канал считается готовым для совершения внутренних платежей и может быть отправлена в сеть первая транзакция, которая платит на multisig  адрес (первая сформированная транзакция). Так как для подтверждении каждой из refunding транзакций необходимо, чтобы обе стороны ее подписали, то фактически уже на данном этапе может произойти закрытие канала (путем подписания транзакции второй стороной и распространения ее в сеть).

Если Алиса доподпишет и опубликует транзакцию, которую она получила от Боба, то в этом случае первый выход сразу отправит 5 монет Бобу, а второй Алисе, но уже по прошествии 100 блоков с момента ее подтверждения (Боб не сможет забрать монеты со второго выхода, так как он не знает секрет Алисы).

Когда Боб подпишет и опубликует транзакцию полученную от Алисы, произойдет точно такая же ситуация: Алиса сразу получит свои 5 монет, а Боб получит свои по прошествии 100 блоков.

В итоге, если на данном этапе хотя бы одна из сторон опубликует транзакцию, то монеты отправятся их владельцам и канал будет закрыт. Из вышеописанного понятно, можем сделать вывод, что ни одна из сторон не сможет мошенничать и забрать монеты другой стороны (это можно сделать, только если одна из сторон опубликует транзакцию в сети, а затем раскроет и собственный секрет).

### Передача монет в рамках канала

После того как канал открыт и созданы транзакции возвращающие монеты пользователям, Алиса и Боб могут передавать монеты в рамках канала. Давайте рассмотрим каким образом это происходит.

Первый этап состоит в генерации нового секрета и передачи его хэш-значения контрагенту (как и в случае формировании первой в канале транзакции).

После этого каждая из сторон формирует новую транзакцию в канале, однако уже с другим распределением монет между сторонами. Например, Алиса решила заплатить 2 BTC Бобу. В этом случае, после того как стороны обменялись хэш-значением сгенерированного секрета, они формируют следующие транзакции:

1. Алиса формирует транзакцию, первый выход которой переводит 3 монеты на адрес Алисы, а второй выход снова содержит два условия траты 7 оставшихся монет: либо Бобу по прошествии определенного времени, либо Алисе, но только в том случае, если она знает секрет, сгенерированный Бобом на втором этапе.
2. Боб формирует такую же транзакцию, однако в первом выходе 7 монет отправляются Бобу,  а во втором Алисе по прошествии 100 блоков либо Бобу, если он узнает секрет Алисы (рис. 4.9).

<img width="50%" alt="Рисунок 4.9 – Формирование и обмен альтернативными commitment-транзакциями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.9-Creating-and-exchanging-alternative-commitment-transactions.png"/> 

После того как эти транзакции сформированы, участники канала обмениваются ими. Затем любая из этих транзакций может быть доподписана и отправлена в сеть для подтверждения, вслед за чем канал будет закрыт. Таким образом стороны могут проводить бесконечное количество платежей между собой в рамках канала путем создания нового секрета и формировании новой транзакции для каждого платежа.

Отметим, что после обмена такими транзакциями, предыдущее состояние refunding транзакций в канале также может быть опубликовано. Поэтому в этот момент времени стороны имеют два способа закрытия канала. Чтобы обеспечить необратимость состояния канала (чтобы только последнее состояние считалось валидным), стороны обмениваются секретами, сгенерированными на первом этапе. Получение этих значений контрагентами не предоставляет им возможность смошенничать на данном этапе, но позволяет в дальнейшем забрать все монеты стороны, которая пытается смошенничать. Поэтому Алиса передает Бобу первый сгенерированный секрет, а Боб свой – Алисе. После этого каждый из них проверяет соответствует ли этот секрет хэш-значению, добавленному в первую в рамках канала транзакцию.

### Механизм штрафования за мошенничество в канале

Двунаправленные платежные каналы такого типа предполагают, что сторона, которая пытается смошенничать теряет все монеты, которые она поместила в канал. Теперь рассмотрим каким образом обеспечивается данный механизм. 

Для примера возьмем ситуацию, которую рассматривали ранее: Алиса с Бобом поместили по 5 монет в платежный канал, после чего создали транзакции, которые возвращают монеты на адреса участников канала (по 5 на каждый). После этого Алиса провела платеж на 2 монеты, и, соответственно, распределение в канале поменялось. Представим этот этап взаимодействия на используемой ранее схеме (рис. 4.10).

<img width="50%" alt="Рисунок 4.10 – Схема открытия платежного канала и осуществления первого платежа" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.10-Opening-the-payment-channel-and-executing-the-first-payment.png"/> 

Окончательные транзакции распределения подразумевают, что после его закрытия канала 3 монеты отправятся Алисе, а 7 – Бобу. Но что мешает Алисе отправить первую транзакцию в канале, после которой она получает 5 монет?

Дело в том, что с целью распределить монеты поровну между сторонами, может быть доподписана и отправлена в сеть одна из двух транзакций: либо со стороны Боба, либо со стороны Алисы. Бобу нет смысла доподписывать и отправлять хранящуюся у него транзакцию, так как эта транзакция нечестная по отношению к нему (тем более, если он это сделает, то потеряет все свои монеты в канале). Чтобы распределить монеты поровну, Алиса может подписать и отправить транзакцию, изображенную на рисунке 4.11:

<img width="40%" alt="Рисунок 4.11 – Commitment-транзакция, которую может опубликовать Алиса" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.11-Commitment-transaction-that-Alice-can-publish.png"/> 

Теперь рассмотрим, что произойдет, если данная транзакция будет отправлена в сеть. Как только эта транзакция подтверждается, Боб сразу получает доступ к монетам на первом выходе. Второй выход может быть разблокирован только в случае, если Алиса дождется подтверждения 100 блоков или, если Боб знает секрет Алисы, сформированный на первом этапе. Вот тут и кроется механизм защиты от мошенничества: Алиса публикует свой секрет после того, как стороны договорились о новом распределении в канале, а так как в канале уже появлялась транзакция, распределяющая 3 монеты Алисе и 7 – Бобу, то Алиса уже опубликовала свое секретное значение, при помощи которого можно получить доступ к оставшимся 5 монетам первой транзакции. Так как Боб знает секретное значение, он использует его вместе со своим личным ключом для получения оставшихся 5 монет. Как результат – он забирает все монеты в канале.

Поэтому, после того как стороны договорились о новом состоянии распределения ценности в канале, предыдущее состояние не может быть опубликовано, так как сторона, которая доподпишет и отправит предыдущую транзакцию в сеть, попросту теряет все свои монеты в канале.

### Закрытие платежного канала

Мы рассмотрели, как создается платежный канал, каким образом совершаются платежи и как работает механизм защиты от мошенничества. Теперь рассмотрим, каким образом безопасно закрыть используемый канал.

Опять же, допустим мы имеем состояние последних транзакций в канале (со стороны Алисы и со стороны Боба), которые передают 3 монеты Алисе и 7 Бобу. Канал в этом случае может быть закрыт тремя способами (рис. 4.12).

<img width="50%" alt="Рисунок 4.12 – Схема вариантов закрытия платежного канала" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.12-Payment-channel-closing-scheme.png"/> 

Первый способ закрытия канала – Алиса доподпишет и опубликует свою последнюю транзакцию в канале. Давайте рассмотрим эту транзакцию и что произойдет после ее публикации (рис. 4.13).

<img width="40%" alt="Рисунок 4.13 – Commitment-транзакция, которую публикует Алиса" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.13-Commitment-transaction-published-by-Alice.png"/> 

После подтверждения такой транзакции в сети, Боб сразу получает доступ к своему выходу на 7 монет. Второй выход доступен Алисе после подтверждения 100 дополнительных блоков либо Бобу, если он знает секрет Алисы. Однако в этом случае, так как это последняя транзакция в канале, Алиса не раскрывала свой секрет и Боб не может получить монеты этого выхода. Единственным недостатком такого подхода является большой промежуток времени, после которого Алиса сможет воспользоваться своими монетами.

Второй способ закрытия канала аналогичен первому, но предполагает, что уже не Алиса, а Боб отправит refunding транзакцию (рис 4.14). В этом случае выход Алисы сразу становится доступным ей, а Боб сможет забрать свои монеты после прохождения 100 блоков.

<img width="40%" alt="Рисунок 4.14 – Commitment-транзакция, которую публикует Боб" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.14-Commitment-transaction-published-by-Bob.png"/> 

Однако существует и третий способ закрытия канала, при котором стороны сразу получают доступ к своим монетам. Для этого они совместно формируют транзакцию, которая тратит монеты с multisig адреса на два выхода, один из которых принадлежит только Алисе, а второй только Бобу. После того как они подписывают такую транзакцию и опубликовывают ее в сеть, они сразу получают доступ к своим выходам.

### Как Lightning Network использует платежные каналы?

Мы полностью разобрались, как работают двунаправленные платежные каналы. Настало время объяснить, как этот подход используется в Lightning Network. 

Чтобы понять, зачем вообще необходима концепция Lightning Network, рассмотрим ситуацию, при которой Алиса хочет передать монеты Кэрол, с которой у нее нет открытого платежного канала. Самым простым способом является открытие такового, однако это может быть неэффективно по ряду причин (например, это единоразовый микроплатеж и Алиса не хочет платить комиссию как за обычную транзакцию, так за открытие и дальнейшее закрытие канала).

Однако вдруг оказывается, что у Алисы и у Кэрол есть открытые каналы с Бобом. Этими каналами они и могут воспользоваться и фактически передать монеты через Боба (рис. 4.15).

<img width="40%" alt="Рисунок 4.15 – Передача монет через несколько каналов" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.15-Transferring-coins-through-several-channels.png"/> 

Основной задачей при этом является обеспечение того, чтобы Боб не мог украсть монеты во время прохождения их через его каналы. Эту задачу и решает Lightning Network посредством коммутации и модификации механизма двунаправленных платежных каналов. Рассмотрим же как LN работает.

Как и в предыдущем случае, давайте представим полную схему работы на рисунке 4.16, а потом рассмотрим все компоненты этой схемы и соберем полную картину того, как работает Lightning Network.

<img width="50%" alt="Рисунок 4.16 –  Схема функционирования Lightning Network" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.16-Lightning-Network-operation-scheme.png"/> 

_Выглядит еще сложнее устройства платежных каналов, однако уверяем, что если вы разобрались с материалом выше, то понимание устройства Lightning Network не будет представлять каких-либо сложностей._

Чтобы иметь возможность передать монеты от Алисы Кэрол, необходимые платежные каналы между Алисой и Бобом, а также между Бобом и Кэрол должны существовать. Поэтому первым шагом является создание этих самых каналов (отметим, что на рисунке 4.17 изображено создание каналов в один момент времени, на самом деле эти каналы могут быть созданы задолго до проведения необходимого платежа; создание одного канала никаким образом не зависит от другого).

<img width="50%" alt="Рисунок 4.17 – Открытие двух независимых каналов" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.17-Opening-two-independent-channels.png"/> 

Фактически, происходит процесс создания двунаправленных платежных каналов, который мы описывали ранее. Изначально создаются multisig адреса, на которые стороны отправляют монеты посредством on-chain транзакции. Далее стороны генерируют между собой секреты и обмениваются хэш-значениями этих секретов. После этого формируются refunding транзакции, которые распределяют монеты с multisig адресов на адреса контрагентов. Каждая из этих транзакций подписывается стороной, которая ее сформировала и передается контрагенту. По итогу взаимодействия (публикации транзакции на multisig) создаются два канала: один между Алисой и Бобом, а второй между Бобом и Кэрол. Итак, пока что ничего нового, стороны могут проводить платежи только в рамках установленных каналов.

Теперь рассмотрим, как происходит передача монет по двум каналам через посредника. Очевидно, что если Алиса просто переведет монеты в рамках своего канала, то ей нужно будет доверять, что Боб в рамках канала с Кэрол также выполнит аналогичный перевод. Если же Боб сначала переведет монеты Кэрол, то он должен доверять Алисе, что она вернет ему монеты в рамках установленных между ними каналами. Очевидно, что каждый из этих подходов требует доверия хотя бы одной стороне.

Lightning Network позволяет провести действительно trustless перевод. Для этого изначально получатель монет (то есть Кэрол) генерирует новый секрет и передает его хэш-значение Алисе (рис. 4.18). При этом она просит Алису передать монету Бобу только в том случае, если он докажет, что узнал секрет сгенерированный Кэрол.

<img width="50%" alt="Рисунок 4.18 – Передача хэш-значения секрета от получателя к отправителю монет" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.18-Transfer-of-the-hash-value-from-the-sender-to-recipient.png"/> 

После того как Алиса получает хэш-значение секрета, они совместно с Бобом изменяют состояние refunding транзакций в своем канале. Для этого они генерируют новые секреты и обмениваются их хэш-значениями. Далее каждый из них создает новую транзакцию, подписывает ее и передает контрагенту как на рисунке 4.19.

В транзакции Алисы указано, что после ее подтверждения:

1. Первый выход сразу переводит 4 монеты на адрес Алисы. 
2. Второй выход на 5 монет может быть потрачен Бобом по прошествии 100 блоков с момента подтверждения транзакции либо Алисой, если она узнает секрет Боба. 
3. Добавляется третий выход на одну монету, который может быть потрачен в трех случаях: Бобом по прошествии 100 блоков и если он знает секрет, который Кэрол сгенерировала для перевода; Алисой, если она знает секрет, сгенерированный Бобом перед формированием транзакции; Алисой, по прошествии определенного времени с момента подтверждения транзакции (в качестве примера возьмем это значение равное 24 часам).

Транзакция, которую сформировал Боб, аналогична транзакции Алисы, за исключением некоторых изменений:

1. Первый выход платит 5 монет на адрес Боба.
2. Второй выход на 4 монеты может быть потрачен Алисой по прошествии 100 блоков либо Бобом, если он узнал секрет Алисы.
3. Третий выход также содержит три условия траты монет: Бобу, если он знает секрет, сгенерированный Кэрол; Бобу, если он знает секрет Алисы; Алисе по прошествии 24 часов (которые включают в себя timelock на 100 блоков).

<img width="40%" alt="Рисунок 4.19 – Обмен новыми refunding транзакциями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.19-Exchange-of-new-refunding-transactions.png"/> 

После того как каждая из транзакций была передана другой стороне и опубликованы секреты для инвалидации предыдущего состояния, стороны могут опубликовать транзакции в сеть и тем самым закрыть канал. Если полученную транзакцию доподпишет и отправит в сеть Боб (рис. 4.20), то первый выход сразу может быть потрачен Алисой. Так как Алиса не знает секрет, который сгенерировал Боб, то он получит доступ ко второму выходу после подтверждения 100 блоков. Если же Боб узнает секрет, который сгенерировала Кэрол, то он по прошествии  100 блоков, получит доступ и к третьему выходу. Если же этот секрет раскрыт не будет, то Алиса заберет свои монеты по прошествии заданного промежутка времени.

<img width="50%" alt="Рисунок 4.20 – Commitment-транзакция, которая может быть отправлена Бобом" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.20-Commitment-transaction-that-Bob-can-send.png"/> 

Если же полученную транзакцию доподпишет и отправит в сеть Алиса, то Боб сразу получает доступ к первому выходу (5 монетам). Второй выход Алиса сможет разблокировать по прошествии 100 блоков (так как Боб не знает секрет сгенерированный Алисой, получить доступ ко второму выходу он не может). Если же Боб раскрыл значение Кэрол (а он мог это сделать, только если передал ей монеты, механизм обеспечения этого мы рассмотрим далее), то он может забрать монеты с 3 выхода себе. Если же нет, то монеты станут доступны Алисе после истечения 24 часов (и включенных в них 100 блоков). Если Алиса не будет мошенничать, то Боб не получит доступ к ее секрету и не сможет забрать монеты с третьего выхода (рис. 4.21).

<img width="40%" alt="Рисунок 4.21 – Commitment-транзакция, которая может быть отправлена Алисой" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.21-Commitment-transaction-that-Alice-can-send.png"/> 

Несмотря на то, что эти транзакции могут быть сразу подтверждены в сети, сторонам невыгодно это делать, так как перевод от Алисы к Кэрол не пройдет и канал между ней и Бобом будет закрыт. Эти действия были необходимы для «блокировки» одной монеты в канале, которая может перейти Бобу, если он узна́ет секрет.

Теперь рассмотрим, как он этот секрет узнает. Для этого теперь уже взаимодействуют Боб и Кэрол. Они также обновляют собственные refunding транзакции в канале. То есть сначала они генерируют новые секреты и создают новые refunding транзакции, используя полученные хэш-значения секретов.

В транзакции, которую формирует Боб указывается:

1. Первый выход переводит 4 монеты на адрес Боба.
2. Доступ ко второму выходу может получить либо Кэрол по прошествии 100 блоков либо Боб, если узнает секретное значение Кэрол, сгенерированное для изменения состояния канала.
3. Доступ к третьему выходу и получение 1 монеты может осуществляться 3 способами: на адрес Кэрол по прошествии 100 блоков, и если она опубликует секретное значение; Бобу, если он узнает секрет Кэрол (который используется для изменения состояния канала); либо Бобом по истечении интервала времени (допустим, 12 часов; этот интервал должен быть меньше, чем при доступе к монетам Алисы в канале).

В транзакции Кэрол:

1. Первый выход переводит 5 монет на адрес Кэрол.
2. Доступ ко второму выходу может получить либо Боб по прошествии 100 блоков либо Кэрол, если узнает секретное значение Боба сгенерированное для изменения состояния канала.
3. Доступ к монете в третьем выходе может получить либо Кэрол, если она опубликует секретное значение, которое сгенерировала для получения монет; либо Кэрол, если разгласит секретное значение Боба; либо сам Боб по прошествии 100 блоков/достижении значения locktime (рис. 4.22).

<img width="40%" alt="Рисунок 4.22 – Обмен refunding транзакциями между Кэрол и Бобом" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.22-Carol-and-Bob-exchange-refunding-transactions.png"/> 

После того как эти транзакции сформированы, Кэрол и Боб подписывают их и обмениваются между собой. Давайте рассмотрим, что произойдет, если один из них попытается опубликовать это состояние refunding транзакции в сеть Bitcoin.

Если Кэрол доподпишет и опубликует транзакцию, полученную от Боба, то монеты с первого выхода сразу уходят на адрес Боба. Второй выход в размере 5 монет будет доступен Кэрол после прохождения времени блокировки (Боб не сможет его забрать, так как он не знает секретное значение Кэрол, при помощи которого можно забрать все монеты). Наибольший интерес представляет третий выход. Первый вариант его разблокировки – Кэрол по истечении  времени блокировки и только в том случае, если она опубликует свой секрет, за которым закреплена 1 монета. Если же Кэрол не успевает опубликовать его в указанный промежуток времени, Боб может забрать эти монеты себе. Фактически считается, что Кэрол не подтвердила перевод платежа от Алисы. В результате каждый из участников канала получит свои монеты и не сможет забрать монеты другого участника (рис. 4.23).

<img width="50%" alt="Рисунок 4.23 – Commitment-транзакция, которая может быть отправлена Кэрол" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.23-Commitment-that-Carol-can-send.png"/> 

Если же Кэрол все-таки опубликует секретное значение вовремя и заберет одну монету, то Боб может воспользоваться этим секретом для того чтобы забрать монеты в их канале с Алисой (мы описывали этот процесс, когда рассматривали транзакции в канале Боба и Алисы).

Что же произойдет, если refunding транзакция будет отправлена в сеть Бобом, а не Кэрол? В этом случае первый выход в размере 5 монет может быть потрачен только Кэрол. Второй выход может быть потрачен Бобом по истечении времени блокировки (либо Кэрол, если Боб попытается мошенничать). Третий же выход (рис. 4.24) может быть потрачен Кэрол, если она разгласит свой секрет, либо Бобом по истечении времени блокировки (либо, опять же, Кэрол, но только если Боб попытается мошенничать).

<img width="40%" alt="Рисунок 4.24 – Commitment-транзакция, которая может быть отправлена Бобом" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.24-Commitment-transaction-that-Bob-can-send.png"/> 

Как и в прошлом варианте (когда транзакция публикуется Кэрол), если Кэрол разгласила свой секрет, Боб может использовать его, чтобы забрать монету в канале с Алисой. Если же секрет не публикуется на протяжении заданного времени, стороны получают свои монеты обратно.

Важная особенность состоит в том, что если Кэрол хочет получить свои монеты при разглашении секрета, ей нет необходимости публиковать refunding транзакцию в сеть. Она может просто сообщить секрет Бобу, тот в свою очередь сообщит его Алисе, и таким образом стороны могут договориться и создать новые refunding транзакции в канале (рис. 4.25).

<img width="40%" alt="Рисунок 4.25 – Новое распределение монет в каналах после прохождения платежа" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.25-New-coin-distribution-in-channels-after-the-payment-was-executed.png"/> 

### Преимущества и недостатки Lightning Network

После того как мы рассмотрели принципы функционирования LN, можем выделить ключевые преимущества этой технологии.

> * _Решение проблем с пропускной способностью учетных систем_
> * _Конфиденциальность переводов участников каналов_
> * _Экономия на комиссиях для подтверждений транзакций_
> * _Предотвращение попыток мошенничества_

Основное преимущество LN – увеличение пропускной способности учетных систем. Фактически, пропускная способность каналов не ограничена и зависит непосредственно от средств коммуникации пользователей между собой. Пользователи могут ежесекундно (и даже каждую милисекунду) отправлять платежи друг другу и не ждать подтверждения транзакций валидаторами (за исключением funding и refunding транзакций).

Второе преимущество – конфиденциальность переводов между пользователями в канале. Детали всех транзакций видны только участвующим сторонам. Если вы используете только платежный канал, то валидаторы сети видят лишь детали funding и refunding транзакций. Детали всех остальных транзакций могут быть скрыты. Если же вы используете Lightning Network для передачи монет другим сторонам, то о транзакциях знают все посредники, через которых вы проводите платежи. При этом узлы Bitcoin не обрабатывают эти транзакции и не знают их деталей (разумеется, если никто из посредников не раскроет детали транзакций).

Третье преимущество состоит в экономии на комиссиях. За каждый канал его участники в сумме платят комиссию лишь дважды (за его открытие и закрытие). Остальные транзакции могут быть и бесплатными (в случае Lightning Network комиссии могут быть минимальными и платиться только посредникам за изменение состояния каналов).

Последнее важное преимущество Lightning Network – предотвращение потенциального мошенничества. Если одна из сторон решит смошенничать, она может утратить все свои монеты в канале.

Однако платежи в Lightning Network имеют некоторые недостатки по сравнению с on-chain транзакциями. Эти недостатки связаны с тем, что пользователю, кроме поддержания ПО полного узла сети Биткоин (или использования доверенного), нужно еще поддерживать узел LN.

Основное преимущество LN – увеличение пропускной способности учетных систем. Фактически, пропускная способность каналов не ограничена и зависит непосредственно от средств коммуникации пользователей между собой. Пользователи могут ежесекундно (и даже каждую милисекунду) отправлять платежи друг другу и не ждать подтверждения транзакций валидаторами (за исключением funding и refunding транзакций).

Второе преимущество – конфиденциальность переводов между пользователями в канале. Детали всех транзакций видны только участвующим сторонам. Если вы используете только платежный канал, то валидаторы сети видят лишь детали funding и refunding транзакций. Детали всех остальных транзакций могут быть скрыты. Если же вы используете Lightning Network для передачи монет другим сторонам, то о транзакциях знают все посредники, через которых вы проводите платежи. При этом узлы Bitcoin не обрабатывают эти транзакции и не знают их деталей (разумеется, если никто из посредников не раскроет детали транзакций).

Третье преимущество состоит в экономии на комиссиях. За каждый канал его участники в сумме платят комиссию лишь дважды (за его открытие и закрытие). Остальные транзакции могут быть и бесплатными (в случае Lightning Network комиссии могут быть минимальными и платиться только посредникам за изменение состояния каналов).

Последнее важное преимущество Lightning Network – предотвращение потенциального мошенничества. Если одна из сторон решит смошенничать, она может утратить все свои монеты в канале.

Однако платежи в Lightning Network имеют некоторые недостатки по сравнению с on-chain транзакциями. Эти недостатки связаны с тем, что пользователю, кроме поддержания ПО полного узла сети Биткоин (или использования доверенного), нужно еще поддерживать узел LN.

> * _Сложности резервного копирования и переноса кошелька на другое устройство_
> * _Необходимость постоянной работы кошелька пользователя для отслеживания состояния каналов путем мониторинга on-chain транзакций_
> * _Невозможность использования опции cold storage wallet_

**Часто задаваемые вопросы**

*— Много ли пользователей в Lightning Network?*

По состоянию на сентябрь 2019 в Lightning Network около 4500 узлов, между которыми открыто более 32000 каналов. Объем заблокированных биткоинов для функционирования Lightning Network равен около 850 BTC.

## 4.3 Принципы работы atomic swap и его применение

По определению, владелец криптовалюты может (и, скорее всего, заинтересован) работать со своими монетами без доверенной стороны, то есть trustless. На практике это свойство часто не обеспечивается – пользователи доверяют управление ключами централизованному серверу, используют централизованные биржи для обмена криптовалютами и т. д. Представьте себе ситуацию – вы купили себе новый электромобиль: быстрый, комфортный и энергоэффективный. Но вместо того, чтобы пользоваться этими преимуществами, вы запрягли в автомобиль лошадь. Звучит довольно абсурдно, не правда ли? Такая же ситуация возникает, когда пользователь, владеющий монетами криптовалюты, доверяет ее хранение некоторому сервису. Согласитесь, что в этом случае часть свойств криптовалюты исчезает, более того, пользователь уже не является владельцем монет – он становится владельцем цифровых обязательств: централизованных, цензурируемых, неанонимных и т. д.

Вполне естественно, что многие сознательные пользователи все таки используют свойства криптовалюты по назначению. Такие пользователи хотят непосредственно управлять монетами, именно trustless образом. Традиционные централизованные биржи не могут удовлетворить этим требованиям. Поэтому появилась потребность в инструменте, позволяющем поддерживать свойства криптовалюты при обмене монет разных учетных систем. Таким инструментом стал atomic swap.

В этом разделе будут описаны особенности функционирования атомарного обмена, актуальность этого механизма, требования к цифровым валютам для его работы. Кроме того, мы коснемся технологии децентрализованных бирж, а также рассмотрим их основные преимущества и недостатки.

### Как работают централизованные биржи?

Централизованный подход предполагает, что пользователь должен доверять свои деньги сервису. При таком подходе пользователь отправляет свои монеты на баланс биржи, а она должна выполнить свои обязательства по возврату денежного эквивалента в другой валюте. Так или иначе, деньги все это время находятся под управлением биржи, а у пользователя есть только ее обязательства по возврату средств. Также предполагается, что централизованная биржа не совершает переводов как таковых, а только перезаписывает балансы пользователей (рис. 4.26).

<img width="50%" alt="Рисунок 4.26 – Схема функционирования централизованной биржи" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.26-Centralized-exchange-operation-scheme.png"/> 

Для совершения обмена Алиса регистрируется на бирже и выставляет _order_ на покупку определенного количества монет определенной криптовалюты. Боб, который уже зарегистрирован на этой бирже, видит order и, если его устраивает цена, соглашается на него. Балансы аккаунтов на этой бирже у Боба и Алисы изменяются. После этого они могут вывести деньги на свои кошельки.

> **_Замечание._** *Order – это заказ на покупку цифрового актива. В нем указывается количество покупаемых монет, валюта, за которую они будут куплены, и желаемая цена.*

В этой ситуации и Алиса, и Боб доверяют бирже. Точнее, они доверяют персоналу биржи, что те исполнят свои обязательства при любых обстоятельствах, а не заберут деньги и не исчезнут с ними. Под обстоятельствами, в том числе, подразумеваются инженеры, которые проектировали и разрабатывали биржу, а также специалисты, которые обеспечивают защиту от мошенников. Последнее особо актуально, так как хакерам нет необходимости тратить много времени и сил на проведение атаки на отдельных пользователей (и получать с этого относительно небольшую выгоду), если существуют централизованные биржи, которые хранят монеты тысяч пользователей в одном месте (зачем грабить по отдельности людей, если можно ограбить банк). Поэтому такие атаки весьма частые и периодически довольно успешны (рис. 4.27).

<img width="40%" alt="Рисунок 4.27 – История краж монет с централизованных бирж" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.27-The-history-of-stolen-coins-from-centralized-exchanges.png"/> 

Интересным также является случай, который произошел с централизованной биржей Quadriga CX. Проблема в том, что все монеты пользователей (около $200 млн) хранились на холодных кошельках, доступ к которым был потерян вместе со смертью главного исполнительного директора биржи. Эта ситуация доказывает, что угроза потери монет централизованными хранилищами очень актуальна, а в результате одной проблемы страдает одновременно много пользователей.

### Идея atomic swaps и требования к учетной системе

_Atomic swaps_ предлагает концепцию обмена цифровых активов между собой таким образом, что обмен будет проходить либо неразрывно, либо вообще не будет выполнен. Такой подход позволяет совершить обмен, даже если пользователи не доверяют друг другу и при этом не использовать третью сторону в качестве посредника.

Чтобы две разные учетные системы могли успешно поддерживать между собой atomic swap, они должны удовлетворять некоторым фундаментальным требованиям.

> **Требования для поддержки atomic swap**
>> * _Возможность создания контрактов с блокировкой по времени_
>> * _Поддержка одинаковой хэш-функции для блокировки монет_
>> * _Off-chain канал между участниками обмена_

Основное требование состоит в возможности создания смарт-контракта с блокировкой монет по времени, при использовании которого один из участников обмена не сможет забрать все монеты себе (далее мы рассмотрим, как именно это работает).

Кроме того, для совершения транзакции между двумя разными учетными системами необходимо, чтобы обе они могли использовать одну и ту же криптографическую хэш-функцию в задании условий траты монет (например, SHA-256). Это необходимо, чтобы контракт выполнялся корректно, когда пользователь предоставит результат выполнения хэш-функции.

Также для успешного осуществления atomic swap необходимо наличие off-chain канала связи, по которому пользователи должны обсудить условия обмена.

### Принципы работы atomic swaps

Давайте детально рассмотрим, как работают atomic swaps. Предположим, что Алиса и Боб захотели обменяться монетами между собой, например, 2 BTC на 44 LTC. Сначала необходимо убедиться в том, что между Bitcoin и Litecoin возможно проведение atomic swaps. Так как обе системы поддерживают контракты с блокировкой по времени и общие хэш-функции (возьмем для примера SHA-256), то такой обмен возможен.

Вначале Алиса и Боб генерируют адреса, на которые они хотят получить монеты, и обмениваются этими адресами между собой (рис. 4.28). Вместе с обменом адресами, пользователи договариваются об условиях обмена. Отметим, что на этом этапе их взаимодействие происходит off-chain.

<img width="50%" alt="Рисунок 4.28 – Обмен участниками адресами в учетных системах" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.28-Participants-exchange-their-addresses-in-accounting-systems.png"/> 

После этого происходит формирование транзакций, в которых проводится перевод ценности взаимодействующей стороне. Сначала Алиса генерирует случайное число х и получает его хэш-значение. Далее она формирует транзакцию №1, в которой она отправляет 2 BTC и при этом задает два условия как эти монеты могут быть потрачены.

В первом условии сказано, что Боб может забрать эти монеты себе, если предоставит число, хэш-значение которого будет соответствовать заявленному (то есть это число будет равно тому, которое загадала Алиса). Во втором условии указано, что Алиса может забрать все эти монеты обратно, но для этого требуются подписи обеих сторон. Схематично сформированная транзакция выглядит, как на рисунке  4.29.

<img width="40%" alt="Рисунок 4.29 – Схема транзакции сформированной Алисой" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.29-Alice’s-transaction-scheme.png"/> 

Отметим, что транзакция только сформирована, но Алиса пока что не подписывает ее и не опубликовывает в сеть Bitcoin. После формирования транзакции, она отправляется Бобу, чтобы он смог ознакомится с ее содержимым. Опубликовать эту транзакцию в сети Биткоин Боб не сможет, так как она не подписана Алисой и не может быть подтверждена.

Алиса создает следующую транзакцию №2, которая тратит первую транзакцию. Однако при этом задается временная блокировка, то есть транзакция не может быть подтверждена на протяжении следующих 24 часов. Напомним, что эта транзакция требует мультиподписи Алисы и Боба для ее подтверждения. Поэтому Алиса подписывает ее и отправляет Бобу. Боб проверяет корректность полученной транзакции, подписывает ее и отправляет обратно Алисе. Схематически содержимое транзакции указано на рисунке 4.30.

<img width="50%" alt="Рисунок 4.30 – Вторая транзакция, сформированная Алисой (отправляет монеты обратно через 24 часа)" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.30-Alice’s-second-transaction-(it-sends-coins-back-after-24-hours).png"/> 

После того как транзакция №2 сформирована и подписана обоими участниками, спустя 24 часа она может подтвердиться и потратить выход транзакции №1. Так как все условия на текущий момент заданы, Алиса подписывает транзакцию №1 (которая переводит монеты Бобу, если он знает секретное значение) и публикует ее в Биткоин-сеть (рис. 4.31).

<img width="50%" alt="Рисунок 4.31 – Публикация Алисой транзакции в сеть" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.31-Alice-is-publishing-her-transaction-to-the-network.png"/> 

Согласно условиям транзакции Боб может потратить монеты в течение 24 часов после публикации Алисой транзакции в сеть Bitcoin, если он узнает соответствующее секретное значение. Как же нужно поступить Бобу, чтобы узнать это значение. Для этого он формирует транзакцию №3, которая тратит его 44 LTC и также задает два условия траты монет (рис. 4.32).

<img width="40%" alt="Рисунок 4.32 – Схема первой транзакции сформированной Бобом" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.32-Bob’s-first-transaction-scheme.png"/> 

В первом условии указывается: Алиса может забрать эти монеты, если предоставит значение, хэш-значение от которого равно хэш-значению, которое задано в выходе транзакции Бобом. Как вы догадались, Боб задал то же самое хэш-значение, которое задавала и Алиса в своей транзакции. То есть Боб просит Алису доказать, что она знает значение которое сгенерировала. Во втором условии указано, что Боб может забрать монеты назад, но только в случае, если обе стороны подпишут транзакцию.

Боб также не подписывает эту транзакцию и только отправляет ее Алисе для ознакомления с содержимым. После этого Боб формирует транзакцию №4, которая тратит транзакцию №3 и отправляет монеты Бобу, однако только по прошествии 12 часов. Эта транзакция должна быть подписана обеими сторонами. Поэтому Боб подписывает транзакцию и отправляет ее Алисе. Алиса проверяет ее содержимое, подписывает собственным ключом и отправляет обратно Бобу. Содержимое транзакции указано на рисунке 4.33.

<img width="40%" alt="Рисунок 4.33 – Вторая транзакция, сформированная Бобом (отправляет монеты обратно через 24 часа)" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.33-The-second-transaction-Bob-has-formed-(sends-coins-back-after-24-hours).png"/> 

После того, как транзакция №4 сформирована, Боб подписывает и отправляет в сеть Litecoin транзакцию №3.

Далее обмен зависит непосредственно от Алисы. Если она не передумала совершать обмен, ей необходимо доказать владение монетами на выходе транзакции Боба с помощью секретного значения. После того как она опубликовывает новую транзакцию (на этот раз в сеть Litecoin), в которой доказывает владение монетами, то секретное значение раскрывается и Боб может его использовать для собственного доказательства и забрать монеты (рис. 4.34).

<img width="50%" alt="Рисунок 4.34 – Публикация секрета Алисой и совершение trustless обмена" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.34-Alice-publishes-the-secret-and-performs-trustless-exchange.png"/> 

Если же Алиса передумала и не хочет совершать обмен, то она не публикует транзакцию с секретным значением, и после наступления заданного момента времени получает доступ к своим монетам. 

Для закрепления материала давайте приведем диаграмму последовательности с описанием основных шагов взаимодействия (рис. 4.35).

<img width="40%" alt="Рисунок 4.35 – Схема atomic swap" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.35-Atomic-swap-scheme.png"/> 

> _Шаг 1_. Алиса генерирует случайное значение х (секрет).

> _Шаг 2_. Алиса создает транзакцию №1 с двумя условиями траты монет: 
1) Бобу, если он знает секрет; 
2) Алисе, если следующая транзакция будет подписана ими двумя. После этого транзакция отправляется Бобу, для того чтобы он согласился с указанными условиями.

> _Шаг 3_. Алиса создает транзакцию №2, которая тратит транзакцию №1 и отправляет монеты Алисе спустя 24 часа.

> _Шаг 4_. Транзакция №2 подписывается Алисой и отправляется Бобу.

> _Шаг 5_. Боб проверяет содержимое транзакции №2, подписывает ее собственным ключом и возвращает Алисе.	

> _Шаг 6_. Алиса публикует транзакцию №1 в сеть Биткоин.

> _Шаг 7_. Боб создает транзакцию №3 с двумя условиями траты монет: 
1) Алисе, если она знает секрет; 
2) Бобу, если следующая транзакция будет подписана ими двумя. После этого транзакция отправляется Алисе, чтобы та согласилась с указанными условиями.
> _Шаг 8_. Боб создает транзакцию №4, которая тратит транзакцию №3 и возвращает монеты Бобу спустя 12 часов.

> _Шаг 9_. Транзакция №4 подписывается Бобом и отправляется Алисе.

> _Шаг 10_. Алиса проверяет содержимое транзакции №4, подписывает ее собственным ключом и возвращает Бобу.	

> _Шаг 11_. Боб публикует транзакцию №3 в сеть Litecoin.

> _Шаг 12_. Алиса тратит транзакцию №3, при этом опубликовывая секретное значение.

> _Шаг 13_. Боб получает секретное значение и использует его для разблокировки транзакции №1.

При этом важно отметить, что если Боб не заберет свои Bitcoin-монеты на протяжении 24 часов, то Алиса может их вернуть себе. Но если Боб успеет забрать свои деньги вовремя, то возможность мошенничать у любой из сторон отсутствует.

### Ограничения atomic swaps 

Как и любая технология, механизм  atomic swap обладает рядом преимуществ и недостатков. Выше мы рассмотрели, какими преимуществами обладает технология – trustless обмен в децентрализованной среде без использования каких-либо посредников. Теперь самое время рассмотреть ограничения технологии.

> * _Большое время подтверждения обмена_
> * _Достаточно высокая комиссия при обмене_ 
> * _Необходимость каждый раз искать контрагента и договариваться об условиях обмена_

Обмен на централизованной бирже может занимать доли секунд, в то время как проведение одного атомарного обмена зависит от платформ и участников процесса и может занимать сравнительно большое количество времени. Например, для случая, который мы рассмотрели, безопасный обмен может быть проведен не менее чем за 2 часа (время полного подтверждения 2-х блоков в Bitcoin и 2-х блоков в Litecoin) и это при условии, что стороны действуют быстро. Верхняя граница проведения обмена в нашем случае – 12 часов.

Следующее ограничение – высокая комиссия за проведение обмена. Для обмена каждому участнику нужно провести две транзакции: одну в сети Bitcoin и одну в Litecoin, а это, как известно не самые дешевые с точки зрения комиссии системы. На той же централизованной бирже комиссия может составлять несколько центов за обмен.

Последним ограничением является необходимость самостоятельного поиска стороны для взаимодействия. Децентрализованные биржи в некотором роде могут решить эту проблему, однако все равно скорость orders matching на них гораздо ниже, чем на централизованных. Также к ограничениям можно отнести невозможность проведения atomic swaps с участием фиатных валют.

Отдельно стоит упомянуть о риске потери монет в результате использования смарт-контракта с закладкой. Если пользователь не провел квалифицированный аудит смарт-контракта транзакции, которая была отправлена в сеть, он может потерять свои деньги (и ему некуда будет обратиться с претензией).

### Применение atomic swaps децентрализованными биржами

На базе atomic swap можно построить децентрализованные биржи, которые будут позволять работать с несколькими учетными системами, каждая из которых имеет собственную историю транзакций. Но при проектировании таких децентрализованных бирж необходимо помнить, что кто угодно должен иметь возможность оставить свое предложение о покупке или продаже. Поэтому сначала необходимо наличие протокола, который позволит составить order book децентрализованным образом.

Что касается гарантий выполнения orders, здесь есть особенности. В случае централизованных бирж, весь баланс находится у биржи. Поэтому, несмотря на то, что пользователь в любой момент может отменить свой order, до того момента, пока он не отменен, биржа может осуществить order matching и исполнить этот order. Для децентрализованных бирж все гораздо сложнее: здесь, вероятно, нужны штрафы за нарушение обязательств или что-то вроде этого.

Сделки на децентрализованных биржах происходят непосредственно между участниками сети (однорангово). На рисунке изображены подсети, каждая из которых взаимодействует в рамках своего протокола. Некоторые узлы содержат несколько различных компонентов (ПО для разных учетных систем) для взаимодействия с разными сетями. Таким образом обеспечивается поддержка обмена различными цифровыми активами между узлами (рис. 4.36). 

<img width="50%" alt="Рисунок 4.36 – Схема функционирования децентрализованных бирж" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.36-Decentralized-exchanges-operation-scheme.png"/> 

Стоит отметить, что до сих пор не существует единого стандарта для atomic swap. Все, кто на текущий момент использует atomic swaps, используют криптографию и смарт-контракты без какого-либо согласованного подхода.

К децентрализованным биржам, использующим технологию atomic swaps, можно отнести Barter DEX, Blockchain.io, Atom DEX и др.

### Проблема panic sells

При массовом использовании atomic swaps существует проблема, которая сложно решается. Допустим, что есть учетная система, внутри которой взимается очень высокая комиссия за обработку транзакций, а сами транзакции очень долго подтверждаются (яркий пример – Bitcoin). Пользователи начинают продавать эту валюту (поскольку система имеет низкую пропускную способность), и создают orders на децентрализованной бирже, но эти orders при выполнении создают смарт-контракты в той же системе, что и валюта, которую пытаются продать. Таким образом, сеть нагружается еще больше, ожидающие транзакции образуют еще большую очередь и пользователи еще сильнее хотят продать эту валюту, выставляя больше orders и увеличивая очередь транзакций. В качестве аналогии можно привести пример из ядерной физики (рис. 4.37).

<img width="40%" alt="Рисунок 4.37 – Схема распада ядра" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.37-Nuclear-fission-scheme.png"/> 

При распаде одно ядро изотопа урана-235 обычно испускает от 1 до 8 свободных нейтронов. Каждый нейтрон, образовавшийся при распаде может вызвать распад соседнего ядра урана, это явление называется цепной реакцией деления ядра. Собственно, это и является принципом взрыва атомной бомбы (причем проблему тушения ядерных взрывов до сих пор не удалось решить должным образом). Конечно, проблема panic sells в децентрализованных биржах на основе atomic swap не такая существенная в сравнении с проблемой атомных бомб, но данная аналогия очень наглядно отражает суть лавинообразного распространения панического процесса на рынке.

[МЕТОДЫ ДОСТИЖЕНИЯ КОНСЕНСУСА](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-2/ru/5-consensus-reaching-methods.md)
