**4 比特币作为一个平台**


    **4.1 侧链机制**

侧链的概念首次出现于 2014 年，当时改进原始比特币协议的趋势变得更加广为人知。这些尝试通常是由其他项目进行的，它们正在创建自己的货币，并且应该按照自己的规则运行。除了欲望通过其货币价格的增长变得更加富裕（实际上，这对情况产生了严重的影响）以外，这种趋势无疑是有意义的。到那时，已经有很多提案来改进协议并扩展其功能，但直接在比特币中实现这些东西在很多方面都是极不切实际的（包括安全考虑在内）。所有的升级都必须经过彻底的测试，然后才能实施。但是，考虑到并不是很多人会愿意尝试并使用替代数字货币，那么如何进行这些测试呢？

通过这种方式，要使用新的匿名化算法、智能合约或具有高吞吐量和低费用的共识机制的社区成员可以尝试使用现有的比特币在次级账户系统中，并有能力将它们发送回主账户系统。在不同的侧链项目中提出和开发的想法对比特币的未来产生了重大影响，但它们目前还没有被使用，因为开发人员试图创建自己独立的货币。

现实生活中侧链的概念可以远程类比为在不发行欧元或美元的国家使用这些货币。在这种情况下，这种国家的政府没有印刷货币的能力，但仍然可以确认交易并维护自己的内部记录。例如，欧元在黑山广泛使用，而美元则在巴拿马使用。

*侧链*是一个独立的区块链，其中包含来自主链的币的交易，如图 4–1 所示。

其操作规则可以与主链不同，并由新的协议确定（例如，可能存在不同的共识算法、不同的交易结构等）。侧链没有自己的货币，但实现了从主区块链转移价值的机制。侧链用于实现新的币计算规则（脚本扩展、智能合约）或测试新技术（签名算法、交易模型）。请注意，侧链可以处于活动或非活动状态。处于活动状态意味着该侧链得到某个验证者社区的支持。当成员停止参与决策和确认交易时，侧链被视为非活动（图 4–1）。


![alt_text](images/image1.png "image_tooltip")


图 4–1

侧链的概念最初由格雷戈里·麦克斯韦尔提出。描述这一想法的第一份文件是由一组作者于 2014 年 10 月 22 日发表的《通过锚定侧链实现区块链创新》[37]，其中之一是亚当·巴克。另一份著名的论文名为《侧链并非直接解决比特币面临的任何扩展问题的手段》，由皮特·吴雷于 2015 年 6 月 13 日发表 [72]。2015 年 6 月 14 日，格雷戈里·麦克斯韦尔发布了他的作品《锚定链的安全限制》。

***单向锚定和双向锚定侧链***

为了传输价值，侧链可以通过两种方式与主链相连：*单向锚定*或*双向锚定*。当使用*单向锚定*时，数字资产只能在一个方向上进行转移，即从主计帐系统的区块链到次要区块链。这种资产转移方式很少被使用，因此我们将更详细地讨论第二种选择。在*双向锚定*的情况下，数字资产可以来回转移。

双向锚定可以通过几种方式实现；最常见的是*联合侧链*和*合并挖矿侧链*。具有双向锚定的*侧链*的工作原理如下。用户首先必须将自己的资产发送到主计帐系统中的特殊地址，以防止在*主链*中花费这些资产。之后，用户将确认在*侧链*网络中所需的交易。这将让处理侧链区块的节点知道主计帐系统中的某些硬币已被冻结。这使得侧链验证者可以在次要网络中发行等值数量的硬币，并将其发送到对应于用户在主计帐系统中使用的公钥的地址。随后，用户可以根据新规则管理这个价值。

为了将数字资产从侧链转移到主链，用户必须在次要计帐系统中将其冻结，并向主计帐系统的验证者发送证明。验证者检查硬币是否真的被冻结，并且相应的价值被锁定（或销毁），然后解除*主链*中等量的硬币，并将它们发送到用户的地址。

假设爱丽丝和鲍勃是比特币计帐系统的用户（图 4–2）。 爱丽丝拥有一定数量的比特币，并希望将它们发送给鲍勃，但基于自己的原因，她无法在主链上执行此操作。因此，她创建了一个交易，在*主链*中冻结了一些比特币，并在侧链中为了创建了等量的交易，以便在那里能够管理。当*主链*中的验证者确认冻结交易时，*侧链*验证者将收到资金被冻结的证明，并确认*侧链*中的交易。


![alt_text](images/image2.png "image_tooltip")


图 4–2

想象一下，爱丽丝在*侧链*中向鲍勃发送硬币，但鲍勃希望在*主链*中使用它们。为此，他创建了一个交易，在*侧链*中冻结硬币，并在*主链*中创建了另一个交易（即比特币计帐系统），通知他打算从*侧链*转移硬币的意图。在收到*侧链*硬币被冻结的证明后，比特币交易被接受，硬币出现在鲍勃的帐户余额中。这就是在最一般的情况下的运作方式。

最大的问题是实现主网络和*侧链*验证者之间的交互，以成功地冻结并解冻资产。解决这个问题的方法正是联合*侧链*和合并挖矿*侧链*之间的主要区别。

***联合侧链***

*联合侧链*使用*多重签名地址*来*冻结主链资产*。为此，侧链的创建者选择联合成员：信托人，他们确定用户的硬币何时被冻结和释放（图 4–3）。他们使用特殊的地址和基于多重签名的合同来实现这一点。这种方法的可靠性取决于联合成员恶意串通的可能性。


![alt_text](images/image3.png "image_tooltip")


图 4–3

这种方法不需要对*主链*协议进行任何更改。如果*侧链*受到攻击或其操作受到影响，这不会影响*主链*状态；但是，这将允许检测和考虑*侧链*协议的漏洞。这种方法的实际实现已经存在，其*主链*是比特币区块链。

***合并挖矿侧链***

*合并挖矿侧链*使用*合并挖矿技术*，允许使用相同的工作量证明任务解决方案来生成主链和侧链中的区块。这项技术的操作原理具有以下特点。在生成新区块的过程中，验证者首先形成一个用于使用*合并挖矿*的另一条链的区块。该区块的标题被放置在其新的*主链*区块中。然后，主链为新区块解决工作量证明任务。如果验证者在*主链*中找到了任务的解决方案，该区块将分发给*主链*节点。其他*主链*参与者会忽略*侧链*的区块头。如果找到的解决方案满足了*侧链*的难度，那么在新的*侧链*区块中将指定一个新的*主链*区块的头部和 SPV 证明。这种工作量证明验证是由*侧链*规则执行的，这些规则提供了接受*主链*的难题解决方案的选项，如果散列算法相同并且解决方案满足*侧链*的难度。

为了在主链脚本语言中实现这种方法，需要类似于比特币中 OP_COUNT_ACKS 的操作。该操作涉及从外部账务系统中获得的一些额外条件的验证，以解冻*主链*资产。这通过从*侧链*到*主链*区块的合并挖矿数据进行，然后主链验证者根据主链协议规则检查相应的数据。如果可以使用硬币，它们将在主账务系统中解冻。这种方法的可靠性取决于拥有大部分计算能力的参与者。要将此操作添加到主账务系统协议中，需要软分叉（图 4–4）。


![alt_text](images/image4.png "image_tooltip")


图 4–4

*侧链*的一个重要组成部分是 SPV 方法（在教材第一册和第 2.3 节中更详细地描述），它允许在不下载整个区块链的情况下验证某些交易是否已确认。

侧账务系统的验证者需要比特币 SPV 节点来检查比特币硬币是否可以被锁定。根据这些数据，验证者决定解锁相应数量的硬币到*侧链*中。请记住，简化的验证假设存在一个区块头列表，确认已进行工作量证明，并且未花费的输出是在该列表中的某个区块中创建的。但是为了在*侧链*中工作，*SPV 证明*必须足够小，以适应一个 *coinbase* *交易*。任何具有 SPV 证明的验证者都可以确保交易已经确认，而无需再次验证每个区块。

如今，已经存在使用*侧链*的项目。例如，Blockstream 为项目 Liquid 开发了其侧链。其目标是在交易所之间实现更快的比特币转账。Rootstock 开发了一个使用*合并挖矿*来管理以 Solidity 编写智能合约的比特币的侧链。

因此，*侧链*不仅允许开发人员在激活之前测试新的实现或协议更改，还可以为现有货币启用新的工具。有一种看法认为，通过可靠的*双向锚定*，侧链技术可以显著减少主网，并允许保持大多数用户在与主要账务系统相连接并并行工作的账务系统中。如果是这样，这项技术可以通过在单独的账务系统中处理某些类型的交易并保持分散的基本原则来解决过载负载问题。

***侧链的缺点***

要实现可靠的网络级互操作，要让多个支持彼此之间交易的去中心化账务系统变得相当具有挑战性。它们必须支持交易脚本，这些脚本可能因后续证明的更改而变得无效。这就需要有软件能够检测潜在的攻击并阻止它们。还应考虑到，钱包软件必须配置为支持多个区块链。

在使用 SPV 证明的双向锚定侧链的情况下，从主账务系统向次要账务系统转移价值，以及反之，相较于同一账务系统内的支付，安全性较低。问题在于，接收者只有来自仅检查了 SPV 证明的验证者的确认。至于价值本身，硬币可以以任何比例和任何系数发送（例如，1:1，1:10 或 1:100）。

***摘要***

应用侧链方法可以为现有硬币的记账添加替代规则。缺点是，为了使用替代的记账规则，用户通常需要支持两个完整节点：一个用于主记账系统，另一个用于附加系统。

然而，侧链方法的价值在于，它提供了一种引入新技术而不暴露主记账系统于风险的机制。很可能在未来，它将有助于解决许多问题，特别是记账系统容量不足的问题。


    **4.2 闪电网络设计**

在本教材的上一册中，我们首次介绍了一个叫做闪电网络的概念。现在我们将更详细地研究这个概念的工作原理以及如何实现无信任操作。

***双向支付通道结构***

为了解释闪电网络（英语：the Lightning Network；LN），有必要先了解双向支付通道结构。实际上，LN 是通过将这些通道连接在一起形成的。

双向通道的主要优势在于参与者可以在双向上转移硬币，而无需彼此信任并将中间交易广播到网络中。如果其中一方试图智胜，那么根据协议，他将失去所有硬币。值得注意的是，这不需要任何第三方的干预：基于加密证明的协议允许对敌对者进行处罚。

如果使用这种类型的支付通道，交互方可以无限次地彼此交换硬币。因此，只需要向网络发布两笔交易：资金交易，将硬币锁定在网络中并打开通道的交易，以及退款交易，根据它们之间的交互结果将硬币退还给各方。在这种情况下，解锁通道参与者硬币可以有3种情景。我们将进一步讨论它们。

总的来说，支付通道的工作方案可以表示为图 4–5 中的方式。


![alt_text](images/image5.png "image_tooltip")


图 4–5


```
注意！看起来相当笨拙、复杂和令人生畏；然而，接下来我们将逐步审视每个交互步骤，并详细描述实际发生的情况。到本章结束时，读者将完全理解闪电网络中双向支付通道的工作原理。
```


***打开支付通道***

为了打开一个支付通道，爱丽丝和鲍勃联系对方（这种交互发生在闪电节点的网络内），并交换他们的公钥以创建一个多重签名地址。双方还交换要在共同通道中锁定的带币未花费输出的链接。然后，双方中的一方启动一笔交易，其输入指向上述的未花费输出。生成的多重签名地址被添加到新交易的输出中。在我们的示例中，爱丽丝与鲍勃最初各自拥有 5 个比特币，并且交易输出为 10 个比特币（图 4–6）。


![alt_text](images/image6.png "image_tooltip")


图 4–6

这是一笔双方必须发送到网络以打开支付通道的资金交易。在这种情况下，交易必须由两个输入的所有者签名。这意味着每一方都证明自己拥有输入，并表示愿意在指定的多重签名地址上花费硬币。


```
注意：我们必须强调一个重要的方面：在确认了这笔交易之后，如果其中一方停止交互（出于某种原因不签署从共享地址使用硬币的交易），那么双方都将失去他们的硬币。然而，这种行为对双方都是不利的，因为他们不能窃取对方的硬币，而且会失去自己的硬币。
```


在隔离见证实施之前，这个问题只能通过创建额外的条件来解决：如果硬币没有从多重签名地址花费，那么一段时间后，各方可以使用他们的私钥将它们解锁。然而，这种方法有两个缺点：首先，它限制了通道的生命周期，其次，各方必须等待很长时间才能使用硬币（支付通道通常会被打开很长一段时间）。

隔离见证允许以更加优雅的方式解决这个问题，通过消除交易的可篡改性（隔离见证允许在 tx_id 中去掉签名值，从而可以构建未确认交易的链）。现在，各方可以创建一个多重签名交易，但在创建发送回通道中被保留的硬币给其所有者的交易之前不签署它。

因此，爱丽丝和鲍勃需要在通道中创建第一笔交易，以将硬币支付给它们的所有者。在此之前，每一方都必须生成一个随机的秘密，并将其哈希值发送给对方（图 4–7）。


![alt_text](images/image7.png "image_tooltip")


图 4–7

之后，爱丽丝和鲍勃各自创建一笔交易（图 4–8）。这些交易将以以下方式花费来自多重签名地址的硬币：



1. 
爱丽丝创建了一笔交易，其中包含两个输入：第一个输入有 5 个硬币，可以使用她的私钥进行花费，第二个输入有剩余的 5 个硬币，具有两个互斥的花费条件：要么鲍勃可以在一段时间后（例如，自此交易确认后的 100 个区块）使用他的私钥花费它们，要么爱丽丝可以立即使用她的私钥和鲍勃生成的秘密使用它们（因为鲍勃的哈希值包含在条件中）。


2. 
鲍勃形成了一笔交易，其中包含相同的输出金额，但具有相反的花费条件：鲍勃可以使用他的私钥花费第一个输出，并在两个互斥的条件下花费第二个输出：要么爱丽丝可以在 100 个区块之后使用她的私钥花费它们，要么鲍勃可以使用他的私钥和爱丽丝的秘密花费它们。

![alt_text](images/image8.png "image_tooltip")


图 4–8

此后，每个通道参与者都会签署自己创建的交易（添加两者之一的必要签名），然后将其发送给对方。然后，每个参与者都会检查从对方接收到的交易。如果在这一点上一切都正常，那么支付通道就被清空以进行内部支付，并且可以发送第一笔付款到多重签名地址的交易（即第一笔创建的交易）。由于退款交易需要由双方签名才能生效，所以在此阶段，只要第二方签署交易并将其发布到网络中，通道就可以关闭。

如果爱丽丝完成签名并发布她从鲍勃那里收到的交易，第一个输出将立即发送 5 个硬币给鲍勃，第二个输出将在初始交易确认 100 个区块后才发送 5 个硬币给爱丽丝（鲍勃将无法从第二个输出获取硬币，因为他不知道爱丽丝的秘密）。

如果鲍勃签署并发布他从爱丽丝那里收到的交易，那么情况会完全相反：爱丽丝将立即收到她的 5 个硬币，而鲍勃将在 100 个区块后收到他的硬币。

因此，如果至少一方现在发布了交易，硬币将发送给它们的所有者，并且通道将被关闭。正如我们所讨论的，没有人可以欺骗并窃取其对手的硬币（只有在其中一方将交易发布到网络，然后还披露自己的秘密时才能做到）。

***通道内的硬币转移***

通道打开并创建了将硬币返还给用户的交易后，爱丽丝和鲍勃可以开始在通道内转移硬币。让我们看看这是如何运作的。

第一步是生成一个新的秘密，并将其哈希值传输给对方（就像在通道中形成第一笔交易时一样）。

然后，每一方在通道中创建一个新的交易，但是硬币的分配方式不同。例如，爱丽丝决定向鲍勃支付 2 BTC。在这种情况下，他们交换了生成的秘密的哈希值后，形成以下交易：



1. 
爱丽丝形成一笔交易，其第一个输出将 3 个硬币转到爱丽丝的地址，而第二个输出再次包含两种条件以花费剩余的 7 个硬币：要么在一定时间后给鲍勃，要么只有在第二阶段爱丽丝知道鲍勃的秘密时才能给爱丽丝。


2. 
鲍勃创建相同的交易，其中第一个输出将7个硬币发送到鲍勃，而第二个输出将 3 个硬币在 100 个区块之后转移到爱丽丝（或者如果鲍勃发现了爱丽丝的秘密，则硬币将转移到鲍勃）（图 4–9）。

![alt_text](images/image9.png "image_tooltip")


图 4–9

创建这些交易后，通道成员进行交换。然后，可以对这些交易中的任何一笔进行签名并发送到网络进行确认，通道就关闭了。因此，各方可以通过每次创建新的秘密和新的交易来在通道内相互执行无限次数的支付。

请注意，在交换这些交易后，通道中退款交易的先前状态也可以被发布。因此，任何时刻，各方都有两种方式来关闭通道。为了确保通道状态的不可逆性（只有最后一个状态被认为是有效的），各方交换了他们在第一阶段生成的秘密。目前，如果交易对手获得这些值，他们就不能作弊，但可以最初获得试图欺骗的一方的所有硬币。因此，爱丽丝将第一个生成的秘密交给鲍勃，而鲍勃则交换了他的秘密给爱丽丝。然后，他们每个人都检查这个秘密是否与添加到第一个通道交易中的哈希值相对应。

***通道中作弊的惩罚机制***

在这种双向支付通道中，试图作弊的一方将失去通道中的所有硬币。现在我们来看看这个机制是如何工作的。

例如，我们来看之前考虑过的一种情况：爱丽丝与鲍勃在一个支付通道中放入了 5 个硬币，然后创建了将硬币退还到各自地址的交易（每人 5 个）。然后爱丽丝进行了 2 个硬币的支付，因此通道中的分配发生了变化。让我们使用先前介绍的方案来想象一下这个交互阶段（图 4–10）。


![alt_text](images/image10.png "image_tooltip")


图 4–10

最终的分配交易意味着在关闭通道后，3 个硬币将归给爱丽丝，而 7 个将归给鲍勃。那么现在什么阻止爱丽丝将第一笔交易发送到通道中，从而她将收到 5 个硬币呢？

事实上，除了其中一笔交易外，还可以签署另一笔交易并将其发送到网络中，以便在各方之间均匀分配硬币：要么是来自鲍勃，要么是来自爱丽丝。对鲍勃而言，签署并发送他保存的交易没有意义（此外，如果他这样做，他将失去通道中的所有硬币）。为了均匀分配硬币，爱丽丝可以签署并发送图 4–11 中显示的交易：


![alt_text](images/image11.png "image_tooltip")


图 4–11

现在让我们看一看这笔交易是否被发送到网络会发生什么。一旦交易得到确认，鲍勃就会立即获得第一个输出上的硬币。第二个输出只有在爱丽丝等待下一个 100 个区块的确认，或者鲍勃找到了爱丽丝在第一阶段创建的秘密时才能解锁。这是针对作弊的基本保护机制：爱丽丝在各方就新通道分配达成一致后发布了她的秘密。由于通道已经有一笔交易将 3 个硬币发送给了爱丽丝，7 个发送给了鲍勃，爱丽丝已经发布了她的私人值，其可以被用来获取第一笔交易中剩余的 5 个硬币。由于鲍勃知道秘密值，他将其与自己的私钥一起使用来检索剩余的 5 个硬币。结果，他拿走了通道中的所有硬币。

因此，在各方就通道中价值分配的新状态达成一致后，旧状态不能被发布。否则，签署并将先前交易发送到网络的一方将简直失去通道中的所有硬币。

***关闭支付通道***

我们已经讨论了如何创建支付通道，执行支付以及防止作弊的机制是如何工作的。现在，让我们来看看如何安全地关闭一个活跃的通道。

再次假设我们有通道中最后交易的状态（来自爱丽丝和鲍勃），将 3 个硬币转给爱丽丝，7 个转给鲍勃。在这种情况下，通道可以通过三种方式关闭（图 4–12）。


![alt_text](images/image12.png "image_tooltip")


图 4–12

关闭通道的第一种方式是由爱丽丝完成签名并将她的最后一笔交易发布到通道上。让我们看看这笔交易以及它被发布后会发生什么（图 4–13）。


![alt_text](images/image13.png "image_tooltip")


图 4–13

在这笔交易被网络接受后，鲍勃立即可以访问他的 7 个币的输出。第二个输出只要经过 100 个确认的区块爱丽丝就能使用，或者如果鲍勃知道爱丽丝的秘密的话，他就也可能使用。然而，在这种情况下，由于这是通道中的最后一笔交易，爱丽丝没有透露她的秘密，因此鲍勃无法获取对应输出的币。这种方法的唯一缺点是爱丽丝必须等待很长时间才能使用她的币。

关闭通道的第二种方式与第一种方式类似，但假设的是不是爱丽丝而是鲍勃发送退款交易（图 4–14）。在这种情况下，爱丽丝的输出立即可用，而鲍勃则需要经过 100 个确认的区块后才能收取他的币。


![alt_text](images/image14.png "image_tooltip")


图 4–14

然而，还有一种关闭通道的第三种方式，即双方立即获得他们的币。为此，他们共同形成一笔交易，从一个多重签名地址上使用硬币到两个输出，一个只属于爱丽丝，另一个只属于鲍勃。当他们签署此交易并将其发布到网络时，他们立即获得对他们输出的访问权限。

***闪电网络如何使用支付通道？***

我们已经完全理解了双向支付通道的工作原理。现在，我们来解释闪电网络如何利用这种方法了。

为了理解为什么需要闪电网络的概念，让我们考虑一种情况，即爱丽丝想要向卡罗尔 转移硬币，但他们没有打开的支付通道。最简单的方法是打开一个通道，但出于多种原因，这可能效率低下（例如，这是一笔一次性微支付，可爱丽丝不想支付常规交易的费用或打开然后关闭通道的费用）。

然而，突然发现爱丽丝和卡罗尔都与鲍勃打开了通道。他们可以利用这些通道，实际上通过鲍勃 转移硬币（图 4–15）。


![alt_text](images/image15.png "image_tooltip")


图 4–15

这里的主要目标是确保鲍勃在硬币通过他的通道时无法窃取硬币。闪电网络通过切换并修改双向支付通道的机制来解决这个问题。让我们看看它是如何工作的。

与之前的情况一样，让我们在图 4–16 中引入完整的方案，然后仔细查看所有组件，以获得闪电网络运行方式的完整图景。


![alt_text](images/image16.png "image_tooltip")


图 4–16

这看起来甚至比支付通道的结构更复杂，但请相信我们，如果你理解了上面的材料，你对闪电网络的结构就不会有任何问题。

为了能够将硬币从爱丽丝转移到卡罗尔，必须存在爱丽丝和鲍勃之间以及鲍勃和卡罗尔之间的必要支付通道。因此，第一步骤是创建这些通道（请注意，图 4–17 显示了一点时间内通道创建的过程；实际上，这些通道可以在实际支付之前很久之前创建；还请注意，创建一个通道的过程不会影响任何其他通道）。


![alt_text](images/image17.png "image_tooltip")


图 4–17

总的来说，实际发生的是双向支付通道的创建——正如我们之前所描述的。最初，创建多签地址，各方通过链上交易向其中发送硬币。然后，各方之间生成密钥，并交换这些密钥的哈希值。完成这些步骤后，退款交易就形成了。它们将硬币从多签地址分发到对方的地址。每个交易由生成它的一方签名并传输给对方。通过这种交互（在多签上发布交易），就创建了两个通道：一个在爱丽丝和鲍勃之间，另一个在鲍勃和卡罗尔之间。到目前为止，一切都还没什么新鲜的内容，现在各方可以在建立的通道内进行支付了。

现在让我们看看在这两个通道之间通过中介进行硬币转移是如何发生的。一方的话，如果爱丽丝只是在她的通道内转移硬币，她必须确信鲍勃能够通过他们的通道将这些硬币传输给卡罗尔。另一方面，如果鲍勃首先将硬币转移到卡罗尔，那么他必须确信爱丽丝将在他们自己的通道内返还必要数量的硬币。显然，这两种方法都至少需要一方的信任。

闪电网络允许进行真正无信任的转账。为此，作为接收方的卡罗尔首先生成一个新的密钥，并将其哈希值传递给爱丽丝（图 4–18）。同时，她要求爱丽丝只有在鲍勃证明他知道由卡罗尔生成的密钥时才将硬币转移到鲍勃。


![alt_text](images/image18.png "image_tooltip")


图 4–18

爱丽丝收到了秘密的哈希值后，她和鲍勃共同更改了他们通道中的退款交易的状态。为此，他们生成了新的秘密并交换了它们的哈希值。然后，他们每个人都创建了一个新的交易，签名并将其传输给对方，如图 4–19 所示。

爱丽丝的交易说明如下：



1. 
第一个输出立即将 4 个币转移到爱丽丝的地址。


2. 
第二个输出为 5 个币，可以在交易确认后 100 个区块内由鲍勃使用，或者在爱丽丝找到鲍勃的秘密后由她使用。


3. 
第三个输出增加了一个币。可以通过以下三种方式使用：a）如果鲍勃知道卡罗尔为转账生成的秘密，则可以在 100 个区块后由自己使用，b）如果爱丽丝在交易形成之前知道鲍勃生成的秘密，则可以使用，c）在交易确认后一定时间（例如，假设该值等于 24 小时）后，爱丽丝可以使用它。
鲍勃形成的交易与爱丽丝的交易类似，除了以下几点不同之处：



1. 
第一个输出将 5 个币支付给鲍勃的地址。


2. 
第二个输出为 4 个币，可以在交易确认后 100 个区块内由爱丽丝使用，或者在鲍勃发现爱丽丝的秘密后由鲍勃使用。


3. 
第三个输出也包含三种条件用于使用币，分别适用于a）鲍勃，如果他知道卡罗尔生成的秘密，b）鲍勃，如果他知道爱丽丝的秘密，c）爱丽丝，在 24 个小时后（包括 100 个区块的时间锁定）后。

![alt_text](images/image19.png "image_tooltip")


图 4–19

在每笔交易被转移到另一方并使前一个状态失效的秘密被公开后，各方可以将交易发布到网络上，从而关闭通道。如果鲍勃完成了他收到的交易的签名并将其发布到网络上（图 4–20），爱丽丝可以立即使用第一个输出。由于爱丽丝不知道鲍勃生成的秘密，她只能在经过 100 个确认的区块后才能获得对第二个输出的访问权限。如果鲍勃在 100 个区块后找到卡罗尔生成的秘密，他将获得对第三个输出的访问权限。如果这个秘密没有被揭示，那么爱丽丝将在一定的时间后收到她的币。


![alt_text](images/image20.png "image_tooltip")


图 4–20

如果爱丽丝确认收到交易并将其发送到网络，鲍勃立即获得对第一个输出（5 个硬币）的访问权限。爱丽丝将能够在 100 个区块后解锁第二个输出（因为鲍勃不知道爱丽丝生成的秘密，他无法访问第二个输出）。如果鲍勃揭示了卡罗尔的值（他只能通过给她币来做到这一点；稍后我们将看一下它是如何工作的），那么他可以从第三个输出中取出币。否则，币将在24小时后（包括100个区块）对爱丽丝可用。如果爱丽丝没有作弊，鲍勃将不会知道她的秘密，也无法从第三个输出中取出币（图 4–21）。


![alt_text](images/image21.png "image_tooltip")


图 4–21

尽管这些交易可以立即在网络上确认，但对于参与方来说，这样做是不利的，因为从爱丽丝到卡罗尔的转账将不会完成，并且她与鲍勃之间的通道将被关闭。这些操作是为了在通道中“锁定” 一个硬币，如果鲍勃发现了一个秘密，这枚币可能会归他所有。

现在，让我们看一看他如何找到这个秘密。假设鲍勃与卡罗尔正在互动。他们也更新了自己在通道中的退款交易。因此，他们首先生成新的秘密，并使用接收到秘密的哈希值创建新的退款交易。

鲍勃生成的交易包含以下内容：



1. 
第一个输出将 4 个币转移到鲍勃的地址。


2. 
第二个输出可以由卡罗尔在 100 个区块后获得，或者由鲍勃获得，如果他找到了用于更改通道状态的卡罗尔的秘密值。


3. 
来自第三个输出的一枚币可以以以下三种方式之一分配：如果卡罗尔发布了秘密值，那么在 100 个区块后可以分配给她的地址，或者如果鲍勃找到了卡罗尔的秘密（用于更改通道状态），或者在一段时间后（比如说 12 小时；这个间隔必须比爱丽丝获得通道内硬币的时间小）。
这是卡罗尔的交易内容：



1. 
第一个输出将 5 个币转移到卡罗尔的地址。


2. 
第二个输出可以在额外生成 100 个区块后由鲍勃访问，或者在卡罗尔找到鲍勃生成的用于更改通道状态的秘密值后由她访问。


3. 
第三个输出中的币可以由卡罗尔获得，如果她发布了她生成用于接收币的秘密值，或者如果她披露了鲍勃的秘密值，或者在 100 个区块过去/达到锁定时间后由鲍勃获得（图 4–22）。

![alt_text](images/image22.png "image_tooltip")


图 4–22

当这些交易形成后，卡罗尔和鲍勃签署它们并相互发送。让我们看如果其中一人试图将这个退款交易状态发布到比特币网络会发生什么。

如果卡罗尔完成签名并发布她从鲍勃那里收到的交易，第一个输出的币将立即转到鲍勃的地址。第二个输出的 5 个币将在锁定时间结束后可供卡罗尔使用（鲍勃将无法取回币，因为他不知道卡罗尔的秘密值）。

最有趣的部分是第三个输出。解锁它的第一种方法是，如果卡罗尔在锁定时间过去后发布了她的秘密，其中有 1 个币锚定。实际上，这是考虑到卡罗尔没有确认爱丽丝的付款。最终，每个通道参与者都将获得他们的硬币，并且不会取走别人的币（图 4–23）。


![alt_text](images/image23.png "image_tooltip")


图 4–23

如果卡罗尔仍然及时发布秘密值并获得一个币，鲍勃可以使用这个秘密来获取他与爱丽丝之间通道中的币（我们在之前讨论鲍勃和爱丽丝通道中的交易时描述过这个过程）。

如果不是卡罗尔将交易发送到网络而是鲍勃发送会发生什么呢？在这种情况下，第一个输出的 5 个币只能由卡罗尔支配。第二个输出在锁定时间结束后鲍勃可以支配（或者如果鲍勃试图欺骗，卡罗尔也可以）。第三个输出（图 4–24）可以由卡罗尔在她揭示秘密后支配，或者在锁定时间结束后由鲍勃支配（或者，如果鲍勃试图欺骗，卡罗尔也可以）。


![alt_text](images/image24.png "image_tooltip")


图 4–24

与前一种情况（卡罗尔发布交易）类似，如果卡罗尔揭示她的秘密，鲍勃可以从他与爱丽丝之间的通道中拿走一个硬币。如果在规定的时间内未公布秘密，各方将获得他们的币。

一个重要的特点是，如果卡罗尔希望在秘密被揭示时获得她的币，她不需要将退款交易发布到网络上。她只需告诉鲍勃秘密，鲍勃会将其发送给爱丽丝，以便各方可以达成一致并在通道中创建新的退款交易（图 4–25）。


![alt_text](images/image25.png "image_tooltip")


图 4–25

***闪电网络的优势和劣势***

在我们审视了 LN 的原则之后，我们可以列出这项技术的一些关键优势，包括以下几点：


```
解决会计系统的容量问题
通道参与者的隐私保护
节省交易确认费用
防止欺诈企图
```


LN 的主要优势是会计系统的容量增加。事实上，通道容量并不受限制，完全取决于用户的通信方式。用户可以每秒（甚至每毫秒）互相发送付款，而不必等待验证者确认交易，除了资金提供和退款交易。

第二个优势是通道用户之间转账的保密性。所有交易的详细信息只对相关方可见。如果只使用支付通道，那么网络验证者只能看到资金提供和退款交易的详细信息。

所有其他交易的详细信息都可以隐藏起来。如果你使用闪电网络向其他方转账，那么所有中介都会知道这些交易。与此同时，比特币节点不会处理这些交易，也不知道它们的详细信息（前提是没有中介透露交易详情）。

第三个优势是节省费用。通道成员只需支付两次费用：开启通道和关闭通道。其他交易甚至可以是免费的（在闪电网络的情况下，费用可以很低，只用于中介更改通道状态）。

闪电网络的最后一个重要优势是预防潜在的欺诈行为。如果其中一方决定采取欺诈行为，他可能会在通道中失去所有的硬币。

然而，与链上交易相比，闪电网络支付也有一些缺点。这些缺点与用户相关，除了维护完整比特币网络节点的软件（或使用可信的节点），用户还需要支持闪电网络节点。

与此相关的一些挑战包括：


```
备份并将钱包转移到另一台设备上存在困难
用户钱包必须始终运行，因为需要监视链上交易以跟踪通道状态
无法使用冷存储钱包
```


*****常见问题*****

*“LN 有多少用户？”*

截至 2019 年 9 月，闪电网络拥有约 4500 个节点，超过 3,2 万个开放通道。闪电网络操作中锁定的比特币数量约为 850 BTC。


    **4.3 原子交换的操作原理和使用**

根据定义，加密硬币所有者可以（而且可能是他有动机这样做的）在不信任任何第三方操作他的硬币，即以无信任的方式。然而，事实上，这种特性经常被忽视，因为用户将密钥管理委托给集中式服务器，并使用集中式交易所交换加密货币等。想象一下这样的情景：当你买了一辆新的电动汽车时：快速、舒适、节能。

不过，你却选择将马拴在汽车前面，而不是充分利用其功能。这听起来相当荒谬，是不是？当一个拥有加密货币的用户将它们的存储托管给某些服务时，就会发生类似的情况。你必须承认，在这种情况下，一些主要的加密货币属性将消失，更糟糕的是，用户将不再拥有这些硬币，而是变成了数字债务的所有者：集中式、容易受到审查、非匿名等。

许多有意识的用户仍然喜欢加密货币的属性，因为它们的初衷是这样的。这些用户希望以一种无需信任的方式直接管理货币。传统的集中式交易所无法满足这些要求。这就是为什么有必要拥有一种工具，可以在交换不同会计系统的货币时保持加密货币的属性。这种工具就是原子交换。

本节将介绍原子交换的原理，这种机制的相关性以及数字货币需要满足的工作要求。此外，我们还将讨论分散交易技术及其主要优缺点。

***中心化交易所是如何运作的？***

中心化的方法意味着用户必须将他们的资金委托给服务提供商。在这种情况下，用户将货币转移到交易所的余额上，交易所则必须履行其义务以返回另一种货币的等值金额。在任何情况下，资金都在交易所的控制之下，用户只有义务返还资金。同时，中心化交易所通常不进行转账，而只是重新调整其用户的余额（图 4–26）。


![alt_text](images/image26.png "image_tooltip")


图 4–26

为了进行交易，爱丽丝在交易服务中创建了一个账户，并下达了购买一定数量加密货币的订单。鲍勃已经有了账户，他看到了她的订单，如果他对价格满意，就会接受订单。鲍勃和爱丽丝的账户余额发生变化，他们可以将资金提取到他们的钱包中。


```
注意：订单描述了购买数字资产的预订。它包含了要购买的货币数量、用于购买的货币和期望的价格。
```


在这种情况下，爱丽丝和鲍勃都信任交易所。更确切的说，他们相信交易所的员工会在任何情况下履行他们的义务，而不是拿钱然后消失。

情况还包括设计和开发交易所的工程师，以及提供欺诈保护的专业人员。后者尤其重要，因为黑客不需要花费大量时间和精力攻击个别用户（并从中获得微薄的利润），特别如果有集中交易所将数千用户的货币存放在一个地方时（为什么只偷一个人的钱，而不是抢一家银行）。因此，这种攻击非常频繁，有时还相当成功（图 4–27）。


![alt_text](images/image27.png "image_tooltip")


图 4–27

另一个值得注意的事件曾经发生在一个名为 Quadriga CX 的中心化交易所。问题在于所有用户的货币（约 2 亿美元）都存放在冷钱包中，由于该交易所的首席执行官去世导致无法访问。这种情况证明了中心化存储失去硬币的风险相当高，导致了许多人遭受了后果。

***原子交换的概念和会计系统的要求***

*原子交换*提供了这样一种数字资产之间进行交换的概念，即交换过程要么完全进行，要么根本不会发生。这种方法允许进行交换，即使用户彼此不信任，同时也不想要中间人的情况下。

为了让两个不同的会计系统能够成功支持彼此之间的原子交换，它们必须满足一些基本要求。


```
支持原子交换的要求
能够创建时间锁合约的选项
支持相同的哈希函数以锁定硬币
存在于交换参与者之间的链下通道
```


主要要求是能够创建一个锁定智能合约，以防止交易参与者将所有的资金占为己有（我们稍后将会看到其工作原理）。

此外，为了在两个不同的账户系统之间完成交易，它们都必须在设置硬币支出条件时使用相同的密码哈希函数（例如，SHA-256）。这是为了在用户提供哈希函数执行结果时正确执行合约。

此外，为了成功执行原子交换，需要有一条参与者可用来讨论交换条件的链下通信通道。

***原子交换的运作原理***

让我们更仔细地看一下原子交换是如何工作的。假设爱丽丝和鲍勃想要交换硬币，例如，2 个比特币换取 44 个莱特币。首先，他们需要确保比特币和莱特币之间支持原子交换。由于两个系统都支持时间锁定的合约并且使用相同的哈希函数（我们以 SHA-256 为例），这种交换是可能的。

首先，爱丽丝和鲍勃生成他们希望收到硬币的地址并交换这些地址（图 4–28）。通过这样做，他们还同意了交换条件。请注意，在此阶段，他们是在链下进行交互。


![alt_text](images/image28.png "image_tooltip")


图 4–28

然后形成将价值发送给对方的交易。首先，爱丽丝生成一个随机数 x 并检索其哈希值。然后她形成交易 ＃1，在其中发送 2 个比特币，并同时设置了两种条件来规定这些硬币如何被花费。

第一个条件是如果鲍勃提供的数字与协商一致的哈希值相匹配（这个数字将与爱丽丝选择的相同），那么鲍勃可以获取这些硬币。第二个条件规定，只有在两个方的签名都存在时，爱丽丝才能够全部收回这些硬币。一个生成的交易方案类似于图 4–29 所示的交易。


![alt_text](images/image29.png "image_tooltip")


图 4–29

请注意，交易已经形成，但爱丽丝尚未签署它，因此仍然没有将其发布到比特币网络。交易形成后，它被发送给鲍勃，以便他可以查看其内容。由于爱丽丝没有签署，鲍勃将无法将此交易发送到比特币网络，因此无法确认。

爱丽丝创建了交易＃2，实际上花费了第一笔交易。然而，她还设置了一个时间锁，这意味着在接下来的 24 小时内无法确认该交易。请记住，此交易需要爱丽丝和鲍勃的多重签名才能确认。因此，爱丽丝签署并将其发送给鲍勃。鲍勃检查接收到交易的正确性，签署并将其发送回爱丽丝。在图 4–30 中，此交易的内容以示意图的形式显示。


![alt_text](images/image30.png "image_tooltip")


图 4–30

在形成并由两个参与者签署了交易 ＃2 之后，它可以在 24 小时内被确认，交易 ＃1 的输出可以被花费。由于所有条件已设置好，爱丽丝签署了交易＃1（转移币给鲍勃的交易，如果他知道密钥值），并将其发布到比特币网络中（图 4–31）。


![alt_text](images/image31.png "image_tooltip")


图 4–31

根据交易条款，如果鲍勃在爱丽丝将其发布到比特币网络中的 24 小时内找到相应的密钥值，他可以在此期间内花费硬币。那么鲍勃需要做什么才能找出这个值呢？为此，他形成了交易 ＃3，该交易花费他的 44 LTC，并为花费硬币设置了两个条件（图 4–32）。


![alt_text](images/image32.png "image_tooltip")


图 4–32

第一个条件规定，如果爱丽丝提供一个数值，其哈希值等于鲍勃交易输出中设置的哈希值，那么她就可以拿走这些硬币。你可能已经猜到，鲍勃在他的交易输出中放置了与爱丽丝设置的相同的哈希值。通过这样做，鲍勃要求爱丽丝证明她知道她生成的值。第二个条件规定，鲍勃可以拿回这些硬币，但只有在双方签署了交易后才能这样做。

鲍勃也不签署这个交易，只是将其发送给爱丽丝来审查其内容。之后，鲍勃形成了花费来自交易 ＃3 资金的交易 ＃4，，并将硬币发送给他，但只有在经过 12 个小时后才能这样做。这笔交易必须由双方签署。然后鲍勃签署了交易并将其发送给爱丽丝。爱丽丝检查其内容，用自己的密钥签署后将其发送回鲍勃。交易结构如图 4–33 所示。


![alt_text](images/image33.png "image_tooltip")


图 4–33

在形成了交易 ＃4 之后，鲍勃签署并将交易 ＃3 发送到莱特币网络。

接下来的交换直接取决于爱丽丝。如果她没有改变主意，她需要证明自己拥有鲍勃交易输出的硬币，使用一个密钥值。在她发布了一个新的交易（这次是到莱特币网络），其中她证明了硬币的所有权后，密钥值就会被揭示，鲍勃可以用它来证明自己的身份并拿走这些硬币（图 4–34）。


![alt_text](images/image34.png "image_tooltip")


图 4–34

如果爱丽丝改变主意不想再进行交易，那么她就不会发布带有密钥值的交易，在时间过去后，她会拿回她的硬币。为了更好地理解机制，让我们看一下描述主要交互步骤的顺序图（图 4–35）。


![alt_text](images/image35.png "image_tooltip")


图 4–35

步骤 1：爱丽丝生成一个随机值 x（密钥）。

步骤 2：爱丽丝创建交易 #1，其中包含两种花费硬币的条件：1）如果鲍勃知道密钥，就由他花费；2）如果他们两个都签署下一笔交易，则由爱丽丝花费。然后将交易发送给鲍勃，以便他同意指定的条件。

步骤 3：爱丽丝创建用于花费交易 #1的交易 #2，并在 24 小时后将硬币发送给爱丽丝。

步骤 4：爱丽丝签署交易 #2 并将其发送给鲍勃。

步骤 5：鲍勃检查交易 #2，使用自己的密钥签署它并将其返回给爱丽丝。

步骤 6：爱丽丝将交易 #1 发布到比特币网络。

步骤 7：鲍勃创建交易 #3，其中包含两种花费硬币的条件：1）如果爱丽丝知道密钥，就她可以花费；2）如果他们两个都签署下一笔交易，就由鲍勃使用。然后将交易发送给爱丽丝，以便她审查并同意其条件。

步骤 8：鲍勃创建用于花费交易 #3的交易 #4， 并在 12 小时后将硬币返回给鲍勃。

步骤 9：鲍勃签署交易 #4 并将其发送给爱丽丝。

步骤 10：爱丽丝检查交易 #4 的内容，使用自己的密钥签署它并将其返回给鲍勃。

步骤 11：鲍勃将交易 #3 发布到莱特币网络。

步骤 12：爱丽丝花费交易 #3，同时发布密钥值。

步骤 13：鲍勃接收密钥值并将其用于解锁交易 #1。

重要的是要注意，如果鲍勃在 24 小时内没有取回他的比特币，那么爱丽丝可以拿回这些比特币。但如果鲍勃及时取回他的钱，那么任何一方都无法作弊。

***原子交换的限制***

原子交换机制像任何技术一样，具有一些优点和缺点。在上文中，我们讨论了这项技术的优点，如在分散环境中进行无需信任的交换，无需依赖中介。现在我们考虑一下其局限性了：


```
交易确认需要很长时间
进行交换时的高费用
每次都需要找到交易对手并就交易条件进行协商
```


集中交易所可以在瞬间完成交易，而原子交换的局限性在于交易确认需要相对较长的时间。以我们考虑的情况为例，安全的交换至少需要 2 个小时（在比特币和莱特币网络中分别完全确认 2 个区块的时间），这要求各方行动迅速。在我们的情况下，交换的时间上限为 12 小时。

另一个限制是高额的交易费用。要进行交换，每个参与者都必须执行两笔交易：一笔在比特币网络中，另一笔在莱特币网络中，而且你可能知道，这些系统的交易费用相当高。另一方面，集中式交易所的手续费可能仅为几美分。

最后一个限制是你需要自己寻找交易对手。分散式交易所在某种程度上可以解决这个问题；然而，与集中式平台相比，订单匹配的速度仍然较慢。此外，还值得一提的是无法使用法定货币执行原子交换。

我们还应该提到由于使用具有漏洞的智能合约而导致丢失代币的风险。如果用户没有对发送到网络的交易的智能合约进行合格的审核，他可能会丢失她的资金（在这种情况下，没有任何一方能够处理这样的索赔）。

***如何使用原子交换的分散交易所***

让你使用多个具有自己交易历史记录的记账系统的分散交易所可以基于原子交换原理构建。然而，设计这种分散交易所时，应记住任何人都必须能够发布他们的买卖报价。因此，你必须首先拥有一个允许创建分散化订单簿的协议。

至于订单履行的保证，有一些需要考虑的事项。集中式交易所将所有余额存储在其服务器上。因此，即使用户可以随时取消订单，交易所仍会在任何情况下完成它，除非用户取消了订单。分散化交易所需要费用来处理违约行为。这是解决这个问题的最佳方法之一，截至 2019 年。

分散交易所上的交易直接在网络参与者之间进行，基于点对点的方式进行。图中显示了在其自己的协议内进行交互的子网。一些节点包含几个不同的组件（为不同会计制度的软件）用于与不同的网络交互。从而，提供了节点之间各种数字资产的交换（图 4–36）。


![alt_text](images/image36.png "image_tooltip")


图 4–36

值得注意的是，目前尚没有一个关于原子交换的统一标准。目前使用原子交换的所有人都可以自己使用密码学和智能合约，而不需要采用统一的方法。

使用原子交换技术的分散交易所包括 Barter DEX、Blockchain.io、Atom DEX 等。

***恐慌性抛售问题***

随着原子交换的广泛使用，存在一个难以解决的问题。假设存在一个交易处理费非常高，而且交易确认时间非常长的记账系统（例如比特币）。用户开始抛售这种货币（因为系统容量低），并在分散交易所上创建订单，但是这些订单在执行时会在与其尝试出售的货币相同的系统中创建智能合约。因此，不断增长的网络负载变得更高，未决交易形成了更大的队列，因此用户开始更积极地抛售这种货币，他们放置更多订单并增加交易队列。这与核物理学中的一个例子非常相似（图 4–37）。


![alt_text](images/image37.png "image_tooltip")


图 4–37

在 235 铀同位素的核裂变中，通常释放 1 到 8 个自由中子。在裂变过程中形成的每个中子都可以引发相邻核的裂变。这种现象被称为核裂变的链式反应。实际上，这就是原子弹爆炸的原理。此外，扑灭核爆炸的问题尚未得到成功解决。当然，基于原子交换的分散交易所中的恐慌性抛售问题与原子弹的问题相比较不那么重要，但这种类比非常清楚地反映了市场上恐慌情绪雪崩式传播的存在。

