# 4 BITCOIN ЯК ПЛАТФОРМА

## 4.1 Механізм sidechains

Ідея sidechains з’явилася у 2014 році, коли став помітний тренд покращення оригінального протоколу Bitcoin. Як правило, ці спроби відбувалися в низці інших проєктів, які створювали свої власні валюти та повинні були працювати за іншими правилами. Якщо залишити за кадром бажання розбагатіти на зростанні своєї валюти (яке в реальності значно вплинуло на ситуацію), то цей тренд, безумовно, мав сенс. До того моменту вже була велика кількість пропозицій щодо покращення протоколу й розширення його функціональності, але впроваджувати все підряд безпосередньо в Bitcoin було б украй недоцільно з багатьох причин (в тому числі з міркувань безпеки). Будь-які покращення повинні спочатку пройти ретельну перевірку й лише потім впроваджуватися. Але як же тоді забезпечити цю перевірку, зважаючи на те, що деякі стануть тестувати й тим більше застосовувати альтернативну цифрову валюту?

У такий спосіб члени спільноти, які хотіли би протестувати новий алгоритм анонімізації, смарт-контрактів або механізм досягнення консенсусу з високою пропускною здатністю й низькими комісіями, могли б використовувати наявні біткоіни в другорядній обліковій системі з можливістю їх повернення в основну. Ідеї, запропоновані й розвинені в проєктах зі створення сайдчейнів, справили великий вплив на майбутнє Bitcoin, але наразі ще не увійшли в ужиток, тому що, знову-таки, розробники прагнули створювати власні незалежні валюти.

Принцип роботи sidechain у реальному світі дуже віддалено можна порівняти з використанням євро або долара в державах, де ці валюти не емітуються. Їхні уряди не мають у цьому разі можливості друкувати гроші, але можуть здійснювати підтвердження транзакцій і вести свій внутрішній облік. Як приклад, для євро такою країною є Чорногорія, а для долара – Панама.

_Sidechain_ – окремий ланцюжок блоків, до якого додаються транзакції з монетами, отриманими з головного ланцюжка (_mainchain_), як зображено на рис. 4.1. Правила роботи в ньому можуть відрізнятися від правил в mainchain і визначатися новим протоколом (наприклад, може бути інший алгоритм досягнення консенсусу, інша структура транзакції тощо. Sidechain не має своєї власної валюти, але реалізує механізм перенесення цінності з основного ланцюжка блоків. Sidechain застосовується для реалізації нових правил обліку монет (розширення сценаріїв, смарт-контрактів) або для тестування нових технологій (алгоритми підпису, модель транзакцій). Відзначмо, що sidechain може бути _активним_ (_active_) і _неактивним_ (_inactive_). Про активний стан говорять, коли sidechain підтримується деякою спільнотою валідаторів. Коли учасники перестають брати участь у прийнятті рішень і підтверджувати транзакції, sidechain вважається неактивним (рис. 4.1).

<img width="50%" alt="Рисунок 4.1 – Будова sidechains" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.1-Sidechains-structure.png"/> 

Уперше ідею sidechain запропонував Gregory Maxwell. Першим документом, де була описана ця ідея, є «Enabling Blockchain Innovations with Pegged Sidechains» [37], що опубліковала 22 жовтня 2014 року група авторів, одним із яких є Adam Back. Ще одна відома праця під назвою «Sidechains not a direct means for solving any of the scaling problems Bitcoin has» була опублікована 13 червня 2015 року за авторством Pieter Wuille [72]. 14 червня 2015 року Gregory Maxwell випустив роботу «Security limitations of pegged chains».

### One-way peg и two-way peg sidechains

Прив’язка _sidechain_ до _mainchain_ для перенесення цінності може бути двох типів: _one-way peg_ або _two-way peg_. За використання one-way peg цифрові активи може бути перенесено тільки в одному напрямку – з ланцюжка блоків основної облікової системи в ланцюжок другорядної. Потреба в односторонньому перенесенні активів трапляється рідко, тому детально розглянемо інший варіант. У разі two-way peg цифрові активи можуть переноситися в обох напрямках.

Є декілька варіантів реалізації two-way peg, і найпоширеніші – _federated sidechains_ і _merged-mined sidechains_. Принцип роботи sidechain з two-way peg полягає в такому. Користувач спочатку повинен відправити свої активи на спеціальну адресу основної облікової системи, щоби заблокувати можливість витрати цих активів в mainchain. Після цього користувач підтверджує потрібну транзакцію в мережі sidechain. Так вузли, що обробляють блоки sidechain, дізнаються, що конкретні монети основної облікової системи були заморожені. Це дозволяє валідаторам sidechain випустити еквівалентну кількість монет у другорядній обліковій системі на адресу, відповідну до відкритого ключа користувача, який він використовував в основний обліковій системі. Далі користувач може розпоряджатися своєю цінністю вже за новими правилами.

Щоби перенести облік цифрових активів з sidechain назад в mainchain, користувач подібним чином повинен заморозити свої активи в другорядній обліковій системі й надати докази валідатору основної облікової системи. Вони перевіряють, що монети дійсно заморожені і відповідна цінність заблокована (або знищена), і розморожують еквівалентну кількість монет в mainchain, відправляючи їх на адресу користувача.

Припустимо, Аліса й Боб – користувачі облікової системи Bitcoin (рис. 4.2). Аліса володіє певною кількістю біткоінів і збирається відправити їх Бобу, але зі своїх причин не може цього зробити в самому mainchain. Тоді вона створює транзакцію, яка заморожує певну кількість біткоінів в mainchain, і створює іншу транзакцію в sidechain, завдяки якій створюється еквівалентна цінність всередині sidechain, якою Аліса може розпоряджатися. Коли валідатори в mainchain підтвердять транзакцію заморозки, валідатори sidechain отримають докази, що кошти заморожені в mainchain, і підтвердять транзакцію в sidechain.

<img width="50%" alt="Рисунок 4.2 – Передача цінності з основного ланцюжка до sidechain" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.2-Transferring-value-from-the-mainchain-to-a-sidechain.png"/> 

Уявімо, що Аліса відправила монети Бобу до sidechain, але Боб захотів витратити їх в mainchain. Для цього він створює транзакцію, що блокує монети, в sidechain, а іншу транзакцію в mainchain, тобто в облікову систему Bitcoin, про намір перевести монети з sidechain. Після отримання доказів того, що монети в sidechain заморожені, транзакція в Bitcoin підтверджується, і монети з’являються на рахунку Боба. Так це працює в найзагальнішому випадку.

Найбільш складною є проблема реалізації взаємодії валідаторів основної мережі з валідаторами в мережі sidechain для успішної заморозки й розморожування активів. Саме в способах вирішення цієї проблеми й полягає основна відмінність між federated і merged-mined sidechains.

### Federated sidechains

Federated sidechains використовують multiSig-адреси для блокування активів в mainchain. Для цього творцями sidechain вибираються члени федерації – довірені особи, які визначають, коли монети, які використовуються користувачем, заморожуються і звільняються (рис. 4.3). Для цього вони використовують спеціальні адреси й контракти на основі мультипідпису. Надійність цього підходу залежить від імовірності зловмисної змови членів федерації.

<img width="50%" alt="Рисунок 4.3 – Будова federated sidechains" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.3-Federated-sidechains-structure.png"/> 

Такий підхід не вимагає змін у протоколі mainchain. Якщо станеться атака на sidechain або його робота буде скомпрометована, то на стані mainchain це не відобразиться, проте це дозволить виявити і врахувати вразливості в протоколі, за яким працює sidechain. Для цього підходу вже є практична реалізація, mainchain якої є блокчейн Bitcoin.

### Merged-mined sidechains

Merged-mined sidechain використовує технологію merged mining, яка дозволяє використовувати розв’язок тієї самої задачі PoW для формування блоків в основному й додатковому ланцюгах блоків. Принцип роботи цієї технології має такі особливості. У процесі створення нових блоків валідатор спочатку формує блок для альтернативного ланцюга, що використовує merged mining. Заголовок цього блоку поміщається у свій новий блок для mainchain. Далі, для нового блоку mainchain розв’язує задачу PoW. Якщо валідатор знаходить рішення, яке задовольняє складності в mainchain, то цей блок поширюється серед вузлів mainchain. Дані заголовка блоку для sidechain ігноруються іншими учасниками mainchain. Якщо знайдене рішення задовольняє складності в sidechain, тоді в новому блоці для sidechain вказується заголовок нового блоку для mainchain і його coinbase-транзакція разом з SPV-proof. Перевірка такого PoW виконується за правилами протоколу для sidechain, які передбачають можливість прийняття розв’язку задачі PoW для mainchain, якщо алгоритм гешування збігається й розв’язок задачі задовольняє складності в sidechain.

Для реалізації такого підходу в скриптовій мові, що використовується в mainchain, потрібно існування операції, подібної OP_COUNT_ACKS, як в Bitcoin. Ця операція пов’язана з перевіркою додаткових умов, які надходять із зовнішньої облікової системи, для розморожування активів в mainchain. Дані з sidechain через merged mining потрапляють в mainchain блок, а валідатори mainchain потрапляють на цю операцію й перевіряють відповідні дані згідно з правилами протоколу mainchain. Якщо монети дозволяється витратити, то вони розморожуються в основний обліковій системі. Надійність такого підходу залежить від володільців більшості обчислювальної потужності. Щоби дана операція була додана в протокол основної облікової системи, необхідно провести softfork (рис 4.4).

<img width="50%" alt="Рисунок 4.4 – Будова merged-mined sidechains" src="/resources/img/volume-2/4.1-Sidechains-mechanism/Figure-4.4-The-structure-of-merged-mined-sidechains.png"/> 

Одним із важливих компонентів sidechain є метод SPV (докладніше був описаний у першій частині навчального посібника та в розділі 2.3), який дозволяє впевнитися в підтвердженності певних транзакцій, не завантажуючи весь ланцюжок блоків.

SPV-вузли в Bitcoin потрібні валідаторам другорядної облікової системи, щоби перевірити, що монети в Bitcoin заблоковані. Ці дані є підставою для валідаторів прийняти рішення про розблокування еквівалентної кількості монет в sidechain.

Нагадаємо, що спрощена перевірка передбачає наявність списку заголовків блоків, які доводять виконання роботи proof-of-work і той факт, що невитрачене вихід був створений в одному з блоків списку. Але для роботи в sidechain доказ (SPV-proof) має бути досить маленьким, щоби мати можливість бути записаним в одну coinbase-транзакцію. Будь-який валідатор, маючи SPV-докази, може переконатися в підтвердження транзакції, не виконуючи верифікацію кожного блоку заново.

На сьогодні уже є проєкти, які використовують sidechain. Наприклад, компанія Blockstream розробила свій sidechain для проєкту Liquid, мета якого прискорити трансфери між біржами. Компанія Rootstock розробила sidechain, який використовує merged mining, для управління біткоінами за допомогою смарт-контрактів, написаних на мові Solidity.

Таким чином, sidechain дозволяє розробникам не тільки тестувати нові реалізації або зміни протоколу перед їх активацією, а й реалізовувати нові інструменти для роботи з наявною валютою. Є думка, що за використання надійних механізмів прив’язки (two-way peg) технологія sidechain значно розвантажить основну мережу й дозволить обслуговувати основну частину користувачів у межах облікових систем, які пов’язані з основною й працюють паралельно. У цьому разі технологія може вирішити проблему надмірного навантаження, обробляючи певні типи транзакцій в окремих облікових системах і зберігаючи основні принципи децентралізації.

### Недоліки sidechains

Для реалізації надійної взаємодії на мережевому рівні величезну складність представляє наявність декількох децентралізованих облікових систем, що підтримують трансфери між собою. Вони повинні підтримувати скрипти транзакцій, які пізніше можуть виявитися не валідними через подальшу зміну доказів. Це тягне за собою необхідність мати ПЗ, яке зможе виявити потенційні атаки та блокувати їх. Потрібно також врахувати, що конфігурація ПЗ гаманця повинна бути змінена для підтримки декількох ланцюжків блоків.

У разі two-way peg sidechain, який використовує SPV-proofs, перенесення цінності з основної облікової системи на другорядну й назад є менш безпечним, у порівнянні з платежами в рамках однієї облікової системи. Адже одержувач має підтвердження від валідатора, який перевірив тільки SPV-доказ. Що стосується самої цінності, то монети можуть переноситися в будь-якому співвідношенні і з будь-яким коефіцієнтом (наприклад, 1:1, 1:10 або 1:100).

### Підсумки

Застосування підходу sidechain дозволяє додати альтернативні правила обліку наявних монет. Незручність полягає в тому, що для використання альтернативних правил обліку користувачу здебільшого необхідно підтримувати два повних вузли: один для основної облікової системи, другий – для додаткової.

Утім, цінність застосування підходу sidechain у тому, що він пропонує механізм, за допомогою якого можна впроваджувати нові технології, не наражаючи на ризик основну облікову систему. Найімовірніше, надалі це дозволить знайти рішення багатьох проблем, зокрема недостатньої пропускної здатності облікової системи.

## 4.2 Будова Lightning Network

У попередній частині навчального посібника ми почали розглядати концепцію під назвою Lightning Network. Зараз ми детальніше розглянемо, як саме працює ця концепція і за рахунок чого досягається можливість сторін не довіряти один одному.

### Будова двоспрямованого платіжного каналу

Для розуміння Lightning Network (LN) необхідно попереднє розуміння влаштування двоспрямованих платіжних каналів. Фактично LN формується за рахунок комутації таких каналів між собою.

Основна перевага двоспрямованих каналів полягає в тому, що учасники можуть передавати монети в обидві сторони, при цьому не довіряючи один одному і не транслюючи проміжні транзакції до мережі. Якщо одна зі сторін спробує зшахраювати, то згідно з протоколом вона втрачає всі свої монети. Важливо відзначити, що водночас не потрібне жодне втручання третьої сторони: протокол на основі криптографічних доказів дозволяє покарати зловмисника.

У разі використання платіжного каналу такого типу, сторони, що взаємодіють, можуть обмінюватися монетами один з одним необмежену кількість разів. При цьому в мережу буде необхідно публікувати тільки дві транзакції: _funding_, яка блокує монети в мережі і відкриває канал, і _refunding_, яка повертає монети сторонам по результату взаємодії між ними. В даному випадку може бути 3 сценарії розблокування монет учасників каналу, які будуть розглянуті далі.

У загальному вигляді схему функціонування платіжного каналу можна подати, як на рисунку 4.5.

<img width="50%" alt="Рисунок 4.5 – Схема роботи двоспрямованого платіжного каналу" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.5-Bidirectional-payment-channel-scheme.png"/> 

> **Увага!** *Виглядає досить громіздко, складно та жахливо, проте нижче ми розглянемо кожен крок взаємодії і детально опишемо, що насправді відбувається, у такий спосіб, що наприкінці розділу читач повністю розумітиме, як працюють двоспрямовані платіжні канали в Lightning Network.*

### Відкриття платіжного каналу

Для відкриття платіжного каналу Аліса і Боб зв'язуються між собою (взаємодія в рамках мережі lightning-вузлів) і обмінюються відкритими ключами для створення multisig-адреси. Також сторони обмінюються посиланнями на невитрачені виходи з монетами, які хочуть заблокувати в спільному каналі. Після цього одна з сторін формує транзакцію, входи якої посилаються на згадані невитрачені виходи. В вихід нової транзакції додається сформована multisig адреса. У нашому прикладі Аліса і Боб спочатку мають по 5 BTC, а вихід транзакції містить суму в 10 BTC (рис. 4.6).

<img width="40%" alt="Рисунок 4.6 – Схема формування транзакції для відкриття каналу" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.6-Channel-opening-and-transaction-generation-scheme.png"/> 

Це і є funding транзакцією, яку сторони повинні відправити до мережі для відкриття платіжного каналу. В цьому випадку транзакція повинна бути підписана власниками обох входів. Це означає, що кожна сторона доводить володіння своїм входом і повідомляє, що готова витратити монети на вказану multisig-адресу.

> **_Зауваження._** *Необхідно відзначити один важливий момент. Після підтвердження такої транзакції, в разі, якщо одна зі сторін припиняє взаємодію (з якої-небудь причини не підписує витрату монет з спільної адреси), то обидві сторони втрачають свої монети. Однак така поведінка не буде вигідною жодній зі сторін, так як це не дозволяє заволодіти чужими монетами і призводить до втрати своїх..*

До впровадження Segregated Witness така проблема могла вирішуватися тільки шляхом завдання додаткових умов: якщо монети не будуть витрачені з multisig-адреси, то через деякий час сторони можуть їх розблокувати, використовуючи тільки свої особисті ключі. Однак такий підхід, по-перше, обмежує час життя каналу, а по-друге, сторони повинні довго чекати, поки монети стануть доступними для розблокування (зазвичай платіжний канал відкривається на тривалий час).

Segregated Witness дозволив же вирішити цю задачу більш витончено, шляхом усунення transaction malleability (segwit дозволяє не включати значення підпису в tx_id, за рахунок чого можна будувати ланцюжок непідтверджених транзакцій). Тепер сторони можуть створити multisig транзакцію, але не підписувати її до того моменту поки не будуть сформовані транзакції, що розподіляють монети в каналі назад до їх власників.

Тому Алісі і Бобу необхідно створити першу транзакцію в каналі, яка буде виплачувати монети назад їх власникам. Але перед цим кожна сторона повинна згенерувати випадковий секрет і передати його геш-значення іншій стороні (рис. 4.7).

<img width="40%" alt="Рисунок 4.7 – Схема генерації секретів і обмін геш-значеннями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.7-Secrets-generation-and-hash-values-exchange-scheme.png"/> 

Після цього Аліса і Боб формують по одній транзакції (рис. 4.8), які витрачають монети з multisig адреси наступним чином:

1. Аліса формує транзакцію, перший вихід якої містить 5 монет і може бути витрачений за допомогою особистого ключа Аліси, а другий вихід містить 5 монет, що залишилися і дві взаємовиключні умови витрати: або після певного часу (наприклад через 100 блоків після підтвердження цієї транзакції) Боб може витратити за допомогою свого особистого ключа, або Аліса може витратити відразу за допомогою свого особистого ключа і секрету, який згенерував Боб (так як в умову включено геш-значення, отримане від Боба).
2. Боб формує транзакцію з такими ж вихідними сумами, але протилежними умовами витрати: перший вихід може витратити Боб за допомогою свого особистого ключа, а другий вихід з двома взаємовиключними умовами: або може витратити Аліса за допомогою свого особистого ключа після 100 блоків, або може витратити Боб за допомогою свого особистого ключа і секрету, згенерованого Алісою.

<img width="50%" alt="Рисунок 4.8 – Формування та обмін commitment-транзакціями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.8-Commitment-transaction-generation-and-exchange.png"/> 

Після цього, кожен учасник каналу підписує транзакцію (додає один з двох необхідних підписів), яку сам сформував і відправляє її другій стороні. Далі кожен з учасників каналу перевіряє транзакцію, отриману від свого контрагента. Якщо на даному етапі все вірно, то платіжний канал вважається готовим для здійснення внутрішніх платежів і може бути відправлена ​​в мережу перша транзакція, яка платить на multisig-адресу (перша сформована транзакція). Так як для підтвердження кожної з refunding транзакцій необхідно, щоб обидві сторони її підписали, то фактично вже на даному етапі може статися закриття каналу (шляхом підписання транзакції другою стороною та поширення її до мережі).

Якщо Аліса допідпише і опублікує транзакцію, яку вона отримала від Боба, то в цьому випадку перший вихід відразу відправить 5 монет Бобу, а другий Алісі, але вже після 100 блоків з моменту її підтвердження (Боб не зможе забрати монети з другого виходу, так як він не знає секрет Аліси).

Коли Боб підпише і опублікує транзакцію отриману від Аліси, відбудеться точно така ж ситуація: Аліса відразу отримає свої 5 монет, а Боб отримає свої по закінченні 100 блоків.

У підсумку, якщо на даному етапі хоча б одна зі сторін опублікує транзакцію, то монети відправляться їх власникам і канал буде закритий. Як ми розглянули – жодна зі сторін не зможе шахраювати і забрати монети іншої сторони (це можна зробити, тільки якщо одна зі сторін опублікує транзакцію в мережі, а потім розкриє і власний секрет).

### Передача монет в рамках каналу

Після того як канал відкритий і створені транзакції повертають монети користувачам, Аліса і Боб можуть передавати монети в рамках каналу. Давайте розглянемо яким чином це відбувається.

Перший етап полягає в генерації нового секрету і передачі його геш-значення контрагенту (як і в разі формування першої в каналі транзакції).

Після цього кожна зі сторін формує нову транзакцію в каналі, проте вже з іншим розподілом монет між сторонами. Наприклад, Аліса вирішила заплатити 2 BTC Бобу. У цьому випадку, після того як сторони обмінялися геш-значенням згенерованого секрету, вони формують такі транзакції:

1. Аліса формує транзакцію, перший вихід якої переводить 3 монети на адресу Аліси, а другий вихід знову містить дві умови витрати 7 залишившихся монет: або Бобу після певного часу, або Алісі, але тільки в тому випадку, якщо вона знає секрет, що згенерував Боб на другому етапі.
2. Боб формує таку ж транзакцію, проте в першому виході 7 монет відправляються Бобу, а в другому Алісі після 100 блоків або Бобу, коли він дізнається секрет Аліси (рис. 4.9).

<img width="50%" alt="Рисунок 4.9 – Формування та обмін альтернативними commitment-транзакціями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.9-Creating-and-exchanging-alternative-commitment-transactions.png"/> 

Після того, як ці транзакції сформовані, учасники каналу обмінюються ними. Потім кожна з цих транзакцій може бути допідписана і відправлена до мережі для підтвердження, вслід за чим канал буде закритий. Таким чином сторони можуть проводити нескінченну кількість платежів між собою в рамках каналу шляхом створення нового секрету і формування нової транзакції для кожного платежу.

Відзначимо, що після обміну такими транзакціями, попередній стан refunding транзакцій в каналі також може бути опубліковано. Тому в цей момент часу сторони мають два способи закриття каналу. Щоб забезпечити незворотність стану каналу (щоб тільки останній стан вважався дійсним), сторони обмінюються секретами, що вони згенерували на першому етапі. Отримання цих значень контрагентами не надає їм можливість шахраювати на даному етапі, але дозволяє в подальшому забрати всі монети сторони, яка намагається шахраювати. Тому Аліса передає Бобу перший згенерований секрет, а Боб свій – Алісі. Після цього кожен з них перевіряє чи відповідає цей секрет геш-значенню, доданому в першу, в рамках каналу, транзакцію.

### Механізм штрафування за шахрайство в каналі

Двоспрямовані платіжні канали такого типу припускають, що сторона, яка намагається шахраювати, втрачає всі монети, які вона помістила до каналу. Тепер розглянемо яким чином забезпечується даний механізм.

Для прикладу візьмемо ситуацію, яку розглядали раніше: Аліса з Бобом помістили по 5 монет до платіжного каналу, після чого створили транзакції, які повертають монети на адреси учасників каналу (по 5 на кожен). Після цього Аліса провела платіж на 2 монети, і, відповідно, розподіл в каналі змінився. Уявімо цей етап взаємодії на схемі, яку використовували раніше (рис. 4.10).

<img width="50%" alt="Рисунок 4.10 – Схема відкриття платіжного каналу і здійснення першого платежу" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.10-Opening-the-payment-channel-and-executing-the-first-payment.png"/> 

Остаточні транзакції розподілу мають на увазі, що після його закриття каналу 3 монети відправляться Алісі, а 7 – Бобу. Але що заважає Алісі відправити першу транзакцію в каналі, в результаті виконання якої вона отримує 5 монет?

Справа в тому, що з метою розподілити монети порівну між сторонами, може бути допідписана і відправлена ​​в мережу одна з двох транзакцій: або з боку Боба, або з боку Аліси. Бобу немає сенсу допідписувати і відправляти транзакцію, що в нього зберігається, так як ця транзакція нечесна по відношенню до нього (тим більше, якщо він це зробить, то втратить всі свої монети в каналі). Щоб розподілити монети порівну, Аліса може підписати і відправити транзакцію, зображену на малюнку 4.11:

<img width="40%" alt="Рисунок 4.11 – Commitment-транзакція, яку може опублікувати Аліса" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.11-Commitment-transaction-that-Alice-can-publish.png"/> 

Тепер розглянемо, що відбудеться, якщо дана транзакція буде відправлена ​​в мережу. Як тільки ця транзакція підтверджується, Боб відразу отримує доступ до монет на першому виході. Другий вихід може бути розблоковано лише в разі, якщо Аліса дочекається підтвердження 100 блоків або, якщо Боб знає секрет Аліси, сформований на першому етапі. Ось тут і криється механізм захисту від шахрайства: Аліса публікує свій секрет після того, як сторони домовилися про новий розподіл в каналі, а так як в каналі вже з'являлася транзакція, що розподіляє 3 монети Алісі і 7 – Бобу, то Аліса вже опублікувала своє секретне значення, за допомогою якого можна отримати доступ до решти 5 монет першої транзакції. Так як Боб знає секретне значення, він використовує його разом зі своїм особистим ключем для отримання решти 5 монет. Як результат – він забирає всі монети в каналі.

Тому, після того як сторони домовилися про новий стан розподілу цінності в каналі, попередній стан не може бути опубліковано, так як сторона, яка допідпише та відправить попередню транзакцію до мережі, просто втрачає всі свої монети в каналі.

### Закриття платіжного каналу

Ми розглянули, як створюється платіжний канал, яким чином відбуваються платежі і як працює механізм захисту від шахрайства. Тепер розглянемо, яким чином безпечно закрити використовуваний канал.

Знову ж, припустимо ми маємо стан останніх транзакцій в каналі (з боку Аліси і з боку Боба), які передають 3 монети Алісі і 7 Бобу. Канал в цьому випадку може бути закритий трьома способами (рис. 4.12).

<img width="50%" alt="Рисунок 4.12 – Схема варіантів закриття платіжного каналу" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.12-Payment-channel-closing-scheme.png"/> 

Перший спосіб закриття каналу – Аліса допідпише й опублікує свою останню транзакцію в каналі. Давайте розглянемо цю транзакцію і що станеться після її публікації (рис. 4.13).

<img width="40%" alt="Рисунок 4.13 – Commitment-транзакція, яку публікує Аліса" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.13-Commitment-transaction-published-by-Alice.png"/> 

Після підтвердження такої транзакції у мережі, Боб відразу отримує доступ до свого виходу на 7 монет. Другий вихід доступний Алісі після підтвердження 100 додаткових блоків або Бобу, якщо він знає секрет Аліси. Однак в цьому випадку, так як це остання транзакція в каналі, Аліса не розкривала свій секрет і Боб не може отримати монети цього виходу. Єдиним недоліком такого підходу є великий проміжок часу, після якого Аліса зможе скористатися своїми монетами.

Другий спосіб закриття каналу аналогічний першому, але припускає, що вже не Аліса, а Боб відправить refunding транзакцію (рис. 4.14). У цьому випадку вихід Аліси відразу стає доступним їй, а Боб зможе забрати свої монети після проходження 100 блоків.

<img width="40%" alt="Рисунок 4.14 – Commitment-транзакція, яку публікує Боб" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.14-Commitment-transaction-published-by-Bob.png"/> 

Однак існує і третій спосіб закриття каналу, при якому сторони відразу отримують доступ до своїх монет. Для цього вони спільно формують транзакцію, яка витрачає монети з multisig адреси на два виходи, один з яких належить тільки Алісі, а другий тільки Бобу. Після того як вони підписують таку транзакцію і публікують її до мережі, вони відразу отримують доступ до своїх виходів.

### Як Lightning Network використовує платіжні канали?

Ми повністю розібралися, як працюють двоспрямовані платіжні канали. Настав час пояснити, як цей підхід використовується в Lightning Network.

Щоб зрозуміти, навіщо взагалі потрібна концепція Lightning Network, розглянемо ситуацію, за якої Аліса хоче передати монети Керол, з якою вона не має відкритого платіжного каналу. Найпростішим способом є відкриття такого, однак це може бути не ефективно з низки причин (наприклад, це одноразовий мікроплатежів і Аліса не хоче платити комісію як за звичайну транзакцію, так за відкриття і подальше закриття каналу).

Однак раптом виявляється, що у Аліси і у Керол є відкриті канали з Бобом. Цими каналами вони і можуть скористатися і фактично передати монети через Боба (рис. 4.15).

<img width="40%" alt="Рисунок 4.15 – Передача монет через кілька каналів" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.15-Transferring-coins-through-several-channels.png"/> 

Основним завданням при цьому є забезпечення того, щоб Боб не міг вкрасти монети під час проходження їх через його канали. Це завдання і вирішує Lightning Network за допомогою комутації та модифікації механізму двоспрямованих платіжних каналів. Розглянемо ж як LN працює.

Як і в попередньому випадку, уявімо повну схему роботи на малюнку 4.16, а потім розглянемо всі компоненти цієї схеми і зберемо повну картину того, як працює Lightning Network.

<img width="50%" alt="Рисунок 4.16 –  Схема функціонування Lightning Network" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.16-Lightning-Network-operation-scheme.png"/> 

_Виглядає ще складніше за будову платіжних каналів, однак запевняємо, що якщо ви розібралися з матеріалом вище, то розуміння будови Lightning Network не становитиме жодних складнощів._

Щоб мати можливість передати монети від Аліси Керол, необхідні платіжні канали між Алісою і Бобом, а також між Бобом і Керол повинні існувати. Тому першим кроком є ​​створення цих самих каналів (відзначимо, що на рисунку 4.17 зображено створення каналів в один момент часу, насправді ці канали можуть бути створені задовго до проведення необхідного платежу; створення одного каналу ніяким чином не залежить від іншого).

<img width="50%" alt="Рисунок 4.17 – Відкриття двох незалежних каналів" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.17-Opening-two-independent-channels.png"/> 

Фактично, відбувається процес створення двоспрямованих платіжних каналів, який ми описували раніше. Спочатку створюються multisig адреси, на які сторони відправляють монети за допомогою on-chain транзакції. Далі сторони генерують між собою секрети і обмінюються геш-значеннями цих секретів. Після цього формуються refunding транзакції, які розподіляють монети з multisig адрес на адреси контрагентів. Кожна з цих транзакцій підписується стороною, яка її сформувала і передається контрагенту. За підсумком взаємодії (публікації транзакції на multisig) створюються два канали: один між Алісою і Бобом, а другий між Бобом і Керол. Отже, поки що нічого нового, сторони можуть проводити платежі тільки в рамках встановлених каналів.

Тепер розглянемо, як відбувається передача монет двома каналами через посередника. Очевидно, що якщо Аліса просто переведе монети в рамках свого каналу, то їй потрібно буде довіряти, що Боб в рамках каналу з Керол також виконає аналогічну передачу. Якщо ж Боб спочатку переведе монети Керол, то він повинен довіряти Алісі, що вона поверне йому монети в рамках встановлених між ними каналами. Очевидно, що кожен з цих підходів вимагає довіри хоча б одній стороні.

Lightning Network дозволяє провести дійсно trustless передачу монет. Для цього спочатку одержувач монет (тобто Керол) генерує новий секрет і передає його геш-значення Алісі (рис. 4.18). При цьому вона просить Алісу передати монету Бобу тільки в тому випадку, якщо він доведе, що дізнався секрет згенерований Керол.

<img width="50%" alt="Рисунок 4.18 – Передача геш-значення секрету від одержувача до відправника монет" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.18-Transfer-of-the-hash-value-from-the-sender-to-recipient.png"/> 

Після того як Аліса отримує геш-значення секрету, вони спільно з Бобом змінюють стан refunding транзакцій в своєму каналі. Для цього вони генерують нові секрети і обмінюються їх геш-значеннями. Далі кожен з них створює нову транзакцію, підписує її та передає контрагенту як на рисунку 4.19.

У транзакції Аліси зазначено, що після її підтвердження:

1. Перший вихід відразу переводить 4 монети на адресу Аліси. 
2. Другий вихід на 5 монет може бути витрачений Бобом після 100 блоків з моменту підтвердження транзакції або Алісою, якщо вона дізнається секрет Боба. 
3. Додається третій вихід на одну монету, який може бути витрачений в трьох випадках: Бобом після 100 блоків і якщо він знає секрет, який Керол згенерувала для передачі монет; Алісою, якщо вона знає секрет, що згенерував Бобом перед формуванням транзакції; Алісою, після певного часу з моменту підтвердження транзакції (як приклад візьмемо це значення рівне 24 годинам).

Транзакція, яку сформував Боб, аналогічна транзакції Аліси, за винятком деяких змін:

1. Перший вихід платить 5 монет на адресу Боба.
2. Другий вихід на 4 монети може бути витрачений Алісою після 100 блоків або Бобом, якщо він дізнався секрет Аліси.
3. Третій вихід також містить три умови витрати монет: Бобу, якщо він знає секрет, що згенерував Керол; Бобу, якщо він знає секрет Аліси; Алісі після 24 годин (які включають в себе timelock на 100 блоків).

<img width="40%" alt="Рисунок 4.19 – Обмін новими refunding транзакціями" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.19-Exchange-of-new-refunding-transactions.png"/> 

Після того як кожна з транзакцій була передана іншій стороні й опубліковані секрети для відміни попереднього стану, сторони можуть опублікувати транзакції в мережу і тим самим закрити канал. Якщо отриману транзакцію допідпише і відправить до мережі Боб (рис. 4.20), то перший вихід відразу може бути витрачений Алісою. Так як Аліса не знає секрет, який згенерував Боб, то він отримає доступ до другого виходу після підтвердження 100 блоків. Якщо ж Боб дізнається секрет, який згенерувала Керол, то він по закінченні 100 блоків, отримає доступ і до третього виходу. Якщо ж цей секрет розкритий не буде, то Аліса забере свої монети по закінченню заданого проміжку часу.

<img width="50%" alt="Рисунок 4.20 – Commitment-транзакція, яка може бути відправлена Бобом" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.20-Commitment-transaction-that-Bob-can-send.png"/> 

Якщо ж отриману транзакцію допідпише і відправить до мережі Аліса, то Боб відразу отримує доступ до першого виходу (5 монетам). Другий вихід Аліса зможе розблокувати після 100 блоків (оскільки Боб не знає секрет згенерований Алісою, отримати доступ до другого виходу він не може). Якщо ж Боб розкрив значення Керол (а він міг це зробити, тільки якщо передав їй монети, механізм забезпечення цього ми розглянемо далі), то він може забрати монети з 3 виходу собі. Якщо ж ні, то монети стануть доступні Алісі після закінчення 24 годин (і включених в них 100 блоків). Якщо Аліса не буде шахраювати, то Боб не отримає доступ до її секрету і не зможе забрати монети з третього виходу (рис. 4.21).

<img width="40%" alt="Рисунок 4.21 – Commitment-транзакція, яка може бути відправлена Алісою" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.21-Commitment-transaction-that-Alice-can-send.png"/> 

Незважаючи на те, що ці транзакції можуть бути відразу підтверджені в мережі, сторонам невигідно це робити, позаяк переказ монет від Аліси до Керол не пройде та канал між нею й Бобом буде закритий. Ці дії були необхідні для «блокування» однієї монети в каналі, якою може заволодіти Боб, якщо він дізна́ється секрет.

Тепер розглянемо, як він цей секрет дізнає́ться. Для цього тепер вже взаємодіють Боб і Керол. Вони також оновлюють власні refunding транзакції в каналі. Тобто спочатку вони генерують нові секрети і створюють нові refunding транзакції, використовуючи отримані геш-значення секретів.

У транзакції, яку формує Боб вказується:

1. Перший вихід переводить 4 монети на адресу Боба.
2. Доступ до другого виходу може отримати або Керол після 100 блоків або Боб, якщо дізнається секретне значення Керол, сгенерироване для зміни стану каналу..
3. Доступ до третього виходу і отримання 1 монети може здійснюватися 3 способами: на адресу Керол після 100 блоків, і якщо вона опублікує секретне значення; Бобу, якщо він дізнається секрет Керол (який використовується для зміни стану каналу); або Бобом після закінчення інтервалу часу (припустимо, 12 годин; цей інтервал повинен бути менше, ніж при доступі до монетам Аліси в каналі).

У транзакції Керол:

1. Перший вихід переводить 5 монет на адресу Керол.
2. Доступ до другого виходу може отримати або Боб після 100 блоків або Керол, якщо дізнається секретне значення Боба сгенерированное для зміни стану каналу.
3. Доступ до монети в третьому виході може отримати або Керол, якщо вона опублікує секретне значення, яке згенерувала для отримання монет; або Керол, якщо розголосить секретне значення Боба; або сам Боб після 100 блоків / досягненні значення locktime (рис. 4.22).

<img width="40%" alt="Рисунок 4.22 – Обмін refunding транзакціями між Керол і Бобом" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.22-Carol-and-Bob-exchange-refunding-transactions.png"/> 

Після того як ці транзакції сформовані, Керол і Боб підписують їх і обмінюються між собою. Давайте розглянемо, що відбудеться, якщо один з них спробує опублікувати цей стан refunding транзакції в мережу Bitcoin.

Якщо Керол допідпише і опублікує транзакцію, отриману від Боба, то монети з першого виходу відразу йдуть на адресу Боба. Другий вихід в розмірі 5 монет буде доступний Керол після проходження часу блокування (Боб не зможе його забрати, так як він не знає секретне значення Керол, за допомогою якого можна забрати всі монети). Найбільший інтерес представляє третій вихід. Перший варіант розблокування – Керол після закінчення часу блокування і тільки в тому випадку, якщо вона опублікує свій секрет, за яким закріплена 1 монета. Якщо ж Керол не встигає опублікувати його в зазначений проміжок часу, Боб може забрати ці монети собі. Фактично вважається, що Керол не підтвердила переклад платежу від Аліси. В результаті кожен з учасників каналу отримає свої монети і не зможе забрати монети іншого учасника (рис. 4.23).

<img width="50%" alt="Рисунок 4.23 – Commitment-транзакція, яка може бути відправлена Керол" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.23-Commitment-that-Carol-can-send.png"/> 

Якщо ж Керол все-таки опублікує секретне значення вчасно і забере одну монету, то Боб може скористатися цим секретом для того щоб забрати монети в їх каналі з Алісою (ми описували цей процес, коли розглядали транзакції в каналі Боба і Аліси).

Що ж станеться, якщо refunding транзакція буде відправлена ​​в мережу Бобом, а не Керол? У цьому випадку перший вихід в розмірі 5 монет може бути витрачений тільки Керол. Другий вихід може бути витрачений Бобом після закінчення часу блокування (або Керол, якщо Боб спробує шахраювати). Третій же вихід (рис. 4.24) може бути витрачений Керол, якщо вона розголосить свій секрет, або Бобом після закінчення часу блокування (або, знову ж таки, Керол, але тільки якщо Боб спробує шахраювати).

<img width="40%" alt="Рисунок 4.24 – Commitment-транзакція, яка може бути відправлена Бобом" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.24-Commitment-transaction-that-Bob-can-send.png"/> 

Як і в минулому варіанті (коли транзакція публікується Керол), якщо Керол розголосила свій секрет, Боб може використовувати його, щоб забрати монету в каналі з Алісою. Якщо ж секрет не публікується протягом заданого часу, сторони отримують свої монети назад.

Важлива особливість полягає в тому, що якщо Керол хоче отримати свої монети при розголошенні таємниці, їй немає необхідності публікувати refunding транзакцію в мережу. Вона може просто повідомити секрет Бобу, той в свою чергу повідомить його Алісі, і таким чином сторони можуть домовитися і створити нові refunding транзакції в каналі (рис. 4.25).

<img width="40%" alt="Рисунок 4.25 – Новий розподіл монет в каналах після проходження платежу" src="/resources/img/volume-2/4.2-Lightning-Network-design/Figure-4.25-New-coin-distribution-in-channels-after-the-payment-was-executed.png"/> 

### Переваги та недоліки Lightning Network

Після того як ми розглянули принципи функціонування LN, можемо виокремити ключові переваги цієї технології.

> * _Рішення проблем з пропускною спроможністю облікових систем_
> * _Конфіденційність перекладів учасників каналів_
> * _Економія на комісіях для підтверджень транзакцій_
> * _Запобігання спробам шахраювання_

Основна перевага LN – збільшення пропускної здатності облікових систем. Фактично, пропускна здатність каналів не обмежена і залежить безпосередньо від засобів комунікації користувачів між собою. Користувачі можуть щомиті відправляти платежі один одному і не чекати підтвердження транзакцій валідаторами (за винятком funding і refunding транзакцій).

Друга перевага – конфіденційність переказів між користувачами в каналі. Деталі всіх транзакцій видно тільки сторонам, які беруть в цьому участь. Якщо ви використовуєте тільки платіжний канал, то валідатори мережі бачать лише деталі funding і refunding транзакцій. Деталі всіх інших транзакцій можуть бути приховані. Якщо ж ви використовуєте Lightning Network для передачі монет іншим сторонам, то про транзакції знають всі посередники, через яких ви проводите платежі. При цьому вузли Bitcoin не обробляють ці транзакції і не знають їх деталей (зрозуміло, якщо ніхто з посередників не розкриє деталі транзакцій).

Третя перевага полягає в економії на комісіях. За кожен канал, його учасники в сумі платять комісію лише двічі (за його відкриття і закриття). Решта транзакцій може бути і безкоштовною (в разі Lightning Network комісії можуть бути мінімальними і сплачуватися тільки посередникам за зміну стану каналів).

Остання важлива перевага Lightning Network – запобігання потенційному шахраюванню. Якщо одна зі сторін вирішить зшахраювати, вона може втратити всі свої монети в каналі.

Однак платежі в Lightning Network мають деякі недоліки порівняно з on-chain транзакціями. Ці недоліки пов'язані з тим, що користувачеві, крім підтримки ПЗ повного вузла мережі Bitcoin (або використання довіреного), потрібно ще підтримувати вузол LN.

> * _Складнощі резервного копіювання та перенесення гаманця на інший пристрій_
> * _Необхідність постійної роботи гаманця користувача для відстеження стану каналів через моніторинг on-chain транзакцій_
> * _Неможливість використання опції cold storage wallet_

**Найбільш поширені питання**

*— Чи багато користувачів у Lightning Network?*

Станом на вересень 2019 у Lightning Network близько 4500 вузлів, між якими відкрито понад 32000 каналів. Обсяг заблокованих біткоінів для функціонування Lightning Network дорівнює близько 850 BTC.

## 4.3 Принципи роботи atomic swap і його застосування

За визначенням, власник криптовалюти може (і, найімовірніше, зацікавлений) працювати зі своїми монетами без довіреної сторони, тобто trustless. На практиці ця властивість часто не забезпечується – користувачі довіряють управління ключами централізованому серверу, використовують централізовані біржі для обміну криптовалют тощо. Уявіть собі ситуацію – ви купили собі новий електромобіль: швидкий, комфортний і енергоефективний. Але замість того, щоб користуватися цими перевагами, ви запрягли в автомобіль коня. Звучить досить абсурдно, чи не так? Така ж ситуація виникає, коли користувач, що володіє монетами криптовалюти, довіряє її зберігання деякому сервісу. Погодьтеся, що в цьому випадку частина властивостей криптовалюти зникає, до того ж, користувач вже не є власником монет – він стає власником цифрових зобов'язань: централізованих, цензурованих, неанонімних тощо.

Цілком природно, що багато свідомих користувачів все таки використовують властивості криптовалюти за призначенням. Такі користувачі хочуть безпосередньо керувати монетами, саме trustless чином. Традиційні централізовані біржі не можуть задовольнити цим вимогам. Тому виникла потреба в інструменті, що дозволяє підтримувати властивості криптовалюти при обміні монет різних облікових систем. Таким інструментом став atomic swap.

У цьому розділі будуть описані особливості функціонування атомарного обміну, актуальність цього механізму, вимоги до цифрових валют для його роботи. Крім того, ми торкнемося технології децентралізованих бірж, а також розглянемо їх основні переваги та недоліки.

### Як працюють централізовані біржі?

Централізований підхід передбачає, що користувач повинен довіряти свої гроші сервісу. При такому підході користувач відправляє свої монети на баланс біржі, а вона повинна виконати свої зобов'язання по поверненню грошового еквівалента в іншій валюті. Так чи інакше, гроші весь цей час знаходяться під управлінням біржі, а у користувача є тільки її зобов'язання по поверненню коштів. Також передбачається, що централізована біржа не здійснює платежів як таких, а лише перезаписує баланси користувачів (рис. 4.26).

<img width="50%" alt="Рисунок 4.26 – Схема функціонування централізованої біржі" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.26-Centralized-exchange-operation-scheme.png"/> 

Для здійснення обміну Аліса реєструється на біржі і виставляє _order_ на покупку певної кількості монет певної криптовалюти. Боб, який вже зареєстрований на цій біржі, бачить order і, якщо його влаштовує ціна, погоджується на нього. Баланси акаунтів на цій біржі у Боба і Аліси змінюються. Після цього вони можуть вивести гроші на свої гаманці.

> **_Зауваження._** *Order – це замовлення на купівлю цифрового активу. У ньому вказується кількість монет, що купуються, валюта, за яку вони будуть придбані, і бажана ціна.*

У цій ситуації і Аліса, і Боб довіряють біржі. Точніше, вони довіряють персоналу біржі, що ті виконають свої зобов'язання за будь-яких обставин, а не заберуть гроші і не зникнуть з ними. Під обставинами, в тому числі, маються на увазі інженери, які проектували і розробляли біржу, а також фахівці, які забезпечують захист від шахраїв. Останнє особливо актуально, так як хакерам немає необхідності витрачати багато часу і сил на проведення атаки на окремих користувачів (і отримувати з цього відносно невелику вигоду), якщо існують централізовані біржі, які зберігають монети тисяч користувачів в одному місці (навіщо грабувати окремо людей, якщо можна пограбувати банк). Тому такі атаки вельми часті і періодично досить успішні (рис. 4.27).

<img width="40%" alt="Рисунок 4.27 – Історія крадіжок монет із централізованих бірж" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.27-The-history-of-stolen-coins-from-centralized-exchanges.png"/> 

Цікавим також є випадок, який стався з централізованої біржею Quadriga CX. Проблема в тому, що всі монети користувачів (близько $200 млн) зберігалися на холодних гаманцях, доступ до яких був втрачений разом зі смертю головного виконавчого директора біржі. Ця ситуація доводить, що загроза втрати монет централізованими сховищами дуже актуальна, а в результаті однієї проблеми страждає одночасно багато користувачів.

### Ідея atomic swaps і вимоги до облікової системи

_Atomic swaps_ пропонує концепцію обміну цифрових активів між собою таким чином, що обмін буде проходити або нерозривно, або взагалі не буде виконаний. Такий підхід дозволяє зробити обмін, навіть якщо користувачі не довіряють один одному і при цьому не використовувати третю сторону в якості посередника.

Щоб дві різні облікові системи могли успішно підтримувати між собою atomic swap, вони повинні задовольняти деяким фундаментальним вимогам.

> **Вимоги для підтримки atomic swap**
>> * _Можливість створення контрактів з блокуванням по часу_
>> * _Підтримка однакової геш-функції для блокування монет_
>> * _Off-chain канал між учасниками обміну_

Основна вимога полягає в можливості створення смарт-контракту з блокуванням монет за часом, за використання якого один із учасників обміну не зможе забрати всі монети собі (далі ми розглянемо, як саме це працює).

Крім того, для здійснення транзакції між двома різними обліковими системами необхідно, щоб обидві вони могли використовувати одну і ту ж криптографічну геш-функцію в завданні умов витрати монет (наприклад, SHA-256). Це необхідно, щоб контракт виконувався коректно, коли користувач надасть результат виконання геш-функції.

Також для успішного здійснення atomic swap необхідна наявність off-chain каналу зв'язку, за яким користувачі повинні обговорити умови обміну.

### Принципи роботи atomic swaps

Давайте детально розглянемо, як працюють atomic swaps. Припустимо, що Аліса і Боб захотіли обмінятися монетами між собою, наприклад, 2 BTC на 44 LTC. Спочатку необхідно переконатися в тому, що між Bitcoin і Litecoin можливе проведення atomic swaps. Так як обидві системи підтримують контракти з блокуванням по часу і загальні геш-функції (візьмемо для прикладу SHA-256), то такий обмін можливий.

Спочатку Аліса і Боб генерують адреси, на які вони хочуть отримати монети, і обмінюються цими адресами між собою (рис. 4.28). Разом з обміном адресами, користувачі домовляються про умови обміну. Відзначимо, що на цьому етапі їх взаємодія відбувається off-chain.

<img width="50%" alt="Рисунок 4.28 – Обмін учасниками адресами в облікових системах" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.28-Participants-exchange-their-addresses-in-accounting-systems.png"/> 

Після цього відбувається формування транзакцій, в яких проводиться передача цінностей взаємодіючій стороні. Спочатку Аліса генерує випадкове число х і отримує його геш-значення. Далі вона формує транзакцію №1, в якій вона відправляє 2 BTC і при цьому ставить дві умови як ці монети можуть бути витрачені.

У першій умові сказано, що Боб може забрати ці монети собі, якщо надасть число, геш-значення якого буде відповідати заявленому (тобто це число буде дорівнює тому, яке загадала Аліса). У другій умові вказано, що Аліса може забрати всі ці монети назад, але для цього потрібні підписи обох сторін. Схематично сформована транзакція виглядає, як на рисунку 4.29.

<img width="40%" alt="Рисунок 4.29 – Схема транзакції сформованої Алісою" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.29-Alice’s-transaction-scheme.png"/> 

Відзначимо, що транзакція тільки сформована, але Аліса поки що не підписує її і не публікує до мережі Bitcoin. Після формування транзакції, вона відправляється Бобу, щоб він зміг ознайомиться з її змістом. Відправити цю транзакцію в Bitcoin-мережу Боб не зможе, так як вона не підписана Алісою і не може бути підтверджена.

Аліса створює наступну транзакцію №2, яка витрачає першу транзакцію. Однак при цьому задається тимчасове блокування, тобто транзакція не може бути підтверджена протягом наступних 24 годин. Нагадаємо, що ця транзакція вимагає мультіпідпису Аліси і Боба для її підтвердження. Тому Аліса підписує її і відправляє Бобу. Боб перевіряє коректність отриманої транзакції, підписує її і відправляє назад Алісі. Схематично зміст транзакції вказано на рисунку 4.30.

<img width="50%" alt="Рисунок 4.30 – Друга транзакція, сформована Алісою (відправляє монети назад через 24 години)" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.30-Alice’s-second-transaction-(it-sends-coins-back-after-24-hours).png"/> 

Після того як транзакція №2 сформована і підписана обома учасниками, через 24 години вона може підтвердитися і витратити вихід транзакції №1. Так як всі умови на поточний момент задані, Аліса підписує транзакцію №1 (яка переводить монети Бобу, якщо він знає секретне значення) і публікує її в Bitcoin-мережу (рис. 4.31).

<img width="50%" alt="Рисунок 4.31 – Публікація Алісою транзакції в мережу" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.31-Alice-is-publishing-her-transaction-to-the-network.png"/> 

Згідно з умовами транзакції Боб може витратити монети протягом 24 годин після публікації Алісою транзакції в мережу Bitcoin, якщо він дізнається відповідне секретне значення. Як же потрібно вчинити Бобу, щоб дізнатися це значення. Для цього він формує транзакцію №3, яка витрачає його 44 LTC і також задає дві умови витрати монет (рис. 4.32).

<img width="40%" alt="Рисунок 4.32 – Схема першої транзакції сформованої Бобом" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.32-Bob’s-first-transaction-scheme.png"/> 

У першій умові вказується: Аліса може забрати ці монети, якщо надасть значення, геш-значення від якого дорівнює геш-значенню, яке задано у виході транзакції Бобом. Як ви здогадалися, Боб задав те ж саме геш-значення, яке задавала і Аліса в своїй транзакції. Тобто Боб просить Алісу довести, що вона знає значення яке згенерувала. У другій умові вказано, що Боб може забрати монети назад, але тільки в разі, якщо обидві сторони підпишуть транзакцію.

Боб також не підписує цю транзакцію і тільки відправляє її Алісі для ознайомлення зі змістом. Після цьому Боб формує транзакцію №4, яка витрачає транзакцію №3 і відправляє монети Бобу, однак тільки після 12 годин. Ця транзакція повинна бути підписана обома сторонами. Тому Боб підписує транзакцію і відправляє її Алісі. Аліса перевіряє її вміст, підписує власним ключем і відправляє назад Бобу. Вміст транзакції вказано на рисунку 4.33.

<img width="40%" alt="Рисунок 4.33 – Друга транзакція, сформована Бобом (відправляє монети назад через 24 години)" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.33-The-second-transaction-Bob-has-formed-(sends-coins-back-after-24-hours).png"/> 

Після того, як транзакція №4 сформована, Боб підписує і відправляє в мережу Litecoin транзакцію №3.

Далі обмін залежить безпосередньо від Аліси. Якщо вона не передумала здійснювати обмін, їй необхідно довести володіння монетами на виході транзакції Боба за допомогою секретного значення. Після того як вона опубліковує нову транзакцію (на цей раз в мережу Litecoin), в якій доводить володіння монетами, то секретне значення розкривається і Боб може його використати для свого доказу та забрати монети (рис. 4.34).

<img width="50%" alt="Рисунок 4.34 – Публікація секрету Алісою та здійснення trustless обміну" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.34-Alice-publishes-the-secret-and-performs-trustless-exchange.png"/> 

Якщо ж Аліса передумала і не хоче робити обмін, то вона не публікує транзакцію з секретним значенням, і після настання заданого моменту часу отримує доступ до своїх монет.

Для закріплення матеріалу наведемо діаграму послідовності з описом основних кроків взаємодії (рис. 4.35).

<img width="40%" alt="Рисунок 4.35 – Схема atomic swap" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.35-Atomic-swap-scheme.png"/> 

> _Крок 1_. Аліса генерує випадкове значення х (секрет).

> _Крок 2_. Аліса створює транзакцію №1 з двома умовами витрати монет:
1) Бобу, якщо він знає секрет;
2) Алісі, якщо наступна транзакція буде підписана ними двома. Після цього транзакція відправляється Бобу, для того щоб він погодився з зазначеними умовами.

> _Крок 3_. Аліса створює транзакцію №2, яка витрачає транзакцію №1 і відправляє монети Алісі через 24 години.

> _Крок 4_. Транзакція №2 підписується Алісою і відправляється Бобу.

> _Крок 5_. Боб перевіряє вміст транзакції №2, підписує її власним ключем і повертає Алісі.

> _Крок 6_. Аліса публікує транзакцію №1 в мережу Bitcoin.

> _Крок 7_. Боб створює транзакцію №3 з двома умовами витрати монет: 
1) Алісі, якщо вона знає секрет;
2) Бобу, якщо наступна транзакція буде підписана ними двома. Після цього транзакція відправляється Алісі, щоб та погодилася з зазначеними умовами.

> _Крок 8_. Боб створює транзакцію №4, яка витрачає транзакцію №3 і повертає монети Бобу через 12 годин.

> _Крок 9_. Транзакція №4 підписується Бобом і відправляється Алісі.

> _Крок 10_. Аліса перевіряє вміст транзакції №4, підписує її власним ключем і повертає Бобу.

> _Крок 11_. Боб публікує транзакцію №3 в мережу Litecoin.

> _Крок 12_. Аліса витрачає транзакцію №3 при цьому публікуючи секретне значення.

> _Крок 13_. Боб отримує секретне значення і використовує його для розблокування транзакції №1.

При цьому важливо відзначити, що якщо Боб не забере свої Bitcoin-монети протягом 24 годин, то Аліса може їх повернути собі. Але якщо Боб встигне забрати свої гроші вчасно, то можливість шахраювати у кожної зі сторін відсутня.

### Обмеження atomic swaps

Як і будь-яка технологія, механізм atomic swap має низку переваг і недоліків. Вище ми розглянули, якими перевагами володіє технологія – trustless обмін в децентралізованому середовищі без використання будь-яких посередників. Тепер саме час розглянути обмеження технології.

> * _Великий час підтвердження обміну_
> * _Доволі висока комісія за обміну_ 
> * _Потреба щоразу шукати контрагента та домовлятися щодо умов обміну_

Обмін на централізованій біржі може займати частки секунд, водночас проведення одного атомарного обміну залежить від платформ і учасників процесу і може займати порівняно велику кількість часу. Наприклад, для випадку, який ми розглянули, безпечний обмін може бути проведено не менше ніж за 2 години (час повного підтвердження 2-х блоків в Bitcoin і 2-х блоків в Litecoin) і це за умови, що сторони діють швидко. Верхня межа проведення обміну в нашому випадку – 12 годин.

Наступне обмеження – висока комісія за проведення обміну. Для обміну кожному учаснику потрібно провести дві транзакції: одну в мережі Bitcoin й одну в Litecoin, а це, як відомо не найдешевші з точки зору комісії системи. На тій же централізованій біржі комісія може складати кілька центів за обмін.

Останнім обмеженням є необхідність самостійного пошуку сторони для взаємодії. Децентралізовані біржі в деякому роді можуть вирішити цю проблему, однак все одно швидкість orders matching на них набагато нижче, ніж на централізованих. Також до обмежень можна віднести неможливість проведення atomic swaps за участю фіатних валют.

Окремо варто згадати про ризик втрати монет унаслідок використання смарт-контракту з закладкою. Якщо користувач не провів кваліфікований аудит смарт-контракту транзакції, яка була відправлена ​​в мережу, він може втратити свої гроші (і йому нікуди буде звернутися з претензією).

### Застосування atomic swaps децентралізованими біржами

На основі atomic swap можна побудувати децентралізовані біржі, які дозволятимуть працювати з декількома обліковими системами, кожна з яких має власну історію транзакцій. Але при проектуванні таких децентралізованих бірж необхідно пам'ятати, що будь-хто повинен мати можливість залишити свою пропозицію про покупку або продаж. Тому спочатку необхідно реалізувати протокол, який дозволить скласти orderbook у децентралізований спосіб.

Що стосується гарантій виконання orders, тут є особливості. У разі використання централізованих бірж, весь баланс перебуває у біржі. Тому, незважаючи на те, що користувач в будь-який момент може скасувати свій order, до того моменту, поки його не скасовано, біржа може здійснити order matching та виконати цей order. Для децентралізованих бірж все набагато складніше: тут потрібні штрафи за порушення зобов’язань чи щось на кшталт цього.

Угоди на децентралізованих біржах відбуваються безпосередньо між учасниками мережі (однорангово). На рисунку зображено підмережі, кожна з яких взаємодіє в межах свого протоколу. Деякі вузли містять кілька різних компонентів (ПЗ для різних облікових систем) для взаємодії з різними мережами. У такий спосіб забезпечується підтримка обміну різними цифровими активами між вузлами (рис. 4.36). 

<img width="50%" alt="Рисунок 4.36 – Схема функціонування децентралізованих бірж" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.36-Decentralized-exchanges-operation-scheme.png"/> 

Варто відзначити, що досі немає єдиного стандарту для atomic swap. Усі, хто на цю мить використовує atomic swaps, використовують криптографію та смарт-контракти без якогось погодженого підходу.

До децентралізованих бірж, що використовують технологію atomic swaps, можна віднести Barter DEX, Blockchain.io, Atom DEX та ін.

### Проблема panic sells

За масового використання atomic swaps існує проблема, яка важко вирішується. Припустимо, що є облікова система, всередині якої справляється дуже висока комісія за обробку транзакцій, а самі транзакції дуже довго підтверджуються (яскравий приклад – Bitcoin). Користувачі починають продавати цю валюту (оскільки система має недостатню пропускну здатність), і створюють orders на децентралізованій біржі, але ці orders при виконанні створюють смарт-контракти в тій же системі, що і валюта, яку намагаються продати. Таким чином, мережа навантажується ще більше, які очікують транзакції утворюють ще більшу чергу і користувачі ще сильніше хочуть продати цю валюту, виставляючи більше orders і збільшуючи чергу транзакцій. В якості аналогії можна привести приклад з ядерної фізики (рис. 4.37).

<img width="40%" alt="Рисунок 4.37 – Схема розпаду ядра" src="/resources/img/volume-2/4.3-Operation-principles-and-use-of-atomic-swap/Figure-4.37-Nuclear-fission-scheme.png"/> 

Під час розпадання одне ядро ізотопу урану-235 зазвичай випускає від 1 до 8 вільних нейтронів. Кожен нейтрон, що утворився при розпаді може викликати розпад сусіднього ядра урану, це явище називається ланцюговою реакцією поділу ядра. Власне, це і є принцип вибуху атомної бомби. Причому проблему тушіння ядерних вибухів досі не вдалося вирішити в належний спосіб. Авжеж, проблема panic sells в децентралізованих біржах на основі atomic swap не така суттєва порівняно з проблемою атомних бомб, але ця аналогія дуже наочно відображає суть лавиноподібного поширення панічного процесу на ринку.

[МЕТОДИ ДОСЯГНЕННЯ КОНСЕНСУСУ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-2/ua/5-consensus-reaching-methods.md)
