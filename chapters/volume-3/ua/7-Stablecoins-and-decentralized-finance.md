# [6 ОСНОВИ ПОСТКВАНТОВОЇ КРИПТОГРАФІЇ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-3/ua/6-Basics-of-post-quantum-cryptography.md)

# 7 STABLECOINS ТА ДЕЦЕНТРАЛІЗОВАНІ ФІНАНСИ


## 7.1 Підходи до створення stablecoins

Stablecoin (стабільна монета) або stable currency (стабільна валюта) – це терміни, які зазвичай використовують для позначення підмножини цифрових активів, ціна яких стабільна (або прагне бути стабільна) відносно деякого еталона. Питання створення stablecoin актуальне, тому що багато людей хоче використовувати такий актив, який матиме одночасно декілька властивостей: можливість зберігання та передавання в цифровій формі, стабільна ціна, незалежність (від банків, регуляторів і їхніх обмежень). У цьому підрозділі описано основні підходи до забезпечення прив'язання (_peg_) ціни цифрового активу до деякого еталону вартості.

Слід розуміти, що стабільність ціни – відносна величина, вона не має абсолютного значення чи універсальних одиниць виміру. Щоби краще зрозуміти цю проблему, можна скласти список звичних товарів і послуг, наприклад: літр молока, кілограм пшениці, одна поїздка в метро. З одного боку, людина вважає вартість цих товарів і послуг порівняно стабільною, з іншого боку, ці самі товари та послуги нестабільні відносно один одного. З цього випливає, що універсальної одиниці виміру ціни немає, тому ціну stablecoin можна прив'язати тільки до деякого еталону, тобто вже наявного товару, послуги чи іншого активу.

Є різні способи прив'язання stablecoin до еталону. Щоби порівнювати їх, зручно використовувати такі критерії.

> * _Рівень стійкості прив'язки до зміни попиту та пропозиції_
> * _Витратність підтримання прив'язки_
> * _Прозорість механізмів прив'язання для користувачів_
> * _Складність визначення меж стійкого стану прив'язки_

Здебільшого stablecoin і відповідний еталон торгуються на різних майданчиках і в різних обсягах, отже, баланс попиту та пропозиції на stablecoin в окремі моменти часу може сильно відрізнятися від балансу попиту та пропозиції на сам еталон. Наприклад, якщо stablecoin прив'язаний до одного літра палива й охочих терміново продати цей stablecoin набагато більше, ніж охочих його купувати, то люди, авжеж, створюватимуть пропозиції з продажу навіть за заниженою ціною (нижчою за поточну ціну одного літра палива). Для stablecoin це основна проблема, і механізм прив'язання має її вирішувати в межах певних припущень.

Способи прив'язання ціни stablecoin до еталону можуть забезпечувати різні системи: централізовані, децентралізовані, зі спеціальними самовиконуваними смарт-контрактами й т. ін. Водночас важлива витратність підтримання такої системи. Вона має на увазі, наприклад, витрати на підтримання достатньої кількості незалежних оракулів, які стежать за змінами ціни еталона та передають дані до системи управління stablecoin; витрати на підтримку валідаторів облікової системи й т. ін. Ці витрати має хтось покривати: розповсюджувачі товарів чи послуг, або торговці, або держателі та користувачі.

Прозорість механізмів прив'язання – ще один важливий критерій для stablecoin. В ідеальному разі будь-хто повинен мати можливість вивчити принцип забезпечення прив'язання та переконатися в його теоретичній працездатності, а також можливість провести аудит системи на практиці, щоби переконатися в її відповідності теоретичній моделі. Інакше stablecoin не викликатиме довіри та не набуде широкого поширення.

Складність визначення меж стійкого стану прив'язки – це критерій, який є наслідок із попереднього. Якщо учасники ринку не можуть легко визначити точки, у яких прив'язка втратить свою стійкість, то зловмиснику стає доволі просто поширити паніку серед користувачів. Так зловмисник може призвести до лавинного ефекту: користувачі самі виводитимуть stablecoin зі стійкого стану без об'єктивних на те причин. Тому прозорий і такий, що легко піддається аналізу, механізм прив'язання стійкіший до маніпуляцій і коливань настрою.
Підходи до створення stablecoin можна розділити на три основні групи.

> * _Повне забезпечення відповідним еталоном вартості_
> * _Забезпечення іншим цифровим активом на еквівалентну суму_
> * _Без забезпечення_


### Способи прив'язання з повним забезпеченням

Найпростіший для розуміння спосіб створення stablecoin – випускання цифрових зобов'язань у централізованій обліковій системі, володілець якої має (заблокований у його сховищі) безпосередній еталон вартості на всю суму випущених зобов'язань. Наприклад, володілець ферми випускає у своїй обліковій системі один новий stablecoin щоразу, коли додає на свій склад один літр свіжого молока, і погашає один stablecoin щоразу, коли любитель молока приходить на склад, щоб обміняти цифрове зобов'язання на справжнє молоко.

Переваги такої організації такі: 

* Володілець ферми розділяє процеси продажу молока і обслуговування клієнтів.
* Теоретично неможлива ситуація, коли клієнт має stablecoin, а на складі немає молока. 

Цікава особливість – те, що люди, які вірять у стабільність ціни молока, можуть використовувати цей stablecoin для зберігання своїх заощаджень. Однак ця особливість – перевага не для кожного зразка. Для прикладу з молоком що більше stablecoin використовується для зберігання заощаджень, то більше молока простоює на складі та, відповідно, псується. Тому такий підхід до створення stablecoin не підходить тоді, коли еталон – те, що складно чи дорого зберігати. 

Інший недолік цього підходу – те, що прив'язку stablecoin до ідеалу забезпечує одна сторона та що її не може перевірити будь-хто охочий. Отже, користуватися таким stablecoin може тільки той, хто повністю довіряє володільцю системи. Також із цього випливає, що stablecoin, які випустили різні емітенти (наприклад, різні фермери), у загальному разі *невзаємозамінні (non-fungible)*, навіть якщо вони прив'язані до одного стандарту.

Щодо способів прив'язання з повним забезпечення також відзначмо, що на практиці трапляються випадки, коли забезпечення зберігається централізовано (зберігає одна компанія), stablecoin випускається також централізовано (випускає та сама компанія), але облік stablecoin здійснюється він у децентралізованій системі. У таких випадках тільки один із процесів прозорий і незалежний; у контексті надійності всієї системи це має вкрай мало сенсу.


### Забезпечення stablecoin іншим цифровим активом

Підхід до створення stablecoin, де в ролі забезпечення використовується інший цифровий актив, цікавий тим, що його може бути застосовано в децентралізованій обліковій системі з властивістю permissionless. Саме цей варіант і буде далі розглянуто. У такому разі процесом випускання stablecoin і зберігання забезпечення управляє смарт-контракт. Теоретично такий stablecoin матиме властивість trustless, оскільки система незалежна та повністю піддається аудиту. Однак важливо розуміти, що цей підхід працює, тільки якщо сам stablecoin і цифровий актив, яким він забезпечується, випускаються й обліковуються в одній системі; тобто створити stablecoin, прив'язаний до одного граму золота та забезпечуваний на еквівалентну суму біткоїнів, неможливо.

Найпоширеніший спосіб реалізування цього підходу передбачає використання так званого контракту на різницю цін (contract for difference, CFD). CFD – це популярний біржовий інструмент, який використовується для страхування від зміни ціни активу. Укладаючи CFD, покупець і продавець домовляються про відшкодування різниці між поточною ціною деякої кількості активу та ціною цієї кількості активу на момент завершення контракту.

Наприклад, якщо ціна одного літра молока в доларах збільшиться на деяку суму, то продавець виплатить покупцю цю суму, а якщо ціна одного літра молока знизиться, то вже покупець заплатить різницю продавцю в доларах. Водночас саме молоко вони один одному не передають, їм навіть не обов'язково його мати: просто одна сторона сплачує іншій стороні різницю в ціні, яка утворилася за час життя контракту.

Очевидно, що в цьому прикладі для закриття (погашення) контракту на різницю цін потрібно виплатити тільки ту суму, на яку змінилася ціна одного літра молока. Таким чином, якщо вона змінилася на 10%, то для погашення СFD потрібно тільки 10% від ціни літра молока. Але на практиці розрахування між сторонами відбувається не після закриття контракту, а саме в момент його закриття. До того ж, обидві сторони хочуть мати гарантію того, що опонент буде платоспроможний у момент закриття контракту, тому ще під час його відкриття стороні заморожують деяку суму в цьому самому контракті як заставу. Наприклад, сторони створюють CFD на суму, що дорівнює ціні одного літра молока в доларах, і як заставу депонують по 20% від вартості одного літра молока в доларах. Варто зазначити, що такий контракт може бути закрито у два способи: з ініціативи однієї зі сторін або автоматично (margin call) в разі зміни ціни одного літра молока в доларах на 20% або більше. Другий спосіб передбачає, що різниця, яку потрібно виплатити, зрівнялася з максимальною сумою, яку один із учасників готовий виплатити.

Розмір застави зазвичай залежить від волатильності ціни активу. Для активів із відносно стабільною ціною це може бути кілька відсотків, а для активів із дуже волатильною ціною – кілька десятків або навіть сотень відсотків. Так чи не так, основна перевага CFD полягає в тому, що він дозволяє торгувати активом, фактично не маючи його в наявності.

Тепер розгляньмо, як, використовуючи CFD в децентралізованій обліковій системі, можна випускати stablecoin, ціна якого прив'язана до довільного ідеалу. Різниця – у тому, що тут контракт укладається не між двома опонентами, а між торговцем і всією обліковою системою. Щоби краще зрозуміти особливості роботи смарт-контракту в цих умовах, розгляньмо приклад випускання з боку деякого торговця одного stablecoin, прив'язаного до ціни одного літра молока, де джерело ціни буде мережа супермаркетів «Господарочка».

Отже, торговець – користувач облікової системи, у якій він володіє деякою кількістю базової валюти. Ця валюта використовуватиметься як забезпечення для stablecoin, що випускається. Припустімо, на цю мить відомо, що в мережі «Господарочка» один літр молока коштує 100 одиниць базової валюти. Тому торговець, складаючи контракт на випускання одного stablecoin, зазначає суму забезпечення, що дорівнює 120 одиницям базової валюти (еквівалент вартості + 20% застави). Після того, як цей контракт підписав торговець і прийняла облікова система, 120 одиниць базової валюти знімаються з його балансу та заморожуються в контракті, а натомість він отримує новий stablecoin.

У межах цієї облікової системи цей stablecoin – гарантія того, що його володілець у будь-який момент часу може обміняти його на базову валюту в еквіваленті ціни одного літра молока з мережі «Господарочка». Торговець може відправити цей stablecoin будь-якому іншому користувачу системи, а може створити пропозицію з його продажу на внутрішній біржі цієї облікової системи (internal exchange, DEX).

У цій системі внутрішня біржа грає дуже важливу роль, гарантуючи коректне закриття контрактів у разі margin call. Припустімо, торговець як благодійність пожертвував свій stablecoin у дитячий будинок, де багато любителів молока. Але поки діти йшли до найближчого супермаркету «Господарочка» за покупками, ціна одного літра молока в цьому магазині виросла на 20% у базовій валюті, яка використовувалася як забезпечення stablecoin. Що ж станеться в системі в цей момент? Справа в тому, що обліковій системі потрібно знати поточну ціну еталона, до якого прив'язаний stablecoin, для своєчасного оброблення таких ситуацій. Тому є спеціальні оракули, які моніторять стан зовнішніх ринків і записують актуальний стан до спільної бази даних облікової системи. Тепер смарт-контракту для виконання margin call потрібно використовувати забезпечення для того, щоби викупити на внутрішній біржі один stablecoin за поточною ціною та знищити його. У цю мить ціна становить 120 одиниць базової валюти, що дорівнює всій сумі забезпечення. Унаслідок автоматичного закриття контракту торговець отримує повідомлення про те, що його CFD погашено, а любителі молока надалі йдуть до магазину, маючи з собою той самий stablecoin, і зможуть ним скористатися, навіть якщо ціна на нього в базовій валюті встигне ще більше зрости.

Тепер розгляньмо, що станеться, якщо ціна одного літра молока в базовій валюті знизиться. Відразу варто відзначити, що таке зниження не призводить до автоматичного закриття контракту. За суттю, якщо ціна знизиться на 20% і становитиме 80 одиниць, а забезпечення залишиться 120 одиниць, то тепер фактичний розмір застави становитиме 40 одиниць. У такій ситуації продавець може сам ініціювати закриття контракту, тоді за поточною ціною на внутрішній біржі буде викуплено та знищено один stablecoin, а торговець отримає назад у своє розпорядження решту 40 одиниць базової валюти; якщо торговець на балансі має відповідний stablecoin, то його буде знищено та в розпорядження торговця повернеться вся сума забезпечення. Крім того, торговець може вирішити, що 40 одиниць застави – це занадто багато для цього смарт-контракту, і попросити його повернути 20 із них або випустити ще 0,2 stablecoin під заставу того самого забезпечення.

Такий підхід до створення stablecoin працюватиме тільки за певних припущень: крім звичайних користувачів, у системі мають бути торговці, які відкривають контракти та випускають достатню кількість stablecoin, на внутрішній біржі системи має бути доволі велика ліквідність, яка дозволить здійснювати автоматичне викупання, багато оракулів має підтримувати актуальність даних про вартість еталона на зовнішніх ринках. Крім цього, варто враховувати й інші припущення, пов'язані з особливостями будови децентралізованої облікової системи.

Гарний приклад застосування цього підходу на практиці – децентралізована платформа Bitshares. Найпопулярніші stablecoin, випущені на цій платформі на момент березня 2020 року, – bitUSD (випущено більш ніж 2 мільйони одиниць) та bitCNY (випущено більш ніж 28 мільйонів одиниць), прив'язані за ціною до долара США та китайського юаня відповідно.


### Способи прив'язання без забезпечення

Особливість способів прив'язання ціни stablecoin до вартості еталона без використання будь-якого забезпечення полягає в тому, що механізм прив'язання, фактично, змінює кількість stablecoin в обігу. Це, зі свого боку, дозволяє впливати на його попит і пропозицію. Теоретично ціна підтримуваного в такий спосіб stablecoin має коливатися у вузькому діапазоні близько ціни самого еталона. Такий підхід схожий на те, як здебільшого підтримують ціна фіатних валют центробанки, які їх випускають. Важлива особливість такого stablecoin – те, що емітент не зобов'язується його погашати за якоюсь ціною, тобто ним можна тільки комусь заплатити або його можна продати на біржі.

Розгляньмо на прикладі принцип роботи механізму прив'язання ціни в цей спосіб. Припустімо, деяка група фермерів прийняла рішення запустити спільну систему для облікування stablecoin, ціну якого вони намагатимуться утримувати такою, що дорівнює вартості одного літра молока в мережі супермаркетів «Господарочка». Вони випускають у цій системі кілька stablecoin і відразу виставляють їх на продаж за ціною літра молока в супермаркеті.

Якщо попит на stablecoin виявляється таким великим, що ціна stablecoin на біржах перевищує поточну ціну молока, то фермери приймають спільне рішення випустити ще нових stablecoin і виставити їх на продаж строго за ціною літра молока в «Господарочці». У такий спосіб задовольняється підвищений попит на stablecoin.

Якщо пропозиція починає перевищувати попит і ціна stablecoin опускається нижче за вартість молока на полицях магазину, то за правилами облікової системи починає зростати винагорода, яку можуть отримати держателі stablecoin, якщо заморозять його на деякий час. Це правило реалізується за допомогою смарт-контракту, який за бажанням користувача заморожує його stablecoin на деякий час і виплачує йому винагороду в базовій валюті. Розмір винагороди залежить від часу, на який заблоковано stablecoin, і відхилення ціни stablecoin. У такий спосіб система мотивує учасників виводити stablecoin із обігу, коли потрібно впоратися з підвищеною пропозицією. У підсумку, збільшення винагороди стимулює попит на stablecoin і знижує його пропозицію.

Такий підхід до створення stablecoin також може бути реалізовано в децентралізованої обліковій системі, проте тут є одне цікаве питання. Хто буде володільцем stablecoin, які щойно було випущено та хто отримає виторг від їх продажу? Гарний приклад застосування цього підходу на практиці – система NuShares, де випускається й обліковується stablecoin NuBits, прив'язаний до вартості одного USD. Проте навесні 2018 року механізм прив'язання не впорався зі своїм завданням і ціна NuBits обвалилася. Утім, у цій системі є відповіді на деякі цікаві питання про сам підхід до створення stablecoin.

У NuShares випускання нових NuBits відбувається тільки за рішенням держателів базової валюти. Випущені внаслідок голосування NuBits відразу надходять на біржу для продажу, а виторг від їх продажу використовується для покриття операційних витрат, підтримання проекту та виплачування дивідендів держателям базової валюти.

### \*\*\*Часті запитання\*\*\*

_– Що станеться за тривалого та неконтрольованого падіння еталону, до якого прив’язано певний stablecoin?_

Припустімо, stablecoin прив’язаний до вартості гречаної крупи. Раптом учені доводять, що гречана крупа дуже шкідлива як харчовий продукт, – та відносно якоїсь іншої крупи (наприклад рисової) вона сильно дешевшає. Водночас механізм прив'язання вартості stablecoin до гречаної крупи діє надалі – вартість цього stablecoin так само дорівнює вартості гречаної крупи відносно рисової.

Утім, вартість цього stablecoin може перестати відповідати вартості еталону, якщо механізм прив'язання stablecoin опинився недостатньо нестійким, але це вже інше питання.


## 7.2 Деталі функціонування stablecoins

Stablecoins – це клас цифрових активів, прив’язаних за своїм ринковим курсом (pegged) до однієї з фіатних валют, найчастіше до долара США.

Першим успішним проєктом stablecoin можна вважати USDT, або Tether. Проєкт був запущений у 2014 році і досі, за винятком рідкісних випадків, його ціна не відхилялася більш ніж на 0,05–0,1 одиниць від долара США (рис. 7.1) [125].

![Рисунок 7.1 – Графік курсу USDT до долара США](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.1-exchange-rate-of-USDT-to-US-dollar.png "Рисунок 7.1 – Графік курсу USDT до долара США")

За 8 років свого існування USDT став популярним і загальний обсяг цих stablecoins, що перебувають в обігу, перевищив 80 млрд доларів США [125].

![Рисунок 7.2 – Графік кількості випущених USDT](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.2-amount-of-USDT-issued.png "Рисунок 7.2 – Графік кількості випущених USDT")

Stablecoins мають важливе значення в екосистемі цифрових активів, бо фактично забезпечують ціноутворення щодо найбільш затребуваних віртуальних активів, як-от bitcoin (BTC) та ether (ETH). Початкове неприйняття з боку класичного ринку цифрової економіки та вкрай обмежені можливості торгівлі за фіатні гроші змусили ентузіастів створити токенізовану версію долара США. На сьогодні вже є десятки різних проєктів stablecoins.

Загальний обсяг випущених stablecoins станом на травень 2022 року перевищує 180 млрд доларів США [126]. Перші 2 stablecoins за ринковою капіталізацією – це Tether (USDT) і Circle (USDC). Обидва – токенізовані версії долара США. Найбільші за капіталізацією недоларові stablecoins, прив’язані до євро – це EURT (Tether) [127] та STASIS EURO [128] з капіталізацією, відповідно, 250 млн і 130 млн доларів США станом на травень 2022.

Зростання популярності stablecoins зумовлене такими чинниками:

* stablecoins відкриті для будь-якого користувача практично 24 години на добу 7 днів на тиждень;
* перекази здійснюються згідно з правилами та особливостями облікової системи, у якій випущений та перебуває в обігу stablecoin, тобто в системі Ethereum переказ здійснюється за лічені хвилини;
* найчастіше stablecoins легко використовувати в смарт-контрактах і тому вони доступні в багатьох децентралізованих фінансових додатків (DeFi DAPPS).

Далі розберімо основні принципи емісії та механізми прив’язання вартості stablecoins. Умовно всі представлені на ринку проєкти можна розрізняти за двома критеріями:

* порядок емісії
* спосіб забезпечення

Відповідна класифікація stablecoins подана на рис. 7.3.

![Рисунок 7.3 – Класифікація stablecoins](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.3-classification-of-stablecoins.jpg "Рисунок 7.3 – Класифікація stablecoins")


### Централізовані stablecoins

Найпростіший варіант – це stablecoin, який випустила централізована організація та який забезпечений еталоном вартості у відношенні 1 до 1. Наприклад, на кожен випущений токен USDT, USDC та USDP на банківському рахунку емітента є один долар США.

Відзначмо, що не завжди доларові токени забезпечуються тільки доларами США на банківському рахунку. Наприклад, у разі Tether йдеться про забезпечення у формі резервів з таким складом [129] станом на травень 2022:

* 83,74 % – грошові кошти та їхні еквіваленти, а також інші короткострокові депозити та комерційні папери:
    * 52,41 % – казначейські зобов’язання США;
    * 36,68 % – комерційні папери та депозитні сертифікати;
    * 6,36 % – готівкові долари та банківські депозити;
    * 4,55 % – фонди фінансового ринку;
* 6,38 % – інші інвестиції (зокрема цифрові токени);
* 5,27 % – забезпечені кредити (не для афілійованих осіб);
* 4,61 % – корпоративні облігації, фонди та коштовні метали.

Тобто, строго кажучи, у всьому забезпеченні USDT власне долари на банківському рахунку становлять лише 6,36 %, що навіть менше, ніж частка «інших інвестицій» (6,38 %). Безумовно, левову частку забезпечення становлять вкрай консервативні вкладення в казначейські зобов’язання США, комерційні папери та депозитні сертифікати. Щоквартальні аудити забезпечення дозволяють оцінити склад та якість забезпечення та через публічні звіти гарантувати користувачам USDT відповідність заявленого реальності.

Проєкт із другую за обсягом емісією – USDC – більш консервативний, ніж USDT. Щомісячний аудиторський висновок містить фразу про те, що загальна справедлива вартість (у доларах США) активів, що зберігаються на окремих рахунках, щонайменше дорівнює вартості 51 388 555 903 токенів USDC, що перебувають в обігу станом на 31 березня 2022 року [130].

Таким чином, ступінь довіри до того чи іншого централізованого stablecoin із забезпеченням у доларах США й аналогічних активах зводиться до довіри до організації-емітента й аудиторів, які перевіряють звітність.

Особливістю централізованих stablecoins є можливість блокування коштів на конкретних адресах. Тобто у відповідному смарт-контракті є функція, яка дозволяє емітенту заблокувати кошти на конкретній адресі на вимогу державних органів.

У разі USDC такі адреси опубліковані на сайті компанії-емітента [131].

Перевагою централізованих stablecoins є простота їх випускання та ведення їх обліку. Недоліками є їхня повна залежність від організації-емітента та від якості та збереженості забезпечення, а також централізований контроль із можливістю блокування коштів на конкретних адресах.


### Децентралізовані stablecoins

Наступним кроком у розвитку stablecoins є децентралізовані протоколи їх випуску та обслуговування, побудовані на смарт-контрактах. У цьому випадку немає єдиної особи або організації, яка би на свій розсуд випускала stablecoins, а є система смарт-контрактів, які відповідають за децентралізовану емісію та вилучення з обігу відповідних токенів.

Найбільш ранній проєкт децентралізованого stablecoin й один із найуспішніших – проєкт Maker DAO з децентралізованим stablecoin DAI [132]. Він виник у 2014 році у формі децентралізованої автономної організації (DAO), запущеної в обліковій системі Ethereum. Керувальний токен у системі керування DAO – MKR. З його допомогою здійснюється голосування та прийняття основних рішень щодо шляхів розвитку проєкту. У ролі забезпечення DAI можуть використовуватися як цифрові валюти (наприклад ether), так і токени або stablecoins (наприклад USDC). Залежно від рівня ризику, що приймає система, забезпечення в цифрових активах може становити від 102 % до 175 % [133]. Для випуску DAI під заставу USDC у відсотковому відношенні 1 до 1 використовується спеціальний модуль – PSM USDC (peg stability module) [134]. За допомогою нього станом на травень 2022 року було випущено 3,8 млрд DAI [135].

В екосистемі Maker DAO станом на травень 2022 випущено 8,5 млрд DAI із забезпеченням на суму 13,9 млрд доларів США [136]. Таким чином, кожен DAI забезпечений заставою на 1,64 доларів США, або на 164 %.

Високорівневе схематичне зображення протоколу Maker DAO наведено на рис. 7.4 [137].

![Рисунок 7.4 – Основні учасники системи Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.4-main-participants-of-Maker-DAO-system.png "Рисунок 7.4 – Основні учасники системи Maker DAO")

На відміну від централізованих stablecoins, у Maker DAO емітентом DAI може бути будь-який користувач, який володіє необхідною для емітування сумою заставного активу (наприклад ether). Для здійснення емісії користувач має відправити ether до спеціального смарт-контракту системи, який має назву сейф (vault). Мінімальна сума випуску DAI для сейфа типу ETH-A за умов забезпечення 145 % та річною комісією (stability fee) 2,25 % [138] – 15000 DAI. Усі ризик-параметри та комісії затверджуються голосуванням власників токенів MKR (MKR Governance). Вибравши допустиму суму емісії DAI, користувач відправляє транзакцію, що викликає смарт-контракт системи, унаслідок чого він отримує на свою адресу DAI. Разом із тим система блокує в сейфі суму ether, що відповідає 145 % випущених stablecoins. Якщо користувач захоче забрати заблоковану заставу, далі він має викликати спеціальний метод смарт-контракту та повернути борг із відповідною кількістю DAI з урахуванням накопичених відсотків комісії (stability fee). Водночас смарт-контракт погашає DAI, а заставу повертає на адресу ініціатора виклику.

Приклад сейфа (сейф 27448) – на рис. 7.5 [139]. Як застава використовується обгорнутий (wrapped) актив stETH (це зобов’язання на ether, вкладені в сервіс Lido Ethereum). Мінімальний заставний коефіцієнт становить 160 %, реальний – 357,63 %. Щойно досягається мінімальний заставний коефіцієнт, сейф ліквідується. Тобто щоб уникнути ліквідації, власник сейфа повинен підтримувати відношення, що перевищує мінімальне, з деяким запасом через волатильність активу в заставі щодо долара США. Щорічна комісія – 2,25 %. Емісія в сейфі становила 8,2 млн DAI. Застава становить 10 275 токенів wstETH на суму понад 29,3 млн доларів США.

![Рисунок 7.5 – Приклад сейфу в Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.5-vault-in-Maker-DAO.png "Рисунок 7.5 – Приклад сейфу в Maker DAO")

Перейдімо від користувачів DAI до іншої групи учасників системи Maker DAO – підтримувачів (keepers). Keepers відповідають, зокрема, за процес ліквідування позицій користувачів, за якими сума боргу перевищує визначену протоколом суму забезпечення.

Розберімо процес ліквідування на такому прикладі. Припустімо, ми кладемо в сейф ETH-A заставу в ether на сsуму \$ $100,000$ доларів. Під цю заставу емітуємо 50 000 DAI. Отже, відсоток забезпечення становить $\frac{100,000}{50,000} \cdot 100$% $=200$. Мінімальне значення забезпечення для сейфа ETH-A становить 145 %. Дещо згодом ціна на ether починає знижуватися, а разом з нею – вартість забезпечення DAI, які було випущено. Щойно вартість застави стає нижчою за граничну величину, а саме $50,000 \cdot 145$% = \$ $72,500$ доларів США, утручаються keepers: вони забирають заставу та погашають кредит у DAI замість користувача. Для keeper це вигідно робити, тому що він викуповує ether за DAI з великою знижкою, оскільки, як і раніше, у момент викуплення сума застави в ether становить 145 % від вартості випущених DAI. З 45 % різниці сплачується комісія 13 % за ліквідацію позиції, а решту keeper забирає як винагороду за вчасну ліквідацію. Відзначмо, що в ролі keeper може бути будь-хто.

Бувають ситуації, коли вартість забезпечення зменшується так стрімко, що keepers не встигають викупити заставу, коли її вартість становить від 100 % до 145 % від вартості DAI. У такому разі для keeper погашати кредит замість користувача економічно недоцільно, позаяк вартість застави, яка одержувалася б, менша ніж вартість DAI, які віддавалися б. Тому позиції ліквідуються на рівні протоколу за допомогою накопиченого системного надлишку (system surplus), який станом на травень 2022 становить приблизно 70 млн DAI. Системний надлишок накопичується із комісій від користувачів за випущення DAI (stability fee). Якщо й цих коштів не досить, токени керування MKR автоматично емітуються та продаються за DAI. Отримані за продаж токенів кошти йдуть на ліквідацію позицій із порушеним відношенням забезпечення до емітованих DAI.

Крім цього, у системі Maker DAO передбачені цінові оракули (oracles). Ці учасники забезпечують систему даними про поточну вартість усіх наявних у системі активів. Саме на підставі інформації, отриманої від цінових оракулів, запускається ліквідування позицій, визначається максимальна сума DAI, яку можна випустити під заставу того чи іншого забезпечення у сейфі системи, тощо.

Також є роль розробників (developers), які відповідають за вдосконалення протоколу та виправлення помилок. Щойно система керування (governance) ухвалює рішення про внесення змін до протоколу, розробники безпосередньо оновлюють програмний код. Розробляння фінансується із системного надлишку (system surplus) за рішенням через голосування власників токенів MKR.

Керування системою здійснюється за двома основними напрямами: загальне керування та команда керування ризиками. Почнімо з останнього.

Команда керування ризиками відповідає за вчасну зміну ризик-параметрів протоколу, зокрема за оцінювання нових цифрових активів, які додаються як забезпечення під випущення DAI. Для кожного такого активу визначається заставний коефіцієнт, максимальна сума запозичення та комісія (stability fee).

Станом на травень 2022 року система дозволяє використовувати застави, наведені в таблиці 7.1 [133]. Згідно з таблицею, система приймає як заставу 31 актив на максимальну суму 34,6 млрд DAI.

![Таблиця 7.1 (1) – Параметри заставних активів у Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/T-7.1-1-en-collateral-asset-parameters-in-Maker-DAO.png "Таблиця 7.1 (1) – Параметри заставних активів у Maker DAO")

![Таблиця 7.1 (2) – Параметри заставних активів у Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/T-7.1-2-en.png "Таблиця 7.1 (2) – Параметри заставних активів у Maker DAO")

Для кожного із видів застав команда керування ризиками визначає такі параметри:

* Межа запозичення (debt ceiling) – це максимальна сума боргу, яка може бути створена одним типом застави. Система керування присвоює кожному типу застави межу запозичення, яка використовується для забезпечення достатньої диверсифікації портфеля забезпечення системи. Щойно тип застави досягає своєї межі запозичення, стає неможливо створити новий борг, доки деякі наявні користувачі не погасять свої борги повністю чи частково.
* Комісія (stability fee) – це річний відсотковий дохід системи, який залежить від того, скільки DAI було емітовано під заставу будь-якого з активів у таблиці 7.1. Комісія (stability fee) виплачується лише у DAI та потім стає доходом Maker DAO.
* Заставний коефіцієнт (liquidation ratio). Низький коефіцієнт означає, що волатильність ціни застави низька; високий коефіцієнт означає, що очікується висока волатильність ціни застави. Keepers не можуть відшкодувати заставу кожного конкретного сейфу доти, поки в цьому сейфі заставний коефіцієнт не стане нижчим за встановлене значення.
* Штраф за ліквідацію (liquidation penalty) – це плата, яка додається до загальної кількості непогашених DAI, яку нарахував сейф і яка підлягає ліквідації. 

Керувальні рішення ухвалюють власники токенів MKR через голосування. Це головний рівень керування DAO. Як приклад наводимо голосування щодо додання нового активу CF-DROP як застави. Саме рішення було прийнято 23 липня 2021: 155,24 токенами MKR було проголосовано за [203].

Механізм керування (governance) передбачає два види керування [204]:

* Проактивне керування включає обговорення, прийняття рішення й автоматизоване впровадження.
* Реактивне керування включає процедурне втручання.

Приклад проактивного керування – процес прийняття нового токена як застави та визначення його ризик-параметрів.

Приклад реактивного керування – збільшення або зменшення межі запозичення у зв’язку зі збільшенням або зменшенням ліквідності застави.

Голосування власників токенів MKR може мати дві форми:

* Керувальні опитування (governance polls) дозволяють ухвалити рішення щодо одного питання або групи питань (наприклад щодо додання нових оракулів або нової групи ризику).
* Виконавчі голосування (executive votes) дозволяють змінити налаштування системи. Наприклад, вони можуть стосуватися конкретних ризик-параметрів нового типу застави.

Загалом система керування ухвалює рішення щодо таких питань:

* Додання нового активу як допустимого забезпечення під випуск DAI з новим набором параметрів ризику.
* Змінення параметрів ризику одного або декількох наявних заставних активів або додавання нових параметрів ризику до одного або кількох наявних заставних активів.
* Виділення коштів із прибутків системи для оплачення різних потреб та послуг інфраструктури, зокрема послуг оракулів та досліджень щодо керування супутніми ризиками.
* Змінення ставки збереження DAI.
* Вибрання набору цінових оракулів.
* Вибрання набору екстрених цінових оракулів.
* Активація аварійного закриття системи.
* Відновлення системи.

Таким чином, відповідальність за функціонування Maker DAO повністю покладається на власників токена MKR. У межах смарт-контракту ініціюється голосування про ухвалення деякого рішення. Будь-який користувач з токенами MKR може підтримати це рішення, віддавши за нього свій голос, причому вага голосу дорівнюватиме кількості токенів на балансі цього користувача. Відповідне рішення буде ухвалено, якщо сумарна вага голосів досягне порогового значення (наприклад 2 % від усіх випущених токенів MKR). Залежно від важливості та складності рішення відповідне голосування може використовувати різне граничне значення для ухвалення.

Ухвалене рішення потрапляє в керувальний модуль безпеки (governance security module) [140]. Основна функція цього модуля полягає в тому, щоб дати змогу всім учасникам системи ще раз перевірити рішення та його наслідки перед його безпосередньою реалізацією.

Модуль безпеки інкапсулює оновлений код роботи системи та зберігає його для остаточного розгляду протягом 24 годин. Таким чином, усі зацікавлені сторони (особливо сторони, відповідальні за аварійне закриття системи) можуть перевірити оновлений код перед його впровадженням, щоби забезпечити цілісність системи.

На початку свого розвитку проєкт Maker DAO застосовував як заставу саме цифрові активи, насамперед ether. Система дозволяє вкладати ether у три види сейфів:

* ETH A: заставний коефіцієнт 145 %, комісія 2,25 %;
* ETH B: заставний коефіцієнт 130 %, комісія 4 %;
* ETH C: заставний коефіцієнт 170 %, комісія 0,5 %.

Тобто що менший заставний коефіцієнт, то вища комісія системи та навпаки.

Крім ether можна використовувати деякі інші цифрові активи (див. табл. 7.1): WBTC, stETH, LINK, YFI, MATIC, UNI, MANA, renBTC. Загальна сума DAI, випущена під заставу цифрових активів, становить 21,53 млрд DAI.

Наступний клас активів – це токени ліквідності, або LP-токени децентралізованих бірж. Їх можна вважати підвидом цифрових активів. Вони є частки в пулі ліквідності, наприклад, пари токенів DAI і USDC з комісією за обміняння 0,01 % на біржі Uniswap. Ця пара – одна з лідерів за обсягом ліквідності на децентралізованій біржі Uniswap V3 (її обсяг ліквідності – 354 млн доларів США) [141]. Токени ліквідності, які можна використовувати як заставу під випуск DAI (див. табл. 7.1): GUNI-DAI/USDC 0.01 %, GUNI-DAI/USDC 0.05 %, DAI/USDC UNISWAP LP, USDC/ETH UNISWAP LP, WBTC/ETH UNISWAP LP, DAI/ETH UNISWAP LP, WBTC/DAI UNISWAP LP, Curve stETH/ETH, UNI/ETH UNISWAP LP.

Коли як застави використовуються токени ліквідності пар двох stablecoins DAI і USDC, можна отримати 100 DAI під заставу 102 одиниць LP-токенів (тобто заставний коефіцієнт становить 102 %). Коли хоча б один токен у парі ліквідності – волатильний віртуальний актив, заставні коефіцієнти значно вищі та становлять від 120 % до 160 %.

Загальна сума DAI, які може бути емітовано під заставу токенів ліквідності, становить 2,18 млрд DAI. Найбільшу частину цієї суми становлять DAI, які випускаються під заставу LP-токенів DAI та USDC. Таким чином, система стимулює збільшення доступної ліквідності для обмінювання DAI на USDC та навпаки.

Для забезпечення стабільності DAI щодо еталона, тобто вартості долара США, було розроблено спеціальний модуль стабільності (Peg Stability Module, PSM). Він дає змогу в будь-яку мить обміняти деяку кількість DAI на таку саму кількість одиниць конкретного stablecoin (наприклад USDC) з комісією системи 0 %.

На сьогодні в межах модуля PSM доступні для обмінювання 3 види stablecoins (див. табл. 7.1): USDC, USDP і GUSD. Система допускає обміни DAI на інші stablecoins на суму до 10,56 млрд DAI. Левова частка цього ліміту припадає на USDC – 10 млрд DAI.

Модуль PSM дозволяє стягувати такі комісії [134]:

* Комісію за вхід (Fee In (tin)). Відсоткова комісія, що стягується, коли в PSM обмінюється заставний актив на DAI.
* Комісію за вихід (Fee Out (tout)). Відсоткова комісія, що стягується, коли в PSM обмінюється DAI на заставний актив.

Станом на травень 2022 року ці комісії мають значення 0 %.
Відзначмо, що обсяг угод, які може запропонувати PSM, обмежує його боргова межа та поточна сума заставних токенів. PSM не може пропонувати DAI до обміняння, якщо досягнуто боргову межу. Так само PSM не може пропонувати заставний актив до обміняння, якщо PSM не має заставних токенів. Тобто якщо, наприклад, для USDC PSM встановлено межу 1000 доларів США, то можна обміняти не більш ніж 1000 USDC на 1000 DAI. З іншого боку, якщо користувачі вже обміняли 500 USDC на 500 DAI та в PSM залишилося 500 USDC, то користувачі, які бажають зробити зворотний обмін DAI на USDC, можуть обміняти не більш ніж 500 DAI на 500 USDC.

Обмінювання через PSM можливе тільки між stablecoins, прив’язаними до однакового цінового еталона.

Важливий складник екосистеми децентралізованих фінансів – так звані лендингові протоколи, або DeFi-банки. Найбільші з них – AAVE та Compound. Їхнє призначення полягає в тому, щоби забезпечити можливість децентралізовано позичати одні токени під заставу інших. Наприклад, ви депонуєте в таку систему 1 ETH і під заставу цього активу можете взяти в кредит DAI. Водночас у контексті керування ризиками для кожного активу є свій заставний коефіцієнт та своя крива відсоткових ставок.

Система працює так, що що більше коштів із пулу ліквідності DAI запозичується, то більша відсоткова ставка за такими кредитами. Докладно формули приросту ставок залежно від частки використання пулу ліквідності (utilization ratio) наведено в описах самих протоколів [142].

Суть модуля прямого депонування (Direct Deposit Dai Module, D3M) полягає в тому, щоб, коли відсоткова ставка в лендинговому протоколі за кредитами перевищує затверджене керувальним рішенням Maker DAO значення (для протоколу AAVE – 4 % [143]), будь-хто охочий міг викликати функцію смарт-контракту лендингового протоколу та збалансувати обсяг DAI в пулі ліквідності, узявши потрібний обсяг DAI безпосередньо з Maker DAO [144]. Водночас Maker DAO отримує як заставу токени пулу ліквідності лендингового протоколу. У разі AAVE це будуть токени aDAI. Процес додавання та віднімання ліквідності зображено на рис. 7.6 [145].

![Рисунок 7.6 – Схема роботи модуля D3M](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.6-D3M-module-operation.jpg "Рисунок 7.6 – Схема роботи модуля D3M")

В аналогічний спосіб ліквідність повертається з лендингового протоколу: коли відсоткова ставка за кредитами падає нижче за 4 %, викликається функція смарт-контракту, яка дозволяє забрати надлишкову ліквідність та погасити кредит Maker DAO на користь лендингового протоколу [146].

У табл. 7.1 зазначено параметри модуля D3M, що працює з протоколом AAVE. Межа запозичення становить 300 млн DAI. Фактична ставка, яку отримує Maker DAO (2,81 %), відповідає приблизно ставці кредитування 4 % в AAVE.

Загальний підхід модуля D3M та його можливості взаємодіяння з іншими лендинговими системами показано на рис. 7.7 [147].

![Рисунок 7.7 – Схема взаємодії модуля D3M із лендинговими протоколами](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.7-D3M-module_s-interaction-with-lending-protocols.png "Рисунок 7.7 – Схема взаємодії модуля D3M із лендинговими протоколами")

Переваги модуля D3M очевидні. Він дозволяє утримувати вартість запозичення DAI в системі AAVE на передбачуваному рівні не більш ніж 4 % річних. Це робить DAI привабливішим stablecoin для отримання в кредит порівняно з його аналогами, у яких ставка запозичення рухома та подекуди може перевищувати двозначні значення (це змушує позичальників переплачувати за кредитами). На рис. 7.8 показано динаміку ставок запозичення DAI в системі AAVE до впровадження модуля D3M [148].

![Рисунок 7.8 –Відсоткова ставка запозичення DAI в системі AAVE](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.8-interest-rate-of-DAI-borrowing-in-AAVE-system.png "Рисунок 7.8 –Відсоткова ставка запозичення DAI в системі AAVE")

Останній клас активів, допустимий як застава під випуск DAI, – це реальні активи (Real World Assets, RWA) (див. табл. 7.1). Загальний ліміт цього класу активів становить 59 млн DAI. Випуск DAI під заставу реальних активів можна розглянути на прикладі затвердженого системою керування RWA001-A ліміту на 15 млн DAI.

Американська компанія «6s Capital LLC» [149] працює з кількома забудовниками комерційної нерухомості по всій території Сполучених Штатів. Забудовники будують комерційну нерухомість, яка далі здається в довгострокову оренду. Компанія 6s надає забезпечені кредити у розмірі до 100 % від вартості будівництва для фінансування будівництва та подальшого придбання комерційної нерухомості [150].

Компанія «6s» з’явилася під час кризи банківського кредитування, пов’язану з COVID-19: тоді її дочірня компанія «6s Development LLC» мала проблеми з банками, які більше не хотіли надавати кредити під будівництво. «6s Development LLC» займається будівництвом і довгостроковим комерційним здаванням в оренду протягом 15 років і побудувала більш ніж 1000 об’єктів. Жодний із проєктів, які профінансувала «6s Development LLC» не був дефолтним [150].

MakerDAO надає кредит в обмін на можливість із поправкою на ризик стягнути активи, що використовуються як застава. У цьому контексті MakerDAO використовуватиме реальні активи як заставу, і водночас необхідно визначити, як може бути ліквідовано кредитну позицію чи стягнено заставу, якщо позичальник матиме проблему із поверненням наданих DAI.

У реальному світі неможливо використовувати цифровий оракул для визначення того, чи відбулося порушення умов кредитування, яке потім спричинить ліквідацію. «6s» та Maker DAO спочатку мають домовитися про тип реальних подій, які можуть спричинити ліквідацію кредиту «6s». Нехай причина ліквідації – порушення умов кредитування із боку «6s». Цифровий оракул не може звернутися до суду та подати позов проти «6s» щодо порушення кредитної угоди. Це може зробити лише особа, яка має право подавати позов до суду від імені Maker DAO, тобто представник Maker DAO в реальному світі. MakerDAO і «6s» можуть домовитися про зобов’язання/вимоги/угоди та зафіксувати ці умови під час голосування токенами DAO, проте ті самі погоджені умови повинні бути потім закріплені в письмовій угоді про кредитну лінію, яку підпише реальна особа від імені та за дорученням Maker DAO.

Отже, для організації кредитної лінії використовуються юридична структура, зображена на рис. 7.9 [150].

![Рисунок 7.9 – Юридична структура кредитування у DAI під заставу RWA](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.9-legal-structure-of-DAI-lending-for-RWA-collateral.png "Рисунок 7.9 – Юридична структура кредитування у DAI під заставу RWA")

Як представник Maker використовується юридична особа, зареєстрована на Кайманових островах. Вона також виконує роль податкового агента (Tax Favorable Entity, TFE), який діє через трастову компанію (Trust).

Усі операції з DAI у світі здійснює представник Maker (TFE) через трастову компанію (Trust).

Кредитна компанія (LendCo) – це кредитор, забезпечений активами в реальному світі. LendCo буде використовувати отримані долари США та свій наявний капітал для надання забезпечених кредитів позичальникам (BorrowCo).

Кредит видається та повертається за такою схемою (див. рис. 7.10) [150]:

1. Нові DAI емітуються на користь TFE.
2. TFE передає DAI до Trust:
    1. TFE відправляє DAI американському брокеру-дилеру на його ether-адресу.
    2. TFE інструктує брокера-дилера обміняти DAI на долари США на трастовому рахунку у брокера-дилера.
    3. TFE інструктує брокера-дилера перевести долари США на банківський рахунок Трастової компанії (Trust).
3. Трастова компанія видає кредитній компанії (LendCo) кредит у доларах США.
4. Кредитна компанія проводить кредитні операції та або погашає позики на користь трастової компанії, або повертає капітал в іншу кредитну транзакцію із обсягом, який затверджує Maker DAO.
5. Кредитна компанія погашає кредит на користь трастової компанії у доларах США. LendCo переказує долари США на рахунок трастової компанії в брокера-дилера та інструктує дилера обміняти долари США на DAI.
6. Трастова компанія повертає DAI TFE на ether-адресу.
7. TFE повертає DAI до сховища Maker, де вони спалюються.

![Рисунок 7.10 – Схема видання та повернення DAI під заставу RWA](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.10-issuing-and-returning-DAI-for-RWA-collateral.jpg "Рисунок 7.10 – Схема видання та повернення DAI під заставу RWA")

Maker DAO контролює та затверджує для кредитної компанії умови за 5 основними напрямками:

1. Сукупна межа боргу (у нашому випадку – 15 млн DAI).
2. Відсоткова ставка (3 %).
3. Мети кредиту (Maker DAO може їх змінити на запит кредитної компанії).
4. Вимоги до застави для кожної угоди кредитної компанії (Maker DAO може їх змінити на запит кредитної компанії).
5. Умови ліквідації.

Maker DAO – новатор і першопрохідник у сфері кредитування під заставу реальних активів, коли stablecoin використовується не всередині криптогалузі, а потрапляє в зовнішній світ. Це дозволяє у нашому прикладі фінансувати будівництво комерційної нерухомості у США.

Для stablecoin DAI проєкти в реальному світі – хороший спосіб підтримувати свою прив’язку до долара США. Якщо DAI стає дешевшим за долар, позичальникам із реального сектора вигідніше погашати кредит у DAI, оскільки вони отримують доходи в реальному світі в реальних доларах США. У протилежному разі позичальникам із реального сектора вигідніше збільшувати обсяг кредиту і, отже, отримувати більше доларів за DAI.

Наступний крок у розвитку кредитування реального сектора за допомогою DAI – угода з «Huntingdon Valley Bank», яку Maker DAO ухвалила 18 квітня 2022 [151]. У перспективі ліміт кредитування цього невеликого американського банку може досягти 1 млрд DAI [152].

Далі розгляньмо важливий з погляду позик процес – ліквідацію застав. Ліквідація – це процес продання застави для покриття суми DAI, яку користувач емітував зі свого сейфа. Ліквідація гарантує, що DAI завжди забезпечений відповідною сумою застави, через закриття сейфів, рівень забезпечення яких нижчий за мінімальний необхідний заставний коефіцієнт для конкретного типу забезпечення.

Сейф (vault) може бути ліквідовано, якщо вартість його застави впаде нижче за мінімальний необхідний рівень, який має назву заставний коефіцієнт (liquidation ratio).

Оскільки система децентралізована, ліквідацію здійснюють треті особи, користувачі системи чи окрема група користувачів, які називаються keepers. Вони викуповують заставу зі знижкою, погашаючи випущені DAI, коли конкретний сейф стає недостатньо забезпеченим.

Оракули Maker DAO надають системі дані про ціни, які використовуються для моніторингу сейфів, і в разі порушення заставного коефіцієнта будь-який keeper може ініціювати ліквідацію сейфа.

Для розрахування заставного коефіцієнта використовується така формула:

Заставний_коефіцієнт = (Сума_застави × Ціна_застави) ÷ Випущені_DAI × 100 %

Наприклад, для сейфа із заставним коефіцієнтом 150 % потрібно щонайменше 1,50 долара заставної вартості на кожен 1 долар випущеного DAI.

Якщо вартість забезпечення впаде до 1,49 долара США (або нижче), воно буде ліквідоване для покриття випущених DAI і штрафу за ліквідацію.

Штраф за ліквідацію (liquidation penalty) – це плата, яку сплачують власники сейфів, коли вартість їхньої застави досягає ціни ліквідації сейфу.

Штраф за ліквідацію додається до загальної суми непогашених DAI, які випустив сейф, коли відбувається ліквідація. Це спричиняє продання більшої частини застави на аукціоні.

Прибутки від штрафів за ліквідацію спрямовуються на поповнення системного надлишку чи спалювання токенів MKR.

Тепер у протоколі Maker DAO використовується версія 2 ліквідації за допомогою голландського аукціону (Dutch auction). Суть цього аукціону в тому, що спочатку оголошується найвища ціна активу, що продається, а далі вона поступово знижується доти, поки перший покупець не погодиться з нею. Після того здійснюється угода [153].

Протокол дозволяє викупати заставу частинами. Таким чином, перший покупець погоджується на викуп частини виставлених на аукціон активів, а після угоди ціна знижується далі, доки заставу не буде викуплено повністю.

На рис. 7.11-А–7.11-Б зображено аукціон з лінійною  функцією зменшення ціни застави в сейфі ETH-A OSM (Oracle Security Module) 200 DAI, buf 20 %, tail (tau) 21600 секунд. У результаті аукціону потрібно продати заставу (lot) 347,32 EТН для погашення 60 000 DAI.

![Рисунок 7.11-А – Аукціон із лінійною функцією зменшення ціни](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-1-auction-with-linear-function-of-price-decrease.png "Рисунок 7.11-А – Аукціон із лінійною функцією зменшення ціни")

![Рисунок 7.11-Б – Аукціон із лінійною функцією зменшення ціни](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-2.png "Рисунок 7.11-Б – Аукціон із лінійною функцією зменшення ціни")

Є два претенденти: Аліса та Боб. Аліса перша готова дати (take) 50 000 DAI в обмін на заставу у розмірі 256,41 ETH за ціною 195 DAI за ETH (рис. 7.11-В).

![Рисунок 7.11-В – Аукціон із лінійною функцією зменшення ціни](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-3.png "Рисунок 7.11-В – Аукціон із лінійною функцією зменшення ціни")

Ціна ETH з часом знижується більше, і Боб забирає 90,91 ETH, що залишилися, в обмін на 10 000 DAI за ціною 110 DAI за ETH (рис. 7.11-Г–7.11-Д).

![Рисунок 7.11-Г – Аукціон із лінійною функцією зменшення ціни](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-4.png "Рисунок 7.11-Г – Аукціон із лінійною функцією зменшення ціни")

![Рисунок 7.11-Д – Аукціон із лінійною функцією зменшення ціни](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-5.png "Рисунок 7.11-Д – Аукціон із лінійною функцією зменшення ціни")

Якщо з моменту початку аукціону пройшло більш ніж 21600 секунд або якщо ціна впала нижче за встановлений мінімум, то аукціон необхідно буде скинути й почати спочатку [154].

Протокол Maker DAO передбачає так зване аварійне вимкнення системи (emergency shutdown), яке забезпечує дві основні цілі. По-перше, воно використовується під час надзвичайних ситуацій як останній із можливих механізмів захищення системи від атак на її інфраструктуру й атаки на цільову ціну DAI. Надзвичайні ситуації можуть включати атаки на механізм керування системою, зламання коду, порушення безпеки та довгострокову ірраціональність на ринку. По-друге, аварійне вимкнення системи можна використовувати для оновлення протоколу Maker DAO. Процес вимкнення може контролювати лише система керування (Maker Governance).

Держателі токенів MKR також можуть миттєво запустити аварійне вимкнення системи через внесення 50000 токенів MKR у відповідний модуль системи (ESM). Щойно користувачі вносять MKR у модуль аварійного вимкнення, токени негайно спалюються [155]. Це запобігає затримці аварійного вимкнення з боку модуля безпеки системи керування (Governance Security Module). Щойно необхідний кворум голосування токенами MKR за вимкнення досягнуто, система вимикається без затримки.

Аварійне вимкнення складається з трьох фаз [132]:

1. Система Maker DAO закривається, власники сейфів забирають свої гроші. Після запуску аварійного вимкнення системи запобігається подальше створення нових сейфів й операції з наявними сейфами, заморожуються цінові оракули. Заморожені цінові показники активів дозволяють гарантувати, що всі користувачі зможуть відкликати чисту вартість своїх активів, на яку вони мають право. Фактично цей захід дозволяє власникам сейфів негайно відкликати надлишкові застави в сейфах, які не використовуються для забезпечення боргів у випущених DAI.
2. Обробляються аукціони із продажу застав після аварійного вимкнення системи. Після запуску системи всі заставні аукціони має бути завершено протягом визначеної кількості часу. Цей період часу система керування задає як трохи довше значення, ніж тривалість найдовшого заставного аукціону. Це гарантує, що наприкінці періоду оброблення аукціонів не буде незавершених аукціонів.
3. Власники DAI забирають решту застав. Наприкінці періоду оброблення аукціонів власники DAI використовують свої DAI, щоби викупити застави за фіксованою ставкою, яка відповідає розрахунковій вартості активів на основі цільової ціни DAI. Наприклад, якщо відношення ціни ETH/USD становить 200, а користувач має 1000 DAI за цільовою ціною 1 долар США, за активації аварійного вимкнення системи користувач зможе претендувати на 5 ETH із Maker DAO після періоду оброблення аукціонів. Період часу, коли може бути обміняно DAI на заставні активи, не обмежується. Власники DAI отримують пропорційні частки з кожної застави, яка є у забезпеченні портфеля. Держателі DAI можуть ризикувати втратити частину застави, унаслідок чого вони не отримають повну вартість своїх DAI за цільовою ціною 1 долар США за DAI. Так може статися через те, що власники сейфів, які мають право забирати надлишкову заставу першими, забрали її й частини застав, що залишилася, не досить для повного покриття вимог держателів DAI.

Далі розгляньмо протокол FRAX. Цей протокол відноситься до категорії так званих алгоритмічних stablecoins. Основне завдання, яке вирішує протокол FRAX, – забезпечення стійкості механізму прив’язання вартості за неповного забезпечення. Станом на 4 липня 2022 року забезпеченість stablecoin FRAX за допомогою USDC становить 90 % (див. рис. 7.12) [156].

![Рисунок 7.12 – Графік забезпеченості FRAX за допомогою USDC](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.12-FRAX-collateralization-with-USDC.png "Рисунок 7.12 – Графік забезпеченості FRAX за допомогою USDC")

Мінімальне значення забезпечення (заставний коефіцієнт) становив 82 % у жовтні 2021 року. Забезпеченням (заставою) для випускання FRAX є інший stablecoin – USDC. Таким чином, у поточних умовах на 1 FRAX припадає 0,9 USDC і 0,1 Frax Shares (FXS). FXS – це волатильний токен, що є керувальним для екосистеми FRAX.

Простіше кажучи, FRAX дозволяє на 900 USDC випустити 1000 FRAX, у такий спосіб отримавши премію в розмірі 100 FRAX. Очевидно, що, якщо FRAX досягне 100 % забезпечення, не буде економічного сенсу конвертувати, наприклад, 1000 USDC в 1000 FRAX і платити комісію за конвертацію.

Спрощено протокол FRAX працює так (див. рис. 7.13) [157]:

* Коли ціна 1 FRAX перевищує 1 долар США (наприклад 1,01), будь-хто охочий може покласти в систему забезпечення у формі USDC згідно з поточним заставним коефіцієнтом 0,9 USDC і токен FXS на суму 0,1 долара й отримати натомість 1 FRAX. Тобто можливий арбітраж, коли віддаються активи в сумі 1 долар, а отримується натомість актив у сумі 1,01 долара. Водночас FXS, який отримала система, спалюється, а в обіг додатково випускається 1 FRAX. Крім того, щогодини заставний коефіцієнт знижується на 0,25 % [158].
* Коли ціна 1 FRAX менша за 1 долар США (наприклад 0.99), будь-хто охочий може обміняти в системі 1 FRAX на активи з сумарною вартістю 1 долар США у формі забезпечення USDC і токена FXS, який емітується в момент обміняння системою. Таким чином, знову можливий арбітраж, коли віддається актив із вартістю 0,99 долара на актив із вартістю 1 долар. Водночас вилучається з обігу та спалюється 1 FRAX. Крім того, щогодини заставний коефіцієнт підвищується на 0,25 % [158].

![Рисунок 7.13 – Модель емісії та погашення FRAX](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.13-model-of-FRAX-minting-and-redeeming.png "Рисунок 7.13 – Модель емісії та погашення FRAX")

В емісії та погашенні stablecoin беруть участь 4 компоненти: сам FRAX, забезпечення у формі USDC, волатильний токен FXS і заставний коефіцієнт, що визначає кількості USDC і FXS за емісії та погашенні FRAX [157]. Загальна формула емісії така:

$F=YP_{Y}+ZP_{Z}$

де _F_ – кількість новоемітованих токенів FRAX,
_Y_ – кількість токенів застави, що передається системі,
_P<sub>Y</sub>_ – ціна в доларах одного токена застави,
_Z_ – кількість токенів FXS, що спалюється,
_P<sub>Z</sub>_ – ціна в доларах одного токена FXS.

Значення _Z_ може бути розраховано з такого рівняння:

$(1-R_{Y})YP_{Y}=R_{Y}ZP_{Z}$

де _C<sub>r</sub>_ – заставний коефіцієнт.

Нехай маємо заставний коефіцієнт 50 %, 220 USDC ($0,9995/USDC) і токени FXS з ціною $3,50/FXS. Визначмо кількість FRAX, які ми можемо випустити в обіг. Спочатку обчислімо кількість FXS, які необхідно спалити для випуску FRAX:

$(1-0.5) \cdot 220 \cdot 0.9995=0.5 \cdot Z \cdot 3.5$;  
$Z=62.54$.
Тепер обчислімо обсяг емісії FRAX:
$F=220 \cdot 0.9995+62.54 \cdot 3.5$;  
$F=437.78$.

У разі погашення FRAX діє така формула [157]:

$Y= \frac{FC_{r}}{P_{Y}}$

де _Y_ – кількість токенів забезпечення, що одержується за погашення FRAX,
_F_ – кількість токенів FRAX, що погашається,
_C<sub>r</sub>_ – заставний коефіцієнт,
_P<sub>Y</sub>_ – ціна в доларах одного токена застави.

Разом із поверненням токенів застави система емітує токени FXS за такою формулою:

$Z= \frac{F(1-C_{r})}{P_{Z}}$

де _Z_ – кількість емітованих токенів FXS,
_F_ – кількість токенів FRAX, що погашається,
_C<sub>r</sub>_ – заставний коефіцієнт,
_P<sub>z</sub>_ – ціна в доларах одного токена FXS.

Наприклад, при погашенні 170 FRAX із заставним коефіцієнтом 65 %, цінами $1,00/USDC і $3.75/FXS користувач отримає таку кількість токенів:

$Y= \frac{170 \cdot 0.65}{1} =110.5$;  
$Z= \frac{170 \cdot (1-0.65)}{3.75} =15.867$.

veFXS – це система блокування за часом токенів FXS, основана на механізмі veCRV Curve. Користувачі можуть заблокувати свої FXS на термін до 4 років й отримати вчетверо більшу суму veFXS (наприклад заблокувати 100 FXS на 4 роки й отримати 400 veFXS). veFXS – токен, який не передається та не перебуває в обігу на ліквідних ринках. Це більше схоже на систему балів на основі облікового запису, що фіксує тривалість блокування певної кількості токенів FXS в рамках протоколу.

Баланс veFXS лінійно зменшується з наближенням терміну дії блокування токенів і досягає 1 veFXS за 1 FXS за нульового залишку часу блокування. Це заохочує довгострокові інтереси учасників спільноти.

Кожний veFXS має 1 голос у пропозиціях щодо керування системою. Розміщення 1 FXS на максимальний час 4 роки веде до отримання 4 veFXS і, отже, збільшує кількість голосів у 4 рази. Користувач також може збільшити свій баланс veFXS, заблокувавши FXS, подовживши термін блокування або зробивши обидві дії. Відзначмо, що veFXS неможливо передати і що кожен обліковий запис може мати лише один термін блокування. Це означає, що один обліковий запис не може заблокувати одну частину токенів FXS на 2 роки, а іншу частину – на 3 роки й т. ін.

Основні одержувачі доходу від роботи Frax – держателі veFXS. Прибуток, отриманий від т. зв. контролерів AMO (Algorithmic Market Operations controllers), розподіляється серед власників veFXS як дохід [159].

Контролери AMO з’явилися у версії 2 протоколу Frax​​. Кожен модуль AMO – це автономний смарт-контракт (смарт-контракти), який проводить власні ринкові операції й не впливає на прив’язку FRAX до долара США. Це означає, що контролери AMO можуть виконувати операції на відкритому ринку алгоритмічно, але вони не можуть довільно емітувати нічим не забезпечені FRAX і в такий спосіб «ламати» прив’язку до долара [160].

Кожен контролер AMO повинен відповідати чотирьом основним критеріям:

1. Деколатералізація – частина стратегії, що знижує заставний коефіцієнт.
2. Ринкові операції – частина стратегії, що працює у рівновазі та не змінює заставний коефіцієнт.
3. Реколатералізація – частина стратегії, яка збільшує заставний коефіцієнт.
4. FXS1559 – облік балансу AMO, який точно визначає, скільки FXS може бути спалено з прибутком, вищим за цільовий заставний коефіцієнт.

Якщо ціна FRAX вища за ціну USD, заставний коефіцієнт зменшується, пропозиція FRAX збільшується як зазвичай, а контролери AMO працюють далі. Якщо заставний коефіцієнт зменшується до значення, за якого прив’язка до долара втрачається, контролери AMO зупиняють всі ринкові операції, система починає реколатеризацію, оскільки FRAX викуповується, а заставний коефіцієнт збільшується, щоби відновити прив’язку. Це дозволяє всім контролерам AMO працювати з урахуванням природних ринкових сил так само, як механізм Frax версії 1.

Будь-який користувач може запропонувати контролер AMO. Запропонований контролер буде інтегровано в екосистему FRAX, якщо система керування його схвалить.

Робота системи дозволяє отримати прибуток від роботи модулів AMO. Спочатку було запропоновано регулярно викуповувати та спалювати FXS на суму накопичених надлишків. У жовтні 2021 року більшістю голосів керування системою було ухвалено рішення про спрямування всього прибутку держателям токенів veFXS [161].

Що більший дохід, який виплачується за veFXS, то більший попит на FXS та більша кількість учасників екосистеми, зацікавлених у довгострокових результатах роботи системи.

Система Frax запустила свій метапул ліквідності FRAX3CRV на протоколі Curve [162]. Це означає, що власна адреса Frax має права адміністратора для цього метапулу Curve, що дозволяє контролеру AMO Curve встановлювати та стягувати адміністративні збори на користь держателів FXS. Модуль AMO може переміщати вільне забезпечення USDC або новоемітовані токени FRAX у свій власний пул Curve, щоби створити ще більшу ліквідність й отримати додатковий дохід, поліпшивши прив’язку до долара.

Загальна стратегія контролера AMO передбачає таку оптимізацію мінімальної пропозиції FRAX _Y_, щоби продання всієї суми _Y_ відразу в пул Curve з _Z_ TVL і коефіцієнтом посилення _A_ вплинуло би на ціну FRAX менш ніж на _X_ %, де _X_ – чутливість діапазону заставного коефіцієнта. Тобто модуль AMO Curve може помістити додаткову ліквідність FRAX+USDC у власний метапул Curve. Оскільки система ініціює реколатералізацію, коли ціна FRAX стає меншою за 0,99 долара, деяку кількість FRAX можливо продати безпосередньо в пул Curve до того, як ціна FRAX зменшиться на 1 %. Система Frax може мати принаймні таку кількість алгоритмічних FRAX в обігу на відкритому ринку, оскільки продання цієї кількості відразу в TVL метапула Curve не вплине на ціну настільки, щоби викликати зміну заставного коефіцієнта. Ці суми доволі великі, якщо врахувати потенціал відхилення курсів stablecoins у метапулі Curve. Наприклад, 330-мільйонний FRAX3Pool (за умови збалансованості базового пулу 3Pool) може підтримувати щонайменше 39,2-мільйонний ордер на продаж FRAX без зміни ціни більш ніж на 0,01 долара. Якщо поріг зміни заставного коефіцієнта становить 1 %, система може мати щонайменше 39,2 млн вільних алгоритмічних FRAX на відкритому ринку, не втрачаючи прив’язку до долара США [163].

Крім того, Curve розподіляє власні токени CRV як винагороду постачальникам ліквідності в метапули. Оскільки Frax – найбільший постачальник ліквідності в пулі FRAX3CRV, він може направити всі свої LP-токени FRAX3CRV на отримання додаткового доходу у формі CRV токенів, які, зі свого боку, можуть використовуватися для впливу на рішення, які ухвалюються в межах протоколу Curve.

Для отримання додаткового доходу токени ліквідності Curve розміщені у системі Convex станом на липень 2022 року (рис. 7.14) [164].

![Рисунок 7.14 – Розподіл активів в Curve AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.14-assets-allocation-in-Curve-AMO-and-in-Convex-AMO.png "Рисунок 7.14 – Розподіл активів в Curve AMO")

Liquidity AMO розміщує FRAX та/або USDC на інших децентралізованих біржах, відмінних від Curve. Роботу цього контролера AMO можна описати 4 пунктами:

1. Деколатералізація – депонування вільної застави та новоемітованих FRAX у пари ліквідності децентралізованих бірж (наприклад Uniswap версії 3).
2. Ринкові операції – збирання комісії за транзакції обміняння токенів на децентралізованих біржах.
3. Реколатералізація – виводження коштів із пулів ліквідності децентралізованих бірж із подальшим спалюванням FRAX та/або поверненням USDC для збільшення заставного коефіцієнта.
4. FXS1559 – щоденне збирання комісій за транзакції та використання їх згідно з FXS1559.

Liquidity AMO, як-от Uniswap версії 3, може емітувати та розміщувати FRAX у пулах ліквідності з іншими stablecoins. Це забезпечує ліквідність для інших stablecoins, які можна обміняти на FRAX. Крім того, Liquidity AMO може періодично викликати функцію зібрання комісій для отримання прибутку від операцій обміняння в пулах ліквідності. Діаграма розподілу відповідних активів на момент липня 2022 наведена на рис. 7.15 [164].

![Рисунок 7.15 – Розподіл активів у Liquidity AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.15-assets-distribution-in-Liquidity-AMO.png "Рисунок 7.15 – Розподіл активів у Liquidity AMO")

Investor AMO дозволяє отримувати дохід завдяки реінвестуванню вільних цифрових активів, що має система Frax. Спочатку за допомогою цього контролера інвестувалися USDC в систему Yearn; пізніше також стало можливим інвестувати в системи AAVE, Compound й інші.

Основна умова роботи цього контролера AMO – можливість в будь-який момент часу вилучити вкладені активи та за потреби спрямувати їх на реколатералізацію. З цієї причини кошти, розміщені через Investor AMO, не враховуються під час визначення заставного коефіцієнта.

Усі кошти, зароблені через контролер, витрачаються згідно з FXS1559. Розподіл коштів станом на липень 2022 показано на рис. 7.16 [164].

![Рисунок 7.16 – Розподіл активів ув Investor AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.16-assets-distribution-in-Investor-AMO.png "Рисунок 7.16 – Розподіл активів ув Investor AMO")

Як видно на рис. 7.16, найбільший прибуток отримано у формі токенів vlCVX, які система отримує від операцій у Curve і використовує для отримання доходу в Convex, а також для голосування щодо перерозподілення доходів між пулами Curve.

Lending AMO випускає FRAX у лендингових системах, як-от Compound, AAVE чи CREAM. Механізм емісії FRAX схожий на механізм роботи модуля D3M у протоколі Maker DAO: це додатковий спосіб емітування токенів FRAX під заставу інших цифрових активів, наявних у лендингових системах.

Такий додатковий механізм емісії допустимий, оскільки на лендингових платформах FRAX завжди випускається з надлишковою заставою та це не зменшує заставний коефіцієнт, який встановлює протокол.

Для активів, що видаються в кредит, лендингові платформи використовують динамічну відсоткову ставку, яка залежить від частки використання пулу ліквідності. Таким чином, що вищий відсоток пулу ліквідності того чи іншого активу, виданого в кредит, то більшу ціну за цей актив сплачують позичальники. Зважаючи на задану в контролері цільову ставку, протокол Frax може емітувати додаткові FRAX в пул ліквідності або вилучати надану ліквідність, щоби запобігати різким стрибкам ціни запозичення FRAX і забезпечувати дешевшу вартість запозичення, ніж вартість запозичення конкурентних stablecoins.

Весь отриманий відсотковий дохід система витрачає згідно з FXS1559. Відповідний розподіл активів станом на липень 2022 показано на рис. 7.17 [164].

![Рисунок 7.17 – Розподіл активів в Lending AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.17-assets-distribution-in-Lending-AMO.png "Рисунок 7.17 – Розподіл активів в Lending AMO")

Розгляньмо ризики системи Frax. FXS розроблено як додатковий токен, що вміщує вартість системи та забезпечення stablecoins. Frax спрямовує прибуток, отриманий від сеньйоражу (доходу, який емітент одержує від емісії коштів і присвоює за правом власності), безпосередньо в токен FXS.

Основний ризик такої моделі – спіраль смерті (death spiral). Суть цього феномена добре проілюстрована на прикладі іншого stablecoin UST (протокол Terra). За масових продажів,  викликаних атакою або загальним падінням активу на ринку, stablecoin відв’язується від долара США. Через це стає вигідним спалювати FRAX за ціною, наприклад, 0,98 долара й отримувати USDC та FXS з сумарною вартістю 1 долар (тобто отримувати фактично 0,02 долара прибутку). Розгортання спіралі смерті полягає в тому, що ціна FXS зменшується так швидко, що стає неможливим зафіксувати прибуток від спалювання FRAX. Нехай у момент часу _X_ обмін FRAX на USDC + FXS має сенс і виходить прибуток 0,02 долара. Однак у пізніший момент часу _X_', коли потрібно зафіксувати прибуток, продавши FXS, може вийти збиток 0,01 долара. У цій ситуації FRAX не спалюються та не виводяться з обігу, відвʼязка збільшується, ціна FXS стрімко зменшується й вартості обох активів наближається до нуля. Саме це сталося з токенами UST та LUNA в травні 2022 року.

На щастя, у системі Frax за частки забезпечення 90 % навряд чи можливе більше зменшення ціни FRAX, ніж до 0,9 USD, тому що завжди за 1 FRAX можна буде отримати 0,9 USDC, навіть якщо вартість FXS опуститься до нуля. Утім, згідно з певними розрахунками фактичне забезпечення FRAX становить не 90 %, а 80 % через кошти самої системи, вкладені в пули ліквідності [165]. Крім того, зацікавлення в проєкті здебільшого тримається завдяки програмам фармінгу FXS, які роздаються як додаткова винагорода в різних пулах ліквідності [166]. Таким чином, довгостроковий успіх системи Frax залежить від її здатності набрати критичну масу та віднайти реальне застосування до моменту, коли вичерпаються джерела штучного стимулювання учасників через роздавання FXS.

Ще одний суттєвий ризик – ​​повна залежність системи від USDC. Як відомо, USDC – це централізований stablecoin, так що в будь-яку мить може бути заблоковано будь-яку адресу на розсуд власника цієї системи. Таким чином, блокування адрес системи Frax, на яких зберігається застава USDC, спричинило би негайний крах системи. Те саме відбулося б у разі відв’язання самого USDC від долара США.

Далі розгляньмо протокол синтетичних активів Synthetix. Основний актив системи, запущеної на цьому протоколі, – stablecoin sUSD. Наступні за обсягом активи – sETH і sBTC. Актив вважається синтетичним, якщо він забезпечений не реальним активом, а лише токеном SNX системи. Протокол Synthetix схожий на Maker DAO в тому сенсі, що в обох протоколах stablecoins випускаються під заставу цифрового активу, проте в протоколі Synthetix як заставу можна використовувати виключно власний токен SNX.

Відзначмо, що ця система працює як повноцінна децентралізована організація (DAO) і всі рішення ухвалюються голосуванням власників токена SNX.

Станом на липень 2022 року сумарно в обігу перебуває понад 100 млн sUSD [167]. Основний механізм емісії нових sUSD працює через так званий стейкінґ-портал Synthetix [168]. Для випущення sUSD необхідно мати токени SNX в одній із двох облікових систем: в Ethereum або в Optimistic Ethereum. Опція з другошарним протоколом Optimistic Ethereum з’явилася через необхідність здешевити вартість транзакцій емітування, погашення й отримання винагород в екосистемі Synthetix.

Рішенням DAO встановлюється заставний коефіцієнт C-Ratio. Станом на липень 2022 року, якщо цей коефіцієнт перевищує 400 % (тобто на 1 випущений sUSD в заставі перебуває SNX на 4 долари), користувач має право отримувати винагороду один раз на тиждень – щосереди в проміжку 20:00–21:00 за Києвом. Винагорода виплачується у формі токенів SNX та sUSD. SNX для винагороди випускає система, причому ці токени стають доступними для обмінювання тільки через 12 місяців після їх отримання. До тієї миті винагородні SNX можуть використовуватися тільки як застава для випускання sUSD. Друга частина щотижневої винагороди – токени sUSD – доступна відразу та є комісією, яка перерозподіляється з платформ, на яких перебувають ув обігу синтетичні активи: «Kwenta Futures», «Lyra Options», «Kwenta Spot», «Curve Cross-Asset Swaps» тощо.

Якщо значення C-Ratio стає нижчим за 400 %, то забрати вже нараховану винагороду неможливо та нова винагорода не виплачується. Якщо нараховану винагороду не забрати протягом тижня після її нарахування, то після настання наступного періоду виплат попередня винагорода втрачається. Таким чином, слід щотижня здійснювати транзакцію забрання (claim) нарахованих винагород. Ця особливість частково зумовила перехід протоколу на стейкінґ і випускання sUSD в обліковій системі Optimistic Ethereum, де комісія за транзакції менша.

Для збільшення C-Ratio є два способи: купування додаткових токенів SNX і спалювання токенів sUSD. Позиція примусово ліквідується через 12 годин після зниження C-Ratio до менш ніж 150 % [169]. Водночас стягується штраф у розмірі 30 %, який перерозподіляється як окремий вид винагороди між усіма стейкерами SNX.

Відзначмо, що, на відміну від багатьох інших протоколів, непотрібно відправляти токени SNX до якогось окремого контракту, щоби їх внести до стейку. Факт перебування токенів на вашій адресі означає їх внесення до стейку, щойно ви емітували ту чи іншу кількість sUSD.

Крім sUSD, система Synthetix дозволяє купувати sBTC, sETH і низку інших синтетичних цифрових активів. Основне застосування синтетичних цифрових активів – це їх використання в коротких продажах (short) заради заробітку на зміні вартості несинтетичного активу (наприклад ETH).

Для проведення короткого продажу використовується платформа «KWENTA». Припустімо, Аліса хоче здійснити короткий продаж 1 sETH, який для нашого прикладу умовно коштує 1000 доларів.

Аліса вносить 3000 sUSD і позичає 1 sETH на платформі «KWENTA». Позиковий sETH автоматично продається за 1000 доларів США, які повертаються Алісі на її рахунок. Щоби повернути заставу, їй слід купити та повернути 1 sETH. Проаналізуймо, як зміна ціни sETH вплине на її прибуток.

Після короткого продажу Аліса має 1000 доларів США у своєму гаманці та винна системі 1 sETH. Якщо ціна sETH зменшиться до 900 доларів, Аліса, викупивши 1 sETH, матиме прибуток в розмірі 100 USD. Однак якщо ціна sETH збільшиться до 1100 доларів, вона втратить 100 USD. Отже, Аліса заробляє на падінні активу.

Якщо ціна sETH далі зростатиме, позиції Аліси загрожуватиме ліквідація. Коли Аліса відкрила коротку позицію, вона заблокувала 3000 долларов США для продажу 1 sETH. Це означає, що її C-Ratio дорівнює 300 %. Механізм ліквідації запускається після зменшення C-Ratio до менш ніж 120 %, тому, якщо ціна sETH зросте до 2500 доларів, коротка позиція Аліси буде ліквідована.

Загалом нині функціонування коротких позицій регулюється згідно з SIP-103 [170]. Відзначмо, що відкрити коротку позицію можна тільки з використанням sUSD – активу, на якому побудована вся екосистема Synthetix.

Ще одна перевага протоколу Synthetix полягає в тому, що sBTC, sETH й інші синтетичні активи купуються за sUSD без прослизання (slippage), яке характерне для операцій на децентралізованих біржах. Протокол дозволяє здійснювати такі купівлі та продажі на основі цін, які передають в систему цінові оракули. Схему цього процесу зображено на рис. 7.18-А–7.18-Б [171].

![Рисунок 7.18-А – Схема роботи протоколу Synthetix](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.18-1-Synthetix-protocol-operation.png "Рисунок 7.18-А – Схема роботи протоколу Synthetix")

![Рисунок 7.18-А – Схема роботи протоколу Synthetix](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.18-2.png "Рисунок 7.18-А – Схема роботи протоколу Synthetix")

Мабуть, найбільш ризикованим був проєкт Terra, який мав на меті створити алгоритмічний stablecoin узагалі без забезпечення. Формально токен UST був забезпечений іншим токеном – LUNA. Насправді же токен LUNA не був забезпечений нічим, окрім віри в те, що крах системи неможливий. У травні 2022 року LUNA потрапив до т. зв. спіралі смерті. Ціна UST зменшилася з 1 долара до кількох центів, а ті, хто раніше володіли кількостями LUNA на мільйони доларів, залишилися з кількома сотнями доларів.

Розберімо докладніше, як проєкт потрапив у спіраль смерті. Механізм забезпечення UST дуже схожий на те, як працює Frax. Утім, на відміну від Frax, де частка алгоритмічного забезпечення у формі FXS становить лише 10–20 %, у системі Terra частка алгоритмічного забезпечення становила 100 %.

За задумом проєкту, за відхилення вартості UST від 1 долара США можливий арбітраж через куплення UST за ціною 0,99 долара США й обміняння на LUNA з вартістю 1 долар США (унаслідок цього виходить прибуток 0,01 долара США). Ця модель працює доти, поки швидкість зменшення курсу LUNA не перевищує швидкість відв’язування UST. Якщо після обміну UST на LUNA та перед фіксацією прибутку в доларах США курс LUNA зменшився до 0,98 долара США, підтримування курсу UST через його спалення й обміняння на LUNA втрачає економічний сенс. Це і є спіраль смерті: подальші спроби стабілізувати курс штатними методами протоколу спричиняють знецінення і UST, і LUNA.


### Підсумки про stablecoins

Випадок із проєктом Terra наочно показав, що практично створювати (емітувати) активи з повітря може лише Федеральна резервна система США. Усім іншим алгоритмам та протоколам доводиться передбачати в ролі забезпечення або вже надруковані долари США (як в USDT, USDC), або якісь наявні цифрові активи (як у Maker DAO). Відзначмо, що вважати  систему Maker DAO надлишково забезпеченою (overcollateralized) безпідставно: що більш волатильний щодо долара США актив-забезпечення, то більший заставний коефіцієнт. Якщо токенізований долар емітується на основі фіатного долара, очевидно, заставний коефіцієнт становить 100 %; якщо stablecoin емітується на основі волатильного цифрового активу, заставний коефіцієнт становить 130 % або більше, тому що потрібен буфер, який дозволяє за різкого знецінення забезпечення ліквідувати позицію та повернути виданий у stablecoins кредит.

Frax умовно можна назвати системою, що емітує stablecoin на основі долара: FRAX на 90 % забезпечений USDC. Решта 10 % забезпечують здатність системи заробляти та накопичувати внутрішню вартість із плином часу.

Протокол Synthetix можна вважати прийнятним винятком. Як забезпечення він використовує власний токен SNX, але водночас, по-перше, стимулює тримати рівень забезпечення не менш ніж 400 % і, по-друге, створив екосистему похідних фінансових інструментів, у якій sUSD – одна лише допустима застава. Сфера застосування sUSD сильно обмежена внутрішньою потребою системи розміщувати заставу на платформі «KWENTA». Отже, sUSD – це приклад stablecoin, який випущений під конкретні потреби створеної екосистеми та має обмежений обіг.

Експерименти зі stablecoins тривають. Заслуговують на увагу оголошення про випущення власних stablecoins у системах AAVE та Curve. З огляду на відключення модуля D3M Maker DAO від AAVE, запущення власного stablecoin – цілком природний крок для AAVE, оскільки всередині цієї системи заблоковано активи на мільярди доларів США. Те саме стосується Curve, бізнес-модель якого принципово побудована на пулах ліквідності для обмінювання одних stablecoins на інші.

Компанія «Distributed Lab» розробила свій лендинговий протокол DL DeFi Core з інтегрованим stablecoin. Модель, яка використана в DL DeFi Core, дозволяє збирати в пули ліквідності віртуальні цифрові активи та емітувати stablecoin із заставним коефіцієнтом, заданим щодо сумарного обсягу розміщеної в системі застави. Цей підхід, зокрема, перевершує можливості Maker DAO, яка давно використовує ту саму модель, але емітує DAI під кожний із заставних активів окремо з різними заставними коефіцієнтами та параметрами ліквідації позиції. Таким чином, DL DeFi Core, на відміну від Maker DAO, дозволяє поліпшувати заставний коефіцієнт, розміщуючи в системі як заставу будь-який допустимий актив, й уникати примусової ліквідації позиції.


## 7.3 Огляд DeFi-протоколів

У світі є багато фінансових інструментів, які створювалися і вдосконалювалися десятками років: кредитування, деривативи, біржі. Водночас із недавнім, але стрімким розвитком децентралізованих технологій вони почали поступово з’являтися в децентралізованому середовищі та набувати нової форми. Для екосистеми, що зароджувалася, навіть було придумано збірний акронім DeFi, що походить від терміна «децентралізовані фінанси» (decentralized finance). DeFi охоплює низку проєктів, технологій і фінансових інструментів, що наявні тільки в децентралізованих облікових системах.

Основні компоненти екосистеми DeFi, які буде розглянуто далі:

* Децентралізовані біржі;
* Децентралізовані протоколи кредитування та позичання;
* Stablecoins;
* Похідні фінансові інструменти (деривативи);
* Yield-агрегатори;
* DEX-агрегатори.


### Протоколи децентралізованих бірж

В підрозділі 1.4 цієї книги було розглянуто технології децентралізованих бірж. Усіх їх об’єднує однаковий принцип роботи: зіставлення ордерів відбувається з використанням order book, обмінювання активів здійснюється peer-to-peer, а ціна активів формується off-chain.

Далі буде розглянуто децентралізовані біржі, побудовані на основі automated market maker (AMM). AMM – це механізм, що дозволяє здійснювати ціноутворення on-chain. Для цього під кожну пару активів створюється спеціальний смарт-контракт (смарт-контракт пулу ліквідності), який слугує як котловий рахунок, а також розраховує ціни за допомогою формул, що враховують попит та пропонування. Крім того, після кожного обмінення одного активу на інший визначається нове відношення цін.

Як наслідок, кожен користувач може взаємодіяти безпосередньо зі смарт-контрактом пулу ліквідності, а не з конкретними ордерами від контрагентів. Приклади таких бірж – Uniswap і Curve. Розгляньмо ці 2 біржі докладніше.


### Протокол Uniswap

Uniswap – це протокол децентралізованого обміну, розгорнутий у системі Ethereum. Саме Uniswap став доказом концепції децентралізованих бірж на основі AMM, яку описав Віталік Бутерін (Vitalik Buterin) [172]. Першу реалізацію запропонував Гейден Адамс (Hayden Adams), який на момент подання своєї пропозиції хотів попрактикуватися в розроблянні на Solidity, а зрештою отримав грант від Ethereum Foundation [173].

На цю мить є 3 версії протоколу. Розгляньмо кожну з них докладніше.

Почнімо з Uniswap V1. Цей протокол містить такі основні компоненти [174]:

* Біржові смарт-контракти, які реалізують контракт пулу ліквідності для пари ERC20-токена й ETH. Такий підхід дозволяє обмінювати будь-які токени стандарту ERC20, використовуючи ETH як проміжний актив. Відношення цін між токеном й ETH визначається за формулою, заданою в біржовому смарт-контракті [175].
* Factory – смарт-контракт, який дозволяє створювати нові біржові смарт-контракти. Також є публічним реєстром усіх доступних біржових смарт-контрактів.

Тепер розглянемо, що доступне користувачам у першій версії протоколу.

Насамперед, як відбувається надання ліквідності? Кожен користувач може вкласти свої ERC20-токени, а також еквівалентну їм кількість ETH до пулу ліквідності за поточним курсом пула. В обмін на вкладені токени користувач отримує від системи кількість LP-токенів, яка відповідає його вкладу (також їх часто називають liquidity provider tokens) [176].

Навіщо це потрібно? У найпростішому випадку, якщо система хоче забезпечити рівномірний поділ винагороди від обмінів між усіма постачальниками ліквідності, вона має створити величезну кількість окремих транзакцій. Очевидно, що розмір винагород не покриє комісії за нові транзакції. Тому винагороди накопичується на адресі смарт-контракту, а потім лише на запит користувача кошти виводяться разом із наданою ліквідністю.

Описаний механізм працює за принципом постійного збільшення курсу між LP-токенами та базовим активом. Сама зміна курсу розраховується на основі усіх комісій за позичення,  які надійшли в систему. Принцип роботи протоколу можна побачити на рис. 7.19 [181].

![Рисунок 7.19 – Схема роботи протоколу Uniswap](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.19-Uniswap-protocol-operation.png "Рисунок 7.19 – Схема роботи протоколу Uniswap")

Також кожен охочий користувач може здійснити обмін, сплативши комісію. У протоколі Uniswap V1 обмін може бути двох видів:

* ERC20-токен на ETH;
* ERC20-токен на інший ERC20-токен.

Розглянемо, як розраховується ціна обміну. Важливо, що відношення цін перераховується смарт-контрактом щоразу після виконання обміну. Головне правило, за яким визначається відношення цін двох активів, описується так: коли в пулі ліквідності стає активу _X_ більше, а активу _Y_ менше, це означає, що попит на актив _Y_ стає більшим і його ціна відносно активу _X_ збільшується.

З математичного погляду цей механізм описується таким інваріантом: $x * y = k$, де _k_ – стала величина. (У цьому контексті інваріант – це вираз, якому властива незмінність.) Це означає, що незалежно від змінень кількості кожного активу в пулі ліквідності добуток їхніх кількостей має бути незмінним. Такий підхід гарантує наявність ліквідності в пулі. Схему ціноутворення Uniswap зображено на рис. 7.20 [181].

![Рисунок 7.20 – Ціноутворення в Uniswap](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.20-pricing-in-Uniswap.png "Рисунок 7.20 – Ціноутворення в Uniswap")

Розгляньмо на прикладі, як змінюватиметься курс унаслідок обмінення двох активів. Для цього застосуймо такі позначення:

_x_ – кількість одиниць активу _X_ у пулі ліквідності;
_y_ – кількість одиниць активу _Y_ у пулі ліквідності;
_Δx_ – кількість одиниць проданого активу;
_Δy_ – кількість одиниць купленого активу;
_x_' – кількість одиниць активу _X_ у пулі ліквідності після укладення угоди;
_y_' – кількість одиниць активу _Y_ у пулі ліквідності після укладення угоди.
Головне правило, яке визначає ціну активу, має такий вигляд:

$xy=(x+Δx)(y-Δy)$

Тоді кількість токенів, що залишилася в пулі ліквідності, розраховується за такими формулами:

$x'=x+Δx=x(1+α)= \frac{x}{1-β}$, 
$y'=y-Δy= \frac{y}{1+α} =y(1-β)$

де $α= \frac{Δx}{x}$, $β= \frac{Δy}{y}$. 

Водночас можна вивести формули вартості обмінення деякої кількості токенів _X_ на токени _Y_:

$Δx= \frac{xβ}{1-β}$, $Δy= \frac{yα}{1+α}$.

Крім цього, для здійснення обміну користувач зобов’язаний сплатити комісію, яку потім буде виплачено постачальнику ліквідності. Для кожного пулу ліквідності задається окрема відсоткова комісія, яка залежить від волатильності активу. Для більш волатильних активів комісія вища, а для stablecoins вона часто дорівнює 0,3%. Головне правило визначення комісії має такий вигляд: $0 \lt p \lt 1$. Тоді, наприклад, для p = 0,003 = 0,3% матимемо

$x'=x+Δx=x(1+α)= \frac{x(1+β( \frac{1}{γ} -1))}{1-β}$, 
$y'=y-Δy= \frac{y}{1+αγ} =y(1-β)$

де $α= \frac{Δx}{x}$, $β= \frac{Δy}{y}$, $γ=1-p$. 

Таким чином, ми можемо розрахувати вартість обміну певної кількості токенів _X_ на _Y_ з урахуванням комісії:

$Δx= \frac{xβ}{γ(1-β)}$, $Δy= \frac{yαγ}{1+αγ}$.

Нові біржові смарт-контракти створюються за допомогою смарт-контракту Factory. Кожному унікальному ERC20 токену може відповідати лише один біржовий смарт-контракт [177].

Побачити весь список доступних пулів ліквідності, а також їхні параметри можна за допомогою веб-інтерфейсу. На рисунку 7.21 зображено топ пулів ліквідності в Uniswap на 15 серпня 2022 [178].

![Рисунок 7.21 – Топ пулів ліквідності в Uniswap](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.21-top-liquidity-pools-in-Uniswap.png "Рисунок 7.21 – Топ пулів ліквідності в Uniswap")

Uniswap V1 надає такі функції для підтримки виконання обмінних операцій [179]:

* createExchange – створення нового пулу ліквідності;
* addLiquidity – надання ліквідності в пул;
* removeLiquidity – забрати депоновані кошти з пулу.

Для безпосереднього обміну активів наявні функції, які мають назви згідно з таким шаблоном: ❬ethToToken | tokenToEth | tokenToToken❭❬Swap | Transfer❭❬Input | Output❭, де:

* ethToToken позначає, що відбувається обмін ETH на ERC20;
* tokenToEth позначає, що відбувається обмін ERC20 на ETH;
* tokenToToken позначає, що відбувається обмін ERC20 на ERC20;
* Swap позначає, що куплені токени відправляться на ту ж адресу, з якої були продані;
* Transfer позначає, що куплені токени будуть відправлені на іншу адресу, визначену користувачем у вхідних параметрах функції смарт-контракту, що викликається;
* Input позначає, що користувач точно задає кількість токенів, що продаються, тоді як кількість токенів, що купуються, може змінюватися залежно від курсу;
* Output позначає, що користувач точно задає кількість токенів, що купуються, тоді як кількість токенів, що продаються, може змінюватися залежно від курсу.

Розгляньмо як приклад функцію ethToTokenTransferInput. Викликаючи цю функцію, користувач повинен визначити:

* точну кількість ETH на продаж;
* мінімальну кількість ERC20;
* адресу одержувача куплених ERC20 токенів.

Унаслідок виконання цієї транзакції:

* на адресу пулу ліквідності зарахується продані ETH;
* на адресу одержувача зарахується кількість ERC20 токенів, що еквівалентне зазначеній кількості ETH. Якщо кількість ERC20 буде меншою за мінімальну кількість, транзакція не виконається.

Крім того, є функції, які повертають відношення цін між різними парами активів [180]:

* getEthToTokenInputPrice;
* getEthToTokenOutputPrice;
* getTokenToEthInputPrice;
* getTokenToEthOutputPrice.

Далі розгляньмо особливості протоколу Uniswap V2. Тоді як версія 1 була націлена на створення proof-of-concept, мета версії 2 – подальший розвиток ідеї, а також поліпшити зручність та безпечність протоколу. Версія впровадила такі оновлення [182]:

* можливість створення пулів ліквідності для пар ERC20 токенів, а також здійснення прямих (без проміжного активу) обмінів;
* децентралізовані цінові оракули (замість централізованих оракулів Uniswap V1).

Наступна версія протоколу – Uniswap V3 – передбачила вирішення такої проблеми: у попередніх версіях протоколу під час обмінення stablecoins механізм розрахунку ціни спрацьовує так, що 1 USDT можна придбати за 1,05 USDC [183]. Через це за великих сум формується занадто велика та невигідна різниця, адже в ідеальному разі stablecoins, прив’язані до одного цінового еталона, мають обмінюватися у відношенні 1 до 1. Це відбувається через неефективність constant-product інваріанту для обмінювання stablecoins, прив’язаних до однакового активу. Тому визначальна новацієя протоколу Uniswap V3 – механізм концентрованої ліквідності, який, імовірно, вирішив описану вище проблему [184].

Завдяки чому працює механізм? Кожен користувач під час надання ліквідності може визначити діапазон, у якому його ліквідність може бути використано. Протокол, зі свого боку, мотивує користувачів концентрувати всю ліквідність, що надається, у певному ціновому діапазоні залежно від пулу ліквідності (наприклад від 0,99 до 1,01 долара для пулу USDT–USDC). У підсумку, більшу винагороду отримують ті користувачі, у чиєму діапазоні використання ліквідності було здійснено найбільше обмінів. Позаяк обмін stablecoins улаштовує обидві сторони обміну (охочих купити USDT й охочих купити USDC), курс між двома stablecoins залишається близьким до відношення 1 до 1.

Очевидна перевага для користувачів, які здійснюють обміни, – більший обсяг ліквідності в певному ціновому діапазоні.


### Протокол Curve

Curve – це протокол децентралізованого обміну [185], принцип роботи якого вкрай близький до Uniswap. Головна його особливість – це орієнтованість на ринок stablecoins.

Для того самого, для чого Uniswap створив механізм концентрованої ліквідності, команда Curve розробила власний механізм обміну stablecoins – StableSwap [186].

Щоби зрозуміти як працює даний механізм, спочатку розгляньмо constant-sum інваріант: $x + y = k$. За такого інваріанта stablecoins обмінюються за курсом 1 до 1, оскільки сумарна кількість двох активів до обміняння дорівнює кількості після обміняння: $x + y = (x + Δx) + (y – Δy)$. З цього також випливає, що суми купленого та проданого активу завжди рівні: $Δx = – Δy$.

Хоча такий спосіб і здається хорошим для роботи зі stablecoins, усе-таки він тягне за собою такі недоліки:

Може скластися ситуація, коли у пулі ліквідності не залишиться монет для обмінювання. У такому разі система може зазнати величезних збитків.

Кількість stablecoins, що підтримуються платформою, може різко скоротитися через «нестабільність» або непопулярність певних stablecoins.

У результаті, команда Curve вирішила об’єднати constant-sum інваріант й інваріант Uniswap (див. рис. 7.22), щоб отримати рішення, за якого відв’язання stablecoins малоймовірне, ціна обміняння прийнятна, а система завжди має певну кількість ліквідності.

![Рисунок 7.22 – Порівняння інваріантів](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.22-comparison-of-invariants.png "Рисунок 7.22 – Порівняння інваріантів")

Розглянемо як математично здійснюється об’єднання інваріантів.
Інваріанти у загальному вигляді виглядають так:

constant sum $\displaystyle\sum_{i}{x_{i}} =D$, 
constant product $\displaystyle\prod_{i}{x_{i}} =( \frac{D}{n} )^{n}$, 

де _D_ – це загальна кількість монет на етапі, коли вони мали рівні ціни;
_n_ – кількість монет, що підтримуються пулом.

Для об’єднання двох графіків constant-sum інваріант множиться на коефіцієнт _X_, а потім до нього додається constant-product інваріант. У підсумку, виходить така формула:

$χD^{n-1} \displaystyle\sum_{i}{x_{i}} + \displaystyle\prod_{i}{x_{i}} = χD^{n} + ( \frac{D}{n} )^{n}$, 

де _X_ – динамічний коефіцієнт, що показує, до якого боку наближається інваріант. Якщо він наближається до нуля – StableSwap перетворюється на constant-product інваріант, якщо же до нескінченності, –  на constant-sum. Цей коефіцієнт задається так:

$χ= \frac{A \displaystyle\prod_{i}{x_{i}}}{( \frac{D}{n} )^{n}}$

Якщо же підставити вираз для X у формулу інваріанта, отримуємо таке:

$An^{n} \displaystyle\sum_{i}{x_{i}} +D=ADn^{n}+ \frac{D^{n+1}}{n^{n} \displaystyle\prod_{i}{x_{i}}}$. 

Надалі система має лише підтримувати це рівняння.

Дослідімо інтерфейс Curve (див. рис. 7.23), а також параметри, які будуть корисні в контексті надання ліквідності пулу ліквідності.

![Рисунок 7.23 – Інтерфейс Curve](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.23-Curve-interface.png "Рисунок 7.23 – Інтерфейс Curve")

Крім тих параметрів, які було розглянуто раніше, необхідні для вибрання пулу ліквідності необхідні такі параметри:

* base vAPY – річний відсоток винагороди, розрахований на основі поточного добового відсотка та обсягу.
* rewards tAPR – річна винагорода в токенах системи, розрахована на основі поточного добового відсотка.


### Протоколи позичання та кредитування

Перш ніж зрозуміти, як працюють децентралізовані системи позичання, розгляньмо, як кредитування та позичання працюють у реальному житті. Візьмімо як приклад банк: частина клієнтів банку відкриває депозит і згодом може отримувати певний відсоток (interest), інша частина клієнтів бере кредити та потім сплачує відсотки. Таким чином, банк у будь-який момент часу має кошти для видавання кредитів, а різниця між відсотками, що виплачують позичальники, і відсотками, що виплачуються вкладникам, залишається в банку як прибуток. Схему банківського кредитування наведено на рисунку 7.24.

![Рисунок 7.24 – Схема кредитування у централізованих фінансових установах](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.24-lending-in-centralized-financial-institutions.jpg "Рисунок 7.24 – Схема кредитування у централізованих фінансових установах")

Такий підхід має очевидний недолік: банк не може видавати кредити всім поспіль, бо ризикує ніколи не побачити гроші вкладників. Тому є два варіанти для банку: видавати кредити під заставу чогось цінного або видавати кредити з огляду на кредитну історію позичальника.

Розгляньмо конкретний приклад із використанням застави. Аліса хоче вступити до університету, і їй потрібно заплатити 10 000 доларів за перший семестр навчання. Проблема полягає в тому, що Аліса не має стільки грошей. Вона вирішує, що найкраще взяти кредит у банку та повернути борг за деякий час після закінчення навчання.

Банк, зі свою боку, не може довіряти Алісі, оскільки її кредитна історія порожня, а її намір стати, скажімо, найвеличнішим стоматологом у світі банк не переконує. Є інший варіант: Аліса може залишити у заставу щось цінне, щоби підкріпити свій зобов’язання сплатити борг згодом.

Аліса якраз недавно отримала в спадок намисто її бабусі, оцінкова вартість якого становить 100 000 доларів. Просто продати його для неї неприйнятно.

Далі є чотири можливі варіанти:

* Аліса погашає заборгованість та забирає свою заставу.
* Аліса не повертає борг. Цей випадок сприятливий для банку, оскільки він матиме право залишити собі заставу, яка коштує набагато більше, ніж сума боргу.
* Аліса може спробувати обдурити банк, заставивши фальшиве намисто. Утім, банк не довіряє Алісі й може перевірити справжність коштовності. Крім того, банк може публічно заявити про те, що Аліса схильна шахраювати.
* Аліса залишає заставу, але через деякий час ціна діаманта падає до $5 000. Для неї вигідніше не повертати позику, а для банку краще позбутися застави, поки вона зовсім не знецінилася.

Тепер розгляньмо, як розвивалися протоколи децентралізованого кредитування. Насамперед було випробувано підхід пірингового позичання/кредитування. Приклад такого протоколу – ETHLend (на цю мить проєкт зупинено) [187].

ETHLend – це децентралізований застосунок (DApp) для пірингового кредитування, який працює у системі Ethereum. Цей протокол дозволяв позичальнику та кредитору визначати важливі деталі кредиту без потреби в посереднику. Передбачалося, що такий підхід усуне ситуацію, коли тільки банк видає кредити та приймає депозити, а також створить конкуренцію між кредиторами, що зумовить найбільш конкурентоздатну відсоткову ставку.

У 2018 році ETHLend був перейменований в Aave, що в перекладі з фінської означає "привид". Команда, яка створила протокол, пояснює, що така назва символізує спробу створити прозору та відкриту систему децентралізованого позичання.


### Протокол AAVE

AAVE – протокол децентралізованого кредитування [188], що дозволяє користувачам позичати кошти й отримувати відсотки за надання коштів у борг.

Значна відмінність архітектури AAVE від ETHLend полягає в тому, що для забезпечення роботи системи з кожним ERC20 токеном створюється пул ліквідності. Схожий етап розвитку пережили DEX: коли order books зникли, з’явилися пули ліквідності, куди користувачі могли додавати активи, що підтримуються системою, і звідки користувачі могли брати кредити. Таким чином, немає потреби зіставляти попит та пропонування. Перевага цього рішення – те, що з погляду безпеки рішення залишається надійним. Воно не вимагає довіри, адже закладені в основу смарт-контракти загальнодоступні для аудитування.

Розберімо процес надання ліквідності до пулу. Уявімо таку ситуацію: Аліса нещодавно придбала 1 ETH, і вона вирішує створити депозит, за який вона зможе отримувати відсотки. Вона стає кредитором у протоколі позичання/кредитування, вкладаючи бажану кількість активу до пулу ліквідності (рис. 7.25). У результаті, Аліса отримує відповідні _interest bearing токени_ (у нашому випадку – ibETH). Коли ж Аліса захоче забрати свій 1 ETH разом із відсотками, що накопичилися, вона зможе просто обміняти interest bearing токени назад.

![Рисунок 7.25 – Схема кредитування AAVE](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.25-AAVE-lending.png "Рисунок 7.25 – Схема кредитування AAVE")

У цей час її кошти позичає інший користувач протоколу. Далі, коли позичальник повертатиме борг, він також сплатить відсотки, які будуть зараховані Алісі (рис. 7.26).

![Рисунок 7.26 – Схема повернення кредиту](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.26-loan-repayment.png "Рисунок 7.26 – Схема повернення кредиту")

Варто відзначити, що винагорода накопичується через постійні коливання курсу оригінального активу до відповідних interest bearing активів. Курс змінюється через те, що разом із поверненням коштів позичальники також сплачують відсотки [189].

Розгляньмо приклад того, як це працює. Створюється новий пул ліквідності ETH. Аліса та Єва вкладають у нього по 100 ETH, і натомість вони отримують по 100 ibETH. Початкове відношення цін – 1:1, тому що пул поки не має жодного прибутку: кількість випущених ibETH дорівнює кількості ETH.

Нехай Бобу потрібна позика 100 ETH і нехай річна відсоткова ставка, визначена в смарт-контракті протоколу, становить 5% за рік. Отже, Боб позичає 100 ETH, і він планує повернути весь борг, а також сплатити відсотки рік потому. Тобто йому доведеться віддати 105 ETH. Нехай початкова сума ETH у пулі – 200 монет. Рік потому сума ETH стане 205 монет. Це означає, що курс буде таким: 1 ibETH = 1,025 ETH.

Уявімо, що рік минув й Аліса тепер хоче вивести свої токени. Якщо вона обміняє свої ibETH назад, вона отримає ~102,5 ETH, тобто її прибуток становитиме 2,5 ETH.

Перевага застосування цього методу очевидна: транзакційні витрати на регулярні виплати відсотків зменшуються, оскільки виплату можна зробити лише на запит одержувача відсотків.

Інший важливий момент полягає в тому, як задається відсоткова ставка. У попередньому спрощеному прикладі ми наперед знали, що позичальник повинен буде заплатити 5%. Насправді же відсоткова ставка в кожний момент часу динамічна (див. рис. 7.27). Вона розраховується відповідно до такої формули:
  
$$
\begin{cases}
interestRate=α+U*β  & \text{ Якщо } U \leq U' \cr \\ 
interestRate=α+U'β+γ(U-U') & \text{ Якщо } U \gt U' 
\end{cases} $$ 

де _α_ – базовий відсоток за один блок,
_β_ – відсоток, який забезпечує зростання курсу,
_U_ – поточне значення балансу попиту та пропонування в пулі,
_U_' – оптимальне значення балансу попиту та пропонування, яке необхідне для контролю наявності коштів у пулі (Воно допомагає захистити систему від ситуацій, коли вкладники не можуть вивести свої кошти через те, що всі кошти утримують кредитори.),
γ – «jump»-множник, який визначає зміну нахилу графіка, коли $U = U'$.

Параметри _α_, _β_, _γ_, _U_' може початково задавати творець протоколу, а далі їх можуть змінювати спеціально призначені адміністратори системи або механізми governance.

Параметр _U_, зі свого боку, розраховується відповідно до такої формули:

_U = borrowed amount / (amount of funds available for borrowing + borrowed amount)_,

де _borrowed_amount_ – те, скільки сумарно коштів запозичено із пулу ліквідності,'
_amount_of_funds_available_for_borrowing_ – те, як багато коштів залишається в пулі ліквідності.

Тепер розгляньмо приклад із готовими параметрами:

$$
\begin{cases}
interestRate=2.5+U*0.05 & \text{ Якщо } U \leq 70 \cr \\ 
interestRate=2.5+70 * 0.05 + 3 * (U-70) & \text{ Якщо } U \gt 70 
\end{cases} $$ 

![Рисунок 7.27 – Графік функції розрахування відсоткової ставки](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.27-interest-rate-calculation-function.png "Рисунок 7.27 – Графік функції розрахування відсоткової ставки")

Далі, використовуючи відсоткові ставки, розраховані для кожного конкретного моменту часу, можна розрахувати кількість монет, які позичальник повинен зрештою повернути. Щоб ефективно акумулювати поблокові відсоткові ставки, дуже важливо створити механізм, який нормалізує борги, тобто наводить їх станом на момент часу, коли було створено пул ліквідності (_t<sub>0</sub>_). Інакше доведеться зберігати кожну зміну поблокової відсоткової ставки, а також час кожного нового запозичення.

Визначмо формулу для нормалізованого боргу:

normalized_debt = deposit_amount / compound_rate

Далі потрібно визначити поняття кумулятивна відсоткова ставка. Ця ставка враховує всі зміни блокового коефіцієнта та дозволяє нам розрахувати кінцевий коефіцієнт, який підсумовує відсоток за весь час позичання:

$R(t)=R_{0} * F_{t0+1} * F_{t0+2} * \cdot * F_{t-1} * F_{t}$

де Fi – відсоткова ставка для блока i,
R0 – початкове значення кумулятивної відсоткової ставки.

Щоби розрахувати кінцеву суму для повернення, застосовується така формула:

$A = N(1+R(t))$, 

де _N_ – нормалізований борг.

Розгляньмо процес взяття кредиту. Головний принцип полягає в тому, що кредит береться під заставу іншого активу (активи, які дозволено використовувати як заставу, визначають творці протоколу або модуль governance). Це дозволяє убезпечити платформу від ситуацій, у яких користувач може не повернути борг. Утім, є ще одна проблема: знецінення застави. Якщо застава, яку вніс користувач, почне різко знецінюватися, а платформа не спроможеться її ліквідувати, платформа залишиться зі збитком. Тому для відстеження ціни застави користувача система використовує цінових оракулів (price oracles).

Є механізм, який допомагає запобігти знеціненню застави: користувач не може взяти в кредит суму більшу, ніж еквівалентна сума застави, помножена на деякий коефіцієнт безпеки $0 \lt factor \lt 1$, що визначає розмір «подушки». Цей коефіцієнт може встановлювати творець системи, а згодом його можуть змінювати адміністратори або модуль governance. Коефіцієнт безпеки відображає волатильність конкретного активу. Тому передбачається, що кожний актив має власне значення цього коефіцієнта.

Якщо вартість застави зменшується та припиняє покривати кредит, тоді настає час ліквідації. Ліквідація – це процес продання застави позичальника, коли вартість застави наближається до того, щоби припинити покривати вартість боргу. Крім описаного вище коефіцієнта безпеки, найчастіше для кожного активу встановлюються значення порогу ліквідування. Цей поріг визначає, коли починається ліквідація.

Найчастіше така ліквідація вигідна й для платформи, і для ліквідатора (користувача, який погашає кредит і забирає заставу), оскільки платформа може продати заставу користувача зі знижкою.

Уявімо такий приклад: Аліса залишила заставу 0,033 ETH, еквівалентну $100 (коефіцієнт безпеки становить 0,7),  і позичила 70 DAI, еквівалентні $70. Утім, поріг ліквідування ETH становить 0,8. Це означає, що, якщо ціна 0,033 ETH знизиться до $80, будь-який користувач зможе ініціювати ліквідацію й викупити заставу зі знижкою. Нехай відсоток знижки становить 6,25%. Тоді 0,033 ETH буде продано за ціною $75, що передбачає знижку $5 для ліквідатора та заробіток $5 для платформи.


### Протокол Compound

Compound – це децентралізований застосунок в обліковій системі Ethereum [190]. Його основне призначення – організування децентралізованого кредитування та позичання.

Принцип роботи Compound такий самий, як в AAVE, але є кілька відмінностей, а саме такі:

* AAVE пропонує користувачам миттєві кредити (flash loans). Вони дозволяють позичати кошти без застави, але позичені кошти має бути повернено системі в тому самому блоці, у якому взято кредит. Незважаючи на таку велику перевагу, ця функціональність часто стає вразливою в схожих протоколах. Нещодавня атака на цей механізм сталася 17 квітня 2022 року; було викрадено 182 мільйони доларів [191].
* Compound та AAVE пропонують різні заставні коефіцієнти за різними активами, тоді як APY у протоколів найчастіше близькі за значенням.
* На відміну від Compound, який підтримує тільки Ethereum, AAVE працює також у таких облікових системах: Polygon, Avalanche, Fantom, Harmony, Optimism.
* На момент 15 серпня 2022 року TVL AAVE становить $12,5 мільярда (з урахуванням усіх мереж), тоді як TVL Compound – $3,03 мільярда.

Зрештою обидва протоколи пропонують своїм користувачам добре спроєктовану функціональність децентралізованої позики.


### Протокол Yearn

У користувачів, які розуміють, як працює DeFi, є багато можливостей заробити через правильне вкладення коштів – або через надання ліквідності протоколу DEX, або через позичення одного активу заради надання ліквідності іншому пулу ліквідності з більшою відсотковою ставкою. З появою же дедалі більшої кількості нових DeFi-протоколів відстежувати всі вигідні шляхи вручну стає дедалі складніше. Унаслідок цього виникає потреба в рішенні, яке автоматизуватиме цей процес.

У лютому 2020 року Andre Cronje спробував реалізувати цю ідею у формі проєкту iearn.finance [192]. Спочатку оптимізація дохідності була реалізована тільки в межах протоколів Fulcrum, Aave, Compound і dYdX, але згодом кількість підтримуваних протоколів DeFi й активів збільшилася, а проєкт було перейменовано в Yearn.

Як працює Yearn? Для кожного активу створюється свій yVault (сейф Yearn). yVault – це смарт-контракт, що підтримує пул токенів, а також керує токенами відповідно до реалізованих у смарт-контракті стратегій [193].

Сейфи Yearn мають такі властивості:

* Дохід накопичуватиметься у токені, який вноситься у yVault. Це дозволяє мати складний відсоток у yVault.
* yVault може мати багато стратегій, активних одночасно. yVault може за потреби змінювати розподіл коштів у своїх стратегіях.
* На відміну від багатьох інших агрегаторів дохідності, комісія за внесення/виведення коштів не стягується.

Отже, будь-який користувач може просто вкласти свої кошти в деякий yVault, а згодом забрати їх разом із накопиченим доходом (рис. 7.28).

![Рисунок 7.28 – Схема роботи Yearn](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.28-Yearn-operation.jpg "Рисунок 7.28 – Схема роботи Yearn")

Для кожного активу є свій yVault. Кожний yVault може підтримувати свою низку стратегій [194]. Загалом стратегії можна поділити на такі категорії:

* Stable – це yVaults, у які можна депонувати stablecoins, як-от USDT, sUSD, DAI, TUSD, USDC, LUSD;
* DeFi Tokens – yVaults, у які можна депонувати токени різних DeFi-протоколів, як-от UNI, SNX, AAVE, COMP;
* Curve Pools – yVaults, у які можна депонувати токени ліквідності системи Curve;
* Retired – це yVaults, які припиняють роботу або вже її припинили.

Для кожної стратегії створюється свій смарт-контракт. Розгляньмо найпоширеніші стратегії:

* Aave Lender Optimizer [195] вносить токени в AAVE, щоб отримати відсотки та заробити токени stkAAVE. Після виведення токенів зароблені stkAAVE продаються в обмін на конкретний токен yVault, який потім вноситься назад в стратегію.
* Aave Borrow [196] вносить DAI у AAVE, щоб отримати відсотки та заробити токени AAVE. Після розблокування зароблені токени збираються та продаються за більшу кількість DAI, яка вноситься назад у стратегію. Ця стратегія також позичає токени під заставу DAI. Позичені токени вносяться у відповідний yVault для отримання доходу.
* Kashi Lender [197] вносить USDC у Sushi через Kashi, щоб отримати відсотки та заробити токени SUSHI. Зароблені токени збираються та продаються за USDC, які вносяться назад у стратегію.
* Curve Yield Seeker [198] вносить WBTC в Curve Finance, щоби заробити CRV. Зароблені токени збираються та продаються за додаткові WBTC, які вносяться назад у стратегію. Стратегія автоматично перемикається на найприбутковіший пул Curve.
* Maker Delegate [199] вносить UNI в MakerDAO та емітує DAI. Емітовані DAI потім вносяться в yVault DAI для отримання доходу.
* Curve Boost [200] вносить steCRV в Curve Finance і спрямовує їх у stake, щоби зібрати всі доступні токени та заробити підвищену винагйороду в CRV завдяки блокуванню CRV boost. Зароблені токени збираються та продаються за додаткові steCRV, які вносяться назад у стратегію.
* Convex Reinvest [201] вносить eCRV в Convex Finance, щоби заробити CRV та CVX (і будь-які інші доступні токени). Зароблені токени збираються та продаються за більшу кількість eCRV, яка вноситься назад у стратегію.

Щодо надійності системи відзначмо, що вже був випадок зламу. У тому випадку було вкрадено 11 мільйонів USD, але зловмиснику вдалося забрати собі лише 2,8 мільйонів USD [202]. Атака ґрунтувалася на експлуатації миттєвих кредитів (flash loans).

# [ВИСНОВОК](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-3/ua/Z.1-Conclusion.md)
