# [3 ПРИМЕНЕНИЕ КОНЦЕПЦИЙ ШАРДИНГА, OFF-CHAIN, И DAG](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-3/ru/3-Applying-the-concepts-of-sharding-off-chain-and-DAG.md)

# 4 МЕХАНИЗМЫ ОБЕСПЕЧЕНИЯ КОНФИДЕНЦИАЛЬНОСТИ В ИНТЕРНЕТЕ


## 4.1 Принципы функционирования и применение Tor

В этом подразделе рассмотрены наиболее популярные подходы к повышению уровня приватности пользователя сети за счет сокрытия тех или иных данных от остальных пользователей или сторонних наблюдателей.

Понятие приватности (privacy) включает две основные составляющие: неотслеживаемость (untraceability) и анонимность (anonymity). Неотслеживаемость подразумевает невозможность обнаружения связи между действиями некоторого пользователя сети. Анонимность значит невозможность достоверно установить личность пользователя в этой сети.

При этом следует понимать, что понятие приватность пользователя включает различные аспекты: технический (связь действий пользователя с конкретным оборудованием или ПО), социальный (связь пользователя с его кругом общения и интересами), временной (связь действий пользователя со временем суток), поведенческий (связь пользователя с манерой ввода текста, используемыми языками и пр.). Поэтому у приватности нет однозначного порога, единиц измерения или абсолютного значения.

На практике же все сводится к тому, что, с одной стороны, люди изобретают методы анализа, позволяющие установить связь между действиями и пользователями, а, с другой стороны, улучшают методы запутывания и сокрытия таких связей, что позволяет увеличить сложность и стоимость анализа.

Углубимся в такой аспект приватности, как сетевая анонимность. Стоит отметить разницу между _анонимностью_ и _псевдонимностью_. Пользователь сети считается _анонимным_, если невозможно (сложно на практике) определить его сетевой адрес, местоположение, персональные данные или присвоить ему идентификатор, по которому можно определять его в дальнейшем. Если же действия пользователя можно связать с абстрактным идентификатором, то он считается _псевдонимным_. Например, если пользователь создал аккаунт с поддельными данными и постоянно его использует, то он уже не анонимен – в лучшем случае псевдонимен [82].


### Подходы к анонимизации пользователя сети

> * _Передача трафика через прокси-сервер_
> * _Использование луковой маршрутизации_
> * _Использование луковой маршрутизации и специального браузера_
> * _Системы распространения данных с большими задержками_

Передача трафика через прокси-сервер, использование SSH-туннеля, подключение через VPN или подобных посредников позволяет скрыть сетевой адрес пользователя сети от ресурса, к которому он обращается. А сторонний наблюдатель, который видит трафик между пользователем и прокси-сервером, не может определить, к какому именно ресурсу обращается пользователь.

Недостаток такого подхода состоит в том, что сам посредник, который выполняет роль прокси-сервера, знает, к каким ресурсам подключаются все его пользователи. Кроме этого, пользователи обычно настраивают соединение с одним прокси-сервером и длительно используют его, что позволяет стороннему наблюдателю и самому ресурсу, не зная сетевого адреса пользователя, утверждать, что все действия совершаются одним и тем же пользователем. Такой подход также неэффективен против глобального наблюдателя, который, анализируя трафик во всей сети одновременно, увидит корреляцию по времени и размеру пакетов между отправителем и получателем, несмотря на то, что они направляются не напрямую.

Подход с использованием луковой маршрутизации или ее модификаций позволяет скрыть сетевые адреса получателя и отправителя не только от стороннего наблюдателя, но даже от посредников. А наличие большого количества узлов, из которых пользователь может сам выбирать посредников, позволяет ему достаточно часто перестраивать маршрут и даже использовать несколько разных цепочек посредников одновременно для разных подключений. Тем не менее, такой подход все равно неэффективен против глобального наблюдателя и не защищает пользователя от намеренных попыток ресурса присвоить ему идентификатор на основании браузерных данных, таких как название и версия браузера, особенности выполнения скриптов, разрешение экрана, сохранение и использование данных о предыдущих сессиях и т. п.

Использование предыдущего подхода в совокупности со специализирующимся на анонимности браузером защищает пользователя от ряда способов его идентификации ресурсом, к которому он подключается. Такой браузер не выдает настоящие данные об операционной системе, браузере, подключенных плагинах и настоящем разрешении экрана, а также позволяет полностью отключить выполнение скриптов и сохранение данных о предыдущих сессиях. Задача специализированного браузера – сделать так, чтобы все его пользователи «выглядели одинаково». Очевидно, что использование такого браузера будет бесполезным, если пользователь посещает ресурсы, которые требуют регистрации, и при этом использует один и тот же аккаунт.

Подход с использованием систем распространения данных с большими задержками позволяет скрыть связь между отправителем, получателем и самими данными, которые передаются между ними. При этом даже глобальный наблюдатель не может увидеть корреляцию в передаче данных между участниками такой системы. Основной принцип такого подхода заключается в том, что данные передаются через посредников, но весь маршрут передачи заранее не известен. Одно сообщение может быть разбито на несколько составляющих частей, каждая из которых будет передаваться независимо от остальных.

Для передачи от посредника к посреднику части разных сообщений объединяются случайным образом и ожидают случайное количество времени, а к получателю они доходят в асинхронном порядке. Время передачи одного сообщения от отправителя получателю может достигать 30 минут. Очевидно, что организованная таким образом связь не является системой передачи данных общего назначения. Она не может использоваться для доступа к традиционным HTTP-серверам, аудио-/видеозвонков или переписки в режиме реального времени. Протоколы, использующие этот подход повышения анонимности, обычно реализуют изолированную среду общения наподобие электронной почты, публичных форумов или микроблогов.


### Принцип работы луковой маршрутизации

Концепция луковой маршрутизации (onion routing) впервые была предложена в 1995 году в исследовательской лаборатории военно-морских сил США. Сначала эти исследования финансировались за счет грантов от правительства США. Исходный код современной версии ПО Tor был опубликован под свободной лицензией в октябре 2003 года, чтобы все желающие могли провести проверку на отсутствие ошибок и закладок. Позже появилась некоммерческая организация, занимающаяся исключительно развитием Tor Project, и ее начали финансировать разные спонсоры. Чтобы добиться независимости от бюджета правительства США, в 2015 году проект начал принимать пожертвования от частных лиц.

Основная задача луковой маршрутизации состоит в сокрытии от стороннего наблюдателя факта общения одного пользователя сети с другим. Идея заключается в том, чтобы передавать пакеты данных не напрямую от отправителя получателю, а через цепочку из нескольких посредников, причем посредники знают не весь путь отдельного пакета, а только необходимую для его передачи часть.

Название «луковая маршрутизация» происходит от использования «многослойного» шифрования. Каждый защитный «слой» связан с конкретным промежуточным узлом, и его может «отделить» только соответствующий посредник. Поскольку сами данные и факт их передачи в сети скрыты от стороннего наблюдателя, Tor-сеть и аналогичные сети называются _dark networks_.

Рассмотрим работу луковой маршрутизации на примере передачи данных между Алисой и Бобом. Желающие использовать луковую маршрутизацию, в том числе Алиса и Боб, начинают использовать один и тот же протокол, образуя одноранговую сеть, которая использует Интернет для передачи своих данных. Узлы такой сети имеют ключи для асимметричного шифрования и обмениваются сетевыми адресами и открытыми ключами друг друга, чтобы каждый знал каждого, а также мог подключиться и отправить пакет данных, который сможет расшифровать только получатель.

Алиса зашифровывает сообщение, которое хочет передать Бобу, с помощью открытого ключа Боба. Далее Алиса формирует пакет данных _P1_, куда помещает зашифрованное сообщение и где указывает адрес Боба как получателя (рис. 4.1). Теперь Алиса выбирает случайный узел сети _R1_ и зашифровывает пакет _P1_ открытым ключом узла _R1_. Далее Алиса формирует пакет _Р2_, куда помещает зашифрованный _Р1_ и где указывает адрес _R1_ как получателя. Таким же образом Алиса выбирает узлы _R2_, _R3_ и формирует пакеты _Р3_ и _Р4_.

![Рисунок 4.1 – Схема шифрования данных при луковой маршрутизации](/resources/img/volume-3/4.1-Operating-principles-and-application-of-Tor/F-4.1-data-encryption-for-onion-routing.png "Рисунок 4.1 – Схема шифрования данных при луковой маршрутизации")

В результате «многослойного» шифрования сообщения от Алисы Бобу получается пакет данных _Р4_, который называют луком ввиду его многослойного строения. Этот пакет Алиса отправляет узлу _R3_ через обычный Интернет (рис. 4.2). Узел _R3_ может расшифровать полученный пакет и получить пакет _Р3_, который адресован узлу _R2_. Таким же образом узел _R2_ отправляет пакет _Р2_, а узел _R1_ отправляет пакет _P1_. В итоге, Боб расшифровывает данные пакета _Р1_ своим личным ключом и может прочитать сообщение. Отметим, что Боб может построить маршрут для отправки ответного сообщения Алисе через новый набор посредников, а может использовать маршрут, уже построенный Алисой (это зависит от конкретного протокола).

![Рисунок 4.2 – Схема передачи данных при луковой маршрутизации](/resources/img/volume-3/4.1-Operating-principles-and-application-of-Tor/F-4.2-data-transmission-for-onion-routing.png "Рисунок 4.2 – Схема передачи данных при луковой маршрутизации")

В такой ситуации сторонний наблюдатель, который может просматривать пакеты данных, передаваемые в Интернете, не видит общения между Алисой и Бобом. Сторонний наблюдатель может видеть пакеты _Р1_, _Р2_, _Р3_ и _Р4_, но не может связать их в одну цепочку, поскольку они содержат разный шифротекст, а ключи неизвестны. Каждый из узлов-посредников также не может раскрыть факт общения Алисы и Боба, поскольку знает адреса только соседних узлов. Факт передачи сообщения от Алисы Бобу может быть доказан, если все задействованные посредники сговорятся и опубликуют все промежуточные данные, которые они обрабатывали. Однако вероятность такого сговора минимизируется за счет выбора посредников случайным образом из множества независимых узлов.

К таким подходам к маршрутизации могут применяться методы раскрытия, основанные на анализе времени появления пакетов данных в сети, их размеров и т. п. Однако протоколы, реализующие такую маршрутизацию, могут использовать механизмы, значительно усложняющие анализ пакетов и установление маршрутов, такие как составные пакеты, динамические маршруты и т. п. Соответственно, разные протоколы настроены на разное количество случайно выбираемых посредников; обычно их количество равно двум или трем.


### Особенности применения Tor

В 2019 году клиентов сети Tor насчитывается более двух миллионов, а передачей трафика занимаются более 7000 активных узлов. Они расположены по всему миру и работают благодаря добровольцам, которые соглашаются отдать часть пропускной способности своего канала на поддержание сети.

Пропускная способность и уровень анонимности Tor зависят от количества узлов: чем оно больше, тем лучше. Это обусловлено тем, что пропускная способность каждого узла ограничена, а большое количество узлов сложнее анализировать.

По умолчанию пользователи Tor передают трафик через 3 случайно выбранных узла. Таким образом трафик проходит следующий путь:

* Пользователь (client)
* Входной узел (guard relay)
* Промежуточный узел (middle relay)
* Выходной узел (exit relay)
* Пункт назначения (destination)

Сначала пользователь зашифровывает данные так, чтобы их мог расшифровать только выходной узел. Далее полученный шифротекст он зашифровывает так, чтобы его мог расшифровать только промежуточный узел. А потом этот шифротекст снова зашифровывает так, чтобы его мог расшифровать только входной узел (рис. 4.3).

![Рисунок 4.3 – Схема обработки передаваемых данных в Tor](/resources/img/volume-3/4.1-Operating-principles-and-application-of-Tor/F-4.3-data-transmission-in-Tor.png "Рисунок 4.3 – Схема обработки передаваемых данных в Tor")

В общем случае запуск и поддержание узла сети, который будет выполнять роли входного и промежуточного узла, передавая трафик других пользователей, считается безопасным. Оператора такого узла сложно обвинить в распространении запрещенного контента или подобных действиях, поскольку он принимает и отправляет данные в зашифрованном виде, а ключей для получения оригинальных данных у него нет.

В этом контексте операторы выходных узлов несут гораздо большую ответственность. Если злоумышленник выполняет незаконные действия, используя сеть Tor, то эти действия будут связаны не с компьютером злоумышленника, а с выходным узлом, который выбрал злоумышленник. Для обычных людей это значит, что запуск и поддержание выходного узла Tor может привести к не очень приятным ситуациям.

Другая особенность связана с тем, что если отправитель и получатель дополнительно не обеспечивают конфиденциальность передаваемых данных (например, используют HTTP или FTP), то выходной узел увидит эти данные в открытом виде.


### Получение списка узлов Tor

После запуска клиенту сети Tor нужно получить списки всех входных, промежуточных и выходных узлов. Составлением, актуализацией и распространением этих списков занимается специальный сервис, состоящий из множества серверов, которые поддерживают разработчики протокола. Списки адресов узлов сети Tor должны быть общедоступными – на практике любой желающий может их получить. Однако с этим связана проблема блокировок.

Заинтересованные лица могут использовать списки адресов всех узлов, чтобы заблокировать использование Tor. В теории для этого существует два варианта: блокировать трафик от выходных узлов или блокировать трафик, направленный ко входным узлам.

Первый вариант реализуется непосредственно на стороне веб-сервисов. Для этого им достаточно иногда актуализировать список выходных узлов Tor и блокировать весь трафик от них. В таком случае часть веб-сервисов недоступна из сети Tor, и противостоять этому практически невозможно.

Второй вариант гораздо хуже: блокировка трафика, направленного входящим узлам, не даст использовать Tor вообще. Если ее реализуют провайдеры во всем мире, Tor станет бесполезным. Но разработчики Tor придумали хорошее решение этой проблемы. Подключаться к входным узлам можно не напрямую, а через _мосты_.

Мосты в контексте Tor – это узлы, которые являются посредниками между пользователем и сетью Tor, т. е. являются дополнительным звеном между клиентом и входным узлом. Мосты задействуют пользователи, которые не могут подключиться к входному узлу Tor или которые хотят скрыть факт использования Tor от стороннего наблюдателя. Список сетевых адресов мостов составляют и актуализируют те же таки специальные серверы разработчиков, однако он никогда не публикуется в общем доступе целиком. Желающий может отправить запрос или послать письмо по электронной почте для получения данных о мостах, однако сервис выдает адреса только нескольких мостов за раз. Этот подход предотвращает полную блокировку всех мостов и все еще позволяет пользователю, запрашивающему адреса мостов, получить доступ к сети.


### Методы деанонимизации пользователей dark networks

При деанонимизации пользователей dark network цель атакующего – установить связь либо между данными и отправителем, либо между данными и получателем, либо между отправителем и получателем. В общем случае для достижения цели атакующий может выполнять следующие действия:

* Просматривать весь трафик выбранного участника сети
* Наблюдать за трафиком двух предполагаемых собеседников одновременно
* Создавать, изменять, удалять или задерживать трафик
* Поддерживать несколько узлов-посредников
* Компрометировать несколько существующих посредников или устанавливать контроль над ними

Рассмотрим метод деанонимизации пользователя, основанный на корреляции пакетов данных по времени, поскольку он простой и эффективный для большинства сетей с низкими задержками. В этом случае атакующий может абстрагироваться от особенностей работы системы анонимизации и воспринимать ее как «черный ящик». Ему достаточно наблюдать за всем входным и выходным трафиком предполагаемых собеседников (например пользователя и ресурса), а также проводить несложный анализ (рис. 4.4). В результате, атакующий может определить, общаются ли между собой предполагаемые собеседники или нет (например, получает ли конкретный пользователь обслуживание от конкретного ресурса или нет).

![Рисунок 4.4 – Схема подключения атакующего к предполагаемым собеседникам](/resources/img/volume-3/4.1-Operating-principles-and-application-of-Tor/F-4.4-attacker-connecting-to-suspicious-parties.png "Рисунок 4.4 – Схема подключения атакующего к предполагаемым собеседникам")

В соответствии с этим методом атакующий должен фиксировать точное время появления каждого получаемого и отправляемого пакета двух предполагаемых собеседников одновременно. В зависимости от порядка и интенсивности взаимодействия собеседников атакующий может собирать данные для анализа на протяжении нескольких минут или часов. Анализ данных состоит в поиске совпадений между группой отправленных пакетов и группой пакетов, принятых через некоторый временной промежуток (рис. 4.5), то есть в сопоставлении временны́х тактов отправки и получения. Например, пользователь отправляет ресурсу запрос, состоящий из семи подряд идущих пакетов, а через 20 миллисекунд ресурс получает семь подряд идущих пакетов. При этом атакующий не анализирует само содержимое пакетов и адреса, указанные в их заголовках, так как предполагается, что собеседники используют многослойное шифрование и цепочку посредников.

![Рисунок 4.5 – Схема обнаружения корреляции пакетов по времени](/resources/img/volume-3/4.1-Operating-principles-and-application-of-Tor/F-4.5-detecting-packet-correlation-by-time.png "Рисунок 4.5 – Схема обнаружения корреляции пакетов по времени")

Для подтверждения факта взаимодействия предполагаемых собеседников атакующий должен обнаружить достаточно много совпадений между группами отправляемых и принимаемых пакетов. Однако стоит также учитывать, что предполагаемые собеседники могут обмениваться пакетами не только друг с другом, но и с другими участниками сети, что может увеличить количество ложных совпадений или уменьшить количество истинных. Но, активно вмешиваясь в обмен пакетами, атакующий может подтвердить результат своей проверки. Для этого, выборочно удаляя или задерживая часть пакетов отправителя, ему нужно следить за изменениями в потоке пакетов получателя.

Не существует универсального метода деанонимизации для всех dark networks, а также метода, который гарантированно выдавал бы результат за определенное время. Можно лишь сказать, что для любой атаки нужны большие ресурсы. Например, для атаки со злонамеренными посредниками необходимо запустить и поддерживать большое количество поддельных узлов анонимизирующей сети. А для атаки с обнаружением корреляции по времени обычному наблюдателю необходимо потратить много времени, чтобы проверить всех предполагаемых собеседников попарно.

Теоретически атакующим может оказаться не обычный наблюдатель, а так называемый глобальный наблюдатель – тот, который одновременно следит за всеми каналами передачи данных. Глобальный наблюдатель может проверять любых предполагаемых собеседников одновременно. Dark networks с низкими задержками обычно не рассматривают глобального наблюдателя в своей модели угроз; его существование на практике маловероятно [83].


### \*\*\*Часто задаваемые вопросы\*\*\*

_– Какова средняя пропускная способность, доступная для клиента сети Tor?_

Среднее время передачи для файла с размером 50 киБ (страницы текста) составляет 0,5–2,5 секунды, а для файла с размером 5 МиБ (фотографии) – 5–20 секунд в зависимости от выбранных промежуточных узлов.


## 4.2 Устройство Tox

Tox – это один из наиболее популярных протоколов децентрализованных мессенджеров. Основные его преимущества состоят в обеспечении конфиденциальности, целостности, подлинности передаваемых сообщений, а также в сокрытии связи между сетевым адресом пользователя и его сообщениями.

Отправной точкой создания Tox стало разглашение Эдвардом Сноуденом информации о программах слежки АНБ. После того, как в обнародованных документах были обнаружены упоминания массового сотрудничества Microsoft с государственными агентствами, а также детали операций по прослушиванию Skype, началось обсуждение проекта по созданию защищенного мессенджера, который функционально не уступал бы Skype и был бы достаточно прост в использовании для среднестатистического пользователя [86].

Со временем появилось множество приложений, работающих по протоколу Tox и поддерживающих популярные операционные системы. В этом подразделе будут рассмотрены наиболее интересные особенности устройства и использования Tox


### Как устроены аккаунты Tox?

У пользователя Tox может быть один или несколько аккаунтов. Уникальным идентификатором каждого аккаунта является долгосрочный открытый ключ пользователя. Соответствующую пару ключей для цифровой подписи пользователь генерирует лично, используя алгоритм ED25519 (длина личного и открытого ключей – 256 бит). Пользователь может прикрепить к своему аккаунту имя (или псевдоним), фото, описание и аналогичные данные. Эти данные хранит приложение самого пользователя, и они передаются только его контактам (при каждом соединении с контактом и обновлении данных).

Контактом в Tox называется аккаунт другого пользователя, с которым был произведен обмен долгосрочными открытыми ключами, а в приложениях, которые обрабатывают соответствующие аккаунты, был подтвержден запрос на добавление в контакты. Чтобы обнаружить другого пользователя в сети и отправить ему запрос на добавление в контакты, необходимо знать его Tox ID.

Tox ID формируется из таких данных: долгосрочного открытого ключа, значения nospam и контрольной суммы. Tox ID представлен одним шестнадцатеричным числом (рис. 4.6).

![Рисунок 4.6 – Схема формирования Tox ID](/resources/img/volume-3/4.2-Tox-design/F-4.6-Tox-ID-structure.png "Рисунок 4.6 – Схема формирования Tox ID")

Открытый ключ используется для взаимной аутентификации пользователей и установления ключей сессии. На протяжении всего времени жизни аккаунта за ним закреплена одна и та же долгосрочная пара ключей. Если пользователь хочет сменить долгосрочную пару ключей, то ему нужно создать новый аккаунт, передать новый Tox ID другим пользователям и заново добавить их в список контактов.

Значение _nospam_ занимает 4 байта и является частью Tox ID, которую владелец аккаунта может изменить произвольным образом. Это значение используется для защиты от спам-атаки с большим количеством запросов на добавление в контакты. Если злоумышленник знает долгосрочный открытый ключ жертвы и действующее значение nospam, то он может передавать в сети большое количество правильных запросов на добавление в контакты. Приложение жертвы будет вынуждено все их обрабатывать. В такой ситуации жертва может просто сгенерировать новое значение nospam и ожидать запросы на добавление в контакты уже по новому Tox ID. А все запросы по старому Tox ID будут недействительными.

Значение контрольной суммы занимает 2 байта и необходимо для обнаружения ошибок после передачи и ввода Tox ID. Контрольная сумма вычисляется как последовательный XOR 36 байт данных (32 байт открытого ключа + 4 байт значения nospam), разбитых на блоки по 2 байт [87].


### Типы узлов и приложения

Каждый узел Tox определяется сетевым адресом, номером порта и открытым ключом. Все существующие узлы можно разделить на два вида: _bootstrap-узел_ и _client-узел_. _Bootstrap-узел_ занимается только обслуживанием сети (соединяется с другими узлами, передает их данные, поддерживает DHT и т. п.), но при этом не взаимодействует с приложениями пользователей напрямую. _Client-узел_, помимо обслуживания сети, также выполняет роль приложения пользователя или чат-бота (соединяясь со своими контактами и обрабатывая сообщения).

В общем случае сторонний наблюдатель не может определить, к какому виду относится конкретный узел сети, т. к. невозможно определить, передает ли он свои сообщения или транслирует сообщения других узлов. В этом контексте отметим важную особенность: приложение и узел используют разные пары ключей: одну для луковой маршрутизации, другую для авторизации контактов.


Чтобы подключится к сети Tox необходимо иметь данные для подключения хотя бы к одному активному узлу, который поможет «разведать» остальные. По умолчанию для этого используется список из общедоступных _bootstrap-узлов_, которые работают в Интернете. Связь с другими узлами необходима для поддержания DHT, а также для поиска и подключения к пользователям из своего списка контактов.

Tox также может достаточно эффективно работать в интранете или в изолированной локальной сети. Для этого библиотека libtoxcore реализует отправку пакетов на широковещательные адреса, что позволяет подключиться к частной сети Tox, не имея выхода в Интернет (если в сегменте сети есть узел). Таким образом, даже двух узлов Tox может быть достаточно для обеспечения взаимодействия локальных клиентов [88].
Соединен


### Соединение собеседников

Узлы Tox действуют в сети открыто: их открытые ключи и сетевые адреса доступны кому угодно, при этом каждый узел готов ответить на запрос любого другого узла. Приложение пользователя, в отличие от узла, стремится не разглашать данные о пользователе. Например, стороннему наблюдателю недостаточно знания Tox ID некоторого пользователя для определения его сетевого адреса и наоборот. Поэтому даже для обмена запросами на добавление контакта и передачи данных для аутентификации уже известного контакта использовать прямое соединение недопустимо. Для сокрытия сетевого адреса пользователей приложения Tox используют механизм луковой маршрутизации.

Рассмотрим процесс установления связи между пользователями Tox. Например, Алиса и Боб знают Tox ID друг друга и запустили приложения Tox, но еще не установили соединение. Каждому из них нужно анонсировать свое появление в сети, чтобы контакты могли обнаружить их. Для этого Алиса и Боб случайным образом выбирают по одному узлу – соответственно, _А_ и _В_ – таким образом, что открытый ключ узла _А_ приближен по значению к открытому ключу Алисы, а открытый ключ узла _В_ приближен по значению к открытому ключу Боба (рис. 4.7). Далее Алиса и Боб, используя луковую маршрутизацию, передают значения своих открытых ключей узлам _А_ и _В_ соответственно, чтобы они могли принять и передать запрос на соединение, при этом не зная соответствия между открытым ключом пользователя и его сетевым адресом.

![Рисунок 4.7 – Построение маршрута для анонса открытого ключа](/resources/img/volume-3/4.2-Tox-design/F-4.7-building-route-to-announce-public-key.png "Рисунок 4.7 – Построение маршрута для анонса открытого ключа")

Приложения пользователей регулярно проверяют состояние своих контактов (в сети/не в сети), отправляя запросы на поиск их открытых ключей в DHT. Предположим, что Боб выполняет такой запрос по ключу Алисы и это приводит его к узлу _А_. Тогда Боб формирует запрос на соединение с Алисой и, используя луковую маршрутизацию, передает его узлу _А_, который, в свою очередь, направляет его Алисе (рис. 4.8).

![Рисунок 4.8 – Отправка запроса через узел, анонсирующий ключ](/resources/img/volume-3/4.2-Tox-design/F-4.8-sending-request-through-node-announcing-key.png "Рисунок 4.8 – Отправка запроса через узел, анонсирующий ключ")

Получив запрос на соединение, Алиса выполняет его идентификацию и аутентификацию. Определив, что этот запрос отправил Боб, она формирует ответ и, используя луковую маршрутизацию, отправляет его узлу _B_, который направляет его Бобу. Боб, в свою очередь, проверяет полученный ответ, убеждаясь в том, что его сформировала Алиса (рис. 4.9).

![Рисунок 4.9 – Отправка ответа через узел, анонсирующий ключ](/resources/img/volume-3/4.2-Tox-design/F-4.9-responding-through-node-announcing-key.png "Рисунок 4.9 – Отправка ответа через узел, анонсирующий ключ")

В ходе отправки таких запросов и ответов участники обмениваются открытыми ключами сессии, а также могут разглашать свои собственные сетевые адреса друг другу для установления прямого соединения. Если участники не желают делиться своими сетевыми адресами, они могут использовать узлы, поддерживающие TCP relay (рис. 4.10).

![Рисунок 4.10 – Варианты соединения собеседников после аутентификации друг друга](/resources/img/volume-3/4.2-Tox-design/F-4.10-connection-options-for-parties.png "Рисунок 4.10 – Варианты соединения собеседников после аутентификации друг друга")


### Узлы TCP relay

Одна из проблем большинства P2P приложений состоит в том, что значительная часть пользователей поддерживают только исходящие соединения, т. е. зная адрес нужного узла и номер порта, который он «прослушивает», могут инициировать соединение с ним. Но сами они не могут принять соединение от желающих к ним подключиться из-за настроек сетевого оборудования, ограничений межсетевого экрана, операционной системы и т. п. Кроме того, могут быть причины, по которым пользователь не может использовать трафик UDP. В децентрализованных системах это действительно проблема: когда двум участникам нужно соединиться для обмена данными (например для совершения аудио- или видеозвонка) и ни один из них не может принять соединение от второго, они могут соединиться только через посредника. Однако в децентрализованной системе по определению не может быть одного узла, к которому подключается значительная часть всех пользователей. Разработчики Tox добавили в ПО узлов функцию TCP relay, благодаря которой любой узел сети, способный принимать входящие соединения, может выполнять роль посредника между другими пользователями. Теперь пользователи, которые не могут соединиться напрямую, могут самостоятельно выбрать себе посредника.

Работает это следующим образом. При запуске клиент Tox пытается подключиться к нужным узлам напрямую, используя UDP. Независимо от результата (т. е. даже если подключение успешно) он подключается к одному из узлов с функцией TCP relay, который будет готов его обслужить, если возникнут проблемы с прямым подключением. Если клиенту не удается открыть прямое соединение, он будет использовать TCP relay, но продолжит попытки соединиться напрямую.

В свою очередь, особенность узлов, поддерживающих TCP relay, состоит в том, что они стараются использовать широко известные номера портов: 80 (HTTP), 443 (HTTPS) и 3389 (RDP). Это затрудняет отслеживание и фильтрацию трафика Tox, а также позволяет ему проходить большинство межсетевых экранов, которые ограничивают конкретные номера портов [89].


### Использование DHT для поиска контактов в сети

Модуль DHT использует отдельную пару ключей, причем при каждом запуске генерируется новая пара. Соответствующий открытый ключ – это идентификатор узла в DHT, т. е. соответствие между этим ключом, адресом и портом узла заносится в распределенную таблицу отдельной строкой.

В ходе работы приложения выполняется мониторинг состояния всех контактов пользователя. Для каждого контакта, с которым нет соединения, приложение осуществляет поиск по его Tox ID в DHT. Результат поиска – сетевой адрес узла, который был выбран для анонсирования открытого ключа этого контакта.

При успешном установлении соединения контакту присваивается статус в сети и с ним можно начинать обмен текстовыми сообщениями и файлами или инициировать звонок. При разрыве соединения статус контакта сразу изменяется на не в сети. Отметим, что по умолчанию сообщения хранят только сами собеседники, а их передача возможна только тогда, когда между собеседниками есть соединение.


### \*\*\*Часто задаваемые вопросы\*\*\*

_– Какой объем трафика потребляет узел сети Tox без самого приложения?_

Если отдельно запустить такой узел (Tox-bootstrap), то его потребление трафика составит около 250 кбит/с, что составляет около 2,5 ГиБ в день.

_– Можно ли определить тип сообщений, передаваемых между пользователями, анализируя размер и частоту передачи пакетов между ними?_

Такой метод анализа действительно весьма эффективен и может применяться даже против протоколов, использующих луковую маршрутизацию. Для усложнения отслеживания типа передаваемых сообщений по размеру пакетов данных участники сети Tox добавляют случайное количество случайных байтов в каждый пакет. Поэтому одно и тоже сообщение будет передаваться между транзитными узлами в пакетах с разным размером.

_– Tox ID представляет собой довольно длинную строку, которую неудобно вводить по памяти или печатать на визитке. Как лучше решать эту проблему?_

В сообществе Tox был утвержден и реализован стандарт DNS Discovery, который позволяет ассоциировать длинные Tox ID с более короткими именами. Используя его, можно зарегистрировать себе адрес вида username@example.com.


## 4.3 Invisible Internet project

Invisible Internet project (I2P) – это проект, реализующий одноранговую оверлейную сеть передачи данных с повышенным уровнем анонимности пользователей, которая функционирует без центральных серверов. Проект I2P был начат в 2003 году с целью создания анонимного средства распространения данных с низкими задержками, более распределенного и устойчивого к атакам по сравнению с альтернативными средствами. Этот проект также основан на передаче трафика через цепочку посредников (промежуточных узлов), однако способы поиска узлов и организации потока пакетов отличаются.

Сеть I2P в первую очередь ориентирована на передачу данных между ее участниками. Поэтому оба собеседника (например, пользователь и ресурс) должны использовать специальное ПО – _I2P-маршрутизатор_. Возможность пользователя I2P подключиться к ресурсу в обычном Интернете также поддерживается, однако такое подключение происходит через один из специально настроенных узлов (_outproxy_), которых в сети гораздо меньше.


### Чесночная маршрутизация

Технологию чесночной маршрутизации предложил Майкл Фридман в 2000 году; это модификация луковой маршрутизации [61]. В луковой маршрутизации каждый пакет между конкретными отправителем и получателем передается посредниками отдельно. Модификация чесночной маршрутизации состоит в том, что такой пакет будет передаваться не отдельно, а в группе с другими пакетами, которые в тот же момент времени нужно отправить тому же узлу.

Таким образом, узлы сети обмениваются так называемыми _чесноками_, которые состоят из пакетов разных собеседников, для которых совпала часть маршрута. В этом случае такие пакеты называют _зубчиками чеснока_. На рисунке 4.11 приведена упрощенная схема обработки чесноков узлом сети.

Здесь Боб получает от Алисы чеснок с зубчиками C, E и F, которые нужно передать Кэрол, Еве и Фрэнку соответственно. В то же время Боб получает чеснок от Дэйва, где зубчик B предназначен самому Бобу, а зубчики F, E и C нужно передать Фрэнку, Еве и Кэрол соответственно. Получив два таких чеснока, Боб их распаковывает и узнает получателей каждого из зубчиков; исходя из этого, он формирует три новых чеснока. Сам Боб хочет передать Еве (или через Еву) пакет данных от себя, поэтому в чеснок, сформированный для Евы, он добавляет еще один зубчик.

![Рисунок 4.11 – Упрощенная схема чесночной маршрутизации](/resources/img/volume-3/4.3-Invisible-Internet-project/F-4.11-simplified-garlic-routing.png "Рисунок 4.11 – Упрощенная схема чесночной маршрутизации")

При создании зубчика применяется схема многослойного шифрования. Если Алиса хочет передать сообщение Бобу, то она зашифровывает его так, что только Боб может его расшифровать, после чего добавляет к полученному шифротексту адрес Боба (рис. 4.12). Полученный пакет Алиса зашифровывает так, что только посредник может расшифровать его, и добавляет к полученному шифротексту адрес посредника. Таким образом добавляются слои для каждого посредника, и только после этого зубчик включается в чеснок. В свою очередь, чеснок зашифровывается так, что только узел-получатель может его расшифровать.

![Рисунок 4.12 – Схема многослойного шифрования в чесночной маршрутизации](/resources/img/volume-3/4.3-Invisible-Internet-project/F-4.12-multilayer-encryption-in-garlic-routing.png "Рисунок 4.12 – Схема многослойного шифрования в чесночной маршрутизации")

Стоит отметить, что сторонний наблюдатель не видит зубчики чеснока, передаваемые между узлами сети; он может видеть только чеснок целиком. Следовательно, сторонний наблюдатель не знает, для каких зубчиков конкретный узел является получателем, а для каких – транзитным узлом. Транзитный узел также не знает, каким по счету посредником он является для каждого зубчика. А чтобы усложнить отслеживание полного маршрута конкретного зубчика по размеру передаваемых чесноков, к каждому чесноку при формировании добавляется случайное количество случайных байтов [84].


### Выбор промежуточных узлов и создание туннелей

Важным объектом в функционировании I2P является _туннель_. Туннель – это ориентированный путь передачи данных через нескольких узлов-посредников. Данные через туннель могут быть отправлены только в одном направлении, поэтому пользователи обычно используют два типа туннелей: _исходящие (outbound)_ и _входящие (inbound)_.

Чтобы Алиса могла передать сообщение Бобу (рис. 4.13), у нее должен быть создан исходящий туннель (состоящий из выбранных Алисой посредников), а у Боба, в свою очередь, должен быть создан входящий туннель (состоящий из выбранных Бобом посредников). При этом Алиса не знает сетевой адрес Боба в обычном Интернете; она знает только его адрес в сети I2P, по которому находит сетевой адрес _шлюза (gateway)_ актуального входящего туннеля Боба. 

Далее Алиса формирует зубчик, с помощью которого сообщение будет передано через ее исходящей туннель на шлюз входящего туннеля Боба. В свою очередь, шлюз входящего туннеля Боба сформирует зубчик, который передаст сообщение Бобу через его входящий туннель.

![Рисунок 4.13 – Схема передачи сообщения через туннели в I2P](/resources/img/volume-3/4.3-Invisible-Internet-project/F-4.13-transmitting-messages-through-tunnels-in-I2P.png "Рисунок 4.13 – Схема передачи сообщения через туннели в I2P")

Чтобы ответить на сообщение Алисы, Бобу необходимо иметь исходящий туннель, знать сетевой адрес шлюза входящего туннеля Алисы и на основе ответного сообщения сформировать соответствующий зубчик. 

Таким образом, сообщения от Алисы к Бобу и от Боба к Алисе передаются по совершенно разным маршрутам. Пользователи сети могут использовать одновременно несколько входящих и несколько исходящих туннелей (например отдельные для каждого приложения или собеседника). По умолчанию время жизни туннеля составляет 10 минут. Это значит, что вне зависимости от длительности взаимодействия собеседников связь через текущих посредников прервется, будут выбраны другие узлы-посредники и будут созданы новые туннели, через которые возобновится связь.


### Адресация и поиск узлов

Полный адрес ресурса в сети I2P включает следующие данные: открытый ключ для асимметричного шифрования, открытый ключ цифровой подписи и данные сертификатов. Эти данные обычно конкатенируются и кодируются в base64; в результате получается строка с длиной 516 символов. Также используются более короткие варианты адресов, которые вычисляются как хэш-значение от полного адреса ресурса, закодированное в base32. Длина короткого варианта адреса составляет 52 символа.

Разумеется, недостаточно знать короткий адрес ресурса (base32), чтобы подключиться к нему. Для этого необходимо найти полный адрес (base64) по его хэш-значению. Поиск новых узлов-посредников, полных адресов ресурсов (соответствующих открытых ключей), а также сетевых адресов шлюзов, через которые можно отправлять запросы этим ресурсам, осуществляется через распределенную базу данных – NetDB. Эта база данных обрабатывает соответствующие запросы, разделяя их на две группы: _RouterInfo_ и _LeaseSet_.

_RouterInfo_ позволяет получить данные, необходимые для использования других узлов сети в качестве транзитных: сетевые адреса, открытые ключи и некоторые статистические данные.

_LeaseSet_ позволяет получить данные, необходимые для подключения к конкретному узлу сети как ресурсу (собеседнику); факт связи с этим узлом должен быть скрыт от остальных. В этом случае NetDB возвращает сетевой адрес шлюза входящего туннеля получателя, время окончания действия (expiration time) этого туннеля и открытые ключи получателя.

Все запросы и ответы в NetDB зашифрованы. Это необходимо для того, чтобы сторонний наблюдатель не мог выяснить, какие именно данные ищет конкретный пользователь. Но стоит также отметить, что узлы сети передают RouterInfo напрямую друг другу, а LeaseSet – только через туннели. Это необходимо для того, чтобы избежать корреляции между сетевым адресом узла и адресом ресурса, по которому он фактически находится, а также между сетевым адресом пользователя и адресом ресурса, которым он интересуется. Благодаря этому установить фактическое местоположение ресурсов и пользователей в сети I2P считается невозможным.

Для создания собственных входящих и исходящих туннелей Алиса отправляет запросы в NetDB и собирает RouterInfo. Таким образом, она формирует список узлов (сетевые адреса и открытые ключи), которые она может использовать в качестве посредников для ее туннелей.

Когда Алиса хочет послать сообщение Бобу, она сначала выполняет поиск в NetDB, чтобы найти LeaseSet Боба и получить данные о текущих входящих туннелях Боба. Затем она выбирает один из своих исходящих туннелей и отправляет через него сообщение с инструкциями для конечной точки исходящего туннеля, чтобы переслать сообщение на один из шлюзов входящего туннеля Боба.

Чтобы ответить Алисе, Бобу также нужно сначала обратиться в NetDB и получить ее LeaseSet. Но Алиса, отправляя первое сообщение Бобу, может сократить время отклика, добавив к сообщению свой актуальный LeaseSet; тогда Бобу не придется обращаться в NetDB, когда он решит ответить [85].


### \*\*\*Часто задаваемые вопросы\*\*\*

_– Какова средняя пропускная способность, доступная для клиента сети I2P?_

Среднее время передачи файла с размером 50 киБ (страница текста) составляет 3–7 секунд, а передача файла с размером несколько мегабайтов может занять несколько минут.


## 4.4 Стеганографические методы сокрытия информации

Стеганография – это способ хранения или передачи данных, который позволяет скрыть их наличие среди других данных (которые хранятся либо передаются). В этом случае скрываемые данные называют сообщением, а данные, среди которых скрывается сообщение, – контейнером. _Стеганографическая система (стегосистема)_ состоит из совокупности алгоритмов для встраивания, обнаружения и извлечения сообщений для определенных типов контейнеров.

Простой и наглядный пример стегосистемы – использование невидимых чернил и бумаги с посторонним текстом в качестве контейнера. В этом случае отправитель наносит свое сообщение поверх видимого текста (или между строк) и передает контейнер получателю как обычную книгу, газету или журнал. Получатель же должен знать о том, что в контейнер встроено сообщение, и то, как его извлечь (рис. 4.14), т. е. как правильно обработать бумагу (изменить температуру, нанести специальный реактив, использовать нестандартное освещение и т. п.).

![Рисунок 4.14 – Пример обнаружения скрытого сообщения](/resources/img/volume-3/4.4-Steganographic-methods-of-information-hiding/F-4.14-hidden-message-detection.png "Рисунок 4.14 – Пример обнаружения скрытого сообщения")

Тогда как криптография позволяет скрыть содержимое сообщения от посторонних лиц, стеганография позволяет скрыть факт наличия сообщения. Таким образом, сообщение встраивается в контейнер обычно в открытом виде, однако посторонние наблюдатели могут предположить, что собеседники используют стеганографию, и совершить попытки обнаружения и извлечения сообщений. Поэтому в ряде стегосистем имеет смысл встраивать сообщение в зашифрованном виде, т. к. это усложняет обнаружение сообщения в контейнере или вообще делает это невозможным.

Для некоторых стегосистем это работает таким образом, что даже если посторонние правильно извлекут сообщение из контейнера, то оно будет нечитаемым. Более того, его будет невозможно отличить от шума, который присутствует в таких контейнерах, даже если они не содержат встроенного сообщения.


### Особенности работы и преимущества

О стеганографии можно сказать, что она обеспечивает безопасность сообщения по принципу _«security through obscurity»_, что буквально значит безопасность за счет незнания. По такому же принципу обеспечивается защита программных продуктов с закрытым исходным кодом от взлома: если нарушитель не знает исходный код программы, то ему гораздо сложнее обнаружить в ней уязвимости.

Почему скрывать сам факт наличия сообщения с помощью стеганографии лучше, чем скрывать содержимое сообщения с помощью криптографии? Ответ на этот вопрос может быть не совсем очевиден. Если данные защищены только криптографическими методами, то их очень легко обнаружить (получить, перехватить). В большинстве случаев по использованному протоколу и вовлеченным сторонам довольно просто определить конкретный алгоритм и того, кто владеет нужным секретом. Поэтому если нарушитель обнаружил защищенные данные, но не может самостоятельно их прочитать, он может воздействовать на того, кто владеет нужным секретом, в том числе и насильственными способами. В случае применения стеганографии нарушителю гораздо сложнее обнаружить присутствие нужных данных.

Основные характеристики стегосистемы – _степень скрытности, емкость контейнера и сложность встраивания/извлечения_. Степень скрытности определяет, насколько сложно нарушителю отличить заполненный контейнер от незаполненного (обнаружить присутствие сообщения в нем). Емкость контейнера определяет отношение размера контейнера к максимальному размеру сообщения, которое можно встроить в этот контейнер. Другими словами, – то, насколько эффективно будет использоваться канал передачи данных (например, каждые 100 байт контейнера содержат 1 байт скрытого сообщения). Сложность стегосистемы определяет количество вычислений, необходимых для встраивания и извлечения сообщения из контейнера (например количество элементарных операций, которые нужно выполнить, чтобы встроить в контейнер сообщение с размером 100 байт).


### Классическая стеганография

Стеганография использовалась еще до нашей эры для передачи тайных уведомлений о военных нападениях и т. п. Контейнерами могли быть, например, восковые таблички, причем сообщение наносилось на деревянную подложку, которая уже потом покрывалась воском. Другой вариант подразумевает использование глиняных табличек, на которых вырезали текст сообщения, а затем наносили еще один слой глины и вырезали текст постороннего сообщения. Существуют также упоминания о том, что в качестве контейнера использовалась обритая голова раба, на которую записывалось сообщение, а после того, как отрастали волосы, он отправлялся к получателю сообщения.

К классическим методам стеганографии также можно отнести записи на боковой стороне колоды карт, расположенных в условном порядке. Возможно также использование различных трафаретов, которые при накладывании на текст оставляют только значимые слова.

Классическая стеганография также включает ряд физических методов сокрытия сообщений. Наиболее популярный из них использует оптическое уменьшение изображений или текста для нанесения его на так называемую _микроточку_. Создание микроточки похоже на создание фотографии на светочувствительной пленке. Микроточки обычно создавались круглой формы с диаметром несколько десятых миллиметра, что позволяло встраивать их в бумагу, вклеивать под марку почтового письма, передавать по голубиной почте и т. п. Для считывания сообщения из микроточки получатель обычно использовал микроскоп. Главное преимущество микроточки состоит в том, что неосведомленный наблюдатель не может ее обнаружить, даже если она просто прикреплена к листу бумаги с текстом, т. к. она выглядит как обычная чернильная точка [90].


### Компьютерная стеганография

Это направление стеганографии основано на использовании особенностей компьютерной платформы, что позволяет сохранить данные так, что они не будут обнаружены при просмотре файловой системы обычными обозревателями. Далее рассмотрим несколько примеров.

Многие форматы файлов предусматривают наличие полей, зарезервированных под будущие обновления формата. Этот подход позволяет обеспечить совместимость между версиями ПО. Поэтому пока эти поля не используются, они по умолчанию заполняются нулями. Соответственно, можно создать в файловой системе некоторое количество таких файлов, каждый из которых по отдельности будет бесполезным, но не будет вызывать подозрений. Далее с помощью специального ПО можно встроить сообщение (или другие полезные файлы) в неиспользуемые поля бесполезных файлов. Недостаток этого метода – низкая степень скрытности.

Существовал также метод сокрытия информации в неиспользуемых местах гибких дисков. Название метода говорит само за себя: скрываемые данные помещаются в неиспользуемые части диска, например, могут быть записаны на нулевую дорожку или после флага, обозначающего конец записанных данных.

Использование особых полей и форматов позволяет добавить скрытое сообщение в текстовые документы так, что его не будет видно при обычном отображении документа на экране. Например, сообщение может быть написано белым шрифтом на белом фоне в области поля для сносок. Недостаток такого способа – низкая емкость контейнера.

Использование незаполненных кластеров файловой системы позволяет весьма просто и эффективно скрывать достаточно большие объемы данных. В большинстве файловых систем записанный на диск файл занимает целое число кластеров (минимальных адресуемых ячеек памяти). Обычно размер кластера составляет от 2 кБ до 32 кБ. Соответственно, для хранения файла с размером 1 кБ на диске выделяется объем памяти, равный одному кластеру, например 16 кБ. Таким образом в этом кластере 1 кБ нужен для хранения самого файла, а остальные 15 кБ может использовать специальное ПО для хранения скрытых данных. Однако такой метод имеет низкую степень скрытности.


### Цифровая стеганография

Направление цифровой стеганографии основано на встраивании сообщений в цифровые мультимедийные файлы или потоки (изображения, аудио, видео). При этом встраивание сообщения в такой контейнер вызывает его искажение. Поэтому для каждого типа контейнера (формата сжатия и кодирования) должны быть использованы специальные алгоритмы встраивания и извлечения, благодаря которым внесенные искажения находятся ниже порога чувствительности среднестатистического человека. Поэтому встраивание сообщений не приводит к заметным изменениям соответствующих мультимедийных контейнеров. Кроме того, в оцифрованных объектах, изначально имеющих аналоговую природу, всегда присутствует шум, что повышает степень скрытности таких стегосистем.

Детальнее остановимся на одном из простейших способов встраивания сообщения в изображение, основанного на изменении наименее значимых битов. Чаще всего изображение кодируется как группа пикселей, каждый из которых задается красной, зеленой и синей составляющими (RGB). Причем яркость каждой составляющей может принимать 256 значений, т. е. задается одним байтом данных. Метод изменения наименее значимых битов (LSB – least significant bit) в этом случае подразумевает замену одного или нескольких младших битов составляющих пикселя на биты встраиваемого сообщения. Схематический процесс встраивания изображен на рис. 4.15.

![Рисунок 4.15 – Схема встраивания сообщения в изображение](/resources/img/volume-3/4.4-Steganographic-methods-of-information-hiding/F-4.15-embedding-message-in-image.png "Рисунок 4.15 – Схема встраивания сообщения в изображение")

В приведенном примере сообщение разделяется на порции по 2 бит и каждая порция встраивается в одну из составляющих пикселя. Например, в пиксель № 103 со значениями составляющих R: 35, G: 118, B: 242 нужно встроить следующую часть сообщения: 10 10 01. Соответственно, у модифицированного пикселя будут значения составляющих R: 34, G: 118, B: 241. Если заменять два наименее значимых бита каждой составляющей цвета, то ее значение в наихудшем случае увеличится или уменьшится на 3 единицы из 256 возможных. Поэтому визуально отличить модифицированное изображение от оригинального невозможно. Однако если в каждой составляющей цвета изменять более чем 2 бит данных, то это приведет к такому искажению изображения, которое будет заметно «невооруженным глазом».

В этом случае также очень просто оценить объем контейнера. Если в каждую составляющую цвета встраивать по 2 бит данных, то в каждый пиксель можно встроить по 6 бит. Следовательно, если использовать изображение с разрешением 200 на 100 пикселей, то в него можно встроить сообщение с размером 120 000 бит.

Очевидно, что метод изменения наименее значимых битов применяется для форматов изображений без сжатия или со сжатием без потерь. Существуют и другие методы встраивания сообщений в изображения, обеспечивающие устойчивость к перекодированию, сжатию, геометрическим преобразованиям и некоторым другим модификациям изображения-контейнера.

Существует ряд модификаций этого метода, которые повышают устойчивость к ручному и автоматизированному обнаружению встроенных данных. Улучшение подхода состоит в том, что сообщение встраивается не напрямую в пиксели, а как сумма значений по группе пикселей. Способ разбиения изображения на группы устанавливается заранее и известен только отправителю и получателю. Изображение может разбиваться как на простые группы пикселей, например, строки, столбцы или квадраты, так и на более сложные, например, кресты или пересекающиеся матрицы. В этом случае отправитель изменяет каждую группу пикселей таким образом, чтобы сумма по всем пикселям группы была равна очередной части встраиваемого сообщения. Получатель, в свою очередь, разбивает изображения на те же группы, вычисляет по ним суммы и составляет из них сообщение. Еще одна особенность состоит в том, что если в один и тот же контейнер встроить одно и то же сообщение, то заполненные контейнеры будут разными, даже если использовался один способ разбиения на группы пикселей.

Для встраивания сообщений в аудиофайлы или аудиопотоки обычно используются следующие методы: эхо-методы, фазовое кодирование, метод расширенного спектра. Эхо-методы основаны на том, что звуковая волна накладывается сама на себя с небольшим сдвигом во времени и с уменьшенной амплитудой. С одной стороны, такое эхо достаточно просто обнаружить; с другой стороны, обычный цифровой аудиосигнал всегда содержит эхо, которое появляется по естественным причинам в момент записи микрофоном.

В этом случае эхо характеризуется начальной амплитудой, степенью затухания и задержкой, которые выбираются таким образом, чтобы эхо оставалось незаметным для человеческого восприятия. С помощью нескольких разных значений задержки в аудиосигнал встраивается само сообщение. Например, эхо с задержкой 0,001 с обозначает нулевой бит сообщения, а эхо с задержкой 0,002 с – единичный бит сообщения.


### Сокрытие сообщений с помощью хэш-стеганографии

Этот метод стеганографии особенный, поскольку он не требует изменения контейнера, а порядок встраивания и извлечения сообщения сильно отличается от рассмотренных выше методов. Принцип работы заключается в том, что отправитель подбирает такой контейнер (картинку, аудиофайл, текстовый файл или другой), хэш-значение которого совпадает с сообщением, которое нужно передать. Разумеется, отправитель и получатель должны заранее согласовать канал передачи данных и используемую функцию хэширования. Для извлечения сообщения получателю нужно просто вычислить хэш-значение контейнера.

Стоит отметить, что чем длиннее хэш-значение используемой функции хэширования, тем сложнее подобрать контейнер, который при хэшировании будет давать нужное сообщение. Например, для выходного значения хэш-функции с длиной 8 бит существует 256 возможных значений, а для значения с длиной 16 бит – 65536. Кроме этого, нужно учитывать, что обычно длина сообщения гораздо больше, чем длина хэш-значения. Поэтому хэш-стеганография предусматривает использование группы упорядоченных контейнеров для передачи одного сообщения. При этом функция хэширования может быть использована даже с длинным выходным значением, но использоваться будет только его часть.

Рассмотрим порядок встраивания и извлечения скрытого сообщения с помощью хэш-стеганографии на примере. Допустим, Алиса и Боб договорились, что будут использовать хэш-стеганографию с хэш-функцией SHA-1 на длине 128 бит, используя первый байт выходного значения; в качестве контейнеров будут использованы фотографии, а каналом связи будет служить личный фотоальбом Алисы в социальной сети. Теперь, если Алисе нужно передать Бобу сообщение с длиной 44 байта, из всего множества фотографий, которые еще не были опубликованы, она выбирает такую, первый байт хэш-значения которой совпадает с ее сообщением, и публикует. Таким же образом Алиса выбирает фотографию для второго байта сообщения и так далее, пока все 44 фотографии не будут опубликованы в нужном порядке (рис. 4.16). Очевидно, что задача извлечения сообщения для Боба гораздо проще. Ему для получения сообщения достаточно вычислить хэш-значения фотографий в порядке их публикации Алисой.

![Рисунок 4.16 – Схема работы хэш-стеганографии](/resources/img/volume-3/4.4-Steganographic-methods-of-information-hiding/F-4.16-operation-of-hash-steganography.png "Рисунок 4.16 – Схема работы хэш-стеганографии")

Однако задачу Алисы можно немного оптимизировать. Вместо того, чтобы для каждого байта сообщения выполнять грубый перебор фотографий в поиске подходящей, она может один раз пройтись по всему множеству неопубликованных фотографий и классифицировать их в зависимости от первого байта хэш-значения. Другими словами, Алиса составляет таблицу фотографий, каждая строка которой содержит фотографии, первый байт хэш-значений которых совпадает с номером строки (рис. 4.17). Теперь для передачи каждого следующего байта скрытого сообщения Алисе достаточно опубликовать фотографию из нужной строки таблицы. Чтобы в фотоальбоме не было повторений и это не вызывало подозрений у посторонних, Алиса сразу после публикации удаляет фотографию из таблицы. Это значит, что при активной передаче скрытых таким образом сообщений Алисе нужно пополнять свою таблицу новыми фотографиями.

![Рисунок 4.17 – Таблица фотографий, подготовленная Алисой](/resources/img/volume-3/4.4-Steganographic-methods-of-information-hiding/F-4.17-prepared-table-of-photos.png "Рисунок 4.17 – Таблица фотографий, подготовленная Алисой")

Преимущество хэш-стеганографии – очень высокая степень скрытности, поскольку контейнеры не требуют модификации и могут быть произвольными файлами. Это позволяет выбирать любые контейнеры в зависимости от ситуации. Недостаток этого метода – низкая емкость контейнера: один контейнер может содержать не более нескольких байтов скрытого сообщения.


### Особенности применения и атаки

Для обеспечения защиты авторского права на цифровой контент часто применяют системы цифровых отпечатков (digital fingerprint) и цифровые водяные знаки (digital watermarking), которые используют стеганографию для незаметного встраивания идентификаторов автора, цифровых подписей или других отметок.

Существует также предположения, что агенты спецслужб и участники террористических группировок используют стеганографию для общения в Интернете. Это обусловлено тем, что публикация контейнеров в открытых ресурсах не вызывает подозрения по сравнению с использованием защищенных мессенджеров или dark networks.

Под атаками на стеганографические системы понимаются попытки обнаружить, извлечь или подменить встроенное в контейнер сообщение, а соответствующая деятельность называется стегоанализом. Атаки на стегосистемы могут основываться на известном методе встраивания, известном встроенном сообщении или известном пустом контейнере.


### \*\*\*Часто задаваемые вопросы\*\*\*

_– Какие изображения лучше подходят для встраивания сообщений?_

Для методов встраивания на основе LSB монотонные, низкоконтрастные изображения с повторяющимися или единообразными текстурами (изображения песка, неба, травы, деревьев, моря и т. п.) подходят гораздо лучше, чем высококонтрастные (изображения с текстом, диаграммами и т. п.). Кроме этого, следует учитывать, что человеческий глаз наиболее чувствителен к изменениям в спектре зеленого цвета; напротив, его наименьшая чувствительность наблюдается относительно спектра синего цвета. Следовательно, в синий канал (согласно цветовой модели RGB) изображения можно встроить больше данных, чем в зеленый канал, и при этом заполненный контейнер останется визуально неотличимым от исходного изображения.

# [5 РОЛЬ КРИПТОГРАФИЧЕСКИХ ОБЯЗАТЕЛЬСТВ В УЧЕТНЫХ СИСТЕМАХ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-3/ru/5-Role-of-cryptographic-commitments-in-accounting-systems.md)
