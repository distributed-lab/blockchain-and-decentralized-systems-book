# [6 ОСНОВЫ ПОСТКВАНТОВОЙ КРИПТОГРАФИИ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-3/ru/6-Basics-of-post-quantum-cryptography.md)

# 7 STABLECOINS И ДЕЦЕНТРАЛИЗОВАННЫЕ ФИНАНСЫ


## 7.1 Подходы к созданию stablecoins

_Stablecoin_ (стабильная монета) или _stable currency_ (стабильная валюта) – это термины, которые обычно используют для обозначения подмножества цифровых активов, цена которых стабильная (или стремится быть стабильной) относительно некоторого эталона. Создание stablecoin актуально, потому что многие люди хотят использовать такой актив, который будет обладать одновременно несколькими свойствами: возможность хранения и передачи в цифровом виде, стабильная цена, независимость (от банков, регуляторов и их ограничений). В этом подразделе описаны основные подходы к обеспечению _привязки (peg)_ цены цифрового актива к некоторому ценовому эталону (_benchmark_).

Следует понимать, что стабильность цены – относительная величина, у которой нет абсолютного значения или универсальных единиц измерения. Чтобы лучше понять эту проблему, можно составить список привычных товаров и услуг, например: литр молока, килограмм пшеницы, одна поездка в метро. С одной стороны, человек считает стоимость этих товаров и услуг сравнительно стабильной, с другой стороны, эти же товары и услуги нестабильны относительно друг друга. Из этого следует, что универсальной единицы измерения цены нет, поэтому цену stablecoin можно привязать только к некоторому эталону, т. е. уже существующему товару, услуге или другому активу.

Существуют разные способы привязки stablecoin к эталону. Чтобы сравнивать их, удобно использовать критерии, приведенные ниже.

> * _Уровень устойчивости привязки к изменению спроса и предложения_
> * _Затратность поддержания привязки_
> * _Прозрачность механизмов привязки для пользователей_
> * _Сложность определения границ устойчивого состояния привязки_

Как правило, stablecoin и соответствующий эталон торгуются на разных площадках и в разных объемах, следовательно, баланс спроса и предложения на stablecoin в отдельные моменты времени может сильно отличаться от баланса спроса и предложения на сам эталон. Например, если stablecoin привязан к одному литру топлива и желающих срочно продать этот stablecoin гораздо больше, чем желающих его покупать, то люди, естественно, будут создавать предложения по продаже даже по заниженной цене (ниже текущей цены одного литра топлива). Для stablecoin это основная проблема, и механизм привязки должен ее решать в рамках определенных допущений.

Способы привязки цены stablecoin к эталону могут обеспечиваться разными системами: централизованными, децентрализованными, со специальными самовыполняющимися смарт-контрактами и т. п. При этом важна затратность поддержания такой системы. Она подразумевает, например, затраты на поддержание достаточного количества независимых оракулов, которые следят за изменениями цены эталона и передают данные в систему управления stablecoin, затраты на поддержание валидаторов учетной системы и т. п. Эти затраты должен кто-то покрывать: распространители товаров или услуг, либо торговцы, либо держатели и пользователи.

Прозрачность механизмов привязки – еще один важный критерий для stablecoin. В идеальном случае у кого угодно должна быть возможность изучить принцип обеспечения привязки и убедиться в его теоретической работоспособности, а также возможность провести аудит системы на практике, чтобы убедиться в ее соответствии теоретической модели. Иначе stablecoin не будет вызывать доверия и не получит широкого распространения.

Сложность определения границ устойчивого состояния привязки – это критерий, который является следствием из предыдущего. Если участники рынка не могут легко определить точки, в которых привязка потеряет свою устойчивость, то злоумышленнику достаточно просто посеять панику среди пользователей. Так злоумышленник может вызвать лавинный эффект: пользователи сами будут выводить stablecoin из устойчивого состояния без объективных на то причин. Поэтому прозрачный и легко поддающийся анализу механизм привязки более устойчив к манипуляциям и колебаниям настроения.

Подходы к созданию stablecoin можно разделить на три основные группы, приведенные ниже.

> * _Полное обеспечение соответствующим эталоном_
> * _Обеспечение другим цифровым активом на эквивалентную сумму_
> * _Без обеспечения_


### Способы привязки с полным обеспечением

Наиболее простой для понимания способ создания stablecoin – выпуск цифровых обязательств в централизованной учетной системе, у владельца которой есть (заблокированный в его хранилище) непосредственный эталон стоимости на всю сумму выпущенных обязательств. Например, владелец фермы выпускает в своей учетной системе один новый stablecoin каждый раз, когда добавляет на свой склад один литр свежего молока, и погашает один stablecoin каждый раз, когда любитель молока приходит на склад, чтобы обменять цифровое обязательство на настоящее молоко.

Преимущества такой организации следующие:

* Владелец фермы разделяет процессы продажи молока и обслуживания клиентов.
* Теоретически невозможна ситуация, когда у клиента есть stablecoin, а на складе нет молока.

Интересная особенность состоит в том, что люди, которые верят в стабильность цены молока, могут использовать этот stablecoin для хранения своих сбережений. Однако эта особенность не для каждого эталона является преимуществом. Для примера с молоком чем больше stablecoin используется для хранения сбережений, тем больше молока простаивает на складе и, соответственно, портится. Поэтому такой подход к созданию stablecoin не подходит тогда, когда эталон затратно хранить или он быстро портится.

Другой недостаток этого подхода – то, что привязку stablecoin к эталону обеспечивает одна сторона и ее не может проверить любой желающий. Следовательно, пользоваться таким stablecoin может только тот, кто полностью доверяет владельцу системы. Из этого следует, что stablecoins, выпущенные разными эмитентами (например разными фермерами), в общем случае _невзаимозаменяемые (non-fungible)_, даже если они привязаны к одному эталону.

Касательно способов привязки с полным обеспечением также отметим, что на практике встречаются случаи, когда обеспечение хранится централизованно (одной компанией), stablecoin выпускается также централизованно (той же компанией), но stablecoin учитывается в децентрализованной системе. В таких случаях только один из процессов прозрачный и независимый; в контексте надежности всей системы это имеет крайне мало смысла.


### Обеспечение stablecoin другим цифровым активом

Подход к созданию stablecoin, где в качестве обеспечения используется другой цифровой актив, может быть применен в децентрализованной учетной системе со свойством permissionless. Именно этот вариант и будет далее рассмотрен. В таком случае процессом выпуска stablecoin и хранения обеспечения управляет смарт-контракт. Теоретически такой stablecoin будет обладать свойством trustless, поскольку система является независимой и полностью поддающейся аудиту. Однако важно понимать, что этот подход работает только в том случае, если сам stablecoin и цифровой актив, которым он обеспечивается, выпускаются и учитываются в одной системе; т. е. создать stablecoin, который привязан к одному грамму золота и обеспечивается на эквивалентную сумму биткоином, невозможно.

Наиболее распространенный способ реализации данного подхода предполагает использование так называемого контракта на разницу цен (contract for difference, CFD). CFD – это популярный биржевой инструмент, который используется для страховки от изменения цены актива. Заключая CFD, покупатель и продавец договариваются о возмещении разницы между текущей ценой некоторого количества актива и ценой этого количества актива на момент завершения контракта.

Например, если цена одного литра молока в долларах увеличится на некоторую сумму, то продавец выплатит покупателю эту сумму, а если цена одного литра молока снизится, то уже покупатель заплатит разницу продавцу в долларах. При этом само молоко они друг другу не передают, им даже не обязательно его иметь: просто одна сторона выплачивает другой стороне разницу в цене, которая образовалась за время жизни контракта.

Очевидно, что в этом примере для закрытия (погашения) контракта на разницу цен нужно выплатить только ту сумму, на которую изменилась цена одного литра молока. Таким образом, если она изменилась на 10%, то для погашения СFD нужно только 10% от цены литра молока. Но на практике расчет между сторонами происходит не после закрытия контракта, а именно в момент его закрытия. Более того, обе стороны хотят иметь гарантию того, что оппонент будет платежеспособен в момент закрытия контракта, поэтому еще при его открытии стороны замораживают некоторую сумму в этом же контракте в качестве залога. Например, стороны создают CFD на сумму, равную цене одного литра молока, в долларах и в качестве залога депонируют по 20% стоимости одного литра молока в долларах. Стоит отметить, что такой контракт может быть закрыт двумя способами: по инициативе одной из сторон или автоматически (margin call) в случае изменения цены одного литра молока в долларах на 20% или более. Второй случай говорит о том, что разница, которую нужно выплатить, фактически сравнялась с максимальной суммой, которую один из участников готов выплатить.

Размер залога обычно зависит от волатильности самого эталона. Для активов с относительно стабильной ценой это может быть несколько процентов, а для активов с высокой волатильностью – несколько десятков или даже сотен процентов. Так или иначе, основное преимущество CFD состоит в том, что он позволяет торговать активом, фактически не имея его в наличии.

Теперь рассмотрим, как используя CFD в децентрализованной учетной системе выпустить stablecoin, цена которого привязана к произвольному эталону. Разница в том, что здесь контракт заключается не между двумя оппонентами, а между торговцем и всей учетной системой. Чтобы лучше понять особенности работы смарт-контракта в этих условиях, рассмотрим пример выпуска некоторым торговцем одного stablecoin, который привязан к цене одного литра молока, где источником цены будет сеть супермаркетов «Господарочка».

Итак, торговец – пользователь учетной системы, в которой он владеет некоторым количеством базовой валюты. Эта валюта будет использоваться в качестве обеспечения для выпускаемого stablecoin. Допустим, на текущий момент известно, что в сети «Господарочка» один литр молока стоит 100 единиц базовой валюты. Поэтому торговец, составляя контракт на выпуск одного stablecoin, указывает сумму обеспечения равной 120 единицам базовой валюты (эквивалент стоимости + 20% залога). После того как этот контракт был подписан торговцем и принят учетной системой, 120 единиц базовой валюты снимаются с его баланса и замораживаются в контракте, а взамен он получает новый stablecoin.

В рамках данной учетной системы этот stablecoin является гарантией, что его владелец в любой момент времени может обменять его на базовую валюту в эквиваленте цены одного литра молока из сети «Господарочка». Торговец может отправить этот stablecoin любому другому пользователю системы, а может создать предложение по его продаже на внутренней бирже этой учетной системы (internal exchange, DEX).

В данной системе внутренняя биржа играет очень важную роль, гарантируя корректное закрытие контрактов в случае margin call. Допустим, торговец в качестве благотворительности пожертвовал свой stablecoin в детский дом, где много любителей молока. Но пока дети шли в ближайший супермаркет «Господарочка» за покупками, цена одного литра молока в этом магазине выросла на 20% в базовой валюте, которая использовалась в качестве обеспечения stablecoin. Что же произойдет в системе в этот момент?

Дело в том, что учетной системе необходимо знать текущую цену эталона, к которому привязан stablecoin для своевременной обработки похожих ситуаций. Поэтому существуют специальные оракулы, которые мониторят состояние внешних рынков и записывают актуальное состояние в совместную базы данных учетной системы. Теперь смарт-контракту для исполнения margin call необходимо использовать обеспечение, чтобы выкупить на внутренней бирже один stablecoin по текущей цене и уничтожить его. В этот момент цена составляет 120 единиц базовой валюты, что равно всей сумме обеспечения. В результате автоматического закрытия контракта торговец получает уведомление о том, что его CFD погашен, а любители молока могут спокойно идти в магазин, имея при себе тот же stablecoin, и смогут им воспользоваться, даже если цена на него в базовой валюте успеет еще сильнее вырасти.

Теперь давайте рассмотрим, что произойдет, если цена одного литра молока в базовой валюте снизится. Сразу стоит отметить, что такое снижение не приводит к автоматическому закрытию контракта. По сути, если цена снизится на 20% и будет составлять 80 единиц, а обеспечение останется 120 единиц, то теперь фактический размер залога будет составлять 40 единиц. В такой ситуации торговец может сам инициировать закрытие контракта, тогда по текущей цене на внутренней бирже будет выкуплен и уничтожен один stablecoin, а торговец получит обратно в свое распоряжение оставшиеся 40 единиц базовой валюты; если у торговца на балансе есть соответствующий stablecoin, то будет уничтожен он и в распоряжение торговца вернется вся сумма обеспечения. Кроме того, торговец может решить, что 40 единиц залога – это слишком много для этого смарт-контракта, и вернуть себе 20 из них, либо внести изменения в контракт и выпустить еще 0.2 stablecoin под залог того же обеспечения.

Такой подход к созданию stablecoin будет работать только при определенных допущениях: кроме обычных пользователей в системе должны быть торговцы, которые открывают контракты и выпускают достаточное количество stablecoin, на внутренней бирже системы должна быть достаточно большая ликвидность, которая позволит осуществлять автоматический выкуп, множество оракулов должно поддерживать актуальность данных о стоимости эталона на внешних рынках. Кроме этого, стоит учитывать и другие допущения, связанные с особенностями устройства децентрализованной учетной системы.

Хорошим примером применения данного подхода на практике является децентрализованная платформа Bitshares. Наиболее популярными stablecoin, выпущенными на этой платформе на момент марта 2020 года, являются bitUSD (выпущено более 2 миллионов единиц) и bitCNY (выпущено более 28 миллионов единиц), привязанные по цене к доллару США и китайскому юаню соответственно.


### Способы привязки без обеспечени

Особенность способов привязки цены stablecoin к стоимости эталона без использования какого-либо обеспечения состоит в том, что механизм привязки фактически изменяет количество stablecoin в обороте. Это, в свою очередь, влияет на спрос и предложение (на данный stablecoin). Теоретически цена поддерживаемого таким образом stablecoin должна колебаться в узком диапазоне около цены самого эталона. Такой подход напоминает способ поддержания цены большинства фиатных валют центробанками, которые их выпускают. Важная особенность такого stablecoin состоит в том, что эмитент не обязуется его погашать по какой-либо цене, т. е. он может использоваться в качестве средства оплаты или может быть продан на бирже.

Рассмотрим на примере принцип работы механизма привязки цены таким способом. Допустим, некоторая группа фермеров приняла решение запустить совместную систему для учета stablecoin, цену которого они будут пытаться удерживать равной стоимости одного литра молока в сети супермаркетов «Господарочка». Они выпускают в этой системе некоторое количество stablecoin и сразу выставляют их на продажу по цене литра молока в сети супермаркетов.

Если спрос на stablecoin оказывается настолько большим, что цена stablecoin на биржах превышает текущую цену молока, то фермеры принимают совместное решение выпустить еще новых stablecoin и выставить их на продажу строго по цене литра молока в Господарочке. Таким образом удовлетворяется повышенный спрос на stablecoin.

Если предложение начинает превышать спрос и цена stablecoin опускается ниже стоимости молока на полках магазина, то по правилам учетной системы начинает расти вознаграждение, которое могут получить держатели stablecoin, если заморозят его на некоторое время. Это правило реализуется с помощью смарт-контракта, который по желанию пользователя замораживает его stablecoin на некоторое время и выплачивает ему вознаграждение в базовой валюте. Размер вознаграждения зависит от времени, на которое заблокирован stablecoin, и отклонения цены stablecoin. Таким образом, система мотивирует участников выводить stablecoin из оборота, когда необходимо справиться с повышенным предложением. В итоге, увеличение вознаграждения стимулирует спрос на stablecoin и снижает его предложение.

Такой подход к созданию stablecoin также может быть реализован в децентрализованной учетной системе, однако тут есть один интересный вопрос. Кто будет владельцем stablecoins, которые только что выпустились? И кому достанется выручка от их продажи? Хорошим примером применения данного подхода на практике является система NuShares, где выпускается и учитывается stablecoin NuBits, который привязан к стоимости одного USD. И хотя весной 2018 года механизм привязки не справился со своей задачей – цена NuBits обрушилась, тем не менее в этой системе есть ответы на некоторые интересные вопросы о самом подходе к созданию stablecoin.

В NuShares выпуск новых NuBits происходит только по решению держателей базовой валюты. Выпущенные в результате голосования NuBits сразу поступают на биржу для продажи, а выручка от их продажи используется для покрытия операционных расходов, поддержания проекта и выплату дивидендов держателям базовой валюты.

### \*\*\*Часто задаваемые вопросы\*\*\*

_– Что произойдет при длительном и неконтролируемом падении эталона, к которому привязан определенный stablecoin?_

Допустим, stablecoin привязан к стоимости гречневой крупы. Вдруг ученые доказывают, что гречневая крупа очень вредная как пищевой продукт, – и относительно какой-либо другой крупы (например рисовой) она сильно дешевеет. При этом механизм привязки стоимости stablecoin к гречневой крупе продолжает действовать – стоимость этого stablecoin все равно равна стоимости гречневой крупы относительно рисовой.

Впрочем, стоимость этого stablecoin может перестать соответствовать стоимости эталона, если механизм привязки stablecoin оказался недостаточно неустойчивым, но это уже другой вопрос.


## 7.2 Детали функционирования stablecoins

Stablecoins представляют собой класс цифровых активов привязанных по своему рыночному курсу (pegged) к одной к одной из фиатных валют, чаще всего к доллару США.

Первым успешным проектом stablecoin можно считать USDT или Tether. Проект был запущен в 2014 году и до сих пор за исключением редких случаев его цена не отклонялась более чем на 0,05–0,1 единиц от доллара США (см. рисунок 7.1) [125].

![Рисунок 7.1 – График курса USDT к доллару США](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.1-exchange-rate-of-USDT-to-US-dollar.png "Рисунок 7.1 – График курса USDT к доллару США")

За 8 лет своего существования USDT обрел популярность и общий объем находящихся в обращении stablecoins превысил 80 млрд. долларов США [125].

![Рисунок 7.2 – График количества выпущенных USDT](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.2-amount-of-USDT-issued.png "Рисунок 7.2 – График количества выпущенных USDT")

Stablecoins играют важную роль в экосистеме цифровых активов, ибо фактически обеспечивают ценообразование насчёт ключевых виртуальных активов, таких как bitcoin (BTC) и ether (ETH). Первоначальное неприятие классическим рынком цифровой экономики и крайне ограниченные возможности торговли за фиатные деньги вынудили энтузиастов создать токенизированную версию доллара США. На текущий момент количество различных проектов stablecoins уже исчисляется десятками.

Общий объем выпущенных stablecoins по состоянию на май 2022 года превышает 180 млрд. долларов США [126]. Первые 2 stablecoins по рыночной капитализации – это Tether (USDT), Circle (USDC). Оба – токенизированные версии доллара США. Самые большие по капитализации недолларовые stablecoins привязанные к евро – это EURT (Tether) [127] и STASIS EURO [128] с капитализацией 250 и 130 млн. долларов США по состоянию на май 2022 года соответственно.

Рост популярности stablecoins обусловлен следующими факторами:

* Stablecoins открыты для любого пользователя практически 24 часа в сутки 7 дней в неделю.
* Переводы осуществляются согласно правилам и особенностям учетной системы в которой выпущен и пребівает в обращении stablecoin, то есть в системе Ethereum перевод осуществляется за считанные минуты.
* Чаще всего stablecoins легко использовать в смарт-контрактах и поэтому они доступны во множестве децентрализованных финансовых приложений (DeFi DAPPS).

Далее разберем основные принципы эмиссии и механизмы привязки стоимости stablecoins. Условно все представленные на рынке проекты можно различать по двум критериям:

* Порядок эмиссии
* Способ обеспечения

Соответствующая классификация stablecoins представлена на рисунке 7.3.

![Рисунок 7.3 – Классификация stablecoins](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.3-classification-of-stablecoins.jpg "Рисунок 7.3 – Классификация stablecoins")


### Централизованные stablecoins

Самый простой вариант – это stablecoin, который выпустила централизованная организация и который обеспечен эталоном стоимости в соотношении 1 к 1. Например, на каждый выпущенный токен USDT, USDC и USDP на банковском счету эмитента есть один доллар США.

Необходимо отдельно отметить что не всегда обеспечение долларовых токенов осуществляется строго долларами США на банковском счете. Например, в случае Tether речь идет об обеспечении в форме резервов со следующим составом [129] по состоянию на май 2022 года:

* 83.74%: денежные средства и их эквиваленты, а также другие краткосрочные депозиты и коммерческие бумаги:
    * 52.41%: казначейские обязательства США;
    * 36.68%: коммерческие бумаги и депозитные сертификаты
    * 6.36%: наличные доллары и банковские депозиты;
    * 4.55%: фонды денежного рынка;
* 6.38%: другие инвестиции (включая цифровые токены);
* 5.27%: обеспеченные кредиты (нет для аффилированных лиц);
* 4.61%: корпоративные облигации, фонды и драгоценные металлы.

То есть, строго говоря, во всем балансе обеспечения USDT собственно долларами на банковском счете обеспечено только 6,36%, что даже меньше, чем доля «других инвестиций» (6,38%). Безусловно львиная доля обеспечения является крайне консервативными вложениями в казначейские обязательства США, коммерческие бумаги и депозитные сертификаты. Ежегодные аудиты обеспечения позволяют оценить состав и качество обеспечения и через публичные отчеты гарантировать пользователям USDT соответствие заявленного реальности.

Второй по объему эмиссии проект USDC является более консервативным чем USDT. Ежемесячное аудиторское заключение содержит фразу о том что общая справедливая стоимость активов, выраженных в долларах США, хранящихся на отдельных счетах, как минимум равна стоимости 51,388,555,903 токенов USDC, пребывающих в обороте по состоянию на 31 марта 2022 года [130].

Таким образом, степень доверия к тому или иному централизованному stablecoin с обеспечением в долларах США и сопоставимых активах сводится к доверию организации эмитенту и проверяющим отчетность аудиторам.

Особенностью централизованных stablecoins является возможность блокировки средств на определенных адресах. То есть в соответствующем смарт-контракте есть функция, которая позволяет эмитенту заблокировать средства на определенном адресе по просьбе государственных органов. В случае с USDC такие адреса опубликованы на сайте компании эмитента [131].

Преимуществами централизованных stablecoins является простота их выпуска и учета. Недостатками является их полная зависимость от организации эмитента и от качества и сохранности обеспечения, а также централизованный контроль с возможностью блокировки средств на отдельных адресах.


### Децентрализованные stablecoins

Следующим шагом в развитии stablecoins являются децентрализованные протоколы их выпуска и обслуживания построенные на смарт-контрактах. В этом случае нет единого лица или организации которая бы по своему усмотрению выпускала stablecoin, а есть система смарт-контрактов отвечающих за децентрализованную эмиссию и изъятие из оборота соответствующих токенов.

Самым ранний проектов децентрализованного stablecoin и одним из самых успешных – проект Maker DAO с децентрализованным stablecoin DAI [132]. Он возник в 2014 году в форме децентрализованной автономной организации (Decentralized Autonomous Organization, DAO), запущенной в учетной системе Ethereum. Управляющим токеном в системе управления DAO является MKR. С его помощью осуществляется голосование и принятие основных решений о путях развития проекта. В качестве обеспечения DAI могут использоваться как цифровые валюты, например, ether, так и токены или stablecoins, например, USDC. В зависимости от принимаемого системой уровня риска обеспечение в цифровых активах может составлять от 102% до 175% [133]. Для выпуска DAI под залог USDC в соотношении 1 к 1 используется специальный модуль – PSM USDC (Peg Stability Module) [134]. С его помощью по состоянию на май 2022 года было выпущено 3,8 млрд. DAI [135].

В экосистеме Maker DAO по состоянию на май 2022 года выпущено 8,5 млрд. DAI с обеспечением на сумму 13,9 млрд. долларов США [136]. Таким образом, каждый DAI обеспечен залогом на 1,64 доллара США или на 164%.

Высокоуровневое схематическое изображение протокола Maker DAO приведено на рисунке 7.4 [137].

![Рисунок 7.4 – Основные участники системы Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.4-main-participants-of-Maker-DAO-system.png "Рисунок 7.4 – Основные участники системы Maker DAO")

В отличие от централизованных stablecoins в Maker DAO эмитентом DAI может быть любой пользователь обладающий необходимой для этого суммой залога, например, в ether. Для осуществления эмиссии пользователю необходимо отправить ether в специальный смарт-контракт системы называемый сейфом (vault). Минимальная сумма выпуска DAI для сейфа типа ETH-A с условием 145% обеспечения и годовой комиссией (stability fee) в размере 2,25% [138] является 15000 DAI. Все риск-параметры и комиссии утверждаются голосованием владельцев токенов MKR (MKR Governance). Выбрав допустимую сумму эмиссии DAI пользователь отправляет транзакцию вызывающую смарт-контракт системы в результате чего он получает на свой адрес DAI. Вместе с тем система блокирует в сейфе сумму ether соответствующую 145% выпущенных stablecoins. Далее если у пользователя будет желание забрать заблокированный залог – ему необходимо вызвать специальный метод смарт-контракта и вернуть долг с соответствующим количеством DAI с учетом накопленных процентов комиссии (stability fee). При этом смарт-контракт погашает DAI, а залог возвращает на адрес инициатора вызова.

Пример сейфа 27448 на рисунке 7.5 [139]. В качестве залога используется обернутый (wrapped) stETH, то есть обязательства на ether, которые были вложены в сервис Lido Ethereum. Минимальный залоговый коэффициент составляет 160%, реальный 357,63%. При достижении минимального залогового коэффициента сейф ликвидируется, то есть чтобы избежать ликвидации владелец сейфа должен поддерживать соотношение превышающее минимальное с некоторым запасом ввиду волатильности актива в залоге к доллару США. Ежегодная комиссия – 2,25%. Эмиссия в сейфе составила 8,2 млн. DAI. Залог составляет 10275 токенов wstETH на сумму более 29,3 млн. долларов США.

![Рисунок 7.5 – Пример сейфа в Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.5-vault-in-Maker-DAO.png "Рисунок 7.5 – Пример сейфа в Maker DAO")

Таким образом, мы разобрались с ролью пользователей DAI которые могут участвовать в выпуске и уничтожении DAI, а также использовать stablecoins, как и другие токены, переводя их с адреса на адрес.

Рассмотрим еще одну группу важных участников системы Maker DAO – это поддерживающие участники (maintainers). Сопровождающие или поддерживающие функционирование системы участники отвечают в частности за процесс ликвидации позиций пользователей, по которым сумма долга превышает определенную протоколом сумму обеспечения. Участники отвечающие за этот процесс в Maker DAO называются keepers.

Проще всего разобрать пример ликвидации на примере. Предположим мы положили в сейф ETH-A залог на сумму \$ $100,000$ долларов в ether. Под этот залог мы эмитировали 50,000 DAI. Таким образом, процент покрытия обеспечением составил $\frac{100,000}{50,000} \cdot 100$% $=200$. Известно, что минимальное значение обеспечения для сейфа ETH-A составляет 145%. По прошествии определенного времени цена на ether начала снижаться и вместе с ней начала падать стоимость обеспечения выпущенных нами DAI. Как только стоимость залога снижается ниже предельной величины, а именно $50,000 \cdot 145$% =$72,500$(долларов США), в процесс вмешиваются keepers, которые забирают залог и погашают кредит в DAI вместо пользователя. Для keeper это выгодно делать, потому что он выкупает ether за DAI с большой скидкой, так как по прежнему в момент выкупа сумма залога в ether составляет 145% от стоимости выпущенных DAI. Из 45% разницы уплачивается комиссия взимаемая системой за ликвидацию позиции в размере 13%, а остальное keeper забирает себе в качестве вознаграждения за своевременную ликвидацию. Важно отметить, что в качестве keeper может быть любой желающий.

Возникают ситуации когда падение стоимости обеспечения происходит настолько стремительно, что keepers не успевают выкупить залог когда его стоимость составляет от 100% до 145% стоимости DAI. В данном случае для keeper погашение кредита за пользователя является экономически нецелесообразным, так как стоимость получаемого залога меньше чем стоимость отдаваемых DAI. В такие моменты ликвидация позиций осуществляется на уровне протокола за счет накопленного системного избытка (system surplus), который по состоянию на май 2022 года составляет около 70 млн. DAI. Системный избыток накапливается из средств уплаченных пользователями комиссий от выпуска DAI (stability fee). В случае если и этих средств недостаточно происходит автоматическая эмиссия токенов управления MKR и их продажа за DAI. Вырученные от выпуска этих токенов средства идут на ликвидацию позиций с нарушенным соотношением обеспечения к эмитированным DAI.

Кроме этого в системе Maker DAO предусмотрены ценовые оракулы (oracles). Данный вид участников снабжает систему данными о текущей стоимости всех задействованных в системе активов. Как раз на основании информации полученной от ценовых оракулов и осуществляется запуск процессов ликвидации позиций, определяется максимальная сумма DAI, которую можно выпустить под залог того или иного обеспечения в сейфе системы и так далее.

Также есть роль разработчиков (developers), которые отвечают за совершенствование протокола и исправление ошибок. Как только системой управления (governance) принято решение о внесении изменений в протокол, разработчики непосредственно имплементируют данные изменения в программный код. Разработка финансируется из системного избытка (system surplus) по решению методом голосования держателей токенов MKR.
Управление системой осуществляется по двум основным направлениям: общее управление и команда управления рисками. Начнем с последнего. 

Команда управления рисками отвечает за своевременное изменение риск-параметров протокола, в частности за оценку новых цифровых активов, добавляемых в качестве обеспечения под выпуск DAI. По каждому такому активу определяется залоговый коэффициент, максимальная сумма заимствования и комиссия (stability fee).

По состоянию на май 2022 года система позволяет использовать залоги приведенные в табл. 7.1 [133]. Согласно таблице, система принимает в качестве залога 31 актив на максимальную сумму 34,6 млрд. DAI.

![Таблица 7.1 (1) – Параметры залоговых активов в Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/T-7.1-1-en-collateral-asset-parameters-in-Maker-DAO.png "Таблица 7.1 (1) – Параметры залоговых активов в Maker DAO")

![Таблица 7.1 (2) – Параметры залоговых активов в Maker DAO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/T-7.1-2-en.png "Таблица 7.1 (2) – Параметры залоговых активов в Maker DAO")

По каждому из видов залогов командой управления рисками определяются следующие параметры:

* Предел заимствования (debt​ ​ceiling) – это максимальная сумма долга, которая может быть создана одним типом обеспечения. Система управления присваивает каждому типу обеспечения предел заимствования, который используется для обеспечения достаточной диверсификации портфеля обеспечения системы. Как только тип залога достигает своего предела заимствования, становится невозможно создать новый долг, пока некоторые существующие пользователи не погасят свои долги полностью либо частично.
* Комиссия (stability fee) – годовой процентный доход системы, который зависит от того, сколько DAI было эмитировано под залог любого из активов в таблице 7.1. Комиссия (stability fee) выплачивается только в DAI и становится доходом Maker DAO.
* Залоговый коэффициент (liquidation​ ​ratio). Низкий коэффициент означает, что волатильность цены залога является низкой; высокий коэффициент означает, что ожидается высокая волатильность цены залога. Keepers не могут выкупать залог каждого конкретного сейфа до тех пор, пока в этом сейфе залоговый коэффициент не опустится ниже установленного значения.
* Штраф за ликвидацию (liquidation penalty) – это плата, добавляемая к общему количеству непогашенных DAI, которое начислил сейф и которое подлежит ликвидации. 

Принятие управляющих решений осуществляется держателями токенов MKR путем голосования. Это главный уровень управления DAO. В качестве примера приводим голосование насчет добавления нового актива CF-DROP в качестве залога. Само решение было принято 23 июля 2021 года: 155,24 токенами MKR было проголосовано за [203].

Механизм управления (Governance) подразумевает два вида управления [204]:

* Проактивное
* Реактивное

Проактивное управление включает в себя обсуждение, принятие решения и автоматизированное внедрение. Пример – процесс принятия нового токена в качестве залога и определения его риск-параметров.

Реактивное управление включает процедурное вмешательство. Пример – увеличение или уменьшение предела заимствования в связи с увеличением или уменьшением ликвидности залога.

Голосование держателей токенов MKR может иметь две формы:

* Управленческие опросы (governance polls)
* Исполнительные голосования (executive votes)

Управленческие опросы позволяют принять решение по одному вопросу или группе вопросов (например по добавлению новых оракулов или новой группы риска).

Исполнительные голосования позволяют изменить настройки системы. Например, они могут касаться конкретных риск-параметров для нового типа залога.

В целом системой управления принимаются решения по следующим вопросам:

* Добавление нового актива в качестве допустимого обеспечения под выпуск DAI с новым набором параметров риска
* Изменение параметров риска одного или нескольких существующих залоговых активов или добавление новых параметров риска к одному или нескольким существующим залоговым активам
* Выделение средств из доходов системы для оплаты различных потребностей и услуг инфраструктуры, включая услуги оракулов и исследования по управлению сопутствующими рисками
* Изменение ставки сбережения DAI
* Выбор набора ценовых оракулов
* Выбор набора экстренных ценовых оракулов
* Активировать аварийное закрытие системы
* Обновление системы

Таким образом, ответственность за функционирование Maker DAO полностью возлагается на держателей токена MKR. В рамках смарт-контракта инициируется голосование о принятии некоторого решения. Любой пользователь с токенами MKR может поддержать это решение, отдав за него свой голос, причем вес голоса будет равен количеству токенов на балансе этого пользователя. Соответствующее решение будет принято, если суммарный вес голосов достиг порогового значения (например 2% от всех выпущенных токенов MKR). В зависимости от важности и сложности решения соответствующее голосование может использовать разное пороговое значение для принятия.

Принятое решение попадает в модуль безопасности управления (governance security module) [140]. Основная функция этого модуля в том чтобы дать возможность всем участникам системы еще раз проверить решение и его последствия перед его непосредственной реализацией.

Модуль безопасности инкапсулирует обновленный код работы системы и хранится его для окончательного рассмотрения в течение 24 часов. Таким образом, все заинтересованные стороны (особенно стороны, ответственные за аварийное закрытие системы) могут проверить обновленный код перед его внедрением, чтобы обеспечить целостность системы.

В начале своего развития проект Maker DAO применял в качестве залога именно цифровые активы, в первую очередь ether. Система позволяет вкладывать ether в три вида сейфов:

* ETH A, залоговый коэффициент 145%, комиссия 2,25%
* ETH B, залоговый коэффициент 130%, комиссия 4%
* ETH C, залоговый коэффициент 170%, комиссия 0,5%

То есть чем меньше залоговый коэффициент, тем выше комиссия системы и наоборот.

Помимо ether можно использовать некоторые другие цифровые активы (см. табл. 7.1): WBTC, stETH, LINK, YFI, MATIC, UNI, MANA, renBTC. Общая сумма DAI, выпущенная под залог цифровых активов, составляет 21,53 млрд. DAI.

Следующий класс активов – токены ликвидности, или LP-токены децентрализованных бирж. Их можно считать подвидом цифровых активов. Они представляют собой долю в пуле ликвидности, например, пары токенов DAI и USDC с комиссией за обмен 0,01% на бирже Uniswap. Данная пара является одной из лидеров по объемам ликвидности на децентрализованной бирже Uniswap V3 (ее объем ликвидности – 354 млн. долларов США) [141]. Токены ликвидности, которые можно использовать в качестве залога под выпуск DAI (см. табл. 7.1): GUNI-DAI/USDC 0,01%, GUNI-DAI/USDC 0,05%, DAI/USDC UNISWAP LP, USDC/ETH UNISWAP LP, WBTC/ETH UNISWAP LP, DAI/ETH UNISWAP LP, WBTC/DAI UNISWAP LP, Curve stETH/ETH, UNI/ETH UNISWAP LP.

Когда в качестве залогов используются токены ликвидности пар двух stablecoins DAI и USDC, можно получить 100 DAI под залог 102 единицы LP-токенов (то есть залоговый коэффициент составляет 102%). Когда хотя бы один токен в паре ликвидности является волатильным виртуальным активом, залоговые коэффициенты значительно выше и составляют от 120% до 160%.

Общая сумма DAI, которые могут быть эмитированы под залог токенов ликвидности, составляет 2,18 млрд. DAI. Наибольшую часть этой суммы составляют DAI, выпускаемые под залог LP-токенов DAI и USDC. Таким образом, система стимулирует увеличение доступной ликвидности для обмена DAI на USDC и наоборот.

Для обеспечения стабильности DAI относительно эталона, то есть стоимости доллара США, был разработан специальный модуль стабильности привязки (Peg Stability Module, PSM). Суть которого заключается в том, что в любой момент времени есть возможность без дополнительной комиссии, оплачивая только стоимость транзакции, обменять некоторое количество DAI на такое же количество, например, stablecoins USDC.

На текущий момент доступен обмен с тремя видами stablecoins в рамках модуля PSM (см. табл. 7.1): USDC, USDP и GUSD. Система допускает максимальную сумму обмена DAI на другие stablecoins на сумму до 10,56 млрд. DAI. Львиная доля этого лимита приходится на USDC – 10 млрд. DAI.

Модуль PSM позволяет взимать следующие комиссии [134]:

* Комиссия за вход (fee in, tin). Процентная комиссия, взимаемая при обмене залогового актива на DAI в PSM
* Комиссия за выход (fee out, tout). Процентная комиссия, взимаемая при обмене DAI на залоговый актив в PSM

По состоянию на май 2022 года эти комиссии имеют значение 0 %.

Важно отметить, что объем сделок, которые может предложить PSM, ограничен его пределом долга и текущей суммой залоговых токенов. PSM не может предлагать DAI на обмен, если достигнут предел долга. Точно так же PSM не может предлагать залоговый актив на обмен, если внутри PSM нет залоговых токенов. То есть если, например, в случае с USDC PSM установлен предел в 1000 долларов США, то можно обменять не более 1000 USDC на 1000 DAI. С другой стороны, если пользователи уже обменяли 500 USDC на 500 DAI и в PSM находится 500 USDC, то у пользователей желающих сделать обратный обмен DAI на USDC есть возможность обменять не более 500 DAI на 500 USDC.

Обмен через PSM возможен только между stablecoins, привязанных к одному эталону в отношении один к одному.

Важной составной частью экосистемы децентрализованных финансов являются так называемые лендинговые протоколы или DeFi банки. Самые крупные это AAVE и Compound. Суть их бизнеса и предназначения в том, чтобы обеспечить возможность децентрализованного заимствования одних токенов под залог других. Например, вы депонируете в такую систему 1 ETH и под залог этого актива имеете возможность взять в кредит, например, DAI. При этом в рамках управления рисками по каждому активу есть свой залоговый коэффициент и кривая процентных ставок.

Система работает таким образом, что чем больше средств из пула ликвидности DAI заимствуется, тем больше процентная ставка по таким кредитам. Подробно формулы прироста ставок в зависимости от утилизации пула ликвидности (utilization ratio) приведены в описании самих протоколов [142].

Суть модуля прямого депонирования (Direct Deposit Dai Module) D3M заключается в том, чтобы в ситуации когда процентная ставка в лендинговом протоколе по кредитам превышает определенное утвержденное управленческим решением Maker DAO значение (в случае с протоколом AAVE – 4% [143]) любой желающий может вызвать функцию смарт-контракта лендингового протокола и сбалансировать объем DAI в пуле ликвидности добавив туда необходимый объем DAI напрямую из Maker DAO [144]. При этом Maker DAO получает в качестве залога токены пула ликвидности лендингового протокола. В случае с AAVE это будут токены aDAI. Процесс добавления и отбора ликвидности изображен на рисунке 7.6 [145].

![Рисунок 7.6 – Схема работы модуля D3M](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.6-D3M-module-operation.jpg "Рисунок 7.6 – Схема работы модуля D3M")

Аналогичным образом производится и возврат ликвидности из лендингового протокола, когда процентная ставка по кредитам падает ниже 4% также вызывается функция смарт контракта, которая позволяет забрать избыточную ликвидность и погасить кредит Maker DAO в пользу лендингового протокола [146].

Параметры модуля D3M, работающего с протоколом AAVE, указаны в табл. 7.1. Потолок заимствования составляет 300 млн. DAI, фактическая ставка которую получает Maker DAO – 2,81%, что соответствует примерно ставке в 4% кредитования в AAVE.

Общий подход и возможность реализации взаимодействия с другими системами заимствования показаны на рисунке 7.7 [147].

![Рисунок 7.7 – Схема взаимодействия модуля D3M с лендинговыми протоколами](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.7-D3M-module_s-interaction-with-lending-protocols.png "Рисунок 7.7 – Схема взаимодействия модуля D3M с лендинговыми протоколами")

Преимущества модуля D3M очевидны. Он позволяет держать стоимость заимствования DAI в системе AAVE на предсказуемом уровне на уровне не более 4% годовых. Это делает DAI более привлекательным stablecoin для получения его в кредит по сравнению с другими аналогами у которых ставка заимствования плавающая и в какие-то моменты времени может превышать двузначные значения, что заставляет заемщиков переплачивать по кредитам. На рисунке 7.8 показана динамика ставок заимствования DAI в системе AAVE до внедрения модуля D3M [148].

![Рисунок 7.8 – Процентная ставка заимствования по DAI в протоколе AAVE](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.8-interest-rate-of-DAI-borrowing-in-AAVE-system.png "Рисунок 7.8 – Процентная ставка заимствования по DAI в протоколе AAVE")

Последний класс активов, допустимый в качестве залога под выпуск DAI, – реальный активы (Real World Assets). Общий лимит на данный класс активов составляет 59 млн. DAI (см. табл. 7.1). Выпуск DAI под залог реальных активов можно рассмотреть на примере утвержденного системой управления RWA001-A лимита на 15 млн. DAI.

Американская компания 6s Capital LLC [149] работает с несколькими застройщиками коммерческой недвижимости по всей территории Соединенных Штатов. Застройщики строят коммерческую недвижимость, которая далее сдается в долгосрочную аренду. Компания 6s предоставляет обеспеченные кредиты в размере до 100% от стоимости строительства для финансирования постройки и последующего приобретения коммерческой недвижимости [150].

Компания 6s появилась во время кризиса банковского кредитования COVID-19, когда у ее дочерней компании 6s Development LLC возникли проблемы с банками, которые больше не хотели предоставлять кредиты под строительство. 6s Development LLC занимаются девелопментом и долгосрочной сдачей коммерческой в аренду в течение 15 лет и построили более тысячи объектов. Ни один из проектов профинансированных 6s Development не было дефолтным [150].

MakerDAO по существу предоставляет кредит в обмен на возможность с поправкой на риск обратить взыскание на активы, используемые в качестве залога. В этом контексте MakerDAO будет использовать «Активы реального мира» (RWA) в качестве залога, и при этом необходимо определить каким образом может быть инициирована и выполнена ликвидация кредитной позиции или обращение взыскания на предмет залога в случае возникновения проблем у заемщика с возвратом предоставленных DAI.

В реальном мире невозможно использовать цифровой оракул для автоматизации принятия решения о том, произошло ли нарушение условий кредитования, которое затем приведет к ликвидации. 6s и Maker DAO сначала должны договориться о типе реальных событий, которые могут привести к ликвидации кредита 6s. В данном случае причиной ликвидации является нарушение условий кредитования со стороны 6s. Цифровой оракул не может обратиться в суд и подать иск о нарушении кредитного соглашения против 6s. Это может сделать только лицо, имеющее право подавать иск в суд от имени Maker DAO, то есть представитель Maker DAO в реальном мире. MakerDAO и 6s могут договориться об обязательствах/требованиях/ковенантах и зафиксировать эти условия в ходе голосования токенами DAO, но те же согласованные условия должны быть затем закреплены в письменном соглашении о кредитной линии, подписанном реальным лицом от имени и по поручению Maker DAO.

Таким образом, для организации кредитной линии используются юридическая структура изображенная на рисунке 7.9 [150].

![Рисунок 7.9 – Юридическая структура кредитования в DAI под залог RWA](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.9-legal-structure-of-DAI-lending-for-RWA-collateral.png "Рисунок 7.9 – Юридическая структура кредитования в DAI под залог RWA")

В качестве представителя Maker используется юридическое лицо зарегистрированное на Каймановых островах, которое также выполняет роль налогового агента (Tax Favorable Entity – TFE), который действует через Трастовую компанию (Trust).

Все операции с DAI в реальном мире осуществляются Представителем Maker (TFE) через трастовую компанию (Trust).

Кредитная компания (LendCo) это кредитор, обеспеченный активами в реальном мире. Полученная кредитной компанией доллары США вместе с имеющимся капиталом, который LendCo имеет и будет продолжать привлекать будут использоваться для предоставления обеспеченных кредитов заемщикам (BorrowCo).

Выдача и возврат кредита осуществляются по следующей схеме (см. рисунок 7.10) [150]:

1. Эмиссия новых DAI в пользу TFE.
2. TFE передает DAI в Trust:
    1. Отправляет DAI американскому брокеру-дилеру на его адрес Ethereum.
    2. TFE инструктирует брокера-дилера обменять DAI на доллары США на трастовом счете у брокера-дилера.
    3. TFE инструктирует брокера-дилера перевести доллары США на банковский счет Трастовой компании (Trust).
3. Трастовая компания кредитует Кредитную компанию (LendCo) в долларах США.
4. Кредитная компания проводит кредитные операции и либо погашает ссуды в пользу Трастовой компании, либо возвращает капитал в другую кредитную транзакцию с утвержденным Maker DAO объемом.
5. Кредитная компания погашает кредит в пользу Трастовой компании в долларах США. LendCo переводит доллары США на счет Трастовой компании у брокера-дилера и дает дилеру инструкции по обмену долларов США на DAI.
6. Трастовая компания возвращает DAI TFE на адрес Ethereum.
7. TFE возвращает DAI в хранилище Maker где они сжигаются.

![Рисунок 7.10 – Схема выдачи и возврата DAI под залог RWA](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.10-issuing-and-returning-DAI-for-RWA-collateral.jpg "Рисунок 7.10 – Схема выдачи и возврата DAI под залог RWA")

Maker DAO контролирует и утверждает для Кредитной компании условия по 5 основным направлениям:

* Совокупный потолок долга (в нашем случае 15 млн. DAI)
* Процентная ставка (3%)
* Цели кредита (могут быть изменены Maker DAO по запросу Кредитной компании)
* Требования к залогу для каждой сделки Кредитной компании (могут быть изменены Maker DAO по запросу Кредитной компании)
* Условия ликвидации

Maker DAO является инноватором и первопроходцем в части кредитования под залог реальных активов, когда stablecoin используется не внутри крипто индустрии, а выходит во внешний мир и позволяет в случае с нашим примером финансировать строительство коммерческой недвижимости в Соединенных Штатах Америки.

Для stablecoin DAI проекты в реальном мире хороший способ поддерживать свою привязку к доллару США. Поскольку как только DAI станет дешевле доллара заемщикам из реального сектора станет выгоднее погашать кредит в DAI, так как они получают доходы в реальном мире в реальных долларах США. В обратном случае более дорого чем доллар DAI заемщикам из реального сектора становится выгоднее наращивать кредит и таким образом получать больше долларов за DAI.

Следующим шагом в развитии кредитования реального сектора с помощью DAI является одобренная 18 апреля 2022 года Maker DAO сделка с Huntingdon Valley Bank [151]. В перспективе общий лимит кредитования этого небольшого американского банка может достигнуть 1 млрд. DAI [152].

Далее рассмотрим важный с точки зрения займов процесс ликвидации залогов. Ликвидация – это процесс продажи залога для покрытия суммы DAI, которую пользователь эмитировал из своего сейфа. Ликвидация гарантирует, что DAI всегда обеспечен соответствующей суммой залога, путем закрытия сейфов, уровень обеспечения которых ниже минимально необходимого залогового коэффициента для данного типа обеспечения.

Сейф (vault) может быть ликвидирован, если стоимость его залога упадет ниже требуемого минимального уровня, называемого залоговым коэффициентом (liquidation ratio).

Поскольку система децентрализована, то ликвидация осуществляется также третьими лицами, пользователями системы или отдельным классом пользователей, которые называются keepers. Они выкупают залог со скидкой погашая выпущенные DAI, когда конкретный сейф становится недостаточно обеспеченным.

Оракулы Maker DAO предоставляют системе данные о ценах, которые используются для отслеживания сейфов и в случае нарушения залогового коэффициента любой keeper может инициировать ликвидацию сейфа.

Для расчета залогового коэффициента используется следующая формула: $R_{Y}= \frac{Y \cdot P_{Y}}{Z} \cdot 100 \%$, где _R<sub>Y</sub>_ – залоговый коэффициент, _Y_ – сумма залога, _P<sub>Y</sub>_ – цена залога, _Z_ – эмитированная сумма DAI. Например, для сейфа с залоговым коэффициентом 150% потребуется минимум 1,50 доллара залоговой стоимости на эмитированную единицу DAI.

Если стоимость обеспечения упадет до 1,49 доллара США (или ниже), оно будет ликвидировано для покрытия выпущенных DAI в дополнение к комиссии, называемой штрафом за ликвидацию.

Штраф за ликвидацию (liquidation penalty) — это плата, уплачиваемая владельцами сейфов, когда стоимость их залога достигает цены ликвидации сейфа.

Штраф за ликвидацию добавляется к общей сумме непогашенных DAI, выпущенных сейфом, когда происходит ликвидация, что приводит к продаже большего количества залога на аукционе.

Доходы от штрафов за ликвидацию направляются на пополнение системного избытка либо на сжигание токенов MKR.

На текущий момент в протоколе Maker DAO используется вторая версия ликвидации при помощи Голландского аукцион (Dutch auction). Суть этого аукциона в том, что сначала объявляется самая высокая цена реализуемого актива и далее она постепенно снижается до момента пока первый покупатель не согласится с ней, после чего совершается сделка [153].

Протокол позволяет делать частичный выкуп залога. Таким образом, первый покупатель соглашается на выкуп части выставленных на аукцион активов, а после сделки цена продолжает снижаться, пока залог не будет выкуплен полностью.

На рис. 7.11 изображен аукцион с функцией линейного убывания цены (calc) для залога в сейфе ETH-A: OSM (Oracle Security Module) 200 DAI, buf 20%, tail (tau) 21600 секунд. В результате аукциона необходимо реализовать залог (lot) 347,32 ETH для погашения 60 000 DAI. Есть два претендента: Алиса и Боб. Алиса первая готова дать (take) 50 000 DAI в обмен на залог в размере 256,41 ETH по цене 195 DAI за ETH. Цена ETH со временем продолжает падать, и Боб забирает оставшиеся 90,91 ETH за 10 000 DAI по цене 110 DAI за ETH. Если с момента начала аукциона прошло более 21600 секунд или если цена упала ниже установленного минимума, то аукцион необходимо будет сбросить и начать весь процесс сначала [154].

![Рисунок 7.11 (1) – Аукцион с функцией линейного убывания](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-1-auction-with-linear-function-of-price-decrease.png "Рисунок 7.11 (1) – Аукцион с функцией линейного убывания")

![Рисунок 7.11 (2) – Аукцион с функцией линейного убывания](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-2.png "Рисунок 7.11 (2) – Аукцион с функцией линейного убывания")

![Рисунок 7.11 (3) – Аукцион с функцией линейного убывания](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-3.png "Рисунок 7.11 (3) – Аукцион с функцией линейного убывания")

![Рисунок 7.11 (4) – Аукцион с функцией линейного убывания](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-4.png "Рисунок 7.11 (4) – Аукцион с функцией линейного убывания")

![Рисунок 7.11 (5) – Аукцион с функцией линейного убывания](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.11-5.png "Рисунок 7.11 (5) – Аукцион с функцией линейного убывания")

Протоколом Maker DAO предусмотрено так называемое аварийное закрытие системы (emergency shutdown), которое служит двум основным целям. Во-первых, оно используется во время чрезвычайных ситуаций в качестве последнего из возможных механизмов защиты системы от атак на его инфраструктуру и непосредственно атаку на целевую цену DAI. Чрезвычайные ситуации могут включать в себя атаки на механизм управления системой, взломы кода, нарушения безопасности и долгосрочную иррациональность на рынке. Во-вторых, аварийное закрытие системы может использоваться для обновления протокола Maker DAO. Процесс выключения может контролироваться только системой управления (Maker Governance).

Держатели токенов MKR также могут мгновенно запустить процесс аварийного закрытия системы путем, внесения токенов 50 000 MKR в модуль аварийного отключения системы (Emergency Shutdown Module, ESM), если достаточное количество держателей токенов MKR считают, что это необходимо. Как только пользователи вносят MKR в модуль аварийного отключения, токены немедленно сжигаются [155]. Это предотвращает задержку аварийного отключения со стороны модуля безопасности управления (Governance Security Module). В тот момент, когда необходимый кворум голосования токенами MKR за отключение достигнут, отключение вступает в силу без задержки.

Аварийное отключение включает в себя три фазы [132]:

1. Система Maker DAO закрывается, держатели сейфов забирают свои средства. После запуска аварийного закрытия системы предотвращается дальнейшее создание новых сейфов и операции с существующими сейфами, замораживаются ценовые оракулы. Замороженные ценовые показатели активов позволяют гарантировать что все пользователи смогут отозвать чистую стоимость своих активов, на которую они имеют право. По сути, данная мера позволяет владельцам сейфов немедленно отозвать избыточные залоги в сейфах, которые не используется для обеспечения долгов в выпущенных DAI.
2. Обработка аукционов по продаже залогов после аварийного закрытия системы. После запуска закрытия системы, все залоговые аукционы должны быть завершены в течение определенного количества времени. Этот период времени определяется системой управления как немного дольше, чем продолжительность самого длинного залогового аукциона. Это гарантирует, что в конце периода обработки аукциона нет незавершенных аукционов.
3. Держатели DAI забирают оставшиеся залоги. В конце периода обработки аукционов держатели DAI используют свои DAI, чтобы выкупать залоги непосредственно по фиксированной ставке, которая соответствует расчетной стоимости их активов на основе целевой цены DAI. Например, если соотношение цены ETH/USD составляет 200, а пользователь имеет 1000 DAI по целевой цене 1 доллар США при активации аварийного закрытия системы, пользователь сможет претендовать на ровно 5 ETH из Maker DAO после обработки периода аукционов. Период времени, когда может быть проведен обмен DAI на залоговые активы не ограничен. Владельцы DAI получают пропорциональные доли из каждого залога, который существует в обеспечении портфеля. Держатели DAI могут подвергаться риску потери части залога, в результате чего они не получают полную стоимость своих DAI по целевой цене 1 доллар США за DAI. Это связано с рисками того, что владельцы сейфов, имеющие право забирать избыточный залог первыми, забрали его и оставшейся части залогов недостаточно для полного покрытия требований держателей DAI.

Следующим протоколом stablecoins рассмотрим FRAX. Этот протокол относится к категории так называемых алгоритмических stablecoins. Основная задача которую решает протокол FRAX это как обеспечить устойчивость механизма привязки стоимости имея неполное обеспечение. По состоянию на 4 июля 2022 года обеспечение stablecoin FRAX с помощью USDC составило 90% (см. рисунок 7.12) [156].

![Рисунок 7.12 – График обеспеченности FRAX с помощью USDC](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.12-FRAX-collateralization-with-USDC.png "Рисунок 7.12 – График обеспеченности FRAX с помощью USDC")

Минимальное значения обеспечения или залоговый коэффициент составлял 82% в октябре 2022 года. Обеспечением или залогом для выпуска FRAX является другой stablecoin – USDC. Таким образом, в текущих условиях на 1 FRAX приходится 0,9 USDC и 0,1 Frax Shares (FXS) или волатильного токена являющегося управляющим для экосистемы FRAX.

Проще говоря FRAX позволяет на 900 USDC выпустить 1000 FRAX, таким образом получив премию в размере 100 FRAX. Очевидно, что в случае если FRAX достигнет 100% обеспечения то не будет экономического смысла конвертировать, например, 1000 USDC в 1000 FRAX и платить при этом дополнительную комиссию.

Упрощенно протокол FRAX работает следующим образом (см. рис. 7.13) [157]. Когда цена 1 FRAX превышает 1 доллар США (например 1,01), любой желающий имеет возможность положить в систему обеспечение в виде USDC согласно текущего залогового коэффициента 0,9 USDC и токен FXS на сумму 0,1 доллара и получить взамен 1 FRAX. То есть возможен арбитраж, когда отдаются активы на сумму 1 доллар, а получается взамен актив на сумму 1,01 доллара. При этом полученный FXS системой сжигается, а в обращение выпускается 1 дополнительный FRAX. Дополнительно каждый час снижается залоговый коэффициент на 0,25% [158]. Когда цена 1 FRAX меньше 1 доллара США (например 0,99), любой желающий может обменять через систему 1 FRAX на активы суммарной стоимостью 1 доллар США в виде обеспечения USDC и токена FXS, который эмитируется в этот момент системой. Таким образом, снова возможен арбитраж, когда система позволяет менять актив стоимостью 0,99 на активы стоимостью 1 доллар США. При этом из обращения изымается и сжигается 1 FRAX. Дополнительно каждый час повышается залоговый коэффициент на 0,25% [158].

![Рисунок 7.13 – Модель эмиссии и погашения FRAX](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.13-model-of-FRAX-minting-and-redeeming.png "Рисунок 7.13 – Модель эмиссии и погашения FRAX")

В эмиссии и погашении stablecoin участвует 4 компоненты: сам FRAX, обеспечение в форме USDC, дополнительный волатильный токен FXS и залоговый коэффициент, определяющий необходимые суммы USDC и FXS [157].

Общая формула эмиссии задается следующим образом: $F=YP_{Y}+ZP_{Z}$, где _F_ – количество эмитируемых новых токенов FRAX, _Y_ – количество токенов залога, передаваемых системе, _P<sub>Y</sub>_ – цена в долларах одного токена залога, _Z_ – количество сжигаемых токенов FXS, _P<sub>Z</sub>_ – цена в долларах одного токена FXS. Значение _Z_ выводится из следующего уравнения: $(1-R_{Y})YP_{Y}=R_{Y}ZP_{Z}$, где _R<sub>Y</sub>_ – залоговый коэффициент.

Таким образом, если у нас имеется залоговый коэффициент 50%, 220 USDC ($0,9995/USDC) и токены FXS с ценой $3,50/FXS, то количество FRAX которые мы можем выпустить в обращение определяется следующим образом. Сначала определим количество FXS, которые необходимо сжечь для эмитирования FRAX:

$(1-0.5) \cdot 220 \cdot 0.9995=0.5 \cdot Z \cdot 3.5$;  
$Z=62.54$.
Теперь вычислим объем эмиссии FRAX:
$F=220 \cdot 0.9995+62.54 \cdot 3.5$;  
$F=437.78$.

В случае погашения (сжигания) FRAX используeтся следующая формула [157]: $Y= \frac{FR_{Y}}{P_{Y}}$, где _Y_ – количество получаемых при погашении FRAX токенов обеспечения, _F_ – количество погашаемых токенов FRAX, _R<sub>Y</sub>_ – залоговый коэффициент, _P<sub>Y</sub>_ – цена в долларах одного токена залога. Вместе с возвратом токенов залога система печатает дополнительные токены FXS по следующей формуле: $Z= \frac{F(1-R_{Y})}{P_{Z}}$, где _Z_ – количество эмитируемых токенов FXS, _P<sub>Z</sub>_ – цена в долларах одного токена FXS.

Например, при погашении 170 FRAX с залоговым коэффициентом 65%, ценой $1,00/USDC и $3,75/FXS пользователь получит следующее количество токенов:
$Y= \frac{170 \cdot 0.65}{1} =110.5$;  
$Z= \frac{170 \cdot (1-0.65)}{3.75} =15.867$.

veFXS – это система для блокирования по времени токенов FXS, основанная на механизме veCRV Curve. Пользователи могут заблокировать свои FXS на срок до 4 лет за сумму, в четыре раза превышающую сумму veFXS (например, 100 FXS, заблокированных на 4 года, возвращают 400 veFXS). veFXS – токен, который не передается и не пребывает в обороте на ликвидных рынках. Это больше похоже на систему баллов на основе учетной записи, которая означает продолжительность наделения заблокированных токенов FXS кошелька в рамках протокола.

Баланс veFXS линейно уменьшается по мере приближения срока действия блокировки токенов, приближаясь к 1 veFXS за 1 FXS при нулевом оставшемся времени блокировки. Это поощряет долгосрочные интересы участников сообощества.

Каждый veFXS имеет 1 голос в предложениях по управлению системой. Размещение 1 FXS на максимальное время, 4 года, приведет к получению 4 veFXS или увеличивает количество голосов в 4 раза. Пользователь также может увеличить свой баланс veFXS, заблокировав FXS, продлив дату окончания блокировки или и то, и другое. Следует отметить, что veFXS не подлежат передаче, и каждая учетная запись может иметь только один срок блокировки, что означает, что один адрес не может заблокировать определенные токены FXS на 2 года, а другой набор токенов FXS – на 3 года и т. д. Все FXS на учетную запись должны иметь единое время блокировки.

Основным получателями дохода от работы Frax являются держатели veFXS. Прибыль, полученная от AMO контроллеров распределяется среди участников veFXS в качестве дохода [159].

В версии 2 протокола Frax появились т. н. алгоритмические контроллеры рыночных операций (Algorithmic Market Operations controller, AMO). Каждый модуль AMO – это автономный смарт контракт (контракты), который проводит собственные рыночные операции и при этом не влияет на привязку FRAX к доллару США. Это означает, что контроллеры AMO могут выполнять операции на открытом рынке алгоритмически, но они не могут произвольно эмитировать ничем не обеспеченные FRAX и таким образом ломать привязку к доллару [160].

Каждый контроллер AMO должен соответствовать четырем основным критериям:

* Деколлатеризация. Часть стратегии, которая снижает залоговый коэффициент (collateralization ratio)
* Рыночные операции. Часть стратегии, которая работает в равновесии и не меняет залоговый коэффициент
* Реколлатеризация. Часть стратегии, которая увеличивает залоговый коэффициент
* FXS1559. Учет баланса AMO, который точно определяет, сколько FXS может быть сожжено с прибылью выше целевого залогового коэффициента

Если цена FRAX выше цены USD, залоговый коэффициент снижается, предложение FRAX увеличивается, как обычно, а контроллеры AMO продолжают работать. Если залоговый коэффициент снижается до точки, при которой привязка к доллару утрачивается, AMO приостанавливают все рыночные операции, система начинает реколлатеризацию, поскольку FRAX выкупается, а залоговый коэффициент повышается, чтобы вернуть привязку. Это позволяет всем AMO работать с учетом естественных рыночных сил, так же, как работает механизм Frax v1.

Любой пользователь может предложить контроллер AMO, после чего, если система управления выберет его, то контроллер будет интегрирован в экосистему FRAX.

Работа системы позволяет получать прибыль от работы AMO. Первоначально было предложено регулярно выкупать и сжигать FXS на сумму накопленных излишков. В октябре большинством голосов управления системой было принято решение о направлении всей прибыли держателям токенов veFXS (замороженных в контракте на определенный временной период до 4 лет FXS) [161].

Больший доход выплачиваемый по veFXS ведет к росту спроса на FXS и увеличению количества участников экосистемы заинтересованных в долгосрочных результатах работы системы.

Система Frax запустила собственный метапул ликвидности FRAX3CRV на протоколе Curve [162]. Это означает, что собственный адрес Frax имеет права администратора для этого метапула Curve, что позволяет Curve AMO контроллера устанавливать и собирать административные сборы в пользу держателей FXS. AMO может перемещать свободное обеспечение USDC или вновь выпущенные токены FRAX в свой собственный пул Curve, чтобы создать еще большую ликвидность и улучшить привязку к доллару, получая дополнительный доход.

Общая стратегия AMO включает в себя оптимизацию минимального предложения FRAX _Y_ таким образом, чтобы продажа всего _Y_ сразу в пул Curve с _Z_ TVL и коэффициентом усиления _A_ повлияла бы на цену FRAX менее чем на _X_% (_X_ обозначает чувствительность диапазона залогового коэффициента). Другими словами Curve AMO может поместить дополнительную ликвидность FRAX+USDC в свой собственный метапул Curve. Поскольку система инициирует реколлетаризацию, когда цена FRAX становится ниже $0,99, можно продать некоторую сумму FRAX непосредственно в пул Curve до того, как цена FRAX упадет на 1%. Система Frax может иметь по крайней мере такое количество алгоритмических FRAX, обращающихся на открытом рынке, поскольку продажа всего этого количества сразу в TVL метапула Curve не повлияет на цену настолько, чтобы вызвать изменение залогового коэффициента. Эти суммы довольно велики, если учесть потенциал отклонения курсов stablecoins в метапуле Curve. Например, 330-миллионный FRAX3Pool (при условии сбалансированного базового пула 3Pool) может поддерживать как минимум 39,2-миллионный ордер на продажу FRAX без изменения цены более чем на $0,01. Если порог изменения залогового коэффициента составляет 1%, то система может иметь как минимум 39,2 млн свободных алгоритмических FRAX на открытом рынке без потери привязки к доллару США [163].

Кроме того, Curve распределяет собственные токены CRV в качестве вознаграждения поставщикам ликвидности в метапулы. Поскольку Frax, является крупнейшим поставщиком ликвидности в пуле FRAX3CRV, он может направить все свои токены FRAX3CRV LP на получение дополнительного доход в форме токенов CRV, которые в свою очередь могут использоваться для влияния на решения принимаемые в рамках протокола Curve.

Для получения дополнительного дохода токены ликвидности Curve размещены в системе Convex на момент июля 2022 года (рис. 7.14) [164].

![Рисунок 7.14 – Размещение активов в Curve AMO и в Convex AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.14-assets-allocation-in-Curve-AMO-and-in-Convex-AMO.png "Рисунок 7.14 – Размещение активов в Curve AMO и в Convex AMO")

AMO ликвидности размещает FRAX и/или USDC на других децентрализованных биржах отличных от Curve. Охарактеризовать действие AMO можно 4 пунктами:

* Деколлатеризация: депонирование свободного залога и вновь напечатанных FRAX в пары ликвидности децентрализованных бирж (например Uniswap V3)
* Рыночные операции: сбор комиссии за транзакции обмена токенов на децентрализованных биржах
* Реколлатеризация: вывод средств из пулов ликвидности децентрализованных бирж с последующим сжиганием FRAX и/или возвращением USDC для увеличения залогового коэффициента
* FXS1559: ежедневный сбор комиссий за транзакции и использование их согласно FXS1559

AMO ликвидности на примере Uniswap V3 может печатать и размещать FRAX в пулы ликвидности с другими stablecoins. Это обеспечивает ликвидность для других stablecoins, которые можно обменять на FRAX. Дополнительно, функция collectFees может периодически вызываться для получения прибыли AMO от операций обмена в пулах ликвидности. Диаграмма распределения соответствующих активов на момент июля 2022 года приведена на рис. 7.15 [164].

![Рисунок 7.15 – Распределение активов в Liquidity AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.15-assets-distribution-in-Liquidity-AMO.png "Рисунок 7.15 – Распределение активов в Liquidity AMO")

АМО инвестора позволяет получать доход за счет реинвестирования свободных цифровых активов находящихся в распоряжении системы Frax. Начало этому контроллеру было положено с инвестирования USDC в систему Yearn, далее добавилась возможность инвестировать в системы AAVE, Compound и другие по решению держателей FXS.

Основное условие работы контроллера, это возможность в любой момент времени изъять вложенные активы и направить их на реколлатеризацию в случае необходимости. По этой же причине средства размещенные системой через AMO инвестора не учитываются и не влияют на расчет залогового коэффициента.

Все средства заработанные через контроллер расходуются согласно FXS1559. Распределение средств на момент июля 2022 года отображено на рис. 7.16 [164]. Как видно на рис. 7.16, наибольшая прибыль получена в форме токенов vlCVX, которые получены системой от операций в Curve и используются для получения дохода в Convex, а также для голосования о перераспределении доходов между пулами Curve.

![Рисунок 7.16 – Распределение активов в Investor AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.16-assets-distribution-in-Investor-AMO.png "Рисунок 7.16 – Распределение активов в Investor AMO")

Лендинговый контроллер выпускает FRAX в таких лендинговых системах как Compound, AAVE или CREAM. Механизм эмиссии FRAX подобен механизму работы D3M модуля в протоколе Maker DAO. По сути это дополнительный к основному способ эмиссии и выпуска в обращение токенов FRAX под залог присутствующих в лендинговых системах других цифровых активов и stablecoins.

Такой дополнительный механизм эмиссии допустим, поскольку всегда FRAX на лендинговых платформах выпускается с избыточным залогом, что не влияет на установленный протоколом залоговый коэффициент в сторону его уменьшения.

Лендинговый платформы используют динамический механизм процентной ставки по выдаваемым в кредит активам в зависимости от доли использования пула ликвидности. Таким образом, чем выше процент пула ликвидности того или иного актива выданного в кредит, тем большую цену за этот актив платят заемщики. Протокол Frax имеет возможность ориентируясь на заданную в контроллере целевую ставку допечатывать FRAX в пул ликвидности или изымать уже предоставленную ликвидность, тем самым не допуская резких скачков в цене заимствования FRAX и обеспечивая стоимость заимствования дешевле чем у конкурирующих stablecoins.

Весь полученный процентный доход система расходует в соответствии с FXS1559, как отображено на рис. 7.17 на момент июля 2022 года [164].

![Рисунок 7.17 – Распределение активов в Lending AMO](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.17-assets-distribution-in-Lending-AMO.png "Рисунок 7.17 – Распределение активов в Lending AMO")

Рассмотрим некоторую критику и риски системы Frax. Токен FXS разработан как дополнительный токен для FRAX, токен вмещающий стоимость системы и обеспечения stablecoins. Frax направляет прибыль, полученную от сеньоража (дохода, получаемого от эмиссии денег и присваиваемого эмитентом на праве собственности), непосредственно в токен FXS.

Основным риском такой модели является так называемая спираль смерти (death spiral). Суть этого феномена хорошо проиллюстрирована на примере другого stablecoin UST (протокол Terra). При массовых продажах stablecoin вызванных атакой, либо общим падением на рынке происходит отвязка stablecoin от доллара США. При этом становится выгодно сжигать FRAX ценой, например, 0,98 доллара и получать два других актива USDC и FXS стоимостью 1 доллар, тем самым зарабатывая 0,02 доллара прибыли. Развертывание спирали смерти ломает эту экономическую логику тем фактом, что FXS в цене падает быстрее чем получается заработать на сжигании FRAX. Таким образом, в момент времени _X_ обмен имеет смысл и будет получена прибыль в размере 0,02 доллара, но в к моменту времени _X'_, когда нужно быть фиксировать прибыль продажей FXS может получиться так что будет получен убыток 0,01 доллара. В этой ситуации сжигания и вывода из оборота FRAX не происходит, отвязка увеличивается, токен FXS стремительно теряет в цене и оба актива устремляют свою стоимость к нулю. Именно это произошло с токеном UST и LUNA в мае 2022 года.

К чести системы Frax при обеспечении в 90% вряд ли возможно отклонение его цены ниже 0,9 USD, так как всегда за 1 FRAX можно будет получить 0,9 USDC даже если условно стоимость FXS опустилась до нуля. Однако, по некоторым расчетам фактическое реальное обеспечение FRAX составляет не 90% а 80% за счет средств самой системы вложенных в пулы ликвидности [165]. Кроме того, интерес к проекту во многом держится за счет программ фарминга раздающих FXS в качестве дополнительного вознаграждения в различных пулах ликвидности [166]. Таким образом, долгосрочный успех системы Frax зависит от его способности набрать критическую массу и реальное применение к моменту когда иссякнут источники искусственного стимулирования участников за счет раздачи FXS.

Еще одним существенным и, пожалуй, главным риском является полная зависимость системы от USDC. Как известно USDC это централизованный stablecoin, который может в любой момент по своим внутренним причинам заблокировать любой адрес. Таким образом, потенциальная блокировка адресов системы Frax держащих залог USDC приведет к немедленному краху системы, то же самое произойдет и в случае отвязки самого USDC от доллара США.

Далее рассмотрим протокол синтетических активов Synthetix. Основным активом системы запущенной на этом протоколе является stablecoin sUSD. Вторым по объему sETH и sBTC. Синтетический актив означает что эта сущность, например, sUSD не обеспечена реальным активом, а обеспечена только токеном системы SNX. Таким образом, протокол Synthetix похож на Maker DAO в том смысле, что в обоих протоколах выпуск stablecoins осуществляется за счет залога цифрового актива, только в протоколе Synthetix в качестве залога можно использовать исключительно собственный токен SNX.

Необходимо отметить, что система является полноценной децентрализованной организацией (DAO) и все решения принимаются голосованием держателей токена SNX.

Всего по состоянию на июль 2022 года в обращении находится более 100 млн. sUSD [167]. Основной механизм эмиссии новых sUSD работает через так называемый стекинг портал Synthetix [168]. Для выпуска sUSD необходимо иметь токены SNX в одной из двух учетных систем Ethereum, либо Optimistic Ethereum. Опция с решением второго уровня Optimistic Ethereum появилась вследствие необходимости удешевить стоимость транзакций по эмиссии, погашению и получению вознаграждений в экосистеме Synthetix.

Решением DAO устанавливается залоговый коэффициент C-Ratio, по состоянию на июль 2022 года в случае если этот коэффициент превышает 400%, то есть на 1 выпущенный sUSD в залоге находится SNX на 4 доллара, то пользователь имеет право на получение вознаграждения один раз в неделю, каждую среду в 20:00–21:00 по Киеву. Вознаграждение выплачивается в виде дополнительных токенов SNX и sUSD. SNX для вознаграждения выпускаются системой и увеличивают количество токенов в обращении, при этом на вознаграждения устанавливается 12 месячный вестинг период или период заморозки, доступны эти токены становятся только через год после их получения. До этого момента выпущенные в качестве вознаграждения SNX могут использоваться только для залога и выпуска sUSD. Вторую часть еженедельного вознаграждения составляет sUSD, который доступен сразу и является комиссией, перераспределяемой с платформ, на которых пребывают в обороте синтетические активы: Kwenta Futures, Lyra options, Kwenta Spot, Curve cross-asset swaps и так далее.

Если значение залогового коэффициента C-Ratio опускается ниже 400% то забрать уже начисленное вознаграждение нельзя и новое вознаграждение не выплачивается. Особенностью протокола Synthetix является тот факт, что если начисленное вознаграждение не забрать в течение недели после его начисления, то после наступления следующего периода выплат предыдущее вознаграждение сгорает, таким образом, необходимо каждую неделю делать транзакцию по забиранию (claim) начисленных вознаграждений. Это во многом и объясняет переход протокола на стейкинг и выпуск sUSD на более дешевой с точки зрения стоимости транзакций учетной системе Optimistic Ethereum.

Для увеличения залогового коэффициента C-Ratio есть два способа. Покупка дополнительных токенов SNX, либо сжигание токенов sUSD. Принудительная ликвидация позиции осуществляется через 12 часов после снижения C-Ratio ниже 150% [169]. При этом взимается штраф в размере 30% который перераспределяется в качестве отдельного вида вознаграждения между всеми стейкерами SNX.

Важно отметить что в отличие от многих других проектов и протоколов для стейкинга SNX нет необходимости отправлять эти токены в какой-либо отдельный контракт, факт нахождения их на вашем адресе уже означает их фактический стейкинг как только вы эмитировали то или иное количество sUSD.

Помимо sUSD система Synthetix позволяет покупать синтетические sBTC, sETH а также ряд других синтетических цифровых активов. Основное применение синтетических цифровых активов это возможность их использования для коротких продаж (short), то есть заработать на падении, например, ETH.

Для проведения короткой продажи используется платформа KWENTA. Предположим Алиса хочет осуществить короткую продажу 1 sETH, который для нашего примера условно стоит 1000 долларов.

Алиса вносит 3000 sUSD и занимает 1 sETH в системе KWENTA. Заемный sETH автоматически продается за 1000 долларов США, которые возвращаются Алисе на ее счет. Алиса только что продала в короткую 1 sETH. Чтобы вернуть залог, она должна купить и вернуть 1 sETH. Давайте посмотрим, как изменение цены sETH повлияет на ее прибыль.

После короткой продажи Алиса имеет 1000 долларов США в своем кошельке и должна системе 1 sETH. Если sETH упадет до 900 долларов, когда она выкупит его, у нее останется прибыль в размере 100 sUSD. Однако, если sETH вырастет в цене до 1100 долларов, она потеряет 100 sUSD. Таким образом, Алиса зарабатывает на падении актива.

Если цена sETH продолжит расти, позиции Алисы грозит ликвидация. Когда Алиса открыла короткую позицию, она заблокировала 3000 долларов США для продажи 1 sETH. Это означает, что ее залоговый коэффициент C Ratio равен 300%. Механизм ликвидации запускается после падения залогового коэффициента ниже 120%, поэтому, если цена sETH вырастет до 2500 долларов, короткая позиция Алисы будет ликвидирована.

В целом функционирование коротких позиций регулируется улучшением SIP-103 [170]. Необходимо отметить что открыть короткую позицию можно только с использованием sUSD, таким образом этот stablecoin является основным активом, на котором строится вся экосистема Synthetix.

Еще одно преимущество протокола Synthetix заключается в том, что покупка волатильных активов sBTC, sETH и других синтов за sUSD осуществляется без проскальзывания которое характерно для сделок на децентрализованных биржах. Протокол позволяет делать такие покупки и продажи на основе цен передаваемых в систему ценовыми оракулами. Схема этого процесса изображена на рис. 7.18 [171].

![Рисунок 7.18 (1) – Схема работы протокола Synthetix](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.18-1-Synthetix-protocol-operation.png "Рисунок 7.18 (1) – Схема работы протокола Synthetix")

![Рисунок 7.18 (2) – Схема работы протокола Synthetix](/resources/img/volume-3/7.2-Operating-details-of-stablecoins/F-7.18-2.png "Рисунок 7.18 (2) – Схема работы протокола Synthetix")

Пожалуй, самым рискованным был проект Terra, когда была предпринята попытка создать алгоритмический вообще без обеспечения. То есть формально один токен UST был обеспечен другим токеном – LUNA. Но на самом деле, LUNA не была обеспечена ничем кроме веры в то что крах системы невозможен. В итоге в мае 2022 года LUNA попала в так называемую спираль или петлю смерти. UST упал с 1 доллара до нескольких центов, а тот кто раньше владел миллионами в долларовом исчислении LUNA остался с несколькими сотнями долларов.

Разберем подробнее произошедший обвал и то как проект попал в петлю смерти. Механизм обеспечения UST очень похож на то как работает Frax, только в отличие от Frax, где доля алгоритмического обеспечения в форме FXS составляет всего 10–20%, остальное обеспечено USDC, в системе Terra доля алгоритмического обеспечения составляла 100%.

При отрыве UST от своей целевой стоимости в 1 доллар США, по замыслу проекта возникает возможность арбитража за счет покупки UST по цене 0,99 доллара США и обмене на токены LUNA стоимостью 1 доллара США, в итоге прибыль в 1 цент. Эта модель работает до тех пор, пока скорость падения курса LUNA не превышает темп отвязки UST. В ситуации когда за время обмена UST на LUNA и последующей фиксации прибыли в долларах США курс LUNA упал до 0,98 доллара США поддержка курса UST его сжиганием и обменом на LUNA теряет всякий экономический смысл, это и есть спираль смерти, дальнейшие попытки стабилизировать курс штатными методами протокола приводят к обесценению и UST и LUNA.


### Итоги о stablecoins

Случай с проектом Terra четко показал, что практически создавать (печатать) доллары из воздуха может только Федеральная Резервная Система США. Все остальные алгоритмы и протоколы должны опираться в качестве обеспечения на либо уже напечатанные доллары США и здесь у нас много примеров, в частности централизованные stablecoins USDT и USDC, либо на другие, цифровые активы, например, система Maker DAO. При этом важно отметить, что чем более волатилен актив используемый в качестве обеспечения к доллару США, тем больше залоговый коэффициент, поэтому, претензии по оверколлатеризации к системе Maker DAO, считаются безосновательными. Если вы печатаете доллар из доллара, залоговый коэффициент у вас 100%, если вы печатаете stablecoin на базе волатильного цифрового актива, залоговый коэффициент у вас 130% и более, так как нужен буфер позволяющий при резком падении цены обеспечения ликвидировать позицию и вернуть выданный кредит в stablecoins.

Frax условно можно назвать системой выпускающей доллар на доллар, так как stablecoin FRAX на 90% обеспечен USDC, оставшиеся 10% это способность системы зарабатывать и накапливать внутреннюю стоимость с течением времени.

Synthetix является хорошим исключением, так как в качестве обеспечения использует собственный токен SNX, но при этом необходимо отметить что, во-первых, протокол стимулирует держать уровень обеспечения выше 400%, то есть на каждый 1 доллар выпущенного sUSD в залоге находятся токены SNX на 4 доллара, а это очень много, во-вторых, проект Synthetix создал экосистему производных финансовых инструментов в которой sUSD является монополистом и единственно допустимым залогом. То есть сфера применения sUSD сильно ограничена внутренними потребностями системы в залоге на платформе KWENTA. То есть sUSD пример stablecoin выпущенного под специфические нужды, созданной экосистемы и имеющего ограниченное хождение, не имеющего целей обширной внешней экспансии.

Эксперименты со stablecoins продолжаются. Заслуживают внимание последние объявления о выпуске собственных stablecoins в системах AAVE и Curve. После отключения модуля D3M Maker DAO от AAVE, для последнего запуск собственного stablecoin является вполне закономерным и логическим шагом, так как внутри AAVE заблокированы активы на миллиарды долларов США. То же самое касается Curve, бизнес модель которого в принципе построена на пулах ликвидности по обмену одних stablecoins на другие.

Компания «Distributed Lab» разработала собственный лендинговый протокол DL DeFi Core с интегрированным stablecoin. Модель которая использована в DL DeFi Core позволяет собирать в пулы ликвидности виртуальные цифровые активы и на их основе выпускать stablecoin с заданным залоговым коэффициентом под всю ликвидность помещенную пользователем в систему. Этот подход, в частности, превосходит возможности Maker DAO, которая давно использует ту же модель, но при этом под каждый из помещенных активов эмиссия DAI осуществляется отдельно с отдельными показателями залогового коэффициента и параметрами ликвидации позиции под каждый из видов залога. Таким образом, DL DeFi Core в отличие от Maker DAO позволяет улучшать залоговый коэффициент помещением в систему любого из активов допущенных в качестве залога и избегать принудительной ликвидации.


## 7.3 Обзор DeFi-протоколов

В мире существует огромное количество финансовых инструментов, которые создавались и совершенствовались десятками лет: кредитование, деривативы, биржи. В то же время с недавним, но стремительным развитием децентрализованных технологий они начали постепенно появляться в децентрализованной среде и обретать новую форму. Для зарождавшейся экосистемы даже был придуман собирательный акроним DeFi, происходящий от термина «децентрализованные финансы» (decentralized finance). DeFi охватывает ряд проектов, технологий и финансовых инструментов, присутствующих только в децентрализованных учетных системах.

Основные компоненты экосистемы DeFi, которые будут рассмотрены далее:

* Децентрализованные биржи
* Децентрализованные протоколы кредитования и займа
* Stablecoins
* Производные финансовые инструменты (деривативы)
* Yield-агрегаторы
* DEX-агрегаторы


### Протоколы децентрализованных бирж

В подразделе 1.4 книги уже были рассмотрены технологии децентрализованных бирж. Всех их объединяет одинаковый принцип работы: сопоставление ордеров происходит с использованием order book, обмен активов осуществляется peer-to-peer, а цена в свою очередь формируется offchain.

В этом разделе будут рассмотрены децентрализованные биржи построенные на основе Automated Market Maker (AMM). AMM – это механизм, позволяющий осуществлять onchain-ценообразование. Для этого под каждую пару активов создается специальный смарт-контракт (смарт-контракт пула ликвидности), который выступает в качестве котлового счета, а также проводит расчет цен на основе формул учитывающих спрос и предложение. Помимо этого, после каждого осуществления обмена одного актива на другой определяется новое соотношение цен.

Как результат, каждый пользователь может взаимодействовать напрямую со смарт-контрактом пула ликвидности, а не с конкретными ордерами, оставленными контрагентами. Примерами таких бирж являются Uniswap и Curve. Рассмотрим каждую из них детальнее.


### Протокол Uniswap

Uniswap – это протокол децентрализованного обмена развернутый в системе Ethereum. Именно Uniswap стал доказательством описанной Виталиком Бутериным [172] концепции децентрализованных бирж на основе AMM. Первая реализация была предложена Hayden Adams, который на тот момент хотел попрактиковаться в Solidity-разработке, а по итогу получил грант от Ethereum Foundation [173].

На текущий момент существует 3 версии протокола. Рассмотрим каждую из них детальнее.

Начнем с первой версии – Uniswap V1. Для того чтобы понять как работает протокол, рассмотрим его основные компоненты [174]:

* Биржевые смарт-контракты, которые реализуют контракт пула ликвидности для пары ERC-20 токена и ETH. Такой подход позволяет совершать обмен любых токенов стандарта ERC-20, используя ETH в качестве промежуточного актива. Соотношение цен между токеном и ETH определяется формулой, заданной в биржевом смарт-контракте [175].
* Factory смарт-контракт, который позволяет создавать новые биржевые смарт-контракты. Также служит публичным реестром всех доступных биржевых смарт-контрактов.

Теперь давайте рассмотрим, что доступно пользователям в первой версии протокола.

Прежде всего, как предоставляется ликвидность? Каждый пользователь может при желании задепонировать свои ERC-20 токены, а также эквивалентное им количество ETH в пул ликвидности по текущему курсу пула. В обмен на предоставленные токены, пользователь получает от системы соответствующее его вкладу количество LP tokens (также их часто называют liquidity provider tokens) [176].

Зачем это необходимо? В простом случае, если система хочет обеспечить разделение награды от обменов равномерно между всеми поставщиками ликвидности – ей необходимо создать огромное количество отдельных транзакций. Очевидно, что размер наград не покроет комиссии за все новые транзакции. Поэтому накопление наград происходит на стороне смарт-контракта, а затем только по запросу пользователя средства выводятся вместе с предоставленной ликвидностью.

Описанный механизм работает по принципу перманентного увеличения курса между LP токенами и базовым активом. Само же изменение курса рассчитывается с учетом всех «принесенных» в систему комиссий за займы. Принцип работы протокола можно увидеть на рисунке 7.19 [181].

![Рисунок 7.19 – Схема работы протокола Uniswap](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.19-Uniswap-protocol-operation.png "Рисунок 7.19 – Схема работы протокола Uniswap")

Также каждый желающий пользователь может совершить обмен, заплатив при этом комиссию. В протоколе Uniswap V1 обмен может быть двух видов:

* ERC20 на ETH
* ERC20 на другой ERC20 token

Рассмотрим как осуществляется расчет цены обмена. Важно отметить, что соотношение цен пересчитывается смарт-контрактом каждый раз после выполнения обмена. Главное правило, по которому определяется соотношение цены между двумя активами, описывается следующим образом: когда в пуле ликвидности становится больше актива _X_, а актива _Y_ меньше – это означает, что спрос на актив _Y_ становится больше, а его цена по отношению к активу _X_ также увеличивается.

С математической точки зрения этот механизм описывается следующим инвариантом: $xy=k$, где _k_ – константа. (Инвариант в этом контексте подразумевает выражение, обладающее свойством неизменности.) Это означает, что независимо от изменения количества каждого актива в пуле ликвидности, произведение их количеств должно оставаться постоянным. Такой подход гарантирует постоянное наличие ликвидности в пуле. Схема ценообразования в Uniswap изображена на рисунке 7.20 [181].

![Рисунок 7.20 – Ценообразование в Uniswap](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.20-pricing-in-Uniswap.png "Рисунок 7.20 – Ценообразование в Uniswap")

Давайте рассмотрим пример, как будет меняться курс при обмене двух активов. Для этого используем такие обозначения:

* _x_ – количество единиц актива _X_ в пуле ликвидности.
* _y_  – количество единиц актива _Y_ в пуле ликвидности.
* _Δx_ количество единиц проданного актива.
* _Δy_ количество единиц купленного актива.
* _x'_  количество единиц актива _X_ в пуле ликвидности после совершения сделки.
* _y'_ количество единиц актива _Y_ в пуле ликвидности после совершения сделки.

Главное правило определяющее цену актива выглядит следующим образом: $xy=(x+Δx)(y-Δy)$. Тогда количество оставшихся токенов в пуле ликвидности будет рассчитываться по таким формулам: $x'=x+Δx=x(1+α)= \frac{x}{1-β}$, $y'=y-Δy= \frac{y}{1+α} =y(1-β)$, где $α= \frac{Δx}{x}$, $β= \frac{Δy}{y}$. В то же время можно вывести формулы стоимости обмена определенного количества токенов _X_ на токены _Y_: $Δx= \frac{xβ}{1-β}$, $Δy= \frac{yα}{1+α}$.

Помимо этого, при совершении обмена пользователь обязан оплатить комиссию, которая затем будет выплачена поставщику ликвидности. Для каждого пула ликвидности задается свой собственный процент комиссии, который определяется волатильностью актива. Для более волатильных активов комиссия выше, а для stablecoins она зачастую равна 0.3%. Главное правило определения комиссии выглядит следующим образом: $0 \lt p \lt 1$, где _p_ – доля комиcсии. Тогда получим такие формулы: $x'=x+Δx=x(1+α)= \frac{x(1+β( \frac{1}{γ} -1))}{1-β}$, $y'=y-Δy= \frac{y}{1+αγ} =y(1-β)$, где $α= \frac{Δx}{x}$, $β= \frac{Δy}{y}$, $γ=1-p$. Таким образом, мы можем рассчитать стоимость обмена определенного количества токенов _X_ на токены _Y_ с учетом комиссии: $Δx= \frac{xβ}{γ(1-β)}$, $Δy= \frac{yαγ}{1+αγ}$.

Рассмотрим каким образом создаются новые биржевые смарт-контракты. Данный процесс осуществляется при помощи Factory смарт-контракта, при этом каждому уникальному ERC-20 токену может соответствовать только один биржевой смарт-контракт [177].

Увидеть весь список доступных пулов ликвидности, а также их параметры можно используя веб интерфейс. На рисунке 7.21 изображен топ пулов ликвидности в Uniswap на 15 августа 2022 года [178].

![Рисунок 7.21 – Топ пулов ликвидности в Uniswap](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.21-top-liquidity-pools-in-Uniswap.png "Рисунок 7.21 – Топ пулов ликвидности в Uniswap")

Uniswap V1 предоставляет следующие функции для поддержки выполнения обменных операций [179]:

* createExchange – создание нового пула ликвидности
* addLiquidity – предоставление ликвидности в пул
* removeLiquidity – забрать депонированные средства из пула.

Для непосредственного обмена активов есть функции, названные согласно следующему шаблону: ‹ethToToken | tokenToEth | tokenToToken›‹Swap | Transfer›‹Input | Output›, где:

* ethToToken обозначает, что происходит обмен ETH на ERC-20.
* tokenToEth обозначает, что происходит обмен ERC-20 на ETH.
* tokenToToken обозначает, что происходит обмен ERC-20 на ERC-20.
* Swap обозначает, что купленные токены отправятся на тот же адрес, с которого были проданы.
* Transfer обозначает, что купленные токены будут отправлены на другой адрес определенный пользователем во входящих параметрах вызываемой функции смарт-контракта.
* Input обозначает, что пользователь точно задает количество продаваемых токенов, в то время как количество покупаемых токенов может варьироваться в зависимости от курса.
* Output обозначает, что пользователь точно задает количество покупаемых токенов, в то время как количество продаваемых токенов может варьироваться в зависимости от курса.

Давайте рассмотрим в качестве примера функцию ethToTokenTransferInput. Вызвав эту функцию, пользователь должен определить такие пункты:

* Точное количество ETH на продажу
* Минимальное количество ERC-20
* Адрес получателя купленных ERC-20 токенов

После выполнения этой транзакции последствия такие:

* На адрес пула ликвидности зачислится проданный ETH.
* На адрес получателя зачислится количество ERC-20 токенов эквивалентное указанному количеству ETH. В случае, если количество ERC-20 будет меньше минимального количества – транзакция не выполнится.

Помимо этого также существуют функции, которые могут возвращать соотношения цен между разными парами активов. Это такие функции [180]:

* getEthToTokenInputPrice
* getEthToTokenOutputPrice
* getTokenToEthInputPrice
* getTokenToEthOutputPrice

Далее рассмотрим особенности следующей версии протокола Uniswap V2. В то время как первая версия была нацелена на доказательство концепции, целью второй версии стало дальнейшее развитие идеи, а также привнесение большего удобства и безопасности в использование протокола. В результате вторая версия включала в себя ряд следующих обновлений [182]:

* *Возможность создавать пулы ликвидности для пар ERC-20 токенов, а также совершение прямых (без промежуточного актива) обменов
* Децентрализованные оракулы цен (вместо централизованных оракулов Uniswap V1)

Следующая версия протокола Uniswap V3 предполагала решение следующей задачи: в предыдущих версиях протокола, при обмене stablecoins, механизм расчета цены срабатывал таким образом, что 1 USDT можно было приобрести за 1.05 USDC [183], что на больших суммах формирует слишком большую и невыгодную разницу, ведь оба stablecoin привязаны к одному эталону, потому и обмениваться они в идеальном случае должны 1 к 1. Это происходило из-за неэффективности constant-product инварианта для обмена стейблкоинов привязанных в одной и той же валюте.

Поэтому определяющим нововведением третьей версии протокола Uniswap V3 стал механизм концентрированной ликвидности, который предположительно решил бы данную проблему [184].

За счет чего работает механизм? Каждый пользователь при предоставлении ликвидности способен определить диапазон, в котором его ликвидность может быть использована. Протокол в свою очередь мотивирует пользователей концентрировать всю предоставляемую ликвидность в определенном ценовом диапазоне в зависимости от пула ликвидности (например от 0,99 до 1,01 доллара для пула USDT-USDC). В конечном счете больше награды получают те пользователи, в чьем диапазоне было совершено больше всего обменов, а так как обмен стейблкоинов удовлетворяет обе стороны обмена (желающих купить USDT и желающих купить USDC), то и курс между двумя стейблкоинами остаётся в близкой к области 1 к 1.

Очевидным преимуществом для пользователей совершающих обмены является больший объем ликвидности в определенном ценовом диапазоне.


### Протокол Curve

Curve – это протокол децентрализованного обмена [185], принцип работы которого крайне близок к Uniswap. Главная его особенность – это ориентированность на рынок стейблкоинов.

С той же целью, что Uniswap создал механизм концентрированной ликвидности, команда Curve разработала собственный механизм обмена стейблкоинов – stableswap [186].

Чтобы понять как работает данный механизм, для начала рассмотрим constant-sum (constant-price) инвариант: $x+y=k$. При таком инварианте обмен стейблкоинов будет происходить по курсу 1 к 1, потому как сумма количества двух активов до обмена будет равной сумме после обмена: $x+y=(x+Δx)+(y-Δy)$. Это в свою очередь означает, что сумма купленного и проданного актива будут всегда равны: $Δx=-Δy$.

Хотя такой способ и кажется хорошим для работы со стейблкоинами, все же он влечет за собой следующие недостатки:

* Может сложиться ситуация, когда в пуле ликвидности не остается монет для совершения обмена. В таком случае система может понести огромные убытки.
* Количество стейблкоинов, поддерживаемых платформой, может быть резко уменьшено ввиду «нестабильности» или непопулярности отдельных стейблкоинов.

В результате команда Curve решила объединить эти два инварианта (см. рис. 7.22), чтобы получить идеальное решение, при котором отвязка стейблкоинов маловероятна, цена обмена будет приемлемой, а у системы всегда будет в наличии определенное количество ликвидности.

![Рисунок 7.22 – Сравнение инвариантов](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.22-comparison-of-invariants.png "Рисунок 7.22 – Сравнение инвариантов")

Рассмотрим как же математически осуществляется объединение инвариантов. Инварианты в общем виде выглядят следующим образом: constant sum $\displaystyle\sum_{i}{x_{i}} =D$, constant product $\displaystyle\prod_{i}{x_{i}} =( \frac{D}{n} )^{n}$, где _D_ – общее количество монет на этапе, когда у них были равные цены, _n_ – количество поддерживаемых пулом монет.

Для объединения двух графиков применяется следующая формула: $χD^{n-1} \displaystyle\sum_{i}{x_{i}} + \displaystyle\prod_{i}{x_{i}} = χD^{n} + ( \frac{D}{n} )^{n}$, где _χ_ – динамический коэффициент, который показывает, к какому направлению стремится инвариант. Если $χ \to 0$, Stableswap превращается в constant-product инвариант; если же $χ \to \infin$, тогда – в constant-sum. Этот коэффициент задается следующим образом: $χ= \frac{A \displaystyle\prod_{i}{x_{i}}}{( \frac{D}{n} )^{n}}$, где _A_ – коэффициент увеличения для constant-sum компонента объединенного инварианта.

Если подставить выражение для _χ_ в формулу инварианта, то получим следующее: $An^{n} \displaystyle\sum_{i}{x_{i}} +D=ADn^{n}+ \frac{D^{n+1}}{n^{n} \displaystyle\prod_{i}{x_{i}}}$. Далее системе остается лишь поддерживать это уравнение.

Исследуем интерфейс Curve (см. рис. 7.23), а также параметры, которые будут полезны при предоставлении ликвидности в пул ликвидности.

![Рисунок 7.23 – Интерфейс Curve](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.23-Curve-interface.png "Рисунок 7.23 – Интерфейс Curve")

Помимо тех параметров, что обсуждались ранее, следующие параметры необходимы для выбора пула ликвидности:

* base vAPY – годовой процент награды, рассчитанный на основе текущего суточного процента и объёма. В зависимости от изменений данных параметров меняется и APY.
* rewards tAPR – годовая награда в токенах системы рассчитанная на основе текущего суточного процента.


### Протоколы займа и кредитования

Прежде чем понять, как же работают децентрализованные системы займа, давайте рассмотрим как это работает в реальной жизни. Возьмем в качестве примера банк: часть клиентов банка открывает депозит и со временем может получать определенный процент (interest rate), а другая часть берет кредиты, а затем выплачивает проценты. Таким образом в банке в любой момент времени есть средства для выдачи кредитов, а разница между процентами выплачиваемыми заемщикам и процентами выплачиваемыми вкладчикам остается у банка в качестве прибыли. Схема банковских кредитов приведена на рисунке 7.24.

![Рисунок 7.24 – Схема кредитования в централизованных финансовых учреждениях](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.24-lending-in-centralized-financial-institutions.jpg "Рисунок 7.24 – Схема кредитования в централизованных финансовых учреждениях")

У такого подхода есть очевидный недостаток – банк не может выдавать кредиты всем подряд, потому как рискует никогда не увидеть деньги вкладчиков. Поэтому есть два варианта для банка – выдавать кредиты под залог чего-либо ценного, либо основываться на кредитной истории заемщика.

Давайте рассмотрим конкретный пример с использованием залога. Алиса хочет поступить в университет, и для этого ей нужно заплатить 10 000 долларов за первый семестр обучения. Проблема заключается в том, что у Алисы нет столько денег. Она приходит к решению, что лучше всего взять кредит в банке, а по окончанию обучения  вернуть долг с денег, которые она начнет зарабатывать.

Банк в свою очередь не может доверять Алисе, так как ее кредитная история пуста, а речь о том, как она станет величайшим стоматологом в мире банк не вдохновляет. Но есть другой вариант – Алиса может оставить в залог что-нибудь ценное, чтобы подкрепить свой интерес в выплате долга в будущем.

Алисе как раз недавно досталось по наследству ожерелье ее бабушки, стоимость которого эквивалентна 100 000 долларов (продать она его не может из большой любви к бабушке). 

Далее у нас есть четыре варианта развития событий:

* Алиса погашает задолженность и забирает свой залог.
* Алиса не возвращает долг. Этот случай благоприятен для банка, так как в таких условиях он имеет полное право оставить себе залог, который стоит намного больше, чем долг.
* Алиса может попытаться обмануть банк следующим образом: она может оставить фальшивое ожерелье, но банк достаточно умен и не доверяет Алисе. Поэтому он может проверить подлинность драгоценностей. Более того, банк может вывесить плакаты о том, что Алиса  злоумышленница.
* Алиса оставляет залог, но через некоторое время цена бриллианта падает до $5 000. Для нее выгоднее не возвращать заем, а для банка лучше избавиться от залога, пока он совсем не обесценился.

Теперь рассмотрим, с чего началось развитие протоколов децентрализованных займов. В первую очередь был опробован подход p2p займов/кредитования. Пример такого протокола – ETHLend (на данный момент проект остановлен) [187].

ETHLend – это децентрализованное p2p кредитное приложение (DAPP), работающее в сети Ethereum. Данный протокол позволял заемщику и кредитору определять важные детали кредита без необходимости посредника. Предполагалось, что такой подход устранит ситуацию, когда банк – единственный провайдер кредитов и возможности депозита, а также создаст конкуренцию между кредиторами, что приведет к предоставлению наиболее конкурентоспособной процентной ставки.

В 2018 году ETHLend был переименован в Aave, что в переводе с финского означает "призрак". Команда создавшая протокол объясняет, что такое название символизирует попытку создать прозрачную и открытую систему децентрализованных займов


### Протокол AAVE

AAVE – протокол децентрализованного кредитования [188], позволяющий пользователям одалживать средства, заимствовать и при этом получать проценты за предоставление средств в долг.

Значимое отличие архитектуры AAVE от ETHLend заключается в том, что для обеспечения работы системы с каждым ERC-20 токеном создается свой пул ликвидности. Подобный этап развития пережили DEX, когда order books исчезли, но появились пулы ликвидности, куда каждый пользователь мог добавить поддерживаемые системой активы, и откуда пользователи могут брать кредит. Таким образом отпадает необходимость сопоставлять спрос и предложение между собой. Преимуществом данного решения является то, что с точки зрения безопасности решение остается надежным, потому как не требует доверия, ведь заложенные в основу смарт-контракты остаются в свободном доступе для аудита.

Рассмотрим процесс предоставления ликвидности в пул. Представим такой пример: Алиса недавно приобрела 1 ETH, но что делать с ним дальше – пока не придумала. Поэтому она решает, что хочет по аналогии с банком создать депозит, за который она сможет получать проценты. Она решает стать кредитором в borrowing / lending протоколе, поэтому она вносит желаемое количество актива в пул ликвидности (см. рис. 7.25). В результате Алиса получает interest bearing токены соответствующие активу (в нашем случае ibETH). А когда Алиса захочет забрать свой 1 ETH вместе с накопившимися проценты – она может просто обменять interest bearing токены обратно.

![Рисунок 7.25 – Схема кредитования AAVE](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.25-AAVE-lending.png "Рисунок 7.25 – Схема кредитования AAVE")

В это время ее средства может взять в займ другой пользователь. В результате, когда заемщик вернет долг, он также вернет проценты, которые зачислятся Алисе (см. рис. 7.26).

![Рисунок 7.26 – Схема кредитования AAVE](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.26-loan-repayment.png "Рисунок 7.26 – Схема кредитования AAVE")

Стоит также отметить, что накопление награды происходит путем постоянного изменения курса между оригинальным и соответствующем ему interest bearing активами. Изменение же курса происходит за счет того, что при возврате средств, заемщики также возвращают проценты [189].

Давайте рассмотрим пример того, как это работает. Создается новый пул ликвидности для ETH. Алиса и Ева кладут в него по 100 ETH, взамен они получают по 100 ibETH каждая. Поначалу соотношение цен 1:1, потому как пул пока не имеет никакой прибыли, а количество выпущенных ibETH равно количеству присутствующих в системе ETH.

Представим, что Боб заинтересовался в займе 100 ETH, а также его заинтересовали выгодные для него условия займа определенные создателями протокола в смарт-контракте – 5% за год. Поэтому он занимает 100 ETH, но спустя год он планирует вернуть весь долг, а также заплатить проценты. Получается, что ему придется отдать уже 105 ETH. Изначально в пуле было 200 монет, а через год стало 205. Это означает, что курс теперь следующий: 1 ibETH за 1.025 ETH.

Представим, что когда Алиса теперь хочет вернуть свои токены. Это означает, что если она обменяет свои ibETH обратно – она получит ~102.5 ETH, а ее прибыль составит 2.5 ETH.

Преимущества применения данного метода очевидны: уменьшение транзакционных издержек по регулярным выплатам процентов с каждого займа, потому как выплата может организовываться только по запросу пользователя и в любое удобное ему время.

Другой важный момент заключается в том, как задается сама процентная ставка (interest rate). В предыдущем упрощенном примере мы заранее знали, что заемщик должен будет заплатить 5%. В реальности же, процентная ставка в каждый момент времени (_R_(_t<sub>i</sub>_)) является динамической (см. рис. 7.27) и рассчитывается согласно такой формуле:  

$$
\begin{cases}
R(t_{i})=α+U_{i}β & \text{ Если } U_{i} \leq U' \cr \\
R(t_{i})=α+U'β+γ(U_{i}-U') & \text{ Если } U_{i} \gt U'
\end{cases} $$ 

где _α_ – базовый процент за один блок, _β_ – процент, обеспечивающий возрастание курса, _U<sub>i</sub>_  – значение отношения спроса и предложения в пуле для момента времени _t<sub>i</sub>_, _U'_ – значение оптимального отношения спроса и предложения (оно необходимо для контроля наличия средств в пуле), _γ_ – «jump»-множитель, определяющий изменение наклона графика при $U_{i}=U'$.

Параметры _α_, _β_, _γ_, _U'_ могут изначально задаваться создателем протокола, а далее изменяться специально назначенными администраторами системы, либо при помощи механизмов governance. Параметр _U_ в свою очередь рассчитывается по формуле: $U= \frac{A_{\text{bor}}}{A_{\text{av}}+A_{\text{bor}}}$, где _A<sub>bor</sub>_ – общая сумма средств, заимствованных из пула ликвидности, _A<sub>av</sub>_ – остаток средств в пуле ликвидности.

На рис. 7.27 изображен пример с такими заданными параметрами: $α=2.5$, $β=0.05$, $γ=3$, $U'=70$.

![Рисунок 7.27 – График функции расчета процентной ставки](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.27-interest-rate-calculation-function.png "Рисунок 7.27 – График функции расчета процентной ставки")

Далее, используя процентные ставки, рассчитанные для каждого конкретного момента времени, возможно рассчитать количество монет, которые заемщик должен в итоге вернуть. Чтобы эффективно аккумулировать блочные процентные ставки, крайне важно создать механизм, который нормализует долги – показывает их величину на момент времени, когда был создан пул ликвидности (_t<sub>0</sub>_). В противном случае придется хранить каждое изменение блочной процентной ставки, а также хранить время каждого нового заимствования.

Определим формулу для нормализованного долга: $N= \frac{A_{\text{dep}}}{R(t)}$, где _N_ – нормализованный долг, _A<sub>dep</sub>_ – сумма депозита, _R_(_t_) – кумулятивная процентная ставка. Теперь определим понятие кумулятивная процентная ставка: $R(t)= \displaystyle\prod_{i=0}^{n}{R(t_{i})}$, где _n_ – количество блоков (конкретных моментов времени). Она учитывает все изменения блочного коэффициента и позволяет нам рассчитать итоговый коэффициент, который подытоживает процент за все время займа. Чтобы рассчитать итоговую сумму для возврата, применяется следующая формула: $A_{\text{ret}}=N(1+R(t))$, где _A<sub>ret</sub>_ – сумма для возврата.

Рассмотрим как осуществляется процесс взятия кредита. Главный принцип взятия кредита – он берется именно под залог другого актива (активы, которые разрешено использовать в качестве залога определяются создателями протокола или же governance). Это позволяет обезопасить платформу от ситуаций, когда пользователь может просто не вернуть долг, но в таком случае появляется совершенно новая проблема: обесценивание залога. Если же вдруг оставленный пользователем залог начнет резко обесцениваться, а платформа не успеет от него избавиться – она останется в минусе, поэтому для отслеживания ценности залога пользователя, система прибегает к помощи price oracles.

Но существует механизм, который помогает предотвратить это: пользователь не может взять в кредит сумму большую чем залог умноженный на некоторый коэффициент безопасности $0 \lt f_{\text{sec}} \lt 1$, определяющий размер “подушки”. Данный коэффициент может также устанавливаться создателем системы, а в будущем изменяться администраторами либо же при помощи governance. Но главная мысль, которую отображает коэффициент – это волатильность конкретного актива. Поэтому для каждого актива будет свой коэффициент.

Но что происходит, когда стоимость залога уменьшается и перестает покрывать кредит? Тогда в дело вступает ликвидация.

Рассмотрим как осуществляется процесс ликвидации кредита. Ликвидация – это процесс продажи залога заемщика в ситуации, когда залог стремиться к тому, чтобы перестать покрывать стоимость долга. Зачастую помимо описанного выше коэффициента, для каждого актива либо же создателем системы, либо же при помощи governance устанавливается, а в будущем и обновляются значения порога ликвидации. Данный порог определяет, когда начинается ликвидация.

Зачастую такая ликвидация выгодна и для платформы, и для ликвидатора (пользователя, который погашает кредит и забирает залог), потому как платформа может продать залог пользователя со скидкой за счет порога ликвидации.

Представим такой пример: Алиса оставила залог 0,033 ETH, равнозначный $100, и взяла в долг 70 DAI, равнозначные $70 (коэффициент безопасности равен 0,7). Но порог ликвидации для ETH равен 0,8. Это означает, что если цена 0,033 ETH упадет до $80, тогда любой желающий пользователь сможет инициировать процесс ликвидации и выкупить залог со скидкой. Представим, что процент скидки составляет 6,25%. Это означает, что 0,033 ETH будут проданы по цене $75, что для ликвидатора означает скидка в $5, а для платформы заработок в $5.


### Протокол Compound

Compound – это децентрализованное приложение в учетной системе Ethereum [190], основная задача которого – организация децентрализованного кредитования и займа.

Принцип работы Compound точно такой же, как и у AAVE, но есть несколько следующих различий:

* AAVE предлагает пользователям функциональность flash loans – мгновенные кредиты. Их основная особенность заключается в том, что средства могут быть взяты в кредит без залога, но в то же время, они должны быть возвращены системе в том же блоке, в котором берется кредит. Несмотря на такое большое преимущество, данная функциональность часто становится уязвимостью в такого рода протоколах. Недавняя атака на этот механизм была произведена 17 апреля 2022 года. Было украдено 182 миллиона долларов [191].
* Compound и AAVE предлагают разные залоговые коэффициенты по разным активам, при этом APY у протоколов зачастую близкие по значению.
* В отличие от Compound, который поддерживает только Ethereum, AAVE работает также в таких учетных системах: Polygon, Avalanche, Fantom, Harmony, Optimism.
* На момент 15 августа 2022 года TVL AAVE составляет $12,5 млрд (с учетом всех сетей), в то время как Compound – $3,03 млрд.

В конечном счете оба протокола предлагают своим пользователям хорошо проработанную функциональность децентрализованного займа.


### Протокол Yearn

У пользователей понимающих как работает DeFi, появляется очень много возможностей заработать путем правильного вложения средств: будь то предоставление ликвидности в DEX протокол, либо же займ одного актива с целью предоставить ликвидность в очередной пул ликвидности с большей процентной ставкой. С появлением же все большего количества все новых и новых DeFi протоколов, отслеживать все выгодные пути вручную становится сложнее и сложнее. Вследствие этого появляется необходимость в решении, которое будет автоматизировать данный процесс.

В феврале 2020 года Andre Cronje попытался реализовать данную идею в виде проекта iearn.finance [192]. Поначалу, была реализована оптимизация доходности только в рамках протоколов Fulcrum, Aave, Compound, and dYdX, но со временем количество поддерживаемых DeFi протоколов, а также активов увеличилось, а сам проект был переименован в Yearn.

Как же работает Yearn? Для каждого актива создается свой yVault – смарт-контракт реализующий пул токенов, а также управляющий токенами в соответствии с реализованными в смарт-контракте стратегиями [193].

Vaults в Yearn обладают следующими свойствами и характеристиками:

* Доход будет накапливаться в токене, который вкладывается в yVault. Это позволяет иметь сложный процент в yVault.
* yVault может иметь много стратегий, активных в одно и то же время. yVault может изменять распределение капитала в своих стратегиях, когда сочтет это необходимым.
* В отличие от многих других агрегаторов доходности, комиссия за ввод/вывод средств не взимается.

И как итог, любой пользователь может просто вложить свои средства в подобный yVault, а затем забрать их вместе с накопленным доходом (см. рис. 7.28).

![Рисунок 7.28 – Схема работы Yearn](/resources/img/volume-3/7.3-Overview-of-DeFi-protocols/F-7.28-Yearn-operation.jpg "Рисунок 7.28 – Схема работы Yearn")

Для каждого актива существует свой yVault. Каждый такой yVault может поддерживать свой ряд стратегий [194], но в целом их можно разделить на следующие категории:

* Stable – это yVaults, в которые можно депонировать stablecoins. Например, USDT, sUSD, DAI, TUSD, USDC, LUSD.
* Defi Tokens – yVaults, в которые можно депонировать токены различных DeFi протоколов. Например, UNI, SNX, AAVE, COMP.
* Curve Pools – yVaults, в которые можно депонировать liquidity tokens, полученные в результате предоставления пользователем ликвидности в систему Curve.
* Retired yVaults – yVault, которые либо прекращают свою работу, либо уже прекратили.

Для каждой стратегии создается свой собственный смарт-контракт. Рассмотрим самые распространенные стратегии:

* Aave Lender Optimizer [195] вкладывает токены в AAVE, чтобы получить проценты и заработать токены stkAAVE. После вывода токенов, заработанные stkAAVE продаются в обмен на токен yVault, а затем они вкладываются обратно в стратегию.
* Aave Borrow [196] вкладывает DAI в AAVE, чтобы получить проценты и заработать токены AAVE. После разблокировки заработанные токены собираются, продаются за большее количество DAI, которые вкладываются обратно в стратегию. Эта стратегия также заимствует токены под DAI. Заимствованные токены затем депонируются в соответствующее хранилище yVault для получения дохода.
* Kashi Lender [197] вкладывает USDC в Sushi через Kashi, чтобы получить проценты и заработать токены SUSHI. Заработанные токены собираются, продаются за USDC, которые снова вкладываются в стратегию.
* Curve Yield Seeker [198] вкладывает WBTC в Curve Finance, чтобы заработать CRV. Заработанные токены собираются, продаются за дополнительные WBTC, которые вкладываются обратно в стратегию. Стратегия автоматически переключается на наиболее прибыльный пул Curve.
* Maker Delegate [199] вкладывает UNI в хранилище MakerDAO и чеканит DAI. Этот новый отчеканенный DAI затем помещается в хранилище DAI yVault для получения дохода.
* Curve Boost [200] вкладывает steCRV в Curve Finance и стейкает их, чтобы собрать все доступные токены и заработать повышенное вознаграждение CRV благодаря блокировке CRV boost. Заработанные токены собираются, продаются за дополнительные steCRV, которые вкладываются обратно в стратегию.
* Convex Reinvest [201] вкладывает eCRV в Convex Finance, чтобы заработать CRV и CVX (и любые другие доступные токены). Заработанные токены собираются, продаются за большее количество eCRV, которые снова вкладываются в стратегию.

Что касается надежности системы, случаи взлома уже были. Изначально было украдено $11 млн, но у злоумышленника удалось забрать себе только $2,8 млн [202]. Каким же образом злоумышленнику это удалось? Атака основывалась на использовании функциональности протоколов децентрализованного займа – flash loans (кредиты, которые могут быть взяты без залога, если долг будет возвращен в том же блоке).

# [ЗАКЛЮЧЕНИЕ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-3/ru/Z.1-Conclusion.md)
