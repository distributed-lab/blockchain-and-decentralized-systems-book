# 2 ІСТОРІЯ ТА ПРИНЦИПИ РОБОТИ BITCOIN


## 2.1 Що таке Bitcoin?

Можна сказати, що Bitcoin – це протокол, що реалізує незалежну валюту та платіжну систему. Інші електронні гроші чи платіжні системи, наприклад WebMoney, PayPal, – це платіжні системи, які оперують уже наявними валютами: доларом, євро, фунтом тощо. Bitcoin же – й окрема валюта, і платіжна система, яка управляє цією валютою. Відзначмо, що це незалежна платіжна система, тобто немає організації, яка б контролювала її роботу.

> **_Зауваження._** *Далі ми використовуватимемо слово **Біткоін (Bitcoin)**, коли йдеться про облікову систему чи протокол, а слово **біткоін (bitcoin)**, коли маємо на увазі валюту або відповідні монети.*

У спробах зрозуміти, що таке Bitcoin, люди нерідко звертаються до Вікіпедії, де написано, що це однорангова платіжна система, яка використовує власні монети, як одиниці обліку цінності, а для забезпечення функціонування та захисту системи використовуються криптографічні методи. Для людини, не досвідченої в питаннях платіжних систем, таке визначення може виявитися складним і не надто зрозумілим, особливо якщо вона чує про Bitcoin вперше. Доведеться підібрати більш зрозумілі слова. Найкращою з аналогій, що трапляються в публікаціях на цю тему, є аналогія з цифровим золотом (рис. 2.1).

![Рисунок 2.1 – Bitcoin – цифровий аналог золота](/resources/img/volume-1/2.1-what-is-bitcoin/2.1-gold.png)

Можна припустити, що творець Bitcoin дійсно спробував відтворити всі властивості золота, як-от: обмежена кількість, складність видобутку, незалежність від єдиної організації, неможливість його штучно відтворити. Той факт, що Bitcoin чітко відтворює перераховані властивості в цифровій формі, можна вважати великим проривом у комп’ютерних науках.

Використовуючи Bitcoin, можна відправити платіж будь-кому будь-куди. Для цього потрібен доступ до Мережі, цифровий гаманець й адреса отримувача. Обмеження, характерні для звичайного міжнародного переказу, просто відсутні. Жодних додаткових дозволів для здійснення платежу не потрібно.

Тому Bitcoin зацікавив людей, які підтримували анархізм, ліберальні ідеї, повну приватність тощо. Саме в них Bitcoin і здобув популярність спочатку. Пізніше до них приєдналися комп’ютерні ентузіасти (шифропанки, хакери), а також вчені, для яких Bitcoin став об’єктом для досліджень і проведення цікавих експериментів. Щойно ціна біткоіна стала хоч якось помітною, він почав привертати увагу підприємців і спекулянтів, що намагалися заробити на коливанні курсу. Звичайну людину зацікавлюють відсутність необхідності реєструватися та можливість здійснювати платежі без залучення третіх сторін.

Якщо розглядати платіжні системи, як-от PayPal або WebMoney, то ними управляють конкретні компанії, куди можна прийти з обшуками, забрати сервери та заблокувати рахунки. У разі Bitcoin немає жодного ТОВ «Біткоін», яке здійснює облік монет або підтверджує транзакції. Це означає, що транзакції не піддаються цензуруванню. Ця властивість дуже важлива, і пізніше ми обговоримо, у який спосіб вона досягається.

### Історія виникнення Bitcoin

Ми не знаємо, хто вперше запропонував цю технологію та назвав її Bitcoin. Офіційно відомо, що це був хтось під псевдонімом Сатоші Накамото. Можливо, цей хтось – одна людина, але є припущення, що за псевдонімом може стояти й група людей. Сатоші зареєстрував домен bitcoin.org у 2008 році, випустив першу статтю, опублікував початкову версію вихідного коду протоколу. До 2011 року від псевдоніма Satoshi Nakamoto на відповідних форумах і в email-розсилках з’являлися повідомлення. Пізніше він написав, що вирішив займатися іншими справами та припинив публічні комунікації.

Проте варто визнати, що ідея створення Bitcoin виникла в Сатоші Накамото зовсім не на рівному місці. У своїй статті «Bitcoin: A Peer-to-Peer Electronic Cash System» [15] (рис. 2.2) він згадав два інші ключові проєкти. Це були попередні спроби створити незалежну цифрову валюту: HashCash доктора Адама Бека (Adam Back) [16] і B-Money інженера Вей Дая (Wei Dai) [17]. У першому з’явився підхід proof-of-work, спочатку створений для боротьби зі спамом в електронних листах, а в іншому – модель мережі для розподіленого зберігання даних про транзакції та використання криптографічних підписів для відправки грошей.

![Рисунок 2.2 – Фрагмент першої публікації про Bitcoin](/resources/img/volume-1/2.1-what-is-bitcoin/2.2-bitcoin-wp.png)

Таким чином, Сатоші залучив уже наявні концепції для реалізації Bitcoin, зумівши вирішити проблеми, що залишилися на ранніх етапах, чого не вдалося зробити їхнім творцям. Вважаємо, що знайдеться небагато людей, які здатні були би розгледіти в зазначених вище провальних проєктах свого роду ембріон незалежної цифрової валюти.

> **Передумови до створення Bitcoin**
>> * *David Chaum—DigiCash [18] (1989*)
>> * *Adam Back—HashCash (1997)*
>> * *Nick Szabo—BitGold [19] (1998)*
>> * *Wei Dai—B-Money (1998)*
>> * *Hal Finney—RPoW as e-money [20] (2004)*

Однак потрібно розуміти, що Bitcoin – це перша успішна реалізація децентралізованої системи обліку. До нього були й інші спроби, наприклад, компанія DigiCash, яку заснував David Chaum в 1989 році, однією з найперших запропонувала цифрові платежі зі спеціальною валютою, яка називалася Ecash. Користувачі платіжної системи були анонімними, так що банки не могли відстежити їхні рахунки. Проєкт підтримали тільки декілька інноваційних банків у США й один у Фінляндії, але оскільки було дуже складно переконати інші банки та мерчантів приймати анонімну валюту, проєкт згорнули.

> **Ключові дати**
>> * *Публікація Bitcoin whitepaper – 31 жовтня 2008*
>> * *Створення генезис-блоку – 3 січня 2009*
>> * *Перший обмін біткоінів – лютий 2010*
>> * *Прийняття P2SH – 5 січня 2012*
>> * *Форк Bitcoin Cash – 1 серпня 2017*
>> * *Прийняття Segregated Witness – 24 серпня 2017*
>> * *Запуск Lightning Network – 15 березня 2018*

Одним із перших кроків у розвитку Bitcoin була публікація Bitcoin White Paper 31 жовтня 2008 року. Перший вихідний код був опублікований 3 січня 2009 року. Тоді само було створено й перший блок (генезис-блок) – у Bitcoin з’явилися перші 50 монет. Власне, цей день можна вважати датою запуску системи. У лютому 2010 року відбувся перший обмін біткоінів на гроші.

Форк Bitcoin Cash, що відбувся 1 серпня 2017 року, став першим відгалуженням від основної системи (докладніше в 6.1). Ще одне важливе оновлення, що реалізує низку певних покращень протоколу, які відкрили для Bitcoin раніше не досяжні можливості, – це Segregated Witness, що було активовано 24 серпня 2017 року. А 15 березня 2018 року світ побачив надбудову над Bitcoin для здійснення миттєвих платежів – Lighting Network.

> **Статистика за мережею Bitcoin на 2018 рік**
>> * *Приблизно 10 мільйонів унікальних користувачів*
>> * *У середньому 300 тисяч платежів на добу*
>> * *Добовий обсяг торгів – 15 мільярдів доларів*

На момент 2018 року в усьому світі Bitcoin використовують мільйони людей, а сотні тисяч компаній приймають біткоіни як платіжний засіб. На базі Bitcoin розробляється багато проєктів. Деякі країни, зокрема Японія, визнали його законним засобом платежу.

### Проблеми, які здатний вирішити Bitcoin

Передусім, Bitcoin отримав свою популярність через те, що він реалізує децентралізовану облікову систему, тобто працює незалежно від режимів, що діють у різних країнах, не схильний до інфляції, не дозволяє скасовувати транзакції та спирається тільки на математику, а не на забаганки окремих людей. Крім того, платежі в Bitcoin можуть допомогти підвищити рівень конфіденційності користувачів порівняно з цифровими валютами, що були до нього.

> * *Фінансовий інструмент, який працює без обмежень*
> * *Відсутня обов’язкова реєстрація користувачів*
> * *Bitcoin можна використовувати анонімно*
> * *Стійкий до цензури*

Звісно, ці властивості приваблюють споживача. Наприклад, для бізнесу вони виступають гарантом того, що якщо покупець відмовився від товару, то він не може автоматично вимагати повернення грошей. Подібна проблема дуже гостро постала для PayPal, коли відбувалося блокування рахунків бізнесів із повідомленням «На вас подано скаргу», а десятки тисяч доларів могло бути заблоковано на півроку – бізнес повністю зупинявся. У Bitcoin це неможливо. Саме тому він став привабливим для бізнесу.

Непрозорість наявної фінансової системи виявилася ще одним аргументом на користь Bitcoin. З історії відомі випадки, коли уряд здійснював емісію без вагомих підстав для цього, що згодом призводило до гіперінфляції та падіння рівня життя населення. Так сталося в 1990-х роках на території пострадянського простору: особисті фінанси громадян знецінилися з причин, що не були їм підвладні. Такі події цілком пояснюють, чому люди хочуть незалежно керувати своїми фінансами.

Власне, перший блок транзакцій, що з’явився, містив посилання на новини про друк великої кількості готівки як спробу залагодити кризу 2008 року [21]. Платіжні системи, а саме проблеми їхнього функціонування, викликали невдоволення користувачів. Так з’явилася «теорія всесвітньої змови», прихильники якої стверджують, що банки можуть робити з грошима клієнтів будь-що (у деяких країнах так і відбувається). На практиці це відбувається пристойніше: банк приймає від клієнта фіатні гроші, натомість видає зобов’язання повернути їх на вимогу клієнта, а трохи пізніше банк відмовляється від своїх зобов’язань. Суть проблеми в тому, що для клієнта дуже складно довести таку відмову та повернути гроші.

> **Проблеми наявних платіжних систем**
>> * *Користувач не контролює свій баланс*
>> * *Кошти можуть бути зараховані на рахунок одержувача за кілька діб, а іноді кілька десятків діб після їх відправлення*
>> * *Платежі можуть бути скасовані під час виконання*
>> * *Кошти можуть бути заблоковані*

Виникла потреба реалізувати систему, у якій люди зможуть незалежно та повністю самостійно управляти своїми грошима. Незважаючи на те, що це завдання виявилося дуже складним, з плином часу це бажання тільки посилювалося. Рішенням став Bitcoin. Він був представлений у 2009 році. Звісно, увага з боку суспільства не змусила довго чекати на себе.

### Головні принципи функціонування Bitcoin

Якщо спробувати коротко сформулювати основний принцип функціонування Bitcoin, то він буде звучати так: *кожен користувач запускає своє програмне забезпечення, що реалізує спільний для всіх набір правил, і, у результаті, усі користувачі підтримують децентралізовану облікову систему*.

> * *Копію бази даних зберігають усі*
> * *Користувачі самостійно обробляють транзакції*
> * *Користувачі дотримуються одних і тих же правил*
> * *Користувачі довіряють тільки тому, що можуть перевірити самі*

Підключення та відключення учасників відбувається незалежно та не впливає на роботу інших учасників мережі. Усі зберігають й оновлюють базу даних і відповідне програмне забезпечення незалежно, усі правила роботи відомі кожному, і всі користувачі перевіряють один одного. Мережу користувачів Bitcoin схематично зображено на рис. 2.3.

![Рисунок 2.3 – Схема мережі користувачів Bitcoin](/resources/img/volume-1/2.1-what-is-bitcoin/2.3-network-of-users.png)

Користувач може самостійно обробляти будь-які транзакції в мережі. За допомогою ПЗ він може підтвердити транзакцію, яку вважає правильною. У результаті, кожен із користувачів має набір транзакцій, які він верифікував і визначив як правильні. На підставі цього кожен вузол мережі формує спільну базу даних, що складається з транзакцій, з якими погодилася більшість користувачів. Щойно чергова транзакція потрапляє до цієї бази даних, вона вважається підтвердженою.

### Емісія в Bitcoin

*Емісія* щодо грошей – *це випуск до обігу готівки чи безготівкових грошей*. У Bitcoin це не зовсім та емісія, що присутня в традиційних фінансових системах. У цьому разі емісія – це випускання монет за певним алгоритмом. Основний принцип полягає в тому, що весь процес повністю децентралізований та ґрунтується на математичних алгоритмах. У такий спосіб досягається абсолютна прозорість під час розподілення монет.

> * *Процес емісії децентралізований*
> * *Правила емісії контролюються математично*
> * *Емісію виконують самі користувачі*
> * *Нові монети розподіляються серед активних учасників*

За правилами протоколу, емісію може виконувати будь-хто з користувачів, а всі учасники мережі перевіряють дотримання цих правил. Якщо коротко, то нові біткоіни розподіляються між користувачами, які беруть активну участь у підтриманні облікової системи. Їх називають *валідаторами*. Тобто в системі може бути безліч учасників і кожен із них може отримати нові монети.

> **Правила емісії біткоінів**
>> * *У середньому кожні 10 хвилин з’являються нові монети*
>> * *Кожні 4 роки кількість нових монет зменшується вдвічі*
>> * *Усього буде емітовано 20 999 999,9769 BTC*

Емісію монет визначають правила, що закладені в програмному забезпеченні вузлів мережі. Сатоші встановив, що в середньому кожні 10 хвилин з’являються нові біткоіни. Спочатку це було 50 монет. Кількість нових монет скорочується вдвічі приблизно кожні 4 роки. На момент написання книги пройшло понад 10 років від дати запуску Bitcoin – і темп емісії монет значно зменшився.

У Bitcoin запрограмовано максимальну кількість монет – майже 21 мільйон. Чому 21 мільйон? Цього ніхто не знає, так вирішив Сатоші, але це насправді не важливо. До того ж, кожен bitcoin ділиться на 100 000 000 частин, а найменша одиниця називається сатоші (за псевдонімом творця протоколу). Вам необов’язково мати цілу монету: ви можете володіти її частиною.

***1 BTC = 100,000,000 satoshis***

Згідно з розрахунками кількість 21 000 000 монет буде досягнуто приблизно у 2140 році, тобто ближче до середини наступного сторіччя. Якщо точніше, то навіть менш ніж 21 млн BTC, а саме 2 099 999 997 690 000 сатоші.

Тепер подивимося, як кількість випущених монет змінюється з часом. На рис. 2.4 подано графік зміни кількості монет ув обігу протягом певного часу. Ми бачимо, що він нагадує логарифмічну криву. На момент 2018 року кількість здобутих монет перевищила 17 млн BTC.

![Рисунок 2.4 – Графік зміни кількості емітованих bitcoin-монет із плином часу](/resources/img/volume-1/2.1-what-is-bitcoin/2.4-graph-of-issuance.png)

> **_Зауваження._** *Bitcoin – це ***дефіцитний (scarce)*** цифровий актив: 17 млн монет було здобуто за менш ніж 10 років, а для здобуття решти 4 млн знадобиться більш ніж 120 років.*

> **Властивості bitcoin-монет**
>> * *Обмежена кількість*
>> * *Необхідність добування*
>> * *Дискретність (подільність монет)*
>> * *Незалежність*
>> * *Неможливість скопіювати*

Bitcoin дозволяє платити будь-кому будь-скільки за будь-що до будь-якої точки світу. Крім того, bitcoin як валюта має низку властивостей, які роблять його придатним для зберігання особистих заощаджень і відкривають перспективу для становлення його як платіжного засобу.

### Формування ціни на монети

Вважаємо, що основна причина, чому багато хто активно цікавиться криптовалютами, – це зростання їхньої ціни. І перше питання: «Як вона взагалі формується?». Ціна bitcoin визначається строго за законом попиту та пропонування. Немає людини, яка приймає рішення: «Сьогодні ціна bitcoin буде така, а завтра – інша». Авжеж, на ринку присутні й маніпуляції, проте вони не можуть кардинально вплинути на ціну монети.

Здебільшого ціна формується на біржі. Саме біржі дозволяють людям досить просто заявити про бажання купити або продати монети. У світі діє велика кількість торгових майданчиків. На кожному з них ціна біткоіна може бути різною, тому що її визначає відношення попиту та пропонування, яке створюють користувачі конкретного майданчика (рис. 2.5).

![Рисунок 2.5 – Відношення попиту та пропонування на bitcoin-монети](/resources/img/volume-1/2.1-what-is-bitcoin/2.5-demand-and-supply.png)

На рис. 2.6 наведено графік вартості одного біткоіна (1 BTC) з дати запуску Bitcoin, а саме з 2009 до 2018 року [22].

![Рисунок 2.6 – Графік зміни вартості bitcoin з плином часу](/resources/img/volume-1/2.1-what-is-bitcoin/2.6-value-change.png)

На момент появи Біткоіна ціна біткоіна взагалі не була визначена. Пізніше люди почали здійснювати перші операції обміну біткоіна на монети інших валют у деякому співвідношенні, водночас не використовуючи автоматичні біржі та спеціалізовані майданчики. А перша купівля реального товару (двох коробок із піцою) за біткоіни була здійснена тільки у 2010 році [23] за курсу декілька центів за монету. Потім курс почав зростати й у 2011 році досяг свого локального піку в 33 USD, але після – знову знизився до 2 USD. Рекордна ціна у 2014 році була зафіксована на позначці в 1100 USD. Після чергового зниження до 200 USD, вона була порівняно стабільною весь 2015 рік, а потім стала плавно зростати. У 2017 році почався період її експоненціального збільшення, і ціна досягала 20 000 USD.

Щодо формування ціни слушно буде зауважити, що монети, доступ до яких утрачено чи які не використовуються з якихось причин, можуть мати велику вагу в загальній картині. Наприклад, той факт, що на момент листопада 2018 року вже опинилося заблокованим майже 3–4 мільйони біткоінів унаслідок утрати ключів, дуже вагомий у формуванні ціни на bitcoin [24]. Також відомо, що Сатоші володіє приблизно мільйоном біткоінів, які він ніколи не витрачав. Якщо зараз з’явився би доказ того, що ключі він знищив і відповідні монети вийшли з обігу, то ціна біткоіна могла би значно змінитися.

Ми не можемо з упевненістю стверджувати, чи заблокував Сатоші можливість витрати своїх біткоінів. Якщо в нього залишилися ключі, то він може їх використовувати, а якщо ключі загублені, то їх ще може хтось знайти та використати. Але довести це або спростувати може тільки він сам. Грубо кажучи, він може з’явитися завтра та сказати, що відтепер він буде управляти курсом біткоіна, причому за принципами, що використовують центральні банки для управління курсами фіатних валют.

Що примітно, у деяких ситуаціях ціна біткоінів неістотна. Якщо користувачеві необхідно здійснити грошовий переказ із України до Китаю, він може використати Bitcoin як проміжний «шар»: купити біткоінів у Харкові за гривні, а продати – у Шанхаї за юані. Тут неважливо, чи коштує він 200 USD або ж 10 000 USD.

> **_Зауваження._** *Не завжди доцільно використовувати біткоіни в ролі платіжного/розрахункового засобу для реального бізнесу (переважно через волатильність його ціни). Однак використання Bitcoin може принести свої плоди в контексті міжнародних транзакцій.*

Перевага Bitcoin полягає в незворотності платежів і можливості «запрограмувати» поведінку. Подібні властивості мають вирішальне значення в ситуаціях, коли покупці не довіряють продавцям. Як приклад уявімо онлайн-аукціон: продавець не хоче відправляти товар до того, як його сплатить покупець, а покупець так само не хоче платити, доки товар не надійде йому.

Просте рішення такої ситуації може полягати в тому, що замість сплати повної вартості за допомогою банківської картки покупець робить часткову передсплату в біткоінах (яка є відносно миттєвою та підтримує trustless депонування), а потім відправляє решту суми за допомогою банківського переказу. Отримавши передсплату в біткоінах (як варіант, вона може покривати витрати з доставлення), продавець відправляє товар. Після того, як товар прибуває та покупець здійснює банківський переказ, продавець повертає передсплату.

У прикладі вище ні ціна, ні волатильність біткоіну не важлива. Урешті-решт, якщо ви уявите світ, у якому багато криптовалют надає однаковий рівень *стійкості до цензурування* та незворотності транзакцій, то ціна таких валют не дуже важлива для людей, що їх використовують.

> **_Зауваження._** *Стійкість до цензури – властивість істинної децентралізації, і саме вона створює реальний попит у суспільства на bitcoin як актив.*
> 
> *Доволі просто скопіювати вихідний код Bitcoin і створити криптовалюту, у якої емісія буде також обмежена та яка навіть може забезпечувати більший рівень анонімності користувачів. Утім, такий актив не обов’язково буде таким самим цінним, як Bitcoin, тому що рівень стійкості до цензурування важливіший, аніж кількість монет чи якась інша функціональність.*

### Концепція довіри в Bitcoin

Ключова особливість Bitcoin – trustless взаємодія всіх користувачів системи. Такий підхід дозволяє перевіряти, що кінцевий стан облікової системи було досягнуто без порушення правил протоколу, і водночас повністю виключити довіру між учасниками системи.

*Довіра тільки до математики* – одна з ключових властивостей криптовалюти. У цій книзі ми повторимо це твердження ще неодноразово. Утім, воно не вичерпне, і на практиці все дещо складніше.

Щодо взаємодії конкретного користувача з мережею Bitcoin слід враховувати низку аспектів, через які користувач вимушений комусь довіряти. Наприклад, якщо ви вірите, що баланс вашого bitcoin-гаманця правильний, це означає, що ви довіряєте:
* Тим, хто порадив вам встановити цей конкретний гаманець (друзі, інтернет-форуми тощо)
* Що гаманець, який ви використовуєте, розроблено та реалізовано коректно 
* Що ваша операційна система не зламана 
* Що апаратне забезпечення вашого комп’ютера не зламане 
* Що ваш гаманець підключений до чесного вузлу мережі Bitcoin (не до вузлу зловмисника)
* Що реалізація криптографічної бібліотеки не має прихованих вразливостей 
* Що конкретний криптографічний алгоритм не містить помилок

Усе, що перераховано вище (насправді можливих загроз набагато більше), аж ніяк не уявне. За кожним із пунктів стоїть реальний випадок, який уже з кимось траплявся. Це показує, що поняття *абсолютна безпека* й *цілковита trustlessness* у системі – лише теоретичні. Децентралізований підхід дозволяє тільки зменшити ймовірність компрометації системи. У контексті Bitcoin це означає, що кожен користувач може самостійно та незалежно перевірити коректність будь-якої транзакції або блоку – йому не доводиться довіряти даним, які надає третя сторона.

### Обмеження технології Bitcoin

Разом із безперечними перевагами Bitcoin також має деякі обмеження порівняно з цифровими валютами з централізованим управлінням.

> * *Обмежена пропускна здатність*
> * *Високі витрати на підтримання системи*
> * *Тривале підтвердження транзакцій*
> * *Загальнодоступність даних транзакцій*
> * *Комісії за платежі та їхня волатильність*

У наступних підрозділах ці обмеження буде розглянуто докладно та буде описано рішення для кожного з них (див. 4.6–4.8).

> **_Зауваження._** *Зазначені вище обмеження не роблять Bitcoin неповноцінним. Вони – наслідок ***компромісу*** між властивостями, як-от ефективністю, безпекою і стійкістю до цензури. З цієї самої причини не дуже коректно порівнювати пропускну здатність цифрових валют, які використовують різні моделі безпеки (Ethereum і Ripple).*

### Значення децентралізації для Bitcoin

Отже, відтепер ви маєте уявлення про децентралізацію як поняття, а також про деякі ключові аспекти роботи з Bitcoin. Тому, перш ніж перейти до подальших розділів, ми хотіли би повторити деякі специфічні властивості Bitcoin. Точніше, пригадати, що мається на увазі, коли Bitcoin називають децентралізованою системою. Це означає, що в системі немає конкретної сторони, яка повністю відповідає за певний процес.

> **Відсутня сторона/організація, яка**
>> * *Відповідає за функціонування Bitcoin*
>> * *Відповідає за управління системою*
>> * *Збирає комісію*
>> * *Обробляє транзакції*
>> * *Одноосібно зберігає історію транзакцій*
>> * *Повертає кошти*
>> * *Виконує судові ухвали*

**Найбільш поширені питання**

*– Чи вистачить 21 млн монет для того, щоби використовувати біткоін масово?*

Хтось може стверджувати, що 21 млн монет недостатньо для великої кількості користувачів. Але не варто забувати, що на сьогодні кожна монета ділиться на сто мільйонів частин, а за потреби можна випустити оновлення та збільшити подільність (дискретність) монети.

*– Чи можна «вимкнути» Bitcoin?*

Якщо підійти до відповіді на питання з теоретичного погляду, то така ймовірність є. На практиці роботу Bitcoin підтримують учасники, обладнання яких розміщене в різних точках світу. Для участі потрібні обчислювальна техніка та доступ до Інтернету. Отже, щоби здійснити «вимкнення», необхідно заборонити використання обчислювальної техніки та каналів передачі даних. До того ж, необхідно ще й стежити за дотриманням цієї заборони. Для цього знадобляться скоординовані та швидкі дії різних політичних сил, зокрема тих, хто протистоїть одна одній. А це здійснити вкрай непросто.

*– Що робити, якщо я хочу внести зміни до протоколу Bitcoin?*

Таке бажання досить поширене, тому є загальноприйнятий спосіб внесення пропозицій щодо покращення протоколу. Відповідний репозиторій має назву «Bitcoin Improvement Proposal» (BIP); у ньому члени спільноти приймають й обговорюють такі пропозиції. Будь-хто може додати до репозиторію свою пропозицію, і якщо спільнота та валідатори погодяться з оновленням, то вони перейдуть на нову версію протоколу.

*– Чи залежить емісія монет від попиту на них?*

Такої залежності немає. Тут само варто зазначити, чи залежить ринкова ціна монети від складності її видобування: у загальному разі – не залежить. Можна впевнено стверджувати лише те, що собівартість однієї монети (ціни її видобування) навряд чи буде вищою за її ринкову ціну.

## 2.2 Як використовувати Bitcoin?

У цьому підрозділі розглядаються питання, що стосуються цифрових гаманців для роботи з Bitcoin: їхні види, експлуатаційні нюанси, особливості їхніх реалізацій, а також вплив цих особливостей на рівень безпеки.

> **Найпоширеніші операції в гаманцях**
>> * *Перевіряння балансу*
>> * *Генерування та зберігання ключів користувача*
>> * *Приймання та відправлення платежів*

Щоб отримати перше уявлення про цифровий гаманець, зверніть увагу на рис. 2.7, де зображено знімок екрана одного з мобільних додатків, що реалізують bitcoin-гаманець. На головному екрані (той, який розташовано зліва на рисунку) можна побачити поточний баланс, список транзакцій, суми та ступінь підтвердженості транзакцій, а також можна переключитися на інші екрани для прийняття та відправлення платежів.

![Рисунок 2.7 – Користувацький інтерфейс одного з біткоін-гаманців](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.7-user-interface.png)

### Адреси в Bitcoin

Bitcoin-адреса – ідентифікатор отримувача. Щоби відправник міг здійснити переказ, йому потрібно знати адресу призначення. Тому важливо, щоб одержувач заздалегідь надав свою адресу. Вигляд звичайна bitcoin-адреса має орієнтовно такий:

**1BooKnbm48Eabw3FdPgTSudt9u4YTWKBvf**

У деякому сенсі bitcoin-адреса – це псевдонім користувача, не прив’язаний до жодних ідентифікаційних даних, тобто вона порівняно анонімна. Але цей факт ще не означає, що будь-які операції з біткоінами є повністю конфіденційними.

Важлива особливість Bitcoin полягає в тому, що користувачі самостійно формують свої bitcoin-адреси (це стосується й інших криптовалют), запускаючи спеціальне ПЗ, що генерує нову адресу. Кількість адрес, які може створити один користувач, необмежена. Ви можете згенерувати їх бодай мільярд, причому на кожну з адрес ви зможете приймати монети, а потім і витрачати.

*Кожній адресі відповідає конфіденційне значення, доступне тільки власнику програми-гаманця, – особистий ключ. Він використовується для доведення володіння монетами в момент їх відправлення*.

Адресу можна математично обчислити з особистого ключа, тому якщо хтось заволодіє вашим особистим ключем, він може отримати доступ до монет, навіть не знаючи адреси.

Одна з ключових відмінностей криптовалюти від традиційної фінансової системи – те, що кількість адрес практично необмежена. Ви можете відправляти монети на будь-яку адресу, тоді як в банківській системі рахунки завжди закріплені за конкретною організацією й обов’язково повинні мати володільця.

### Транзакції в Bitcoin

*Транзакція – це набір цифрових даних, що ініціює оновлення бази даних (відправлення біткоінів з однієї адреси на іншу).* Це спрощене визначення, оскільки насправді структура транзакції більш складна (детально у 2.3). Відзначмо, що транзакцію формує та відправляє безпосередньо цифровий гаманець користувача, так що навіть розробники цифрової валюти не можуть вплинути на цей процес. На рис. 2.8 зображені знімки екрана частин інтерфейсу мобільного гаманця [25], які дозволяють, відповідно, надати свої реквізити та відправити платіж.

![Рисунок 2.8 – Відправлення й отримання коштів за допомогою мобільного гаманця](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.8-spend-and-receive.png)

> **Основні види bitcoin-гаманців**
>> * *Програмний гаманець*
>> * *Апаратний гаманець*
>> * *Централізоване сховище*

### Програмні гаманці

Деякі люди використовують для зберігання біткоінів програмні гаманці, які запускаються на смартфоні, ноутбуці або настільному комп’ютері. *Програмний гаманець – це застосунок, що обробляє ключі та транзакції*. Він з’єднується з мережею Bitcoin *через довірені* вузли чи *централізовані сервіси* або сам є вузол мережі.

Відзначмо, що рекомендується користуватися тільки тими програмними гаманцями, до розробників яких користувача має довіру. Така обережність пов’язана з тим, що розробники можуть закласти в програмний код застосунку вразливість, за допомогою якої вони зможуть заблокувати або вкрасти монети. Також потрібно враховувати, що розробник може припуститися помилки в продукті, якою можуть скористатися хакери.

З огляду на це рекомендується використовувати програмні гаманці з відкритим вихідним кодом. Таке рішення дозволяє провести аудит програмного коду гаманця та підготувати його до запуску на своєму пристрої.

Однак розробники ПЗ – не одні лише, кому користувач програмного гаманця довіряє. Крім них, користувач довіряє сервісам поширення цього ПЗ (магазини застосунків тощо), розробникам операційної системи та розробникам апаратного забезпечення пристрою користувача, оскільки на кожному з цих етапів можуть бути передбачені «лазівки».

### Апаратні гаманці

Звернімо особливу увагу на апаратні гаманці. Такий гаманець – це комп’ютер із вузьким набором операцій та обмеженим інтерфейсом управління. Так зроблено, щоби максимально ускладнити внесення шкідливого ПЗ в пристрій, а також щоби внеможливити злам як такий. Найчастіше основні функції апаратних гаманців такі: генерування особистих ключів, зберігання особистих ключів і підписання транзакцій.

Мінімальний варіант такого гаманця не має жодних додаткових інтерфейсів; це просто компактний пристрій. Найчастіше можна підключити його до звичайного ПК і працювати з ним за допомогою спеціального ПЗ. Максимальний варіант апаратного гаманця має екран, клавіатуру, акумулятор, сканер відбитка пальця та модулі бездротового з’єднання (рис. 2.9). У деяких випадках навіть є камера для сканування адреси одержувача. Апаратні гаманці мінімізують ризик крадіжки особистих ключів, але не захищають власника від їх утрачання. Тому здебільшого вони передбачають резервне копіювання особистих ключів.

![Рисунок 2.9 – Приклади апаратних гаманців](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.9-hardware-wallets.png)

Одного разу стався цікавий випадок: одна людина купила на eBay у незнайомого продавця апаратний гаманець виробника Ledger [26]. У коробці з гаманцем був аркуш паперу (рис. 2.10) із записаною *мнемонічною фразою* з позначкою: «Використовуйте цю фразу, щоби відновити ваш гаманець». Новий власник пристрою, недовго думаючи, ввів запропоновані слова, а через кілька днів виявилося, що всі його біткоіни пропали. Як це сталося? Продавець гаманця знав цю мнемонічну фразу спочатку. Отже, він міг отримати доступ до адрес, що використовував новий власник гаманця. Вийшло, що продавець сказав: «Поклади гроші до сейфу, ключ від якого маю і я». Таким чином, покупець пристрою безповоротно втратив усі монети. Безумовно, помилки припустився той, хто купив пристрій і не згенерував нові ключі.

![Рисунок 2.10 – Мнемонічна фраза для відновлення конкретного гаманця](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.10-mnemonic.png)

Теоретично можна уявити випадок, коли особистий ключ одного користувача збігся з особистим ключем іншого. Але на практиці це вкрай малоймовірно. Це пояснюється тим, що простір можливих особистих ключів становить 2<sup>256</sup>, а це число більше, ніж кількість атомів у всесвіті. Тому для мнемонічної фрази з довжиною 24 слова ймовірність збігу буде наближатися до нуля.

> **_Зауваження._** *Якщо генератор послідовності чисел для нового особистого ключа задається тривіальними даними, наприклад паролем користувача або поточним часом, то ймовірність збігу таких ключів збільшується.*

### Централізовані сховища

Є онлайн-сервіси, що реалізують базові функції цифрових гаманців, але зберігають особисті ключі централізовано на власних серверах. У їхніх користувачів виникає помилкове відчуття, що вони мають bitcoin-гаманець, тоді як насправді саме віддалений сервіс здійснює операції та зберігає монети замість користувача. Очевидно, що, використовуючи такі сервіси, користувач взагалі не контролює свої монети й повинен цілковито довіряти сторонній організації.

Один із найбільших сервісів централізованого зберігання – це компанія Coinbase. Вона – фактична подоба bitcoin-банку, тобто користувач реєструється в цьому сервісі, як у PayPal (за допомогою лоґіна–пароля). Після цього йому видають адресу для депонування біткоінів і застосунок для віддаленого управління своїми монетами, водночас сам користувач володіє лише зобов’язаннями цієї компанії. За використання централізованих сховищ ваші можливості з управління своїми коштами обмежені: ви можете тільки відправити запит на виведення біткоінів, а далі тільки сподіватися, що сервіс виконає свої зобов’язання.

Основна частина бірж зберігає цифрові монети користувачів за принципом централізованого сховища, отже, вимагає максимального рівня довіри від своїх користувачів.

### Резервне копіювання гаманців

Оскільки особистий ключ – одна лише можливість довести всім володіння монетами та витратити їх, *власник монет визначається знанням особистого ключа*. Нагадаємо, що будь-який bitcoin-гаманець реалізує такі функції: формування адрес для отримання монет, відображення балансів й історії транзакції, відправлення платежу, створення *резервної копії* гаманця й відновлення гаманця з резервної копії.

Відомий цікавий випадок із життя одного чоловіка на ім’я Джеймс. У нього був жорсткий диск, на якому зберігалися ключі з доступом до 7500 BTC. Одного разу він викинув його на смітник, оскільки на той момент курс біткоіну був незначним і ця сума не уявляла особливої цінності. Коли ціна монети зросла, Джеймс, побачивши, яких грошей позбувся, став шукати свій жорсткий диск на звалищі. Він навіть звернувся до муніципалітету, щоби місцева влада дозволила розкопати йому це звалище, але йому відмовили. Наскільки відомо, Джеймс довго перебирав різні можливості повернути диск, але так і не спромігся цього зробити [26].

Акцентуємо увагу на тому, що робити резервну копію гаманця потрібно ще до отримання першого платежу. Цей процес дуже важливий і для нього наявна технічна специфікація, яка підтримується різними розробниками цифрових гаманців. Найчастіше резервна копія може бути відновлена в гаманцях від різних розробників.

Якщо в користувача виникає запитання, чи потрібно робити резервну копію гаманця після кожного платежу, то відповідь залежатиме від реалізації конкретного гаманця. Зазвичай гаманець генерує нові адреси та відповідні ключі для кожного платежу. Отже, щоразу їх потрібно наново переносити до резервної копії. Але є такі гаманці, які використовують так зване детерміністичне генерування ключів (*детерміністичні гаманці*). У цьому разі досить одноразового резервування.

Для гаманців із детерміністичним генеруванням ключів є поняття *основний секрет гаманця*. З нього математично породжуються всі нові ключі. Це означає, що можна один раз зробити резервну копію основного секрету гаманця, а потім у будь-який час відновити доступ до монет на іншому пристрої та/або в іншому ПЗ. Для зручного подання основного секрету найчастіше використовується спеціальне кодування, що дозволяє перетворити секрет на *мнемонічну фразу*.

Приклад *мнемонічної фрази* проілюстровано на рис. 2.11. На практиці мнемонічну фразу зручно виписати на папір і зберігати в надійному місці, а за потреби ввести до іншого гаманця. Також для надійного зберігання ключів можна використовувати програми під назвою *менеджери паролів (password managers)*. Зручність таких програм полягає в тому, що вони дозволяють користувачу не записувати всю мнемонічну фразу, а запам’ятати від 4 до 6 слів, які знадобляться для того, щоби відкрити менеджер паролів й отримати доступ до всіх своїх особистих ключів.

![Рисунок 2.11 – Приклад мнемонічної фрази](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.11-mnemonic-example.png)

**Поширені міфи**

*Якщо ви зберігаєте особисті ключі на своєму пристрої, то у вас їх неможливо вкрасти.*

Найбанальніший спосіб украдення монет – це крадіння особистих ключів за допомогою програмного вірусу. Тому зберігати ключі, до яких прив’язані великі суми, на незахищених пристроях не рекомендується.

*Якщо зберігати особисті ключі поза доступу до глобальної мережі, про їхню безпеку можна не турбуватися.*

Такий підхід дійсно здатний підвищити безпечність зберігання ключів і здебільшого захистити від віддалених атак. Але це не означає, що збережений у такий спосіб особистий ключ перебуває в цілковитій безпеці.

*Квантові комп’ютери легко зламають систему шифрування в Bitcoin.*

Насправді Біткоін не використовує шифрування взагалі. Він використовує тільки цифрові підписи й геш-функції, причому в такій комбінації, що вони не вразливі до атак квантового комп’ютера (див. 3.2).

**Часті запитання**

*– Чи є організації, які вирішують сперечання щодо транзакцій?*

З одного боку, сперечання щодо транзакцій вирішуються на рівні самого протоколу Bitcoin. З іншого боку, можуть виникати суперечки за межами протоколу під час його використання. Для їх вирішення зазвичай використовують так званих escrow-агентів. Це означає, що під час здійснення угоди монети заморожуються між відправником й одержувачем, а рішення про розподілення цих монет ухвалюється за участі медіатора. У цьому разі медіатору мають одночасно довіряти обидва учасники угоди.

*– Чому не можна персоналізувати гаманець, тобто прив’язати його до конкретної особи?*

Протокол Bitcoin не вимагає ідентифікувати користувача. Навіть більше, це не необхідна умова для перевіряння транзакцій (для цього досить цифрового підпису). Хто може генерувати такі підписи, той і є їхній володілець. Отже, підписом може володіти людина, група з кількох людей, робот тощо. Що стосується персоналізації, жодних ідентифікаційних даних база даних Bitcoin не має, проте вся історія транзакцій загальнодоступна. Це означає, що якщо ви спроможетеся зв’язати конкретну адресу з конкретною особою, то ви зможете деанонімізувати деяких користувачів із певною ймовірністю.

*– Якщо ще кілька мільярдів користувачів заведуть гаманці, чи сповільниться Bitcoin?*

Якщо лише завести гаманець і створити багато адрес, то на мережу та базу даних це не вплине. Має вагу потік транзакцій, який залежить не від кількості користувачів, а від їхньої активності.

*- Чи можливо створити гаманці, які працюють без серверів і центру (однорангово)?*

Так, можливо. Однак у цьому разі вимоги до мобільного пристрою підвищуються: обсяг інтернет-трафіку, довге відновлення на іншому пристрої, енергоспоживання та пам’ять пристрою.

## 2.3 Поняття транзакція в Bitcoin

У цьому підрозділі ми опишемо деякі основні концепції, які так чи інакше стосуються поняття *транзакція* в Bitcoin: що таке біткоін-транзакція; як у розподіленій базі даних вона верифікується; як користувачу довести володіння монетами, які він намагається витратити; як визначаються та задаються комісії в Bitcoin; а також що таке конфліктні транзакції.

### Що таке біткоін-транзакція?

Як ми відзначали раніше, *транзакція – це набір цифрових даних, через який відбувається оновлення бази даних (відображає переказування монет із однієї адреси на іншу)*. Транзакція визначає як суму переказу та адресу одержувача, так і умови, необхідні для отримання доступу до монет, які буде переказано.

> **Життєвий цикл транзакції**
>> * *Створення*
>> * *Розповсюдження*
>> * *Верифікування*
>> * *Включення до блоку (валідування)*
>> * *Відхилення*

Розгляньмо, які дані входять до складу bitcoin-транзакції. Будь-яка транзакція містить дані про походження монет, що витрачаються (посилання на транзакції, де ці монети були отримані), докази володіння монетами, адреси нових власників (в ширшому сенсі – умови, за якими монети можуть бути витрачені) і суми переказів.

> **Дані в тілі транзакції**
>> * *Походження монет, які витрачаються*
>> * *Доказ володіння монетами*
>> * *Адреса для переказу (та умови витрати)*
>> * *Суми переказів*

> **_Зауваження._** *У найпростішому випадку адреса прив’язана до однієї пари ключів (відкритий та особистий ключі), що використовується для формування та перевірки цифрового підпису. Особистий ключ використовується для завірення транзакцій. Важливо підкреслити, що простір усіх можливих адрес величезний, а простір можливих особистих ключів ще більше. При коректній генерації, вгадати або підібрати особистий ключ до чужої адреси майже неможливо. Важливо не плутати поняття адреси з поняттям акаунта, оскільки в межах протоколу Bitcoin акаунтів немає.*

Аналогія зі звичайною розпискою допоможе краще зрозуміти, що таке bitcoin-транзакція. У певному сенсі найпростіші гроші – це розписки. У кожній розписці є дані: хто отримав платіж, від кого отримав, за що, сума платежу, дата та підпис (рис 2.12).

![Рисунок 2.12 – Приклад звичайної розписки](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.12-traditional-receipt.png)

Однак транзакція повинна відповідати певним вимогам, щоб її можна було вважати коректною. По-перше, вона повинна переводити монети, які належать відправнику. По-друге, ці монети можна витратити тільки один раз.

*Верифікація – це процес перевірки даних (транзакцій, блоків тощо) відповідно до правил протоколу.*

У процесі верифікації для кожної транзакції перевіряється доказ того, що відправник володіє монетами, які витрачає. Зазвичай автор транзакції доводить володіння монетами за допомогою цифрового підпису. Також необхідно перевірити, що транзакція витрачає існуючі монети, один раз і вперше.

Справжність розписки на папері перевірити нескладно. А ось у цифровому вигляді розписка може бути скопійована безліч разів і складно встановити, яка з них є оригінальною. Припустимо, користувач А видав розписку користувачеві Б. Якщо користувач Б виявиться шахраєм, то логічно припустити, що він прийде з друзями, у яких буде по такій же розписці, і кожен з них захоче отримати гроші. Якби кожна розписка мала силу оригіналу, то користувач А виявився би у незручній ситуації. У паперовому вигляді копію відрізнити від оригіналу досить легко, в електронному – ні. Тому необхідно вирішити цю та подібні їй проблеми.

У Bitcoin передбачено об'єднання транзакцій в структурні одиниці під назвою блоки. Блоки зв'язуються між собою за допомогою геш-значень і в такому вигляді зберігаються в розподіленій базі даних. Подібний підхід дозволяє забезпечити незмінність бази даних усіх транзакцій.

### Верифікування транзакцій

Відомо, що паперові чеки досі поширені у США і люди отримують ними заробітну плату, оплачують оренду, переводять у готівку в банках тощо. На рис. 2.13 показано, який вигляд має такий чек. На самому чеку можна побачити його серійний номер. Зауважимо, що у кожного чека він свій. Неможливо перевести в готівку два чека з однаковими серійними номерами.

![Рисунок 2.13 – Приклад паперового чеку](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.13-paper-check.png)

Як же Bitcoin вирішує проблему захисту від копіювання своєрідних «розписок» – транзакцій? У чековій книжці унікальним ідентифікатором служить порядковий номер чека. Але у *децентралізованому середовищі*, де функціонує Bitcoin, пронумерувати транзакції неможливо, оскільки всі учасники працюють асинхронно. Тому для можливості розрізнення однієї транзакції від іншої вводиться глобально унікальний ідентифікатор транзакції (txid / wtxid) – це *геш-значення*, розраховане від даних самої транзакції (докладніше див. підрозділ 3.1). Якщо зустрічається кілька транзакцій з однаковим геш-значенням, враховується тільки одна. Але бувають і виняткові ситуації, які будуть описані окремо.

Цікава особливість Bitcoin полягає у тому, що існує можливість в будь-який транзакції вказати, звідки беруться монети, тобто виконується посилання на попередню транзакцію із зазначенням її геш-значення. Таким чином, відбувається перевірка історії походження монет, які передаються. На рис. 2.14 схематично зображено, як нова транзакція витрачає монети, які були отримані в минулій транзакції.

![Рисунок 2.14 – Схема функціонування транзакцій у Bitcoin](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.14-how-transactions-work.png)

> **Основні етапи верифікації транзакції**
>> * *Перевірка умови, що витрачаються монети, які існують в обліковій системі*
>> * *Перевірка умови, що монети витрачаються не повторно, а вперше*
>> * *Перевірка доказів володіння монетами, що представив відправник (ініціатор транзакції)*

Працює це таким чином. Щоб витратити монети, користувач повинен вказати, де він їх отримав, і довести, що саме він ними володіє. Якщо походження монет не викликає додаткових питань, тобто відсутня інша транзакція, що витрачає ці монети, і користувач дійсно довів, що він – володілець, то залишається тільки дочекатися на підтвердження цієї транзакції від решти учасників системи.

Процес підтвердження транзакцій передбачає, що учасники попередньо перевіряють їх, після чого спільно узгоджують, які транзакції будуть вважатися правильними. Для підтвердження, транзакція повинна отримати згоду *більшості активних учасників* (див. 2.5). У процесі підтвердження транзакцій в Bitcoin може взяти участь будь-який бажаючий (рис. 2.15).

![Рисунок 2.15 – Схема взаємодії вузлів у мережі Bitcoin](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.15-nodes-iteraction.png)

### Поняття комісія в Bitcoin

Модель транзакцій у Bitcoin передбачає комісійні збори, які оплачуються біткоінами. Комісію включає сам відправник у момент створення транзакції, і за замовчуванням вона повинна бути вище певного порогового значення (хоча на практиці користувач може встановити її рівною нулю і така транзакція теоретично буде вважатися правильною). Встановлену комісію в якості додаткової винагороди отримують ті учасники, які підтверджують транзакції.

З ростом популярності Bitcoin значно виріс потік нових транзакцій у мережі. При цьому відомо, що згідно протоколу розмір блоку жорстко обмежений. В Bitcoin максимальний базовий розмір блоку складає 1МВ. Відповідно, бувають такі ситуації, коли потік нових транзакцій перевищує пропускну здатність Bitcoin. При цьому кожен вузол мережі організовує усі непідтверджені транзакції у чергу таким чином, що спочатку підтверджуються ті транзакції, що платять комісію більшого розміру за одиницю своєї ваги. Ціна запису даних встановлюється як відношення встановленої в транзакції комісії до її розміру в байтах (чи до її ваги в *weight units*; див. 4.6). Очевидно, що ті транзакції, які потрапляють в кінець черги, можуть довго залишатися непідтвердженими. Це не завжди зручно, тому що формується складно передбачуваний ринок на ціну запису одиниці даних до бази даних Bitcoin (див. 4.7).

Принципи децентралізації, що застосовуються для встановлення комісії у bitcoin-транзакціях, можна проілюструвати на наступному прикладі. Умовно можна порівняти потенційно підтверджений блок із політичною партією, яка має шанси пройти до парламенту. Місця у прохідній частині партії дістануться  тим депутатам, які запропонують найбільш велику «компенсацію». Очевидно, що депутати будуть «відсортовані» по розміру компенсації, і ті, що пропонували менше деякого значення, навіть не потраплять до прохідної частини списку. Скоріш за все, їм доведеться чекати наступних парламентських виборів і повторити спробу. Однак і ця проблема може бути вирішена у протоколі Bitcoin (див. 4.7).

> *Транзакція платить комісію за одиницю своєї ваги*
> *Максимальний базовий розмір блоку – 1 MB*
> *Валідатори сортують транзакції за зменшенням ціни запису даних*
> *Транзакції з низкою ціною запису даних можуть залишитися непідтвердженими надовго (чи назавжди)*

### Поняття конфліктні транзакції

Правильно сформований ланцюг блоків містить транзакції, які не конфліктують одна з одною. Що таке конфліктуючі транзакції? Якщо Кузьма в одній транзакції перевів 5 монет Степану, а в іншій ті ж самі 5 монет він відправив Леоніду, очевидно, що в одну версію історії обидві транзакції потрапити не можуть. Отже, повне підтвердження отримає тільки одна з них. Проте залишається питання, кому дістануться 5 монет, – Степану або Леоніду? До моменту повного підтвердження, однозначно на питання, яка транзакція буде прийнята, відповісти неможливо. Можна лише сказати, що з більшою ймовірністю підтвердиться саме та транзакція, яка раніше була поширена по мережі, або та, яка платить комісію більшого розміру.

**Поширені міфи**

*Вихідний код протоколу Bitcoin не є відкритим і вносити зміни до нього можуть лише його творці.*

Якраз навпаки: є навіть декілька реалізацій одного протоколу на різних мовах програмування, вихідний код цих реалізацій відкритий і доступний для вивчення, модифікації тощо.

*Звичайні інженери та розробники не можуть запропонувати модифікацію протоколу Bitcoin чи розробити свій гаманець.*

Будь-хто може запропонувати модифікацію протоколу і навіть запрограмувати власний клієнт мережі або власний додаток. Наявна Bitcoin-спільнота відчинена для нових пропозицій і складається в першу чергу з незалежних ентузіастів. 

**Часті питання**

*– Чи є необхідним з'єднання з мережею Bitcoin для генерації нової адреси?*

Ні, для цього з'єднання не потрібно. Генерація ключів для цифрового підпису та формування адреси може виконуватися локально. Цей процес ніяк не залежить від інших користувачів.

*– Що трапиться, якщо ключі у двох різних користувачів збіжуться?*

Слід розуміти, що ймовірність такого збігу вкрай мала, тому нею зазвичай нехтують. Але якщо через помилку генерації або з будь-яких інших малоймовірних причин таке станеться, то фактично обидва користувачі будуть бачити одну суму на балансі і мати доступ до одних і тих же монет, кожну з яких можна витратити тільки один раз.

*– Хто встановлює комісію для транзакції?*

Розмір комісії визначений у тілі самої транзакції. Тобто встановлює її той, хто формує та підписує транзакцію. Але її треба встановлювати вище необхідного мінімуму, який може змінюватися з плином часу.

*– Чи правда, що якимось чином можна аналізувати історію походження всіх монет і порушити конфіденційність деяких угод в Bitcoin?*

Так, є практика створення таких організацій, які аналізують велику кількість прямих і непрямих даних, щодо угод з використанням Bitcoin. І ці організації з певною ймовірністю можуть сказати, які монети кому належать і з якою метою використовуються. У свою чергу сервіси, які приймають біткоіни, наприклад централізовані біржі, можуть звертатися до подібних організацій за необхідною інформацією. Біржі, які цінують свою репутацію, такі як Kraken, не приймають платежі, якщо *історія походження монет* перебуває під сумнівом (див. 4.1). Однак підходи до підвищення рівня приватності існують в самому Bitcoin. Також існують криптовалюти Monero і Zcash, які роблять великий акцент на приватності користувачів (див. 7.2).

## 2.4 Високорівнева архітектура Bitcoin

У цьому підрозділі ми познайомимося з тим, як влаштований Bitcoin, особливостями організації спільної бази даних і колективної обробки транзакцій, опишемо основні принципи досягнення консенсусу в Bitcoin, а також порівняємо Bitcoin з традиційними платіжними системами.

На архітектуру Bitcoin сильно впливає необхідність працювати у вкрай ворожому інтернет-середовищі, яке є відносно анонімним, де правоохоронні органи майже не працюють, яке повне хакерів, відсутні відповідальні сторони та будь-які гарантії. Таким чином, запуск Bitcoin довів, що можна створити фінансову систему з відкритою базою даних. Систему, яку кожен користувач може використовувати без реєстрації. Її основні принципи наступні: копії бази даних зберігаються всіма користувачами, користувачі слідують однаковим правилам і довіряють тільки тому, що можуть перевірити самі. В цьому і суть децентралізації в платіжних системах.

### Архітектура Bitcoin

Локальна копія бази даних у кожного користувача організована як ланцюжок жорско впорядкованих наборів транзакцій (блоків). Схематично таку організацію даних можна відобразити у вигляді ланцюжка блоків, в якій кожен блок – це група транзакцій (рис. 2.16). Сатоші назвав цей формат зберігання даних block chain, а пізніше його стали називати blockchain. 

![Рисунок 2.16 – Організація бази даних в системах, що використовують технологію blockchain](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.16-blockchain-based-database.png)

Технологія blockchain дозволяє організувати базу даних таким чином, що всі блоки пов'язані один з одним (зліва на рис. 2.16 зображений genesis block, детальніше він буде розглянутий в 4.3). В результаті неможливо змінити вміст одного блоку, не торкнувшись при цьому всіх наступних.

Хто ж верифікує транзакції і як вони потрапляють до ланцюга блоків? Насправді будь-який користувач може створити коректну транзакцію, відправити її до мережі, і вона буде передана всім іншим учасникам. Після цього кожен валідатор незалежно від інших перевіряє транзакцію на предмет коректності і додає її до свого блоку для підтвердження. Транзакція має потрапити до одного з нових блоків, щоб її можна було вважати підтвердженою. Над таким блоком учасники теж працюють паралельно та незалежно один від одного (рис. 2.17).

![Рисунок 2.17 – Робота учасників системи над продовженням ланцюга блоків](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.17-users-work-on-the-chain.png)

Хто формує блоки та вибирає транзакції, якими потрібно їх наповнювати? На рис. 2.18 видно, що кожен блок створений деяким користувачем і продовжує основний ланцюг. Творець пропонує свій блок іншим вузлам мережі, після чого вони перевіряють цей блок і додають його до своєї копії бази даних, якщо він відповідає правилам протоколу. Якщо більшість учасників додає запропонований блок, то він потрапляє до ланцюжка, а транзакції в ньому вважаються підтвердженими. Слід розуміти, що додається до ланцюжка лише один блок. Уся решта блоків, які згенерували інші учасники, але які не потрапили до ланцюжка, відкидається. Транзакції, які містив відкинутий блок (*orphan block*), не підтверджуються та доступні для підтвердження згодом. Такий порядок дій потрібний для досягнення консенсусу в *децентралізованому середовищі*.

![Рисунок 2.18 – Формування блоків учасниками системи](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.18-how-users-create-block.png)

### Процеси в обліковій системі Bitcoin

> *Аудит облікової системи*
> *Валідація транзакцій*
> *Управління оновленнями*

Аудит представляє собою процес, який полягає в перевірці факту, що поточний стан бази даних облікової системи повністю відповідає проведеним транзакціям.

Валідація транзакцій (також відома як процес формування блоків або майнінг) полягає у перевірці транзакцій на предмет відповідності правилам протоколу та додавання їх до блоку, а в подальшому і до бази даних облікової системи.

Управління оновленнями означає процес, метою якого є затвердження функціональності облікової системи та, в ідеальному випадку, приведення всіх вузлів системи до єдиної формі функціонування.

### Ролі учасників в обліковій системі Bitcoin

Облікова система Bitcoin надає можливість кожному учаснику керувати перерахованими вище процесами. Виходячи з цього, кожен учасник облікової системи може виконувати одну чи декілька таких ролей.

> *Користувач*
> *Аудитор*
> *Валідатор*
> *Розробник*
> *Тестувальник*

Особливість Bitcoin полягає в тому, що кожен учасник системи самостійно (у *permissionless* спосіб) вирішує, яку роль він виконуватиме.

### Умови, у яких досягається консенсус у Bitcoin

Як було зазначено вище, перш ніж внести будь-які зміни до загального стану ланцюга блоків, учасники повинні прийти до єдиного рішення. Якщо учасники перевірили блок на предмет коректності та всі згодні додати його до свого ланцюга, то блок додається, і на його основі вони починають будувати новий. Однак часто прийняти рішення дуже непросто, а саме це завдання часто є ключовим. Без його вирішення надійна робота децентралізованої облікової системи неможлива. Тому одним з найважливіших її компонентів, які повинні бути реалізовані, є механізм досягнення консенсусу.

*Консенсус – це стан згоди користувачів щодо транзакцій, які вони вважають правильними, що був досягнутий у ході обговорення (обміну повідомленнями про транзакції, блоки, стан вузлів)*. Мета всіх чесних користувачів – досягти консенсусу. При цьому очевидно, що ви не будете покладатися на те, що більшість учасників системи є чесною. З цієї причини протокол Bitcoin розроблений у такий спосіб, що консенсус у системі може бути досягнуто навіть за умов нижче.

> *Кількість вузлів мережі невідома*
> *Учасники можуть бути анонімними*
> *Валідатори можуть бути анонімними*
> *Учасники системи не довіряють один одному*
> *Немає єдиного центру управління*
> *Кількість зловмисних вузлів невідома*

В ідеальному разі всі повинні погодитися зі списком підтверджених транзакцій. Однак на практиці, під час узгодження присутня низка складностей. Як було вже згадано, Bitcoin спроектований таким чином, щоб забезпечити безпечне функціонування у вкрай ворожому інтернет-середовищі. У даному випадку, передбачається, що всі учасники анонімні, не довіряють один одному, їх кількість взагалі невідома та може бути дуже великою. До того ж голос кожного користувача може бути легко підроблений (у порівнянні з традиційним підходом до голосування).

Безпосередньо, у мережі працює комп’ютерна програма, за якою звичайно стоїть людина. Однак може виявитися, що за програмним забезпеченням чесного користувача стоїть бот зловмисника. Більш того, може трапитися так, що за сотнею чи тисячою користувачів буде стояти лише одна людина.

### Як досягається консенсус в Bitcoin?

Визначивши всю складність задачі, а саме досягнення консенсусу в середовищі, в якому відсутня довіра, де будь-яких учасник потенційно може бути зловмисником, ми можемо розглянути ключове питання, як саме це відбувається.

Принцип досягнення консенсусу в децентралізованій обліковій системі Bitcoin можна пояснити на наступному прикладі. Кожен з нас колись грав у карти. В грі немає «головного» – всі учасники знають правила і повинні слідувати ним. Всі ходи (в нашому випадку ними являються транзакції) публічні і перевіряються всіма учасниками гри. Якщо хтось достане з рукава п’ятий туз, це буде одразу помітно іншими учасниками, і порушник правил буде вилучений (рис. 2.19). Зі схожими принципами виконується «розподілення» нових карт з колоди (по аналогії добуття біткоінів) – правилами визначений порядок, в якому гравці добирають карти, і кількість цих карт.

![Рисунок 2.19 – Карткова гра як приклад досягнення консенсусу](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.19-poker.png)

Зобразимо консенсус схематично (рис. 2.20). Всі користувачі локально зберігають копію бази даних, що організована з застосуванням технології blockchain. Стан одностайності означає, що у кожного чесного користувача стан копії буде ідентичним після синхронізації. Тобто у всіх учасників однакові блоки даних, які утворюють однакові ланцюги. 

![Рисунок 2.20 – Ситуація, у якій учасники системи досягли консенсусу](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.20-consensus-reaching.png)

> **_Зауваження._** *У контексті Bitcoin поняття загальна база даних, ланцюжок блоків, історія транзакцій мають однакове значення.*

### Порівняння Bitcoin з традиційними платіжними системами

> *Bitcoin не вимагає реєстрації*
> *В транзакції відсутні будь-які персональні дані*
> *Адреса може використовуватися один раз*

Часто люди цікавляться, наскільки конфіденційними будуть їх дії при роботі з Bitcoin? Дійсно, у Bitcoin можна побачити всі транзакції між усіма адресами, але однозначно неможливо стверджувати кому вони належать. Це ускладнює простежування історії транзакцій конкретного користувача. Щоб краще зрозуміти питання приватності користувачів у Bitcoin, давайте проведемо аналогію з традиційними фінансовими системами (табл. 2.1).

Таблица 2.1 – Порівняння традиційних платіжних систем із Bitcoin

|*Традиційні платіжні системи*| *Bitcoin* |
|---|---------|
|Непрозора історія транзакцій і обмежений доступ до аудиту|Прозора історія транзакцій, усі зміни видно кожному|
|Централізоване прийняття рішень щодо змін|Колективне оновлення бази даних з транзакціями|
|Вимагає повної довіри до відповідальної організації|Довіра до математики та програмного коду|
|Можливість відновлення доступу до рахунку |Самостійне управління ключами доступу|
|Є ризик банкрутства та відмови в обслуговуванні|Ризики роботи з ключами і ПО користувачі несуть самі |

Банк виконує функцію зберігання й обліку. Для цього банк бере у клієнтів гроші та цінні речі, а натомість обіцяє пам'ятати, скільки та кому він винен. Такий підхід зазвичай зручний, оскільки доступ до грошей здійснюється за допомогою банківської карти, яку може використовувати тільки її власник. Це позбавляє клієнта від необхідності носити готівку при собі, а у разі втрати картки її можна без зусиль відновити. Однак усі рішення банк приймає централізовано, і кошти знаходяться повністю під його керуванням. Якщо банк забуде, скільки та кому винен, у клієнта з'являться проблеми. Фактично, це типова історія про компроміс зручності та безпеки.

До появи Bitcoin фінансові відносини у суспільстві так і відбувалися. Більш того, банки віддавали все більшу перевагу саме такій схемі роботи і з часом розробили багато різних її реалізацій. Користувачам залишалося тільки сподіватися, що банк виконає свої зобов'язання та поверне гроші, коли клієнту вони будуть потрібні.

Bitcoin працює без деяких обмежень, які властиві традиційним платіжним системам і цифровим валютам. У деякому сенсі він доповнює фінансову систему, показуючи, що альтернативні варіанти архітектури також можливі та що *облікова система* без головної керуючої організації може існувати.

**Поширені міфи**

*Творець Bitcoin може змінити правила роботи валюти або вкрасти монети користувачів.*

Це не так. У творця Bitcoin такі ж права по відношенню до цієї валюти, як і в інших користувачів.

*Щоб відправляти та приймати платежі у Bitcoin, потрібно десь зареєструватися.*

У Bitcoin немає ні бази даних зареєстрованих користувачів, ні центру прийняття рішень. Кожна транзакція завіряється окремо, а перевірку цифрового підпису може виконати будь-хто. Зазвичай централізовані облікові системи використовують сеансову автентифікацію, яка має на увазі, що вже верифікуваному користувачеві не потрібно повторно проходити цей процес для кожної наступної дії, на відміну від Bitcoin, де кожна транзакція користувача верифікується окремо.

**Найбільш поширені питання**

*– Як виглядають біткоін-монети?*

Насправді фізичного представлення вони не мають, а визначені лише абстрактно. Це абстрактне поняття досить добре відображає властивості цифрової валюти, оскільки в загальній базі даних зафіксовані записи про всі дії по видобутку і передачі цієї валюти, тому фізичні монети вже не потрібні.

*– Якщо угода оскаржується в суді і суд її скасовує, то як скасувати транзакцію у Bitcoin?*

Оскільки рішення у Bitcoin приймаються децентралізовано, з досягненням консенсусу, то одноосібне рішення не вплине на кінцевий стан бази даних. Суд, звісно, може прийняти рішення про скасування транзакції, але реалізувати його буде, найімовірніше, неможливо. Виняток становить ситуація, коли більшість учасників підтримало б ухвалу суду. Проте ледве можна уявити таку судову практику в сучасних умовах.

## 2.5 Підтвердження транзакцій у Bitcoin

Раніше ми згадували, що Bitcoin може стабільно працювати в умовах анонімності учасників і потенційної наявності невідомої кількості зловмисників. У цій темі ми спробуємо детально описати, як це відбувається. Також ми спробуємо пояснити, чому в таких умовах неможливі фінальні транзакції й як на практиці вирішується ситуація, коли навіть вже підтверджена транзакція може знову стати непідтвердженою [28]. Також ми розглянемо, як Bitcoin реалізує підтвердження транзакцій у *децентралізованому середовищі*.

Будь-який користувач може вибрати серед непідтверджених транзакцій такі, які він вважає правильними, після чого об'єднати їх до блока та запропонувати цей блок усім іншим вузлам мережі. За рішенням «більшості» блок може бути прийнятий або відхилений. Якщо сам валідатор працював чесно, верифікував транзакції за правилами протоколу та першим запропонував наступний блок загального ланцюжка, то інші чесні учасники приймуть цей блок.

### Формування блоків транзакцій

Правильно сформований блок складається з транзакцій, які не підтверджені в попередніх блоках і не конфліктують між собою. Кожен блок обов'язково містить геш-значення від попереднього блока. Це означає, що блок підтверджує не тільки свої транзакції, але й усі попередні, що вже включені до ланцюжка, на який цей блок посилається. Ще одна особливість формування блоків полягає у тому, що протокол регулює складність ресурсоємного завдання для формування блоків так, щоби новий блок з’являвся в середньому що 10 хвилин.

> **Правильно сформований блок**
>> * *Містить коректні транзакції, які раніше не підтверджені та не конфліктують одна з одною*
>> * *Містить геш-значення попереднього блока*

Як формується новий блок? Комп'ютер окремого користувача зберігає весь ланцюжок блоків, який був верифікований за допомогою  ПЗ Біткоіна та вважається правильним. У системі постійно здійснюються перекази між користувачами та з’являються нові непідтверджені транзакції, які розповсюджуються серед усіх вузлів. Комп'ютер кожного користувача верифікує потік цих транзакцій і об'єднує в блок ті, які він вважає правильними (рис. 2.21). Далі він обов'язково вказує посилання на попередній блок, щоб було зрозуміло, на підставі якої історії він працює, і щоб дотримувалася цілісність бази даних. Після він пропонує іншим вузлам мережі свій блок як продовження загального ланцюжка.

![Рисунок 2.21 – Процес верифікації отриманих транзакцій](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.21-transaction-verification.png)

Але якщо деякий користувач запустить такий вузол мережі, що буде шахраювати, пропонуючи підроблені блоки іншим користувачам, що тоді трапиться? Гірше того, це може бути не один користувач, а організована група зловмисників, яка запустила цілий botnet з модифікованих вузлів мережі, які нехтують правилами протоколу. Як у такій ситуації чесним користувачам досягти консенсусу? Очевидно, що завдання непросте, але Сатоші Накамото вирішив його.

> **Згода щодо нових транзакцій**
>> * *Будь-який користувач може вибрати серед непідтверджених транзакцій правильні й об'єднати їх до блока*
>> * *Запропонований блок буде прийнятий або відхилений за рішенням валідаторів*

### Вимоги до нових блоків

Настав час зануритися до процесу створення блока. Рішення проблеми з підробленими блоками полягає у наступному: блок вважається правильним, якщо на його створення було витрачено задану кількість обчислювальних ресурсів. Це означає, що користувач повинен надати рішення ресурсномісткого завдання, щоб усі інші учасники могли перевірити та прийняти його блок.

Тепер зловмисник уже не може відволікати інших учасників великою кількістю підроблених блоків. Разом із цим вирішуються питання частоти появи нових блоків і послідовності валідаторів у формуванні наступного блока. Працює це таким чином. Починають формувати новий блок усі, але право запропонувати свій блок іншим отримує тільки той, хто вирішив ресурсомістке завдання першим.

Очевидно, що чим більше у користувача обчислювальних потужностей, тим частіше він стає першим серед усіх бажаючих. Якщо конкретніше, то ймовірність стати першим дорівнює відсотку від усіх обчислювальних ресурсів системи, який має участник.

> **Процес створення нового блока**
>> * *Потрібно надати рішення ресурсомісткого завдання*
>> * *Той, хто вирішив задачу першим, сповіщає всіх, розсилаючи їм свій блок*
>> * *Ймовірність стати першим залежить від частки ресурсів учасника в усіх обчислювальних ресурсах, задіяних у системі, а також від затримок в каналах передачі даних*

Ми повільно підійшли до суті майнінгу в Bitcoin. На практиці *рішення ресурсоємного завдання  –  це і є майнінг*. Це завдання має однакову складність для всіх вузлів мережі. Майнінг дуже важливий для Bitcoin, і чесні користувачі займаються цим з метою підтримки надійності процесу підтвердження транзакцій. Справедливо, що той, хто контролює більше потужності, створює блоки частіше інших. Подивимось, як це працює на прикладі нижче.

### Принципи змагання між користувачами

Припустімо, у системі працює 10 вузлів-валідаторів. У кожного з них є майнінговий комп’ютер, що обчислює однакову кількість геш-значень в одиницю часу (рис. 2.22). Цю обчислювальну потужність приймемо за 1, тоді сумарна потужність системи дорівнюватиме 10. А кожний валідатор, відповідно, контролює 1/10 цієї потужності. Імовірність знаходження наступного блока кожним із учасників складає 0,1.

![Рисунок 2.22 – Облікова система з десятьма валідаторами](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.22-ten-validators.png)

Нехай учасник А вирішив, що займатися майнінгом вигідно, і придбав собі ще 2 комп’ютера (рис. 2.23). Відтепер сумарна потужність системи дорівнюватиме 12 (10 + 2 = 12). Частка цього учасника відтепер становить 3/12 чи 1/4, а частка кожного з решти учасників так само дорівнює 1/12. Отже, ймовірність того, що учасник А буде знаходити новий блок першим, дорівнює 0,25, а для всіх інших учасників вона буде рівною по 0,08(3). Таким чином, маючи навіть малу частку обчислювальної потужності, валідатор може створити новий блок першим, хоча ймовірність буде нижче, ніж в інших.

![Рисунок 2.23 – Мережа з десятьма валідаторами, один з яких придбав додаткову обчислювальну потужність](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.23-ten-validators-with-diff-power.png)

Але що ж станеться якщо зловмисник вирішить задачу для блока, який буде містити правильні з точки зору протоколу транзакції, а чесні учасники будуть все одно не згодні з цим блоком? Адже всі учасники мережі анонімні, програмне забезпечення можливо модифікувати, а хто з учасників буде вести себе чесно чи зловмисно, заздалегідь невідомо.

### Розповсюдження блока

Перш ніж ми відповімо на питання, як вирішуються розбіжності щодо певного блока, пропонуємо розглянути процес поширення блока мережею. Отже, один з вузлів мережі знаходить рішення завдання і формує блок. Далі відбувається процес трансляції блока до мережі. Тобто вузол, що сформував блок, передає цей блок усім вузлам, з якими має безпосереднє з'єднання.

Після цього вузли, що прийняли блок, перевіряють його на відповідність правилам протоколу. Є два варіанти розвитку подій. У першому випадку, якщо вузол погоджується, що прийнятий блок є коректним і може бути доданий до ланцюжка блоків, то він зберігає собі копію блока та поширює його далі мережею. Але що відбувається у тому випадку, якщо вузол не погоджується з отриманим блоком?

### Вирішення розбіжностей

Якщо один учасник не згоден з блоком іншого, то абсолютно нормальним вважається створення альтернативного блока на тій же висоті ланцюжка блоків.

> *Учасник, що не згоден, формує альтернативний блок*
> *Альтернативні блоки можуть включати однакові транзакції*
> *Вузли мережі зберігають обидва варіанти*
> *Решта учасників формують блоки, продовжуючи одну з версій ланцюжка*
> *Перемагає ланцюжок з найбільшою довжиною (найбільшою кількістю роботи, що витрачена на його побудову)*

*Висотою блока називається порядковий номер блока в ланцюжку щодо genesis block.
*
*Genesis block – блок, висота якого дорівнює нулю.(рис. 2.24)*

![Рисунок 2.24 – Нумерація блоків (0 – Genesis block)](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.24-block-num.png)

Таким чином, факт незгоди одного з учасників може спричинити ситуацію, коли буде сформовано два блоки, що посилаються на один попередній. Такі блоки можуть містити навіть однакові або конфліктні транзакції. При цьому вузли мережі можуть зберегти обидва запропоновані варіанти, якщо вважатимуть їх правильними, але кожен з них повинен для себе визначити, на базі якого з альтернативних блоків створювати наступний. Таким чином, інші учасники роблять свій вибір, формуючи блоки на одному з існуючих блоків, вказуючи посилання на нього у своєму новому блоці для продовження конкретної версії ланцюжка. А правила протоколу вказують на те, що з двох правильних версій пріоритет потрібно віддавати тій, на створення якої було витрачено більше обчислювальних ресурсів.

Процес розв'язання суперечностей можна зобразити схематично (рис. 2.25). Це вирішується просто. Є мережа вузлів, в локальних копіях бази даних яких є два альтернативних блока на одній висоті. Умовно позначмо, що користувачі зліва вирішили вибрати верхній блок в якості основного, а користувачі справа  –  нижній. І припустімо, що всі продовжують працювати над створенням наступного блока, підтримуючи різні версії.

![Рисунок 2.25 – Процес розв’язання суперечностей в мережі Bitcoin](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.25-disagreement.png)

У наступний момент часу якийсь користувач створив і запропонував новий блок, що посилається на верхній з двох альтернативних. При цьому його пропозиція була прийнята всіма іншими учасниками мережі. І навіть ті учасники, які спочатку вибрали інший альтернативний блок, перевірили і прийняли більш довгий ланцюжок (рис. 2.26).

![Рисунок 2.26 – Стан мережі після розв’язання суперечень](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.26-disagreement-resolved.png)

Це так зване *правило найдовшого ланцюжка*. У ньому йдеться, що учасник повинен вибирати найдовший ланцюжок з усіх можливих, той ланцюжок, який він вважає правильними, і вважати його основним. А якщо більш жорстко, то вибирається той ланцюжок, для створення якого було виконано більше роботи. До того ж, важливо розуміти, що чесний учасник переключиться на довший ланцюжок тільки в тому випадку, якщо він буде побудований за правилами протоколу. Це не дозволяє зловмисникам порушити початкові правила Bitcoin, навіть якщо вони будуть мати велику обчислювальну потужність.

### Поняття повного підтвердження транзакції

Зупинімося на найважливішому положенні в контексті використання валюти bitcoin. Воно стосується процесу підтвердження транзакцій в Bitcoin. *Транзакція вважається достатньо підтвердженою, якщо вона включена до найдовшого ланцюжка і після блока, у якому вона міститься, є ще 5 блоків.* Інакше кажучи, потрібно дочекатися 3–6 підтверджень. Якщо врахувати, що блок з'являється в середньому 1 раз в 10 хвилин, нескладно розрахувати, що повне підтвердження транзакції займає до однієї години.

Відповідь на питання, чому необхідно саме 6 підтверджень, дає математичний розрахунок: якщо один ланцюжок випереджає інший на 5 блоків, при тому ж розподілі обчислювальної потужності, ймовірність «обігнати» той, що довший вкрай мала. У своїй статті [14] Сатоші Накамото математично доводить це на підставі наступного положення. 

$$ q_{z}=
\begin{cases}
1 & \text{ якщо } p \leq q \cr \\ 
(q/p)^{z} & \text{ якщо } p \gt q 
\end{cases} $$

де p  –  імовірність того, що чесний вузол знайде наступний блок; q  –  імовірність того, що зловмисник знайде наступний блок; qz  –  імовірність того, що зловмисник коли-небудь наздожене основний ланцюжок, якщо він почав альтернативний z блоків назад.

Наприклад, якщо зловмисник володіє 10% обчислювальної потужності всіх валідаторів, а чесні вузли працюють в мережі з швидкою доставкою повідомлень, то ця ймовірність буде менше 1/1000.

### Винагороди за створення блоків 

Ще одне важливе питання  –  це мотивація користувачів вирішувати ресурсомісткі завдання, створювати нові блоки та підтверджувати транзакції, не залишаючи шансів зловмисникам. 

Ми вже говорили про процеси формування блоків, емісії монет і про комісії за підтвердження транзакцій. У Bitcoin ці процеси дуже тісно пов'язані один з одним. Справа в тому, що за правилами протоколу творець блока може відправити на свою адресу певну кількість монет, взявши їх з нізвідки. Це й є емітовані монети. Підсумкова сума винагороди розраховується як емітовані монети плюс сума комісій всіх транзакцій, включених в цей блок.

**винагорода = нові монети + комісійні збори**

Таким чином, у 2018 році винагорода за створення одного блока становить 12.5 монет плюс комісійні збори. Відзначимо, що з міркувань безпеки валідатор не отримує при цьому винагороду відразу після створення блока. Є спеціальний параметр *coinbase maturity* [29]. Він вказує на мінімальну кількість підтверджень транзакції, в якій валідатор отримує винагороду. У Bitcoin цей параметр має значення 100, отже, після створення блока необхідно дочекатися появи ще 99 блоків, які будуть підтверджувати цей, перш ніж винагорода стане доступною.

Як було зазначено раніше, новий блок з’являється в середньому що 10 хвилин незалежно від сумарної обчислювальної потужності системи. Це досягається за рахунок використання параметра складності, який розраховується кожним вузлом незалежно за відомим алгоритмом і використовується для завдання вимог до вирішення ресурсомісткого завдання. Згодом цей параметр перераховується з урахуванням зміни обчислювальної потужності системи.

Дуже важливо розуміти, що всі вузли мережі колективно знаходять новий блок за 10 хвилин. Кожен окремий учасник може шукати рішення задачі для створення блока годинами або навіть роками. Але згідно з теорією ймовірностей хтось один знайде його в середньому за 10 хвилин, за умови, що всі валідатори будуть працювати над одним ланцюжком блоків. Це також означає, що виключення половини потужності системи в один момент призведе до збільшення середнього періоду формування блока до 20 хвилин. І він буде залишатися збільшеним до того моменту, коли параметр складності буде перерахований.

Прийнято вважати, що впливати на обробку транзакцій може тільки той, хто контролює понад 50% потужності. Щоб облікова система Bitcoin могла вважатися безпечною, необхідно, щоби більшість обчислювальної потужності системи контролювали саме чесні валідатори. Це означає, що довіряючи Bitcoin, користувач впевнений в тому, що тисячі людей не домовляться одночасно проти нього. Атака, за якої зловмисник контролює більш ніж половину обчислювальних потужностей системи, зазвичай називається *атакою 51%* (докладніше в 4.2). На момент 2020 року Bitcoin жодного разу не наразився на неї на практиці. Однак можна навести яскраві приклади з успішними атаками 51% в Bitcoin Gold і ZenCash, які сумарно обійшлися в більш ніж 18 млн доларів США.

### Вплив розривів мережі на облікову систему Bitcoin

В якості драматичного прикладу можна привести вигадану ситуацію. Одного разу морські бобри, напившись піратського рому, одночасно перегризли всі оптоволоконні кабелі, які проходили по дну океанів і з'єднували всі континенти у глобальну мережу. Канали передачі даних між континентами відмовили, але вузли кожного континенту продовжили коректно працювати у своїх підмережах. Однак користувачі різних підмереж, не могли синхронізуватися, щоб обмінюватися транзакціями та блоками, тому на кожному континенті валідатори формували різні версії ланцюжка блоків.

Очевидно, що більшість вузлів мережі Bitcoin використовують глобальну мережу для спілкування один з одним, а популяція підприємців-майнерів нерівномірно нанесена на поверхню материкової частини Землі (рис. 2.27). Що ж може статися з цією цифровою валютою, якщо в роботі Всесвітньої мережі між шістьма континентами будуть збої?

![Рисунок 2.27 – Схема розташування континентів та зв’язків між ними у прикладі](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.27-network-connection.png)

Поки доктор Айболить сточував зуби одночасно всім морським бобрам, а інспектор Ґаджет лагодив оптоволоконні кабелі ізолентою, валідатори продовжували формувати блоки (рис. 2.28). Оскільки групи валідаторів на різних континентах мали різну обчислювальну потужність, а параметр складності ще не оновився, то період формування одного блока став набагато більше десяти хвилин для кожної з підмереж. Більш того, цей період виявився різним для кожного континенту, що призвело до формування альтернативних ланцюжків різної довжини.

![Рисунок 2.28 – Неоднорідність стану бази даних на різних континентах](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.28-non-uniformity.png)

У момент, коли лікар Айболить та інспектор Ґаджет закінчили свою роботу і канали передачі даних були відновлені, вузли мережі Bitcoin з різних континентів одночасно почали синхронізуватися між собою. Тоді-то і з'ясувалося, що є кілька різних версій ланцюжка блоків, і що всі вони мають різну довжину (рис. 2.29). Більш того, у різних ланцюжках знаходяться різні транзакції, підмножини яких можуть тільки частково перетинатися.

Відповідно до правил протоколу Bitcoin усі вузли виберуть найбільш довгий ланцюжок і вважатимуть його основним (*mainchain*). Цікавим є і той факт, що транзакції, які були включені тільки в альтернативні ланцюжки, знову отримали статус непідтверджених. Проте повні вузли мережі продовжують їх зберігати і синхронізувати, а вузли валідатори, як і завжди, зацікавлені включити їх в свої блоки і отримати винагороду, за умови, що ці транзакції не конфліктують з уже підтвердженими в *mainchain*.

![Рисунок 2.29 – Вибір найдовшого ланцюжка блоків](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.29-choosing-the-longest-chain.png)

Таким чином, транзакції з відкинутих блоків (*orphan blocks*) потрапляють до списку непідтверджених і з високою ймовірністю будуть підтверджені пізніше. В результаті, частина валідаторів не отримає винагороду за вирішення завдань, хоча всі вони працювали з однаковою ретельністю.

В описаній ситуації є ризики втратити монети не тільки для валідаторів Bitcoin, але й для користувачів. Ці ризики зумовлені тим, що не вся обчислювальна потужність Bitcoin використовувалася для підтримки надійності валюти. Наприклад, користувачі можуть не помітити поділ глобальної мережі на підмережі і продовжити приймати платежі у криптовалюті, ризикуючи пізніше не виявити прийняті монети на своєму балансі. Провести подібний обман здатні навіть пірати Карибського моря. Припустимо, Капітан Джек Горобець роздобув зображення особистого ключа. На відповідну цьому ключу адресу, ще до того, як пірати навчили морських бобрів пити ром і бунтувати, хтось відправив біткоіни, і вони збереглися не витраченими. А коли бобри перетворили глобальну мережу на шість локальних, капітан вирішив, не гаючи часу, оплатити біткоінами установку дизельного двигуна на Чорну Перлину в порту першого континенту. Після чого корабель піратів відразу попрямував до другого континенту під дією попутного вітру, щоб заправитися там дизельним паливом.

Часу на обман до відновлення зв'язку у піратів небагато, проте на другому континенті ще не знають про першу транзакцію Джека Горобця. Після прибуття на другий континент Джек знову використовує зображення особистого ключа, щоб оплатити заправку піратського корабля біткоінами (рис. 2.30). Тутешній заправник чекає першого підтвердження і приймає ті монети, які фактично були витрачені на першому континенті.

![Рисунок 2.30 – Витрата одних і тих же монет декілька разів](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.30-captain-jack-sparrow.png)

Тим часом доктор Айболить й інспектор Ґаджет обіцяють усунути загрозу і вирішити проблему з цим дуже скоро. З огляду на їх сумлінне ставлення до роботи, пірати завчасно підготувалися до щільного графіку кругосвітньої подорожі. Маючи зображення особистого ключа та швидкохідний корабель з повним баком дизельного палива вони готові відвідати й інші континенти, щоб заповнити трюм ромом і купити керівництво по вивченню квантової механіки.

Очевидно, що після того, як вузли синхронізувалися, підтвердженою залишилася тільки одна транзакція  – та, яка платила торговцю з континенту з найбільшою частина обчислювальної потужності Bitcoin. Пірати ж дали гарний урок торговцям, яких обдурили. Після цього, багато користувачів Bitcoin вирішили відмовитися від звичайних транзакцій на користь *Lightning Network* (докладніше в 4.8), а капітан і його команда аналізують події, думають над поліпшенням своєї стратегії та розглядають варіанти застосування квантового комп'ютера.

**Поширені міфи**

*Створення блока в Bitcoin завжди займає 10 хвилин.*

На практиці блок може бути створений за долю секунди, а може бути створений і за півтори години. Час створення наступного блока практично непередбачуваний. Але є алгоритм, який адаптує складність так, щоб блоки з’являлися в середньому що 10 хвилин. Для бізнесу, звичайно, це не завжди добре, тому що складно визначити, коли платіж можна вважати прийнятим.

*Якщо хтось контролює більшість майнінгової потужності, то він може порушити правила протоколу.*

Насправді найбільша шкода, якої може завдати володілець більшості потужностей, – це успішна спроба подвійного витрачання своїх монет, а також фільтрування або блокування чужих транзакцій під час підтвердження. Важливо врахувати, що це можливо тільки в той період часу, поки він містить відповідне обладнання. Вкрасти монети або здійснити довільну емісію він не може, отже, Bitcoin не зламається, а може просто відмовити в обслуговуванні на деякий час.

**Часті питання**

*– Яку мінімальну кількість підтверджень повинна отримати транзакція, щоб вона вважалася доданою до ланцюжка блоків?*

Одне, але щоб вона вважалася повністю підтвердженою буває і більше (за замовчуванням це шість підтверджень). Деякі сервіси приймають платежі з двома або трьома підтвердженнями. А взагалі це кількість залежить від суми платежу і може навіть перевищувати 100.

*– Яка ймовірність того, що правильно сформована транзакція при відправці у мережу буде підтверджена?*

Якщо процес формування нових блоків дійсно децентралізований (не піддається цензурі), а також транзакція містить достатню комісію, імовірність її підтвердження наближається до одиниці.

*– Чи варто налаштовувати повний вузол і в яких випадках це потрібно?*

Повний вузол протоколу Bitcoin потрібен у тому випадку, якщо ви хочете бачити актуальну версію бази даних, а також приймати і відправляти платежі. Для того щоб працювати з Bitcoin, вам у будь-якому випадку потрібна актуальна версія бази даних, а її може побачити тільки повний вузол. Усі легкі клієнти, веб-гаманці, мобільні гаманці, що не викачують увесь ланцюжок блоків, використовують довірені вузли для отримання актуальних даних. Інакше кажучи, вузол, який запущений якимось сервісом, сам відстежує актуальний стан всіх транзакцій і поточного розподілу монет, а через нього легкі клієнти отримують цей стан, щоб здійснювати свої платежі. Але в цьому випадку виникає питання довіри відвідування таких сайтів, цих сервісів, а в певних випадках це не прийнято. Тому найкраще запускати повний вузол і бути впевненим, що саме ваш софт працює правильно: ви провели його аудит, самі його оновлюєте, а також не залежите від сторонніх сервісів.

*– Що таке форк? Які різновиди форків бувають?*

Під словом форк люди можуть розуміти дві речі: розгалуження ланцюжка блоків і клонування вихідного коду. В контексті блокчейна форки бувають випадковими і навмисними (спланованими). А форки вихідного коду роблять для внесення деяких змін до протоколу з метою їх тестування або для розвитку окремого проекту. При цьому форк не варто плутати з поняттями *softfork* і *hardfork*: це типи оновлення протоколу (докладніше в 6.1).

*– Хто в системі приймає рішення щодо підвищення і зниження складності*

Ніхто, це визначається однаковими правилами, закладеними у програмному забезпеченні кожного вузла мережі. Кожен учасник оновлює параметр складності для себе відповідно до цих правил. В результаті цей параметр буде однаковим для всіх, а центр прийняття рішень не потрібен. В цьому і полягає найважливіший принцип роботи децентралізованих облікових систем.

*– Якщо спочатку в системі закладено 1 годину на підтвердження транзакції, яким чином планується використовувати Bitcoin як засіб платежу?*

Насправді 1 година  –  це рекомендація, якої дотримуються за замовчуванням. Якщо заглибитися в деталі, то виявиться, що час очікування до ухвалення платежу визначає сам одержувач. Причому чим більше сума угоди, тим довше одержувач зацікавлений чекати. За грубою оцінкою, для прийняття платежу на суму 1 USD досить одного підтвердження транзакції, а на суму 1 000 000 USD  –  16 підтверджень (докладніше в 4.2). Крім того, відомі методики здійснення платежів через так звані *платіжні канали*, де платежі підтверджуються набагато швидше, ніж звичайні транзакції (*on-chain*), а час підтвердження не залежить від суми платежу і встановленої комісії (докладніше в 4.8).

[КРИПТОГРАФІЯ Й КЕРУВАННЯ КЛЮЧАМИ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-1/ua/3-cryptography-and-keys-management.md)