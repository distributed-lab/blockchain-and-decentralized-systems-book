# 2 ИСТОРИЯ И ПРИНЦИПЫ РАБОТЫ BITCOIN


## 2.1 Что такое Bitcoin?

Можно сказать, что Bitcoin – это протокол, который реализует независимую валюту и платежную систему. Другие электронные деньги или платежные системы, например WebMoney, PayPal, – это платежные системы, оперирующие уже существующими валютами: долларом, евро, фунтом и т. д. Bitcoin же является и отдельной валютой, и платежной системой, которая управляет этой валютой. Отметим, что это независимая платежная система, то есть нет организации, которая бы контролировала ее работу.

> **_Замечание._** *Далее мы будем использовать слово Биткоин (Bitcoin), когда речь идет об учетной системе или протоколе, а слово биткоин (bitcoin), если подразумеваем валюту или соответствующие монеты.*

В попытках понять, что такое Bitcoin, люди нередко обращаются к Википедии, где написано, что это одноранговая платежная система, которая использует собственные монеты, как единицы учета ценности, а для обеспечения функционирования и защиты системы используются криптографические методы. Для человека, не искушенного в вопросах платежных систем, такое определение может оказаться сложным и не весьма понятным, особенно если он слышит о Bitcoin впервые. Придется подобрать более понятные слова. Наилучшей из аналогий, которые встречаются в публикациях на эту тему, является аналогия с цифровым золотом (рис. 2.1).

![Рисунок 2.1 – Bitcoin – цифровой аналог золота](/resources/img/volume-1/2.1-what-is-bitcoin/2.1-gold.png)

Можно предположить, что создатель Bitcoin действительно попытался воспроизвести все свойства золота, такие как ограниченное количество, сложность добычи, независимость от одной организации, невозможность его искусственно воспроизвести. Тот факт, что Bitcoin четко воспроизводит перечисленные свойства в цифровом виде, можно считать большим прорывом в компьютерных науках.

Используя Bitcoin, можно отправить платеж кому угодно и куда угодно. Для этого нужен доступ к Сети, цифровой кошелек и адрес получателя. Многие ограничения, характерные для обычного международного перевода (особенности правового поля отдельной страны, время подтверждения и т. д.), просто отсутствуют. Никаких разрешений для осуществления платежа не требуется.

Поэтому Bitcoin заинтересовал людей, которые поддерживали анархизм, либеральные идеи, полную приватность и т. п. Именно в этих кругах Биткоин и получил известность изначально. Позже к ним присоединились компьютерные энтузиасты (шифропанки, хакеры), а также ученые, для которых Bitcoin стал объектом для исследований и проведения интересных экспериментов. Как только цена биткоина достигла отметки, когда стала заметной, он начал привлекать внимание предпринимателей и спекулянтов, которые пытались заработать на колебании курса. Для обычного человека интерес представляет отсутствие необходимости регистрироваться и возможность совершать платежи без привлечения третьих сторон.

Если рассматривать такие платежные системы, как PayPal или WebMoney, то они управляются конкретными компаниями, куда можно прийти с обысками, забрать серверы и заблокировать счета. В случае Bitcoin не существует никакого ООО «Биткоин», которое осуществляет учет монет или подтверждает транзакции. Это значит, что транзакции не подвержены цензурированию. Это свойство является очень важным и позже мы обсудим, каким образом оно достигается.

### История возникновения Bitcoin

Мы не знаем, кто впервые предложил данную технологию и назвал ее Bitcoin. Официально известно, что это был кто-то под псевдонимом Сатоши Накамото. Возможно, этот некто – один человек, но есть предположения, что за псевдонимом может стоять группа людей. Сатоши зарегистрировал домен bitcoin.org в 2008 году, выпустил первую статью, опубликовал начальную версию исходного кода протокола. До 2011 года от псевдонима Satoshi Nakamoto на соответствующих форумах и в email-рассылках появлялись сообщения. Позже он написал, что решил заняться другими делами и прекратил публичные коммуникации.

Тем не менее, стоит признать, что идея создания Bitcoin возникла у Сатоши Накамото вовсе не на ровном месте. В своей статье «Bitcoin: A Peer-to-Peer Electronic Cash System» [15] (рис. 2.2) он упомянул два других ключевых проекта. Это были предшествующие попытки создать независимую цифровую валюту: HashCash доктора Адама Бэка (Adam Back) [16] и B-Money инженера Вэй Дая (Wei Dai) [17]. В первом появился подход proof-of-work, изначально созданный для борьбы со спамом в электронных письмах, а во втором – модель сети для распределенного хранения данных о транзакциях и использование криптографических подписей для отправки денег. 

![Рисунок 2.2 – Фрагмент первой публикации о Bitcoin](/resources/img/volume-1/2.1-what-is-bitcoin/2.2-bitcoin-wp.png)

Таким образом, Сатоши задействовал уже существующие концепции для реализации Bitcoin, сумев решить оставшиеся проблемы ранних попыток, чего не удалось сделать их создателям. Полагаем, что мало найдется людей, которые способны были бы разглядеть в вышеупомянутых провальных проектах своего рода эмбрион независимой цифровой валюты.

> **Предпосылки к созданию Bitcoin**
>> * *David Chaum—DigiCash [18] (1989*)
>> * *Adam Back—HashCash (1997)*
>> * *Nick Szabo—BitGold [19] (1998)*
>> * *Wei Dai—B-Money (1998)*
>> * *Hal Finney—RPoW as e-money [20] (2004)*

Однако нужно понимать, что Биткоин – это первая *успешная* реализация децентрализованной системы учета. До него были и другие попытки, например, компания DigiCash, которую основал David Chaum в 1989 году, одной из самых первых предложила цифровые платежи со специальной валютой, которая называлась Ecash. Пользователи платежной системы были анонимны и банки не могли отслеживать их счета. Проект поддержали только несколько инновационных банков в США и один в Финляндии, но поскольку было очень сложно убедить остальные банки и торговые сети принимать анонимную валюту, проект был свернут.

> **Ключевые даты**
>> * *Публикация Bitcoin whitepaper – 31 октября 2008*
>> * *Создание генезис-блока – 3 января 2009*
>> * *Первый обмен биткоинов – февраль 2010*
>> * *Принятие P2SH – 5 января 2012*
>> * *Форк Bitcoin Cash – 1 августа 2017*
>> * *Принятие Segregated Witness – 24 августа 2017*
>> * *Запуск Lightning Network – 15 марта 2018*

Одним из первых шагов в развитии Bitcoin была публикация Bitcoin White Paper 31 октября 2008 года. Исходный код был впервые опубликован 3 января 2009 года. Тогда же был создан и первый блок (генезис-блок) – в Bitcoin появились первые 50 монет. Собственно, этот день можно считать датой запуска системы. В феврале 2010 года состоялся первый обмен биткоина на деньги.

Форк Bitcoin Cash, состоявшийся 1 августа 2017 года, стал первым ответвлением от основной системы (детальнее в 6.1). Другое важное обновление – Segregated Witness – было внедрено 24 августа 2017 года. С его помощью удалось реализовать ряд улучшений протокола (отделить доказательство владения монетами от бизнес-логики транзакции, детальнее в 4.6), которые открыли ранее не доступные возможности. А 15 марта 2018 года мир увидел надстройку над протоколом Bitcoin для осуществления мгновенных платежей – Lightning Network.

> **Статистика по сети Bitcoin на момент 2018 года**
>> * *Около 10 миллионов уникальных пользователей*
>> * *В среднем 300 тысяч платежей в сутки*
>> * *Суточный объем торгов – 15 миллиардов долларов*

По состоянию на 2018 год по всему миру Биткоин используют миллионы людей, а сотни тысяч компаний принимают биткоины в качестве платежного средства. На базе Bitcoin разрабатывается множество проектов. Некоторые страны, в частности Япония, признали его законным средством платежа.

### Проблемы, которые способен решить Bitcoin

Прежде всего, Bitcoin стал популярным по причине того, что он реализует децентрализованную учетную систему, то есть работает независимо от регуляции, которая действует в разных странах, не подвержен инфляции в обывательском смысле слова, не позволяет отменять транзакции и опирается только на математику, а не на прихоти людей. Кроме того, платежи в bitcoin могут помочь повысить уровень приватности пользователей по сравнению с цифровыми валютами, которые существовали до него.

> * *Финансовый инструмент, который работает без ограничений*
> * *Нет обязательной регистрации пользователей*
> * *Bitcoin можно использовать анонимно*
> * *Устойчивый к цензуре*

Конечно, эти свойства привлекают потребителя. Например, для бизнеса они выступают гарантом того, что если покупатель отказался от товара, то он не может автоматически требовать возврата денег. Подобная проблема стала основной для PayPal, когда происходило блокирование счетов бизнесов с сообщением «На вас подана жалоба», а десятки тысяч долларов могли быть заблокированы на полгода – бизнес полностью останавливался. В Bitcoin это невозможно. Именно поэтому он стал привлекательным для бизнеса.

Непрозрачность существующей финансовой системы стала еще одним аргументом в пользу Bitcoin. Из истории известны случаи, когда правительства совершали эмиссию без веских оснований для этого, что впоследствии приводило к гиперинфляции и падению уровня жизни населения. Так произошло в 1990-х годах на территории постсоветского пространства – личные финансы граждан подверглись обесцениванию по причинам, которые не были им подвластны. Такие события вполне объясняют, почему люди хотят независимо управлять своими финансами.

Собственно, первый блок транзакций, который появился, наряду с вознаграждением включал в себя ссылки на новости о печати большого количества наличных денег как попытке уладить кризис 2008 года [21]. Платежные системы, а именно проблемы их функционирования, вызвали недовольство пользователей. Так появилась теория «всемирного заговора», сторонники которой утверждают, что банки могут делать с деньгами клиентов все, что угодно (в некоторых странах так и происходит). На практике все выглядит «приличнее»: банк принимает от клиента фиатные деньги, взамен выдает обязательство вернуть их по требованию клиента, а чуть позже банк отказывается от своих обязательств. Суть проблемы в том, что для клиента задача доказать такой отказ и вернуть деньги представляет большую сложность.

> **Проблемы существующих платежных систем**
>> * *Пользователь не контролирует свой баланс*
>> * *Средства могут быть зачислены на счет получателя через несколько дней, а иногда несколько десятков дней после их отправки*
>> * *Платежи могут быть отменены в процессе выполнения*
>> * *Средства могут быть заблокированы*

Как следствие, возникла потребность реализовать систему, в которой люди смогут независимо и полностью самостоятельно управлять своими деньгами. Несмотря на то, что данная задача оказалась очень сложной, с течением времени это желание только усиливалось. Решением стал Bitcoin. Естественно, внимание со стороны общества не заставило себя долго ждать.

### Главные принципы функционирования Bitcoin

Если постараться кратко сформулировать основной принцип функционирования Bitcoin, то он будет звучать следующим образом: *каждый пользователь запускает свое программное обеспечение, которое реализует общий для всех набор правил, и, в результате, пользователи совместно поддерживают децентрализованную учетную систему*.

> * *Каждый пользователь может локально хранить свою версию базы данных*
> * *Пользователи сами обрабатывают транзакции*
> * *Пользователи придерживаются одних и тех же правил*
> * *Пользователи доверяют только тому, что могут проверить сами*

Подключение и отключение участников происходит независимо и не влияет на работу других участников сети. Все хранят и обновляют базу и соответствующее программное обеспечение независимо, все правила работы известны каждому, и все пользователи имеют возможность перепроверить друг друга. Сеть пользователей Bitcoin схематически изображена на рис. 2.3.

![Рисунок 2.3 – Схема сети пользователей Bitcoin](/resources/img/volume-1/2.1-what-is-bitcoin/2.3-network-of-users.png)

Пользователь может самостоятельно обрабатывать любые транзакции в сети. При помощи ПО он может подтвердить транзакцию, которую считает верной. В результате, у каждого из пользователей есть набор транзакций, которые он верифицировал и определил как правильные. На основании этого каждый узел сети формирует совместную базу данных, состоящую из транзакций, с которыми согласилось большинство пользователей. Как только очередная транзакция попадает в эту базу данных, она считается подтвержденной.

### Эмиссия в Bitcoin

*Эмиссия* в приложении к деньгам – *это выпуск в обращение наличных или безналичных денег*. В Bitcoin это не совсем та эмиссия, которая присутствует в традиционных финансовых системах. Здесь эмиссия представляет собой выпуск монет по определенному алгоритму. Основной принцип состоит в том, что весь процесс полностью децентрализован и основан на математических алгоритмах. Таким образом достигается абсолютная прозрачность при распределении монет.

> * *Процесс эмиссии децентрализован*
> * *Правила эмиссии контролируются математически*
> * *Эмиссию выполняют сами пользователи*
> * *Новые монеты распределяются среди активных участнико*

По правилам протокола, эмиссию может выполнять любой из пользователей, а все участники сети проверяют соблюдение этих правил. Если коротко, то новые биткоины может получить любой пользователь, который активно участвует в поддержании учетной системы. Их называют *валидаторами*. То есть в системе может быть множество участников и каждый из них может получить новые монеты.

> **Правила эмиссии биткоинов**
>> * *В среднем каждые 10 минут появляются новые монеты*
>> * *Каждые 4 года количество новых монет уменьшается вдвое*
>> * *Всего будет эмитировано 20 999 999,9769 ВТС*

Эмиссия монет определена правилами, которые заложены в программном обеспечении узлов сети. Сатоши установил, что в среднем каждые 10 минут появляются новые биткоины. Сначала это было 50 монет. Количество новых монет сокращается вдвое примерно каждые 4 года. На момент 2019 года прошло более 10 лет от даты запуска Bitcoin – и темп эмиссии монет значительно уменьшился.

В Bitcoin запрограммировано максимальное количество монет – около 21 миллиона. Почему 21 миллион? Этого никто не знает, так решил Сатоши, но это, на самом деле, не важно. Тем более, что каждый bitcoin делится на 100 000 000 частей; наименьшая единица называется сатоши (по псевдониму разработчика протокола). Вам необязательно иметь целую монету: вы можете владеть ее частью.

***1 BTC = 100,000,000 satoshis***

Согласно расчетам количество 21 000 000 монет будет достигнуто примерно в 2140 году, то есть ближе к середине следующего века. Если точнее, то даже меньше 21 млн BTC, а именно 2 099 999 997 690 000 сатоши.

Теперь посмотрим, как количество выпускаемых монет изменяется со временем. На рис. 2.4 представлен график изменения количества монет в обращении в течение определенного времени. Мы видим, что он напоминает логарифмическую кривую. По состоянию на 2018 год, количество добытых монет превысило 17 млн ВТС.

![Рисунок 2.4 – График изменения количества эмитированных bitcoin-монет с течением времени](/resources/img/volume-1/2.1-what-is-bitcoin/2.4-graph-of-issuance.png)

> **_Замечание._** *Bitcoin – это дефицитный (scarce) цифровой актив: 17 млн монет было добыто за менее чем 10 лет, а добыча оставшихся 4 млн займет более 120 лет. *

> **Свойства bitcoin-монет**
>> * *Ограниченное количество*
>> * *Необходимость добывать*
>> * *Дискретность (делимость монет)*
>> * *Независимость*
>> * *Невозможность скопировать*

Биткоин позволяет платить кому угодно сколько угодно за что угодно в любую точку мира. Кроме того, биткоин как валюта обладает рядом свойств, которые делают его пригодным для хранения личных сбережений и открывают перспективу для становления его как платежного средства.

### Формирование цены на монеты

Полагаем, что основная причина, по которой многие активно интересуются криптовалютами, – это рост их цены. И первый вопрос: «Как она вообще формируется?». Цена bitcoin определяется строго по закону спроса и предложения. Нет человека, который принимает решение: «Сегодня цена bitcoin будет такая, а завтра – другая». Конечно, на рынке присутствуют и манипуляции, однако они не могут кардинально повлиять на цену монеты.

По большей части цена формируется на бирже. Именно биржи позволяют людям достаточно просто заявить о желании купить или продать монеты. В мире действует огромное количество торговых площадок. На каждой из них цена биткоина может быть разной, потому что она определяется соотношением спроса и предложения, которое создают пользователи конкретной площадки (рис. 2.5).

![Рисунок 2.5 – Соотношение спроса и предложения на bitcoin-монеты](/resources/img/volume-1/2.1-what-is-bitcoin/2.5-demand-and-supply.png)

На рис. 2.6 приведен график стоимости одного биткоина (1 ВТС) с даты запуска Bitcoin, а именно с 2009 года по 2018 год [22].

![Рисунок 2.6 – График изменения стоимости bitcoin с течением времени](/resources/img/volume-1/2.1-what-is-bitcoin/2.6-value-change.png)

На момент появления Биткоина цена биткоина вообще не была определена. Позже люди начали осуществлять первые операции обмена биткоинов на монеты других валют в некотором соотношении, при этом не используя автоматические биржи и специализированные площадки. А первая покупка реального товара (двух коробок с пиццей) за биткоины была осуществлена только в 2010 году [23] при курсе несколько центов за монету. Затем курс начал расти и в 2011 году достиг своего локального пика в 33 USD, но после снова снизился до 2 USD. Рекордная цена в 2013 году пришлась на отметку 1100 USD. После очередного снижения до 200 USD, она была сравнительно стабильной весь 2015 год, а потом стала плавно расти. В 2017 году начался период экспоненциального увеличения цены, и она достигала 20 000 USD.

Касательно формирования цены справедливо будет заметить, что монеты, доступ к которым утерян или которые не используются по каким-то причинам, могут играть значительную роль в общей картине. Например, тот факт, что на момент ноября 2018 года уже оказалось заблокированным около 3–4 миллионов биткоинов в результате потери ключей, является очень весомым в формировании цены на биткоин [24]. Также известно, что Сатоши обладает примерно миллионом биткоинов, которые он никогда не тратил. Если сейчас появилось бы доказательство того, что ключи он уничтожил и соответствующие монеты вышли из оборота, то цена биткоина могла бы значительно измениться.

Мы не можем с уверенностью утверждать, заблокировал ли Сатоши возможность траты своих биткоинов. Если у него остались ключи, то он может их использовать, а если ключи утеряны, то они могут быть найдены и применены кем-либо другим. Однако доказать это или опровергнуть может только он сам. Грубо говоря, он может появиться завтра и сказать, что отныне он будет управлять курсом биткоина, причем по принципам, которые используют центральные банки для управления курсами фиатных валют.

Что примечательно, в некоторых ситуациях цена биткоина несущественна. Если пользователю необходимо совершить денежный перевод из Украины в Китай, он может использовать Bitcoin как промежуточный «слой»: купить биткоинов в Харькове за гривни, а продать – в Шанхае за юани. Тут неважно, стоит ли 1 BTC 200 USD или же 10 000 USD.

> **_Замечание._** *Не всегда целесообразно использовать биткоины в качестве платежного/расчетного средства для реального бизнеса (в основном из-за волатильности его цены). Однако использование Bitcoin может принести свои плоды в контексте международных транзакций.*

Преимущество Bitcoin заключается в необратимости платежей и возможности «запрограммировать» поведение. Подобные свойства имеют решающее значение, когда покупатели не доверяют продавцам. В качестве примера представим онлайн-аукцион: продавец не хочет отправлять товар до того, как его оплатит покупатель, а покупатель, в свою очередь, не хочет платить до тех пор, пока товар не прибудет к нему.

Простое решение подобной ситуации может состоять в том, что вместо оплаты полной стоимости банковской картой, покупатель делает частичную предоплату в биткоинах (которая является мгновенной и поддерживающей trustless депонирование), а затем отправляет оставшуюся сумму с помощью банковского перевода. Получив предоплату в биткоинах (как вариант, она может покрывать расходы по доставке), продавец отправляет товар. После того, как товар прибывает и покупатель совершает банковский перевод, продавец возвращает предоплату.

В примере выше ни цена, ни волатильность биткоина не важна. В конечном счете, если вы представите мир, в котором множество криптовалют предоставляет одинаковый уровень *устойчивости к цензурированию* и *необратимости транзакций*, то цена таких валют не сильно важна для людей, которые их используют.

> **_Замечание._** *Устойчивость к цензуре – свойство истинной децентрализации, и именно оно создает реальный спрос у общества на bitcoin как актив.*
> 
> *Достаточно просто скопировать исходный код Bitcoin, чтобы создать другую криптовалюту, в которой эмиссия будет также ограничена и которая даже сможет обеспечивать больший уровень анонимности пользователей. Тем не менее, такой актив не обязательно будет таким же ценным, как Bitcoin, потому что уровень устойчивости к цензуре намного важнее, чем количество монет или какая-то другая функциональность.*

### Концепция доверия в Bitcoin

Ключевая особенность Bitcoin – trustless взаимодействие всех пользователей системы. Подобный подход позволяет проверять, что конечное состояние учетной системы было достигнуто без нарушения правил протокола, и при этом полностью исключить доверие между участниками системы.

*Доверие только* к *математике* – одна из ключевых особенностей криптовалюты. В этой книге мы повторим это утверждение еще не один раз. Впрочем, оно не исчерпывающее, и на практике все несколько сложнее. 

Касательно взаимодействия конкретного пользователя с сетью Bitcoin следует учитывать ряд аспектов, из-за которых пользователь вынужден кому-то доверять. Например, если вы верите, что баланс вашего bitcoin-кошелька правильный, это значит, что вы доверяете:
* Тем, кто советовал установить этот конкретный кошелек (друзья, интернет-форумы и т. д.)
* Что кошелек, который вы используете, разработан и реализован корректно 
* Что ваша операционная система не взломана 
* Что аппаратное обеспечение вашего компьютера не взломано 
* Что ваш кошелек подключен к честному Bitcoin узлу (не к узлу злоумышленника)
* Что реализация криптографической библиотеки не имеет скрытых уязвимостей 
* Что конкретный криптографический алгоритм не содержит ошибо

Все вышеперечисленное (на самом деле возможных угроз гораздо больше) вовсе не мнимое. За каждым из пунктов стоит реальная ситуация, которая уже случилась с кем-то. Это показывает, что понятия *абсолютная безопасность* и *полная trustlessness* в системе являются лишь теоретическими. Децентрализованный подход позволяет лишь уменьшить вероятность компрометации системы. В контексте системы Bitcoin это значит, что каждый пользователь может самостоятельно и независимо проверить корректность любой транзакции или блока – ему не приходится доверять данным, которые предоставляет третья сторона.

### Ограничения технологии Bitcoin

Наряду с несомненными преимуществами Bitcoin также имеет ограничения по сравнению с централизованно управляемыми цифровыми валютами.

> * *Ограниченная пропускная способность*
> * *Высокие затраты на поддержание системы*
> * *Длительное подтверждение транзакций*
> * *Общедоступность данных транзакций*
> * *Комиссии за платежи и их волатильность*

В следующих подразделах эти ограничения будут рассмотрены детально и будут описаны решения для каждого из них (см. 4.6–4.8).

> **_Замечание._** *Вышеупомянутые ограничения вовсе не делают Bitcoin неполноценным. Они являются следствием **компромисса** между свойствами, такими как эффективность, безопасность и устойчивость к цензуре. По этой же причине не очень корректно сравнивать пропускную способность цифровых валют, которые используют различные модели безопасности (Ethereum и Ripple).*

### Значение децентрализации для Bitcoin

Итак, теперь вы имеете представление о децентрализации как понятии, а также о некоторых ключевых аспектах работы с Bitcoin. Поэтому, прежде чем перейти к дальнейшим разделам, мы хотели бы повторить некоторые специфические свойства Bitcoin. Точнее, вспомнить, что подразумевается, когда Bitcoin называют децентрализованной системой. Это значит, что в системе нет конкретной стороны, которая полностью отвечает за определенный процесс.

> **Отсутствует сторона/организация, которая**
>> * *Ответственна за функционирование Bitcoin*
>> * *Отвечает за управление системой*
>> * *Собирает комиссию*
>> * *Обрабатывает транзакции*
>> * *Единолично хранит историю транзакций*
>> * *Возвращает средства*
>> * *Исполняет судебные постановления*

**Часто задаваемые вопросы**

*– Хватит ли 21 млн монет для использования биткоинов массово?*

Кто-то может утверждать, что 21 млн монет недостаточно для большого количества пользователей. Но не стоит забывать, что каждая монета делится как минимум на сто миллионов частей, а при необходимости можно выпустить обновление и увеличить делимость (дискретность) монеты.

*– Можно ли «отключить» Bitcoin?*

Если подойти к ответу на вопрос теоретически, то такая вероятность существует. На практике работу Bitcoin поддерживают участники, оборудование которых размещено в разных точках мира. Для участия нужны вычислительная техника и доступ в Интернет. Следовательно, чтобы осуществить «отключение», было бы необходимо запретить использование вычислительной техники и каналов передачи данных. Более того, было бы необходимо еще и следить за соблюдением этого запрета. Для этого понадобились бы скоординированные и быстрые действия различных политических сил, в т. ч. противостоящих друг другу. А это осуществить крайне непросто.

*– Что делать, если я хочу внести изменения в протокол Bitcoin?*

Такое желание является довольно распространенным, поэтому существует общепринятый способ внесения предложений по улучшению протокола. Соответствующий репозиторий называется «Bitcoin Improvement Proposal» (BIP); в нем члены сообщества собирают и обсуждают такие предложения. Любой может добавить в репозиторий свое предложение, и если сообщество и валидаторы согласятся с обновлением, то они перейдут на новую версию протокола.

*– Зависит ли эмиссия монет от спроса на них?*

Такой зависимости нет. Здесь же стоит упомянуть, зависит ли рыночная цена монеты от сложности ее добычи: в общем случае – не зависит. Можно уверенно утверждать лишь то, что себестоимость одной монеты (цена ее добычи) вряд ли будет выше ее рыночной цены.

## 2.2 Как использовать Bitcoin?

В этом подразделе рассматриваются вопросы, которые касаются цифровых кошельков для работы с Bitcoin: их виды, эксплуатационные нюансы, особенности их реализаций, а также влияние этих особенностей на уровень безопасности.

> **Наиболее распространенные операции в кошельках**
>> * *Проверка баланса*
>> * *Генерация и хранение ключей пользователя*
>> * *Прием и отправка платежей*

Чтобы получить первое представление о цифровом кошельке, обратите внимание на рис. 2.7, где изображен снимок экрана одного из мобильных приложений, реализующих bitcoin-кошелек. На главном экране (слева на рисунке) можно увидеть текущий баланс, список транзакций, суммы и степень подтвержденности транзакций, а также можно переключиться на другие экраны для принятия и отправки платежей.

![Рисунок 2.7 – Пользовательский интерфейс одного из биткоин-кошельков](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.7-user-interface.png)

### Адреса в Bitcoin

Bitcoin-адрес – идентификатор получателя. Чтобы отправитель мог совершить перевод, ему нужно знать адрес назначения. Поэтому важно, чтобы получатель заранее предоставил свой адрес. Выглядит обычный bitcoin-адрес примерно следующим образом:

**1BooKnbm48Eabw3FdPgTSudt9u4YTWKBvf**

В некотором смысле bitcoin-адрес – это псевдоним пользователя, не привязанный ни к каким идентификационным данным, то есть он (адрес) сравнительно анонимен. Но этот факт еще не означает, что любые операции с биткоинами являются полностью конфиденциальными.

Важная особенность Bitcoin состоит в том, что пользователи самостоятельно формируют свои bitcoin-адреса (это касается и других криптовалют), запуская специальное ПО, которое генерирует новый адрес. Количество адресов, которые может создать один пользователь, неограниченное. Вы можете сгенерировать их хоть миллиард, причем на каждый сможете принимать монеты и затем тратить.

*Каждому адресу соответствует некоторое конфиденциальное значение, доступное только владельцу программы-кошелька, – личный ключ. Он используется для доказательства владения монетами в момент их отправки.*

Адрес можно математически вычислить из личного ключа, поэтому если кто-то завладеет вашим личным ключом, он сможет получить доступ к монетам, даже не зная адреса.

Одно из ключевых отличий криптовалюты от традиционной финансовой системы – то, что количество адресов практически неограниченно. Вы можете отправлять монеты на любой адрес, в то время как в банковской системе счета всегда закреплены за конкретной организацией и обязательно должны иметь владельца.

### Транзакции в Bitcoin

*Транзакция – это набор цифровых данных, который инициирует обновление базы данных (отправку биткоинов с одного адреса на другой)*. Это упрощенное определение; на самом деле структура транзакции более сложная (детально в 2.3). Отметим, что транзакцию формирует и отправляет непосредственно цифровой кошелек пользователя, так что даже разработчики цифровой валюты не могут повлиять на этот процесс. На рис. 2.8 изображены снимки экрана частей интерфейса мобильного кошелька [25], которые позволяют, соответственно, предоставить свои реквизиты или отправить платеж.

![Рисунок 2.8 – Отправление и получение монет с помощью мобильного кошелька](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.8-spend-and-receive.png)

> **Основные виды bitcoin-кошельков**
>> * *Программный кошелек*
>> * *Аппаратный кошелек*
>> * *Централизованное хранилище*

### Программные кошельки

Некоторые люди используют для хранения биткоинов программные кошельки, которые запускаются на смартфоне, ноутбуке или настольном компьютере. *Программный кошелек – это приложение, которое обрабатывает ключи и транзакции*. Оно соединяется с сетью Bitcoin через *доверенные узлы* или *централизованные сервисы* или само является узлом сети.

Отметим, что рекомендуется пользоваться только теми программными кошельками, к разработчикам которых у пользователя есть доверие. Подобная осторожность связана с тем, что разработчики могут заложить в программный код приложения уязвимость, с помощью которой они смогут заблокировать или украсть монеты. Также нужно учитывать, что разработчик может допустить ошибку в продукте, которой могут воспользоваться хакеры.

Ввиду этого рекомендуется использовать программные кошельки с открытым исходным кодом. Такое решение позволяет провести аудит программного кода кошелька и подготовить его к запуску на своем устройстве.

Однако разработчики ПО – не единственные, кому пользователь программного кошелька доверяет. Кроме них, пользователь доверяет сервисам распространения этого ПО (магазины приложений и т. п.), разработчикам операционной системы и разработчикам аппаратного обеспечения устройства пользователя, поскольку на каждом из этих этапов могут быть предусмотрены «лазейки».

### Аппаратные кошельки

Обратим особое внимание на аппаратные кошельки. Такой кошелек представляет собой компьютер с узким набором операций и ограниченным интерфейсом управления. Так сделано, чтобы максимально усложнить внедрение вредоносного ПО в устройство, а также чтобы сделать невозможным взлом как таковой. Как правило, к основным функциям кошелька относят генерацию личных ключей, хранение личных ключей и подпись транзакций.

В минимальном варианте такого кошелька нет никаких дополнительных интерфейсов; это просто компактное устройство. Чаще всего можно подключить его к обычному ПК и работать с ним через специальное ПО. В максимальном варианте аппаратного кошелька есть экран, клавиатура, аккумулятор, сканер отпечатка пальца и модули беспроводного соединения (рис. 2.9). В некоторых случаях даже есть камера для сканирования адреса получателя. Такие кошельки минимизируют риск кражи личных ключей, но не защищают владельца от их потери. Поэтому многие аппаратные кошельки предусматривают резервное копирование личных ключей.

![Рисунок 2.9 – Примеры аппаратных кошельков](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.9-hardware-wallets.png)

Однажды произошел интересный случай: один человек купил на eBay у незнакомого продавца бывший в употреблении аппаратный кошелек производителя Ledger [26]. В коробке с кошельком находился лист бумаги (рис. 2.10) с записанной *мнемонической фразой* с пометкой: «Используйте эту фразу, чтобы восстановить ваш кошелек». Новый владелец устройства, недолго думая, ввел предлагаемые слова, а через несколько дней оказалось, что все его биткоины пропали. Как это случилось? Продавец кошелька знал эту мнемоническую фразу изначально. Следовательно, он мог получить доступ к адресам, которые использовал новый владелец кошелька. Получилось, что продавец сказал: «Положи деньги в сейф, ключ от которого есть и у меня». Таким образом, покупатель устройства безвозвратно потерял все монеты. Безусловно, ошибку допустил тот, кто купил устройство и не сгенерировал новые ключи.

![Рисунок 2.10 – Мнемоническая фраза для восстановления конкретного кошелька](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.10-mnemonic.png)

В теории можно представить случай, когда личный ключ одного пользователя совпал с личным ключом другого. Но на практике это крайне маловероятно. Это объясняется тем, что пространство возможных личных ключей составляет 2<sup>256</sup>, а это число больше, чем количество атомов во вселенной. Поэтому для мнемонической фразы с длиной 24 слова вероятность совпадения будет стремиться к нулю.

> **_Замечание._** *Если генератор последовательности чисел для нового личного ключа инициализируется тривиальными данными, например паролем пользователя или текущим временем, то вероятность совпадения таких ключей увеличивается.*

### Централизованные хранилища

Существуют онлайн-сервисы, которые реализуют базовые функции цифровых кошельков, но хранят личные ключи централизованно на собственных серверах. У их пользователей возникает ложное чувство, что у них есть bitcoin-кошелек, тогда как на самом деле именно удаленный сервис совершает операции и хранит монеты вместо пользователя. Очевидно, что, используя такие сервисы, пользователь вообще не контролирует свои монеты и должен полностью доверять сторонней организации.

Один из крупнейших сервисов централизованного хранения – это компания Coinbase. Она – фактическое подобие bitcoin-банка, то есть пользователь регистрируется в этом сервисе, как в PayPal (при помощи логина–пароля). После этого ему выдают адрес для депонирования биткоинов и приложение для удаленного управления своими монетами, при этом сам пользователь владеет лишь обязательствами этой компании. При использовании централизованных хранилищ ваши возможности по управлению своими средствами ограничены: вы можете только отправить запрос на вывод биткоинов, а дальше только надеяться, что его обработают.

Основная часть бирж хранит цифровые монеты пользователей по принципу централизованного хранилища, следовательно, требуют максимального уровня доверия от своих пользователей.

### Резервное копирование кошельков

Поскольку личный ключ – единственная возможность доказать всем владение монетами и потратить их, *владелец монет определяется знанием личного ключа*. Любой bitcoin-кошелек реализует следующие функции: формирование адресов для получения монет, отображение балансов и истории транзакций, отправку платежей, создание *резервной копии* кошелька и восстановление кошелька из резервной копии.

Известен интересный случай из жизни одного человека по имени Джеймс. У него был жесткий диск, на котором хранились ключи с доступом к 7500 BTC. Однажды он его выбросил на свалку, поскольку на тот момент курс биткоина был незначительным и эта сумма не представляла особой ценности. Когда цена монеты возросла, Джеймс, увидев, каких денег лишился, стал искать свой жесткий диск на свалке. Он даже обратился в муниципалитет, чтобы местные власти разрешили раскопать ему эту свалку, но ему отказали. Насколько известно, Джеймс долго перебирал разные возможности вернуть диск, но так и не смог этого сделать [27].

Акцентируем внимание на том, что делать резервную копию кошелька нужно еще до получения первого платежа. Для этой функциональности существуют техническая спецификация, поддерживаемая разными разработчиками цифровых кошельков. Зачастую резервная копия может быть восстановлена в кошельках от разных разработчиков.

Если у пользователя возникает вопрос, нужно ли делать резервную копию кошелька после каждого платежа, то ответ будет зависеть от реализации конкретного кошелька. Обычно кошелек генерирует новые адреса и соответствующие ключи для каждого платежа. Следовательно, каждый раз их нужно заново переносить в резервную копию. Но есть такие кошельки, которые используют так называемую детерминистическую генерацию ключей (*детерминистические кошельки*). В этом случае достаточно единоразового резервирования.

Для кошельков с детерминистической генерацией ключей существует понятие *основной секрет кошелька*. Из него математически порождаются все новые ключи. Это значит, что можно единожды сделать резервную копию основного секрета кошелька, а потом в любое время восстановить доступ к монетам на другом устройстве и/или в другом ПО. Для удобного представления основного секрета чаще всего используется специальное кодирование, которое позволяет преобразовать секрет в мнемоническую фразу.

Пример мнемонической фразы проиллюстрирован на рис. 2.11. На практике мнемоническую фразу удобно выписать на бумагу и хранить в надежном месте, а при необходимости ввести в другой кошелек. Также для надежного хранения ключей можно использовать программы под названием *менеджеры паролей* (*password managers*). Удобство таких программ состоит в том, что они позволяют пользователю не записывать всю мнемоническую фразу, а запомнить от 4 до 6 слов, которые понадобятся для того, чтобы открыть менеджер паролей и получить доступ ко всем своим личным ключам.

![Рисунок 2.11 – Пример мнемонической фразы](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.11-mnemonic-example.png)

**Распространенные мифы**

*Если вы храните личные ключи на своем устройстве, то у вас их невозможно украсть.*

Самый банальный способ кражи монет – это кража личных ключей при помощи программного вируса. Поэтому хранить большие суммы на незащищенных устройствах не рекомендуется.

*Если хранить личные ключи вне доступа к глобальной сети, об их безопасности можно не переживать.*

Такой подход действительно способен повысить безопасность хранения ключей и защитить от большинства удаленных атак. Но это не значит, что сохраненный таким образом личный ключ находится в безопасности.

*Квантовые компьютеры легко взломают систему шифрования в Bitcoin.*

На самом деле Биткоин не использует шифрование вообще. Он использует только цифровые подписи и хэш-функции, причем в такой комбинации, что они не уязвимы к атакам квантового компьютера (см. 3.2).

**Часто задаваемые вопросы**

*– Есть ли организации, которые разрешают споры относительно транзакций?*

С одной стороны, споры относительно транзакций решаются на уровне самого протокола Bitcoin. С другой стороны, могут возникать споры за пределами протокола в процессе его использования. Для их решения обычно используют так называемых escrow-агентов. Это значит, что во время совершения сделки монеты замораживаются между отправителем и получателем, а решение о распределении этих монет принимается при участии медиатора. Причем медиатору в этом случае должны одновременно доверять оба участника сделки.

*– Почему нельзя персонализировать кошелек, то есть привязать его к конкретной личности?*

Протокол Bitcoin не требует идентифицировать пользователя. Более того, это не является необходимым условием для проверки транзакций (для этого достаточно цифровой подписи). Кто может генерировать такие подписи, тот и является их владельцем. Следовательно, подписью может владеть человек, группа из нескольких человек, робот и т. д. Что касается персонализации, никаких идентификационных данных в базе данных Bitcoin нет, но вся история транзакций общедоступна. Это значит, что если вы сумеете связать конкретный адрес с конкретным лицом, то вы сможете деанонимизировать некоторых пользователей с определенной вероятностью.

*– Если еще несколько миллиардов пользователей заведут кошельки, замедлится ли Bitcoin?*

Если лишь завести кошелек и создать много адресов, то на сеть и базу данных это не повлияет. Играет роль поток транзакций, который зависит не от количества пользователей, а от их активности.

*- Возможно ли создать кошельки, которые работают без серверов и центра (однорангово)?*

Да, возможно. Однако в этом случае требования к мобильному устройству повышаются: объем интернет-трафика, долгое восстановление на другом устройстве, энергопотребление и память устройства.

## 2.3 Понятие транзакция в Bitcoin
В этом подразделе мы опишем некоторые основные концепции, которые так или иначе касаются понятия транзакция в Bitcoin: что такое биткоин-транзакция; как в распределенной базе данных она верифицируется; как пользователю доказать владение монетами, которые он пытается потратить; как определяются и задаются комиссии в Bitcoin; а также что такое конфликтующие транзакции.

### Что такое биткоин-транзакция?
Как мы ранее отмечали, *транзакция – это набор цифровых данных, посредством которого происходит обновление базы данных (отражает перевод монет с одного адреса на другой)*. Собственно, транзакция определяет как сумму перевода и адрес получателя, так и условия, необходимые для получения доступа к монетам, которые будут переведены.

> **Жизненный цикл транзакции**
>> * *Создание*
>> * *Распространение*
>> * *Верификация*
>> * *Включение в блок (валидация)*
>> * *Rejection (in case the block is invalidated later)*

Рассмотрим, какие данные входят в состав bitcoin-транзакции. Прежде всего, транзакция содержит данные о происхождении монет, которые тратятся (т. е. ссылки на транзакции, где эти монеты были получены), доказательства владения монетами, адреса новых владельцев (в более широком смысле – условия, по которым монеты могут быть потрачены) и суммы переводов.

> **Данные в теле транзакции**
>> * *Происхождение монет, которые тратятся*
>> * *Доказательство владения монетами*
>> * *Адрес для перевода (условия траты)*
>> * *Суммы переводов*

> **_Замечание._** *В наиболее простом случае адрес привязан к одной паре ключей (открытый ключ и личный ключ), которая используется для формирования и проверки цифровой подписи. Личный ключ используется для заверения транзакций. Важно отметить, что пространство всех возможных адресов огромно, а пространство возможных личных ключей еще больше. При корректной генерации угадать или подобрать личный ключ к чужому адресу практически невозможно. Важно не путать понятие адреса с понятием аккаунта, поскольку в рамках протокола Bitcoin аккаунтов не существует.*

Аналогия с обычной распиской поможет лучше понять, что такое bitcoin-транзакция. В некотором смысле самые простые деньги – это расписки. В каждой расписке есть данные: кто получил платеж, от кого получил, за что, сумма платежа, дата и подпись (рис 2.12).

![Рисунок 2.12 – Пример обычной расписки](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.12-traditional-receipt.png)

Однако транзакция должна удовлетворять определенным требованиям, чтобы ее можно было считать корректной. Во-первых, она должна переводить монеты, которые принадлежат отправителю. Во-вторых, эти монеты можно потратить только один раз (имеется в виду, что одни и те же монеты нельзя перевести сразу двум получателям, как и в случае с обычной банкнотой).

*Верификация – это процесс проверки данных (транзакций, блоков и т. п.) в соответствии с правилами протокола.* В процессе верификации для каждой транзакции проверяется доказательство того, что отправитель владеет монетами, которые тратит. Обычно автор транзакции доказывает владение монетами с помощью цифровой подписи. Также необходимо проверить, что транзакция тратит существующие монеты, один раз и впервые (как и было написано ранее, речь идет о случае, когда человек пытается потратить одни и те же монеты дважды).

Подлинность расписки на бумаге проверить несложно. А вот в цифровом виде расписка может быть скопирована множество раз и сложно установить, какая из них является оригинальной. Предположим, пользователь А выдал расписку пользователю Б. Если пользователь Б окажется мошенником, то логично предположить, что он придет с друзьями, у которых будет по такой же расписке, и каждый из них потребует деньги. Если бы каждая расписка имела силу оригинала, то пользователь А оказался бы в неловкой ситуации. В бумажном виде, естественно, копию отличить от оригинала достаточно легко, в электронном – нет. Поэтому необходимо решить эту и ей подобные проблемы.

В Bitcoin предусмотрено объединение транзакций в структурные единицы под названием блоки. Блок представляет собой единицу данных, которая состоит из заголовка и тела блока, которое представляет собой набор транзакций (обычно не пустой). Блоки связываются между собой при помощи хэш-значений и в таком виде хранятся в распределенной базе данных. Подобный подход позволяет обеспечить неизменность базы данных всех транзакций.

### Верификация транзакций

Известно, что бумажные чеки до сих пор распространены в США и люди получают ими заработную плату, оплачивают аренду, обналичивают их в банках и т. д. На рис. 2.13 показано, как выглядит подобный чек. На самом чеке можно видеть его серийный номер. Заметим, что у каждого чека он свой. Невозможно обналичить два чека с одинаковыми серийными номерами.

![Рисунок 2.13 – Пример бумажного чека](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.13-paper-check.png)

Как же Bitcoin решает проблему защиты от копирования своеобразных «расписок» – транзакций? В чековой книжке уникальным идентификатором служит порядковый номер чека. Но в *децентрализованной среде*, где функционирует Bitcoin, пронумеровать транзакции не представляется возможным, поскольку все участники работают асинхронно. Поэтому для отличия одной транзакции от другой вводится глобально уникальный идентификатор транзакции (*txid/wtxid*) – *хэш-значение*, рассчитанное от данных самой транзакции (подробнее см. пункт 3.1). Если встречается несколько транзакций с одинаковым хэш-значением, учитывается только одна. Но бывают и исключительные ситуации, которые будут описаны отдельно.

Интересная особенность Bitcoin состоит в том, что существует возможность в любой транзакции показать, откуда берутся монеты, то есть выполняется ссылка на предыдущую транзакцию с указанием ее хэш-значения (идентификатора). Таким образом, происходит проверка истории происхождения монет, которые передаются. На рис. 2.14 схематично изображено, как новая транзакция тратит монеты, которые были получены в прошлой транзакции.

![Основные этапы верификации транзакции](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.14-how-transactions-work.png)

> **Basic stages of transaction verification**
>> * *Проверка условия, что тратятся монеты, которые существуют в учетной системе*
>> * *Проверка условия, что конкретные монеты не тратятся дважды*
>> * *Проверка доказательств владения монетами, которые представил отправитель (инициатор транзакции)*

Работает это следующим образом. Чтобы потратить монеты, пользователь должен показать, где он их получил, и доказать, что именно он ими владеет. Если происхождение монет не вызывает дополнительных вопросов, отсутствует другая транзакция, которая тратит эти монеты, и пользователь действительно доказал, что он – владелец, то остается только дождаться подтверждения этой транзакции от остальных участников системы.

Процесс подтверждения транзакций подразумевает, что участники предварительно проверяют их, после чего совместно согласовывают, какие транзакции будут считаться правильными. Для подтверждения транзакция должна получить согласие *большинства активных участников* (см. 2.5). В процессе подтверждения транзакций в Bitcoin может принять участие любой желающий (рис. 2.15).

![Рисунок 2.15 – Схема взаимодействия узлов в сети Bitcoin](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.15-nodes-iteraction.png)

### Понятие комиссия в Bitcoin

Модель транзакций в Bitcoin предусматривает комиссионные сборы, которые оплачиваются биткоинами. Комиссию определяет сам отправитель в момент создания транзакции, и по умолчанию она должна быть выше определенного порогового значения. Хотя на практике пользователь может установить ее равной нулю и такая транзакция теоретически будет считаться правильной. Эту комиссию в качестве дополнительного вознаграждения получает один из участников, который подтверждает транзакцию (добавляет ее в свой блок).

С ростом популярности Bitcoin значительно увеличился поток новых транзакций в сети. При этом известно, что по протоколу размер блока строго ограничен. В Bitcoin максимальный базовый размер блока составляет 1 MB. Соответственно, бывают такие ситуации, когда поток новых транзакций превосходит пропускную способность Bitcoin. При этом каждый узел сети выстраивает все неподтвержденные транзакции в очередь таким образом, что сначала подтверждаются те транзакции, которые платят комиссию большего размера за единицу своего веса. *Цена записи данных* определяется как отношение установленной в транзакции комиссии к ее размеру в байтах (или ее весу в *weight units*; см. 4.6). Очевидно, что те транзакции, которые попадают в конец очереди, могут долго оставаться неподтвержденными. Это не всегда удобно, потому что формируется трудно предсказуемый рынок на цену записи единицы данных в базу Bitcoin (см. 4.7).

Принципы децентрализации, применяемые для установки комиссий в bitcoin-транзакциях, можно проиллюстрировать на следующем примере. Условно можно сравнить потенциально подтвержденный блок с политической партией, которая имеет шансы пройти в парламент. Места в проходной части партии достанутся тем депутатам, которые предложат самую большую «компенсацию». Очевидно, что депутаты будут «отсортированы» по размеру компенсации, и те, кто предложил меньше некоторого значения, даже не попадут в проходную часть списка. Скорее всего, им придется ждать следующих парламентских выборов и повторить попытку. Однако эта проблема может быть решена (см. 4.7).

> *Транзакция платит комиссию за единицу своего веса*
> *Максимальный базовый размер блока – 1 MB*
> *Валидаторы сортируют транзакции по убыванию цены записи данных*
> *Транзакции с низкой ценой записи данных могут остаться неподтвержденными надолго (или навсегда)*

### Понятие конфликтующие транзакции

Правильно сформированная цепочка блоков содержит транзакции, которые друг с другом не конфликтуют. Что такое конфликтующие транзакции? Если Кузьма в одной транзакции перевел 5 монет Степану, а в другой те же 5 монет отправил Леониду (с целью обмануть кого-то из получателей), очевидно, что в одну версию истории обе транзакции попасть не могут. Следовательно, полное подтверждение получит только одна из них. Вопрос остается открытым, кому достанутся 5 монет, – Степану или Леониду? До момента полного подтверждения однозначно на него ответить невозможно. Можно лишь сказать, что с большей вероятностью подтвердится именно та транзакция, которая раньше была распространена по сети, либо та, которая платит комиссию большего размера.

**Распространённые мифы**

*Исходный код протокола Bitcoin закрыт и вносить изменения могут только создатели.*

Как раз наоборот: существует даже несколько реализаций одного протокола на разных языках программирования. Исходный код этих реализаций открыт и доступен для изучения, модификации и т. д.

*Обычные инженеры и разработчики не могут предложить улучшение протокола Bitcoin или разработать свой кошелек.*

Кто угодно может предложить модификацию протокола и даже запрограммировать собственный клиент сети или приложение. Существующее Bitcoin-сообщество открыто для новых предложений и состоит, в первую очередь, из независимых энтузиастов. Но, как правило, наиболее опытные участники предлагают наиболее полезные модификации протокола. 

**Часто задаваемые вопросы**

*– Необходимо ли соединение с сетью Bitcoin для генерации нового адреса?*

Нет, для этого сетевое соединение не нужно. Генерация ключей для цифровой подписи и формирование адреса выполняется локально. Этот процесс никак не зависит от других пользователей.

*– Что случится, если ключи у двух разных пользователей совпадут?*

Следует понимать, что вероятность такого совпадения крайне мала, поэтому обычно ею пренебрегают. Но если из-за ошибки генерации или по каким-либо иным маловероятным причинам такое произойдет, то фактически оба пользователя будут видеть одну сумму на балансе и иметь доступ к одним и тем же монетам, каждую из которых сможет потратить только один из пользователей.

*– Кто устанавливает комиссию для транзакции?*

Размер комиссии определен в теле самой транзакции. То есть устанавливает ее тот, кто формирует и подписывает транзакцию. Но ее надо устанавливать выше необходимого минимума, который может меняться с течением времени.

*– Правда ли, что каким-то образом можно анализировать историю происхождения всех монет и нарушить конфиденциальность некоторых сделок в Bitcoin?*

Да, существует практика создания таких организаций, которые анализируют большое количество прямых и косвенных данных, касательно сделок с Bitcoin. И эти организации с некоторой вероятностью могут сказать, какие монеты кому принадлежат и с какой целью используются. В свою очередь сервисы, которые принимают биткоины, например централизованные биржи, могут обращаться к подобным организациям за информацией. Биржи, которые ценят свою репутацию, такие как Kraken, не принимают платеж, *если история происхождения монет* сомнительная (см. 4.1). Однако подходы к повышению уровня приватности существуют в самом Bitcoin. Также существуют криптовалюты Monero и Zcash, которые делают большой упор на приватность пользователей (см. 7.2).

## 2.4 Высокоуровневая архитектура Bitcoin

В этом подразделе мы познакомимся с устройством Bitcoin, особенностями организации совместной базы данных и коллективной обработки транзакций, опишем основные принципы достижения консенсуса в Bitcoin, а также сравним Bitcoin с традиционными платежными системами.

Во многом архитектура Bitcoin обусловлена необходимостью работать в крайне враждебной интернет-среде, которая является относительно анонимной, полна хакеров и в которой отсутствуют ответственные стороны, правоохранительные органы и какие-либо гарантии. Запуск Bitcoin доказал, что можно создать финансовую систему, которая имеет открытую базу данных и которую каждый пользователь может использовать без регистрации. Ee основные принципы следующие: копии базы данных хранятся всеми пользователями, пользователи следуют одинаковым правилам и доверяют только тому, что могут проверить сами. В этом и суть децентрализации в платежных системах.

### Архитектура Bitcoin

У каждого пользователя, который хранит локальную копию базы данных, она организована как цепочка строго упорядоченных наборов транзакций (блоков). Схематически такую организацию данных можно изобразить в виде цепочки блоков, в которой каждый блок – это группа транзакций (рис. 2.16). Сатоши назвал этот формат хранения данных *block chain*, а позже его стали называть *blockchain*.

![Рисунок 2.16 – Организация базы данных  в системах, которые используют технологию blockchain](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.16-blockchain-based-database.png)

С помощью технологии blockchain можно организовать базу данных таким образом, что все блоки связаны друг с другом (слева на рис. 2.16 изображен genesis block; детальнее он будет рассмотрен в 4.3). В результате невозможно изменить содержимое одного блока, не затронув при этом все последующие.

Кто же верифицирует транзакции и как они попадают в цепочку блоков? На самом деле, любой пользователь может создать корректную транзакцию, отправить ее в сеть, и она будет передана всем остальным участникам. После этого каждый валидатор независимо от остальных проверяет, корректна ли транзакция, и добавляет ее в свой блок для последующего подтверждения. Транзакция должна попасть в один из новых блоков, чтобы ее можно было считать подтвержденной. Над следующим блоком участники тоже трудятся параллельно и независимо друг от друга (рис. 2.17).

![Рисунок 2.17 – Работа участников системы над продолжением цепочки блоков](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.17-users-work-on-the-chain.png)

Кто формирует блоки и выбирает транзакции, которыми нужно их наполнять? На рис. 2.18 видно, что каждый блок создан некоторым активным участником и продлевает основную цепочку. Создатель предлагает свой блок остальным узлам сети, после чего они проверяют этот блок и добавляют в свою копию базы данных, если он соответствует правилам протокола. Если большинство участников добавляет предложенный блок, то он попадает в цепочку, а транзакции в нем считаются подтвержденными. Следует понимать, что добавляется в цепочку лишь один блок. Все остальные блоки, которые сгенерировали другие участники, но которые не попали в цепочку, отбрасываются. Транзакции, которые содержал отброшенный блок (*orphan block*), не подтверждаются и доступны для подтверждения в дальнейшем. Такой порядок действий необходим для достижения консенсуса в *децентрализованной среде*.

![Рисунок 2.18 – Формирование блоков участниками системы](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.18-how-users-create-block.png)

### Процессы в учетной системе Bitcoin

> *Аудит учетной системы*
> *Валидация транзакций*
> *Управление обновлениями*

*Аудит* представляет собой процесс, который подразумевает проверку факта, что текущее состояние базы данных учетной системы полностью соответствует проведенным транзакциям. Архитектура Bitcoin предоставляет возможность провести аудит истории транзакций любому пользователю.

*Валидация транзакций* (также известна как процесс формирования блоков или майнинг) представляет собой проверку транзакций на предмет соответствия правилам протокола и добавление их в блок, а впоследствии и в базу данных учетной системы.

*Управление обновлениями* подразумевает процесс, целью которого является утверждение функциональности учетной системы и, в идеальном случае, функционирование всех узлов по единым правилам протокола. Непосредственное управление обновлениями осуществляют валидаторы.

### Роли участников в учетной системе Bitcoin

Учетная система Bitcoin предоставляет возможность каждому участнику управлять вышеперечисленными процессами. Исходя из этого, каждый участник учетной системы может выполнять одну или несколько из следующих ролей.

> *Пользователь*
> *Аудитор*
> *Валидатор*
> *Разработчик*
> *Тестировщик*

Особенность Bitcoin состоит в том, что каждый участник системы самостоятельно (*permissionless* образом) решает, какую роль он будет исполнять.

### Условия, в которых достигается консенсус в Bitcoin

Как было обозначено выше, прежде чем внести какие-либо изменения в общее состояние цепочки блоков, участники должны прийти к единому решению. Если участники проверили блок на предмет корректности и все согласны добавить его в свою цепочку, то блок добавляется и на его основе начинают строить новый. Однако часто принять решение очень непросто, а именно эта задача часто является ключевой. Без ее решения надежная работа децентрализованной учетной системы невозможна. Поэтому одним из важнейших ее компонентов, которые должны быть реализованы, является механизм достижения консенсуса.

*Консенсус – это состояние согласия пользователей относительно транзакций, которые они считают правильными, выработанное в ходе обсуждения (обмена сообщениями о транзакциях, блоках, состоянии узлов).* Цель всех честных пользователей – достичь консенсуса. При этом очевидно, что пользователь не будет полагаться на то, что большинство участников являются честными. По этой причине протокол Bitcoin разработан таким образом, что консенсус в системе может быть достигнут даже в следующих условиях.

> *Количество узлов сети неизвестно*
> *Участники могут быть анонимными*
> *Валидаторы могут быть анонимными*
> *Участники системы не доверяют друг другу*
> *Нет единого центра управления*
> *Количество злоумышленных узлов неизвестно*

В идеальном случае все должны согласиться со списком подтверждаемых транзакций. Однако на практике во время согласования присутствует ряд сложностей. Как уже было упомянуто, Bitcoin спроектирован таким образом, чтобы обеспечить безопасность функционирования в крайне враждебной интернет-среде. Предполагается, что все участники анонимны, не доверяют друг другу, их количество вообще неизвестно и может быть очень большим. К тому же, голос каждого пользователя может быть легко подделан (если сравнивать с традиционным подходом к голосованию).

Непосредственно в сети работает компьютерная программа, за которой обычно стоит человек. Однако может оказаться, что за ПО под видом честного пользователя стоит бот злоумышленника. Более того, может случиться так, что за сотней или тысячей «пользователей» будет стоять всего один человек.

### Как достигается консенсус в Bitcoin?

Осознав всю сложность задачи по достижению консенсуса в среде, в которой нет доверия, а любой участник потенциально может быть злоумышленником, рассмотрим ключевой вопрос: как же это происходит?

Принцип достижения консенсуса в *децентрализованной учетной* системе Биткоин можно объяснить на следующем примере. Каждый из нас когда-либо играл в карты. В игре нет «главного» – все участники знают правила и должны следовать им. Все ходы (в нашем случае они же транзакции) публичны и проверяются всеми участниками игры. Если кто-то достанет из рукава пятый туз, это будет сразу же замечено остальными участниками, а нарушитель правил будет исключен (рис. 2.19). По схожим принципам происходит «распределение» новых карт из колоды (по аналогии с добычей биткоинов) – правилами определено количество карт и порядок, в котором игроки добирают эти карты.

![Рисунок 2.19 – Схема карточной игры как пример достижения консенсуса](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.19-poker.png)

Изобразим консенсус схематически (рис. 2.20). Все пользователи локально хранят копию базы данных, которая организована с применением технологии blockchain. Состояние единогласия означает, что у каждого честного пользователя состояние копии будет идентичным после синхронизации. То есть у всех участников одинаковые блоки данных, которые образуют одинаковые цепочки.

![Рисунок 2.20 – Ситуация, в которой участники системы достигли консенсуса](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.20-consensus-reaching.png)

> **_Замечание._** *В контексте Bitcoin понятия общая база данных, цепочка блоков, история транзакций имеют одинаковое значение.*

### Сравнение Bitcoin с традиционными платежными системами

> *Bitcoin не требует регистрации*
> *Транзакция не содержит никаких персональных данных пользователей*
> *Адрес может использоваться один раз*

Люди часто интересуются, насколько конфиденциальными будут их действия при работе в Bitcoin. Действительно, в Bitcoin можно увидеть все транзакции между всеми адресами, но однозначно невозможно утверждать, кому они принадлежат. Это усложняет прослеживание истории транзакций конкретного пользователя. Чтобы лучше понять вопрос приватности пользователей Bitcoin, давайте проведем аналогию с традиционными финансовыми системами (табл. 2.1).

Таблица 2.1 – Сравнение традиционных платежных систем с Bitcoin

|*Традиционные платежные системы*| Bitcoin |
|---|---------|
|Непрозрачная история транзакций и ограниченный доступ к аудиту|Прозрачная история транзакций, все изменения видны каждому|
|Централизованное принятие решений об изменениях|Коллективное обновление базы данных с транзакциями|
|Требует полного доверия к ответственной организации|Доверие к математике и программному коду|
|Возможность восстановления доступа к счету |Самостоятельное управление ключами доступа|
|Существует риск банкротства и отказа в обслуживании|Риски работы с ключами и ПО пользователи несут сами |

Банк выполняет функцию хранения и учета. Для этого банк берет у клиентов деньги и ценные вещи, а взамен обещает помнить, сколько и кому должен. Такой подход обычно удобен, поскольку доступ к деньгам осуществляется посредством банковской карты, возможность использовать которую должна быть только у владельца. Это избавляет клиента от необходимости носить наличные деньги при себе, а в случае утери карты ее можно без труда восстановить. Однако все решения банк принимает централизованно, и средства находятся полностью под его управлением. Если банк «забудет», сколько и кому должен, у клиента появятся проблемы. По сути, это типичная история о *компромиссе удобства* и *безопасности*.

До появления Биткоина финансовые отношения в обществе так и осуществлялись. Более того, банки отдавали все большее предпочтение именно такой схеме работы и со временем разработали много различных ее реализаций. Пользователям оставалось только надеяться, что банк выполнит свои обязательства и вернет деньги, когда клиенту они потребуются.

Bitcoin работает без некоторых ограничений, которые присущи традиционным платежным системам и цифровым валютам. В некотором смысле он дополняет финансовую систему, показывая, что альтернативные варианты архитектуры также возможны и что учетная система без главной управляющей организации может существовать.

**Распространенные мифы**

*Создатель Bitcoin может изменить правила работы валюты или украсть монеты пользователей.*

Это не так. У создателя Bitcoin такие же права по отношению к этой валюте, как и у других пользователей.

*Чтобы отправлять и принимать платежи в Bitcoin, нужно где-то зарегистрироваться.*

В Bitcoin нет ни базы данных зарегистрированных пользователей, ни центра принятия решений. Каждая транзакция заверяется отдельно, а проверку цифровой подписи может выполнить кто угодно. Обычно централизованные учетные системы используют сеансовую аутентификацию, которая подразумевает, что единожды верифицированному пользователю на протяжении одного сеанса связи не нужно повторно проходить этот процесс для каждого следующего действия, в отличие от Bitcoin, где каждая транзакция пользователя верифицируется отдельно.

**Часто задаваемые вопросы**

*– Как выглядит монета bitcoin?*

В действительности физического представления они не имеют, а определены абстрактно. Это абстрактное понятие достаточно хорошо отражает свойства цифровой валюты. Поскольку в общей базе данных зафиксированы записи обо всех действиях по добыче и передаче этой валюты, то физические монеты уже не нужны.

*– Если сделка оспаривается в суде и суд ее отменяет, то как отменить транзакцию в Bitcoin?*

Поскольку решения в Bitcoin принимаются децентрализованно, с достижением консенсуса, то единоличное решение не повлияет на конечное состояние базы данных. Суд, конечно, может принять решение об отмене транзакции, но реализовать его будет, скорее всего, невозможно. Исключение составляет ситуация, в которой большинство участников поддержало бы постановление суда. Однако едва ли можно представить подобную судебную практику в современных условиях.

## 2.5 Подтверждение транзакций в Bitcoin

Ранее мы упоминали, что Bitcoin может стабильно работать в условиях анонимности участников и потенциального наличия неизвестного количества злоумышленников. В этой теме мы постараемся подробно описать, как это происходит. Также мы попробуем объяснить, почему в таких условиях невозможны финальные (гарантировано подтвержденные) транзакции и как на практике решается ситуация, когда даже получившая подтверждение транзакция может снова стать неподтвержденной [28]. Также мы рассмотрим, как Bitcoin осуществляет подтверждение транзакций в *децентрализованной среде*.

Любой пользователь может выбрать среди неподтвержденных транзакций такие, которые он считает правильными, после чего объединить их в блок и предложить этот блок всем остальным узлам сети. По решению «большинства» блок может быть принят или отклонен. Если сам валидатор работал честно, верифицировал транзакции по правилам протокола и первым предложил следующий блок общей цепочки, то остальные честные участники примут этот блок.

### Формирование блоков транзакций

Правильно сформированный блок состоит из транзакций, не подтвержденных в предыдущих блоках и не конфликтующих между собой. Каждый блок обязательно содержит хэш-значение от предыдущего блока (подробнее в 3.1). Это означает, что блок подтверждает не только свои транзакции, но и все предыдущие, уже включенные в цепочку, на которую этот блок ссылается. Еще одна особенность формирования блоков заключается в том, что протокол регулирует сложность ресурсоемкой задачи для формирования блоков таким образом, чтобы новый блок появлялся в среднем каждые 10 минут.

> **Правильно сформированный блок**
>> * *Содержит корректные транзакции, ранее не подтвержденные и не конфликтующие друг с другом*
>> * *Содержит хэш-значение предыдущего блока*

Как формируется новый блок? Компьютер отдельного пользователя хранит всю цепочку блоков, которая была верифицирована при помощи ПО Биткоина и считается правильной. В системе постоянно осуществляются переводы между пользователями и появляются новые неподтвержденные транзакции, которые распространяются среди всех узлов. Компьютер каждого пользователя верифицирует поток этих транзакций и объединяет в блок те, которые он считает правильными (рис. 2.21). Далее он обязательно указывает ссылку на предыдущий блок, чтобы было понятно, на основании какой истории он работает, и чтобы соблюдалась целостность базы данных. После он предлагает другим узлам сети свой блок как продолжение общей цепочки.

![Рисунок 2.21 – Процесс верификации полученных транзакций](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.21-transaction-verification.png)

Но если некоторый пользователь, запустит такой узел сети, который будет мошенничать, предлагая поддельные блоки другим пользователям, что тогда случится? Хуже того, это может быть не один пользователь, а организованная группа злоумышленников, запустившая целую сеть ботов (botnet) из модифицированных узлов сети, которые пренебрегают правилами протокола. Как в такой ситуации честным пользователям достичь консенсуса? Очевидно, что задача непростая, но Сатоши Накамото решил ее.

> **Согласие относительно новых транзакций**
>> * *Любой пользователь может выбрать среди неподтвержденных транзакций правильные и объединить их в блок*
>> * *Предложенный блок будет принят или отклонен по решению большинства валидаторов*

### Требования к новым блокам

Настало время углубиться в процесс создания блока. Решение проблемы с поддельными блоками состоит в следующем: блок считается правильным, если на его создание было затрачено заданное количество вычислительных ресурсов. Это значит, что пользователь должен предоставить решение ресурсоемкой задачи, чтобы все остальные участники могли проверить и принять его блок.

Теперь злоумышленник уже не может отвлекать остальных участников большим количеством поддельных блоков. Попутно с этим решаются вопросы частоты появления новых блоков и очередности валидаторов в формировании следующего блока. Работает это следующим образом. Начинают формировать новый блок все, но право предложить свой блок остальным получает только тот, кто решил ресурсоемкую задачу первым.

Очевидно, что чем больше у пользователя вычислительных мощностей, тем чаще он становится первым среди остальных желающих. Если более конкретно, то вероятность стать первым равна проценту от всех вычислительных ресурсов системы, которым обладает участник.

> **Процесс создания нового блока**
>> * *Нужно предоставить решение ресурсоемкой задачи*
>> * *Решивший задачу первым, оповещает всех, рассылая им свой блок*
>> * *Вероятность стать первым зависит от доли ресурсов участника во всех вычислительных ресурсах, задействованных в системе, а также от задержек в каналах передачи данных*

Мы плавно подошли к сути майнинга в Bitcoin. На практике *решение ресурсоемкой задачи* – это и есть *майнинг*. Эта задача имеет одинаковую сложность для всех узлов сети. Майнинг очень важен для Bitcoin, и честные пользователи занимаются этим с целью поддержания надежности процесса подтверждения транзакций. Справедливо, что тот, кто контролирует больше мощности, создает блоки чаще. Рассмотрим, как это работает на примере ниже.

### Принципы соревнования между пользователями

Допустим, в системе работает 10 узлов-валидаторов. У каждого из них есть один майнинговый компьютер, который вычисляет одинаковое количество хэш-значений в единицу времени (рис. 2.22). Эту вычислительную мощность мы примем за 1, тогда суммарная мощность системы будет равна 10. А каждый валидатор, соответственно, контролирует 1/10 этой мощности. Вероятность нахождения следующего блока каждым из участников составляет 0,1.

![Рисунок 2.22 – Учетная система с десятью валидаторами](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.22-ten-validators.png)

Пусть участник А решил, что заниматься майнингом выгодно, и купил себе еще пару компьютеров (рис. 2.23). Теперь суммарная мощность системы будет равна 12 (т. к. 10 + 2 = 12). Доля этого участника теперь составляет 3/12 или 1/4, а доля каждого из остальных участников точно так же равна 1/12. Следовательно, вероятность того, что участник А будет находить новый блок первым, равна 0,25, а для остальных участников она будет равной по 0,08(3). Таким образом, имея даже малую долю вычислительной мощности, валидатор может создать новый блок первым, хотя вероятность будет ниже, чем у остальных.

![Рисунок 2.23 – Один из валидаторов системы приобрел дополнительную мощность](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.23-ten-validators-with-diff-power.png)

А что же будет, если злоумышленник решит задачу для блока, который будет содержать правильные с точки зрения протокола транзакции, а честные пользователи будут все равно не согласны с этим блоком? Ведь все участники сети анонимны, ПО можно модифицировать, а кто из участников поведет себя честно или злоумышленно, заранее неизвестно.

### Распространение блока

Прежде чем мы ответим на вопрос, как решаются разногласия относительно определенного блока, предлагаем рассмотреть процесс распространения блока по сети. Итак, один из узлов сети находит решение задачи и формирует блок. Далее происходит процесс трансляции блока в сеть. То есть узел, сформировавший блок, передает этот блок всем узлам, с которыми имеет непосредственное соединение в рамках сети Bitcoin.

После этого узлы, которые приняли блок, проверяют его на соответствие правилам протокола. Есть два варианта развития событий. В первом случае, если узел соглашается, что принятый блок является корректным и может быть добавлен в цепочку блоков, то он сохраняет себе копию блока и распространяет его дальше по сети. Но что происходит в том случае, если узел не соглашается с полученным блоком?

### Решение разногласий

Если один участник не согласен с блоком другого, то совершенно нормальным считается создать альтернативный блок на той же высоте цепочки блоков. 

> *Несогласный участник формирует альтернативный блок*
> *Альтернативные блоки могут включать одинаковые транзакции*
> *Узлы сети сохраняют оба варианта*
> *Остальные участники формируют блоки, продлевая одну из версий цепочки*
> *Побеждает цепочка с наибольшей длиной (наибольшим количеством работы, затраченной на ее построение)*

*Высотой блока называется порядковый номер блока в цепочке относительно genesis block .* (рис. 2.24).

*Genesis block – блок, высота которого равна нулю.*

![Рисунок 2.24 – Нумерация блоков (0 – genesis block)](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.24-block-num.png)

Таким образом, факт несогласия одного из участников может повлечь за собой ситуацию, когда будет сформировано два блока, которые ссылаются на один предыдущий. Такие блоки могут включать даже одинаковые или конфликтующие транзакции. При этом узлы сети могут сохранить оба предложенных варианта, если сочтут их правильными, но каждый из этих узлов должен для себя определить, на базе какого из альтернативных блоков создавать следующий. Таким образом, остальные участники делают свой выбор, формируя блоки на одном из существующих блоков, указывая ссылку на него в своем новом блоке для продления конкретной версии цепочки. А правила протокола указывают на то, что из двух правильных версий приоритет нужно отдавать той, на создание которой было затрачено больше вычислительных ресурсов.

Процесс решения разногласий можно изобразить схематически (рис. 2.25). Существует сеть узлов, в локальных копиях базы данных которых существует два альтернативных блока на одной высоте. Условно обозначим, что пользователи слева решили выбрать верхний блок в качестве основного, а пользователи справа – нижний. И предположим, что все продолжают работать над созданием следующего блока, поддерживая разные версии.

![Рисунок 2.25 – Процесс решения разногласий в Bitcoin](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.25-disagreement.png)

В следующий момент времени некий пользователь создал и предложил новый блок, который ссылается на верхний из двух альтернативных. При этом его предложение было принято всеми остальными участниками сети. И даже те участники, которые изначально выбрали другой альтернативный блок, проверили и приняли более длинную цепочку (рис. 2.26).

![Рисунок 2.26 – Состояние узлов после решения разногласий](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.26-disagreement-resolved.png)

Это так называемое *правило самой длинной цепочки*. Оно гласит, что участник должен выбирать самую длинную цепочку из всех, которые он считает правильными, и считать ее основной. А если более строго, то выбирается та цепочка, для создания которой было выполнено больше работы. Причем важно понимать, что честный участник переключится на длиннейшую цепочку только в том случае, если она была построена по правилам протокола. Это не позволяет злоумышленникам нарушить изначальные правила Bitcoin, даже если они будут обладать большой вычислительной мощностью.

### Понятие полного подтверждения транзакции

Остановимся на самом важном положении в контексте использования валюты bitcoin. Оно касается процесса подтверждения транзакций в Bitcoin. *Транзакция считается достаточно подтвержденной, если она включена в самую длинную цепочку и после блока, в котором она содержится, следует еще 5 блоков*. Иначе говоря, нужно дождаться 6 подтверждений, а не 1. Если учесть, что блок появляется в среднем 1 раз в 10 минут, несложно вычислить, что полное подтверждение транзакции занимает приблизительно один час.

Ответ на вопрос, почему необходимо именно 6 подтверждений, дает математический расчет: если одна цепочка опережает другую на 5 блоков, при том же распределении вычислительной мощности вероятность «обогнать» более длинную крайне мала. В своей статье [14] Сатоши Накамото математически доказывает это на основании следующего выражения: 

[Formula]

где p – вероятность того, что честный узел найдет следующий блок; q – вероятность того, что атакующий найдет следующий блок; qz – вероятность того, что атакующий когда-нибудь догонит основную цепочку, если он начал альтернативную z блоков назад.

Например, если злоумышленник обладает 10% вычислительной мощности всех валидаторов, а честные узлы работают в сети с быстрой доставкой сообщений, то эта вероятность после 1 подтверждения будет иметь значение около 0,1, а после 6 – меньше 0,000002.

### Вознаграждения за создание блоков 

Еще один важный вопрос – это мотивация пользователей решать ресурсоемкие задачи, создавать новые блоки и подтверждать транзакции, не оставляя шансов злоумышленникам.

Мы уже говорили о процессах формирования блоков, эмиссии монет и о комиссиях за подтверждение транзакций. В Bitcoin эти процессы очень тесно связаны друг с другом. Дело в том, что по правилам протокола создатель блока может отправить на свой адрес определенное количество монет, взяв их из ниоткуда. Это и есть эмитированные монеты. Итоговая сумма вознаграждения рассчитывается, как эмитированные монеты плюс сумма комиссий всех транзакций, включенных в этот блок.

**вознаграждение = новые монеты + комиссионные сборы**

Таким образом, в 2018 году вознаграждение за создание одного блока составляет 12,5 монет плюс комиссионные сборы. Отметим, что из соображений безопасности валидатор не получает это вознаграждение сразу после создания блока. Существует специальный параметр coinbase maturity [29]. Он указывает на минимальное количество подтверждений транзакции, в которой валидатор получает вознаграждение. В Bitcoin этот параметр имеет значение 100, следовательно, после создания блока необходимо дождаться появления еще 99 блоков, которые будут подтверждать данный, прежде чем вознаграждение станет доступным.

Как было отмечено ранее, новый блок появляется в среднем каждые 10 минут вне зависимости от суммарной вычислительной мощности системы. Это достигается за счет использования параметра сложности, который рассчитывается каждым узлом независимо по известному алгоритму и используется для задания требований к решению ресурсоемкой задачи. Со временем этот параметр пересчитывается с учетом изменения вычислительной мощности системы.

Очень важно понимать, что все узлы сети коллективно находят новый блок за 10 минут. Каждый отдельный участник может искать решение задачи для создания блока часами или даже годами, но согласно теории вероятностей кто-то один найдет его в среднем за 10 минут при условии, что все валидаторы будут работать над одной цепочкой блоков. Это также означает, что выключение половины мощности системы в один момент приведет к увеличению среднего периода формирования блока до 20 минут. И он будет оставаться увеличенным до момента, когда параметр сложности будет пересчитан.

Принято считать, что влиять на обработку транзакций может только тот, кто контролирует более 50% мощности. Чтобы учетная система Bitcoin могла считаться безопасной, необходимо, чтобы большинство вычислительной мощности системы контролировали именно честные валидаторы. Это значит, что доверяя Биткоину, пользователь уверен в том, что тысячи людей не сговорятся одновременно против него. Атака, при которой злоумышленник контролирует больше половины вычислительных мощностей системы, обычно называется *атакой 51%* (подробнее в 4.2). На момент 2020 года Bitcoin ни разу не подвергся ей на практике. Однако можно привести яркие примеры с успешными атаками 51% в Bitcoin Gold и ZenCash, которые суммарно нанесли ущерб на более чем 18 млн долларов США.

### Влияние разрывов сети на учетную систему Bitcoin

В качестве драматичного примера можно привести вымышленную ситуацию. Однажды морские бобры, напившись пиратского рома, одновременно перегрызли все оптоволоконные кабели, которые проходили по дну океанов и соединяли все континенты в глобальную сеть. Каналы передачи данных между континентами отказали, но узлы каждого континента продолжили корректно работать в своих подсетях. Однако пользователи разных подсетей не могли синхронизироваться, чтобы обмениваться транзакциями и блоками, поэтому на каждом континенте валидаторы формировали разные версии цепочки блоков.

Очевидно, что большинство узлов сети Bitcoin используют глобальную сеть для общения друг с другом, а популяция предпринимателей-майнеров неравномерно нанесена на поверхность материковой части Земли (рис. 2.27). Что же может произойти с этой цифровой валютой, если в работе Всемирной сети между шестью континентами будут сбои?

![Рисунок 2.27 – Пример сетевых соединений между континентами](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.27-network-connection.png)

Пока доктор Айболит стачивал зубы одновременно всем морским бобрам, а инспектор Гаджет чинил оптоволоконные кабели изолентой, валидаторы продолжали формировать блоки (рис. 2.28). Поскольку группы валидаторов на разных континентах имели разную вычислительную мощность, а параметр сложности еще не обновился, то период формирования одного блока стал намного больше десяти минут для каждой из подсетей. Более того, этот период оказался разным для каждого континента, что привело к формированию альтернативных цепочек разной длины.

![Рисунок 2.28 – Неоднородность состояния базы данных на разных континентах](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.28-non-uniformity.png)

В момент, когда доктор Айболит и инспектор Гаджет закончили свою работу и каналы передачи данных были восстановлены, узлы сети Bitcoin с разных континентов одновременно начали синхронизироваться друг с другом. Тогда-то и выяснилось, что есть несколько разных версий цепочки блоков и что все они имеют разную длину (рис. 2.29). Более того, в разных цепочках находятся разные транзакции, подмножества которых могут только частично пересекаться.

В соответствии с правилами протокола Bitcoin все узлы выберут наиболее длинную цепочку и будут считать ее основной (*mainchain*). Интересным является и тот факт, что транзакции, которые были включены только в альтернативные цепочки, снова получили статус неподтвержденных. Тем не менее, полные узлы сети продолжают их хранить и синхронизировать, а узлы-валидаторы, как и всегда, заинтересованы включить их в свои блоки и получить вознаграждение при условии, что эти транзакции не конфликтуют с уже подтвержденными в mainchain (детальнее в 4.2).

![Рисунок 2.29 – Выбор наиболее длинной цепочки блоков](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.29-choosing-the-longest-chain.png)

Таким образом, транзакции из отброшенных блоков (*orphan blocks*) попадают в список неподтвержденных и с высокой вероятностью будут подтверждены позже. В итоге, часть валидаторов не получит вознаграждение за решение задач, хотя все они работали с прежним усердием.

В описанной ситуации существуют риски потерять монеты не только для валидаторов Bitcoin, но и для пользователей. Эти риски обусловлены тем, что не вся вычислительная мощность Bitcoin использовалась для поддержания надежности валюты. Например, пользователи могут не заметить разделение глобальной сети на подсети и продолжить принимать платежи в криптовалюте, рискуя позже не обнаружить принятые монеты на своем балансе.

Провести подобный обман способны даже пираты Карибского моря. Допустим, Капитан Джек Воробей раздобыл изображение личного ключа. На соответствующий этому ключу адрес еще до того, как пираты научили морских бобров пить ром и бушевать, кто-то отправил биткоины, и они сохранились непотраченными. А когда бобры превратили глобальную сеть в шесть локальных, Капитан решил, не теряя времени, оплатить биткоинами установку дизельного двигателя на Черную Жемчужину в порту первого континента. После чего корабль пиратов сразу направился ко второму континенту под действием попутного ветра, чтобы заправиться там дизельным топливом.

На втором континенте еще не знают про первую транзакцию Джека Воробья, но времени на обман у пиратов немного (до восстановления связи). По прибытии на второй континент Джек снова использует изображение личного ключа, чтобы оплатить заправку пиратского корабля биткоинами (рис. 2.30). Здешний заправщик дожидается первого подтверждения и принимает те монеты, которые в действительности были потрачены на первом континенте.

![Рисунок 2.30 – Трата одних и тех же монет в разных цепочках](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.30-captain-jack-sparrow.png)

Тем временем доктор Айболит и инспектор Гаджет обещают устранить угрозу и решить проблему связи очень скоро. Учитывая их добросовестное отношение к работе, пираты заблаговременно подготовились к плотному графику кругосветного путешествия. Имея изображение личного ключа и быстроходный корабль с полным баком дизельного топлива, они готовы навестить и другие континенты, чтобы заполнить трюм ромом и купить руководство по изучению квантовой механики.

Очевидно, что после синхронизации узлов подтвержденной осталась только одна транзакция – та, которая платила торговцу с континента с наибольшей частью вычислительной мощности Bitcoin. Пираты же преподнесли хороший урок торговцам, которых обманули. Капитан и его команда анализируют события, думают над улучшением своей стратегии и рассматривают варианты применения квантового компьютера.

**Распространенные мифы**

*Создание блока в Bitcoin всегда занимает 10 минут.*

На практике блок может быть создан за долю секунды, а может быть создан за полтора часа. Время создания следующего блока практически непредсказуемо. Но существует алгоритм, который адаптирует сложность так, чтобы блоки появлялись в среднем каждые 10 минут. Для бизнеса, конечно, это не всегда хорошо, потому что сложно определить, когда платеж можно считать принятым.

*Если некто контролирует большинство майнинговой мощности, то он может нарушить правила протокола.*

На самом деле наибольший вред, который может нанести владелец большей части мощностей, – это успешная попытка двойной траты своих монет, а также фильтрация или блокирование чужих транзакций при подтверждении. Важно учесть, что это возможно только в тот период времени, пока он содержит соответствующее оборудование. Украсть монеты или совершить произвольную эмиссию он не может, следовательно, Bitcoin не сломается, а может просто отказать в обслуживании на некоторое время.

**Часто задаваемые вопросы**

*– Какое минимальное количество подтверждений должна получить транзакция, чтобы она считалась добавленной в цепочку блоков?*

Одно, но чтобы она считалась подтвержденной с высокой вероятностью, бывает и больше, по умолчанию это шесть подтверждений. Некоторые сервисы принимают платежи с двумя или тремя подтверждениями. А вообще это количество зависит от суммы платежа и может даже превышать 100.

*– Какова вероятность того, что правильно сформированная транзакция при отправке в сеть будет подтверждена?*

Если процесс формирования новых блоков действительно децентрализован (не поддается цензуре), а также транзакция предусматривает достаточную комиссию, вероятность ее подтверждения стремится к единице.

*– Стоит ли настраивать полный узел и в каких случаях это нужно?*

Полный узел протокола Bitcoin нужен в том случае, если вы хотите видеть актуальную версию базы данных, а также принимать и отправлять платежи. Для того, чтобы работать с Биткоином, вам в любом случае нужна актуальная версия базы данных, а ее может видеть только полный узел. Все легкие клиенты, веб-кошельки, мобильные кошельки, которые не выкачивают всю цепочку блоков, используют доверенные узлы для получения актуальных данных. Иначе говоря, узел, который запущен каким-то сервисом, сам отслеживает актуальное состояние всех транзакций и текущего распределения монет, а через него легкие клиенты получают это состояние, чтобы осуществлять свои платежи. Но тогда возникает вопрос доверия этим узлам, этим сервисам, а в определенных случаях это неприемлемо. Поэтому лучше всего запускать полный узел и быть уверенным, что именно ваш софт работает правильно: вы провели его аудит, сами его обновляете, а также не зависите от сторонних сервисов.

*– Что такое форк? Какие разновидности форков бывают?*

Под словом форк люди могут понимать две вещи: разветвление цепочки блоков и клонирование исходного кода. В контексте блокчейна форки бывают случайными и умышленными. А форки исходного кода делают для внесения некоторых изменений в протокол с целью их тестирования или для развития отдельного проекта. При этом форк не стоит путать с понятиями *softfork* и *hardfork*: это типы обновления протокола (подробнее в 6.1).

*– Кто в системе принимает решение о повышении и понижении сложности?*

Никто, это определяется одинаковыми правилами, заложенными в ПО каждого узла сети. Каждый участник обновляет параметр сложности для себя в соответствии с этими правилами. В результате, этот параметр будет одинаковым для всех, а центр принятия решений не нужен. В этом и состоит важнейший принцип работы децентрализованных учетных систем.

*– Если изначально в системе заложен 1 час на подтверждение транзакции, каким образом планируется использовать Bitcoin как средство платежа?*

На самом деле, 1 час – это рекомендация, которой придерживаются по умолчанию. Если углубиться в детали, то окажется, что время ожидания до принятия платежа определяет сам получатель. Причем чем больше сумма сделки, тем дольше получатель заинтересован ждать. По грубой оценке, для принятия платежа на сумму 1 USD достаточно одного подтверждения транзакции, а на сумму 1 000 000 USD – 16 подтверждений (подробнее в 4.2) [30]. Кроме того, известны методики осуществления платежей через так называемые *платежные каналы*, где платежи подтверждаются гораздо быстрее, чем обычные (*on-chain*) транзакции, а время подтверждения не зависит от суммы платежа и установленной комиссии (подробнее в 4.8).

*– Как работает отмена bitcoin-транзакций?*

Если транзакция была распространена, но еще не подтвердилась, то есть шансы успеть ее заменить, например, на конфликтующую транзакцию с теми же входами но другими выходами. Если транзакция уже подтвердилась, то обычный пользователь уже не может ее отменить или заменить, но валидаторы могут создать альтернативную ветку цепочки блоков, которая не содержит конкретную транзакцию или содержит конфликтующую.

[КРИПТОГРАФИЯ И УПРАВЛЕНИЕ КЛЮЧАМИ](https://github.com/distributed-lab/blockchain-and-decentralized-systems-book/blob/main/chapters/volume-1/ru/3-cryptography-and-keys-management.md)