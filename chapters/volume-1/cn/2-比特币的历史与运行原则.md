# [1 密码学与密钥管理](/chapters/volume-1/cn/1-资料系统里的分权.md)

# 2 比特币的历史与运行原则


## 2.1 比特币是什么？

基本上，比特币是一个实施独立的货币与付款系统的协议。所有其他的数字货币或付款系统（例如 WebMoney 与 PayPal）使用现有（法币（fiat)）的货币政府实体控制(例如美元、欧元、英镑)。比特币是不但独立的货币，而且管理自己的货币的付款系统。请注意，这是一个独立的支付系统：没有中央实体控制其运作。

> **_注意：_** _我们将使用比特币来指代会计系统或协议，而用小写的"比特币(BTC)"来指代货币或硬币。_

当人们尝试理解比特币时，他们通常会查阅维基百科，维基百科将其定义为一种点对点支付系统，它使用自己的硬币作为价值单位，并使用加密方法来确保系统的运作与保护。对于没有任何支付系统经验的人来说，这个定义既复杂又不完整，特别是当他们第一次听说比特币时。因此，必要用更为熟悉的词语来定义比特币。在这个主题上出现在出版物中的最好的类比是与“数字黄金”的类比（图 2–1）。

![图 2–1](/resources/img/volume-1/2.1-what-is-bitcoin/2.1-gold.png "图 2–1")

可以合理地假设比特币的创造者实际上旨在复制黄金的所有属性，例如有限的供应、挖掘、独立于单一组织以及无法人工复制的特性。比特币以数字形式复制自然存在的矿物的特质，这一事实可以被视为计算机科学的重大突破。

使用比特币任何人都可以向任何人与在任何地方进行支付。所需的只是接入因特网、一个数字钱包与接收者的地址。国际汇款常见的缺点在比特币中都不存在。进行支付无需额外的许可。

因此，比特币在坚定信仰无政府主义、自由主义思想与完全隐私的社群中变得广为人知而受尊敬；后来，电脑机极客（密码朋克、黑客）以及进行比特币研究而实验的科学家们也加入了他们。不久，比特币(BTC)的价格吸引了企业家与投机投资者的注意。最后，广泛使用比特币的关键动机是普通人能够进行无需第三方参与而无需注册的无许可支付。

像 PayPal 或 WebMoney 这样的支付系统由公司管理，这些公司可能会受到黑客攻击或政府要求，导致信息泄漏、服务器关闭与账户冻结。但比特币并非如此：不存在比特币有限责任公司这样的机构可以冻结账户或单独确认交易。比特币交易不受审查。这个特性非常重要，我们稍后会讨论它是如何实现的。


### 比特币创造历史

我们不知道谁发明了比特币，尽管众所周知，这是一个化名为中本聪(Satoshi Nakamoto)的人。也许这是一个个人，但也有建议说这可能是一个团队。中本聪于 2008 年注册了 bitcoin.org 域名，发布了第一篇文章，并发布了协议源代码的初始版本。直到2011年，有人在论坛与电子邮件列表上以中本聪的化名发表消息。后来，他写道自己决定专注于其他事情，并停止了公开交流。

然而，值得注意的是，中本聪创造比特币的想法并非空穴来风。在他的论文《比特币：一种点对点式的电子现金系统》[15]（图 2–2）中，中本聪提到了两个早期的关键项目（早期尝试创建独立数字货币的项目）：亚当·巴克的 HashCash [16] 与韦戴的 B-Money [17]。HashCash 最初引入了工作量证明的方法，最初是为了打击电子邮件中的垃圾邮件，而 B-Money 引入了用于分配交易数据的网络模型，以及使用加密签名发送资金的方法。

![图 2–2](/resources/img/volume-1/2.1-what-is-bitcoin/2.2-bitcoin-wp.png "图 2–2")

> **_图里的文本：_**  
> _“比特币：一种点对点式的电子现金系统_
> 
> _中本聪_  
> _satoshin@gmx.com_  
> _www.bitcoin.org_
> 
> _摘要。一个纯粹的点对点版本的电子现金可以允许在线支付直接从一方发送到另一方，而无需经过金融机构。数字签名提供了部分解决方案，但如果仍然需要信任的第三方来防止双重支付，主要好处就会丧失。我们提出了使用点对点网络解决双重支付问题的方案。网络通过将交易时间戳化为基于哈希的工作量证明链的不断链条，形成了一条不经重新完成工作量证明就无法改变的记录。最长的链不仅作为事件序列的证明，而且证明它来自最大的 CPU 算力池。只要大多数 CPU 算力由不合作攻击网络的节点控制，它们就将生成最长的链并超过攻击者。网络本身需要最小的结构。消息以尽力而为的方式广播，节点可以随意离开和重新加入网络，接受最长的工作量证明链作为他们离开期间发生的事情的证明”。_

因此，中本聪利用现有的概念来实现比特币，并解决了早期尝试创建数字货币所遇到的问题。公平地说，可能没有多少人会从上述项目中意识到独立数字货币的雏形形成。

> **_比特币发明背景_**  
> * _大卫·川姆（David Chaum）——DigiCash [18] (1989)_  
> * _亚当·巴克（Adam Back）——HashCash (1997)_  
> * _尼克·萨博（Nick Szabo）——BitGold [19] (1998)_  
> * _韦戴（Wei Dai）——B-Money (1998)_  
> * _哈尔·芬尼（Hal Finney）——RPoW作为电子货币[20] (2004)_

比特币是第一个成功实现的分散会计系统。以前也有其他尝试：例如，大卫·川姆（David Chaum）于 1989 年创立的公司 DigiCash 是第一个提供名为 Ecash 的特殊数字货币的数字支付公司。该支付系统的用户是匿名的，银行无法追踪他们的账户。该项目得到了美国的几家创新银行与芬兰的一家银行的支持；由于很难说服更多的银行与商家接受匿名货币，该项目被取消了。

> **_关键日期_**  
> * _比特币白皮书发布日期：2008年10月31日_  
> * _创世区块创建日期：2009年1月3日_  
> * _第一个比特币交易：2010年2月_  
> * _P2SH 采用日期：2012年1月5日_  
> * _比特币现金分叉日期：2017年8月1日_  
> * _隔离见证采用日期：2017年8月24日_  
> * _闪电网络推出日期：2018年3月15日_  

比特币发展的最初步骤之一是于2008年10月31日发布了比特币白皮书。2009 年 1 月 3 日，首次发布了源代码并创建了第一个区块（创世区块）产生了最初的50个比特币。因此，这一天可以被视为系统的启动日期。稍过一年后，首次出现了比特币(BTC)兑换法定货币的交易。

比特币现金分叉发生在 2017 年 8 月 1 日，这是主要系统首次分裂（更多细节请参阅6.1节）。另一个重要事件是比特币的关键更新——隔离见证的引入，它实施了一些改进，为比特币打开了一些以前不可能的机会（更多细节请参阅4.6节）。而在 2018 年 3 月 15 日，在比特币上的革命性、变革性的即时支付系统——闪电网络，正式启动。

> **_比特币网络在 2018 年的统计数据_**  
> * _预计有1千万独立用户_  
> * _平均每天使用比特币(BTC)进行30万笔支付_  
> * _每日交易量相当于150亿美元_

2018 年，比特币被全球数百万人使用，数百家公司接受比特币(BTC)作为支付方式。许多项目正在基于比特币开发，并有些国家（尤其是日本）承认并确认比特币为合法支付手段。


### 比特币可以解决的问题

比特币之所以成为热门，首先是因为它实现了一个独立于政府与银行的分散金融系统。在传统意义上，它不受通货膨胀的影响（没有任何实体或特定个人可以单独印制更多比特币）。它不允许冻结、回滚或取消交易，完全依赖数学，而不是人们的奇想。此外，与之前存在的数字货币相比，比特币(BTC)支付更为私密。

> * _金融工具，无需限制运作_  
> * _无复杂的注册流程_  
> * _可匿名使用_  
> * _抗审查的_

这些特性吸引了不同类型的用户。例如，企业可以确信，当买家不喜欢所购买的商品时，他不能仅仅自动要求退款。对于 PayPal 商业用户来说，另一个令人痛苦的问题是，因为“有人对您提出了投诉”等原因，他们的账户与数以万计的美元被封锁了数个月。这在比特币中是不可能的，这也是它为何对商业变得吸引的原因。

现有金融系统的不透明性是支持比特币的另一个论点。历史上存在许多情况，政府无故发行货币，导致了恶性通货膨胀而生活水平下降。这种情况发生在 1990 年代的前苏联国家，公民的个人财富由于他们无法控制的原因被贬值至几乎毫无价值。这样的事件清楚地解释了为什么人们更愿意在可能的情况下独立管理自己的财务，而不受政府或银行的控制。

实际上，比特币中的第一个交易区块包括了指向新闻的链接，描述了印制大量现金作为应对2008年金融危机的尝试[21]。非透明的支付系统在危机期间引起了用户的不满。而阴谋论正是在这里：其支持者认为银行随意处理客户的资金（在一些国家确实存在这种情况）。在实践中，这种情况更为“体面”：银行收取客户的法定货币，并以此给予了返还请求时的义务；稍后银行可能拒绝履行其义务。问题的实质在于，对客户来说证明这种拒绝是错误的并且返还资金是一个非常复杂的任务。

> **_现有支付系统的问题_**  
> * _用户无法掌控自己的资金_  
> * _资金转移可能需要几天甚至几周才能结算_  
> * _支付可能会被取消或作废_

在实现一个让人们能够独立管理自己资金的系统方面，事实证明非常困难。然而，随着时间的推移，对这方面的需求不断增加，直到 2009 年，比特币以一种真正的解决方案的形式呈现出来。没过多久，这引起了公众的关注。


### 比特币运作的主要原则

比特币运行的基本原则的简洁表述如下： _每个用户运行相同版本的软件，具有相同的状态，因此维护了一个分散的系统_ 。

> * _所有用户都存储数据库的副本_  
> * _用户自行处理交易_  
> * _所有用户遵循相同的规则_  
> * _用户只信任自己可以验证的内容_

参与者的连接与断开是独立发生的，不会影响其他网络成员的工作。每个人都独立保留而更新数据库以及相应的软件。所有的工作规则都被每个人保存，所有用户彼此相互双重检查。比特币用户网络可以用图 2–3 来表示。

![图 2–3](/resources/img/volume-1/2.1-what-is-bitcoin/2.3-network-of-users.png "图 2–3")

特定用户可以独立处理任何网络交易。通过软件，用户可以确认他认为正确的特定交易。因此，每个用户都有一组他们已经验证并确定为正确的交易。基于此，每个网络节点构建由大多数用户同意的交易组成的共享数据库。一旦交易进入此数据库，就被视为已确认。


### 发行比特币

_发行_ （在货币的语境下） _是将现金或非现金货币投入流通的过程。_ 比特币中的发行与传统金融系统中的发行不同。相反，它是通过算法创建硬币。基本原则是整个过程完全分散的，并且基于公开发布且不可篡改的数学算法。这是实现硬币分配中绝对透明度的方法。

> * _发行过程是分散的_  
> * _发行规则由数学控制_  
> * _发行是由用户自行执行的_  
> * _新币会在活跃参与者之间分发_

根据协议规则，任何用户都可以执行发行，而所有网络成员都会验证其符合这些规则。简而言之，新比特币会在积极参与维护会计系统的用户之间分发。他们称为验证者。这意味着系统中可以有很多参与者，每个人都有可能获得新的比特币。

> **_比特币发行规则_**  
> * _新的比特币每隔大约10分钟出现一次_  
> * _每4年新比特币的数量减半_  
> * _比特币的绝对总量将永远发行的数量是20,999,999.9769_

硬币的发行量由网络 _节点软件_ （运行比特币软件的计算机）中设定的规则决定。中本聪规定，新的比特币平均每 10 分钟出现一次。最初，数量为 50 枚，自那时起，大约每4年新币的数量减半一次。目前，比特币推出已经超过 10 年，而硬币的发行速度已经显著降低。

在比特币中编程规定最大硬币数量约为二千一百万。为什么是二千一百万？没有人知道确切的原因，也并不重要；这是中本聪决定的。每个比特币可分为 100,000,000 份，最小的单位称为“聪”（以协议创造者的化名命名）。因此，您不必拥有整个硬币：您可以拥有部分。

**_1 比特币 （BTC） = 100,000,000 聪(satoshis)_**

根据计算，绝对数量的 21,000,000 比特币(BTC)将在大约2140年达到。精确数量将略少于二千一百万比特币(BTC)，即2,099,999,997,690,000 聪。

现在，让我们来看一下随着时间推移发行的比特币数量如何变化。 图2–4 展示了某段时间内现有比特币数量的变化情况。我们可以看到它类似于对数曲线。在 2018 年，挖掘的比特币数量超过了一千七百万 BTC。

![图 2–4](/resources/img/volume-1/2.1-what-is-bitcoin/2.4-graph-of-issuance.png "图 2–4")

> **_比特币硬币的特性_**  
> * _稀缺性（有限数量）_  
> * _离散性（硬币可分割）_  
> * _抗审查性（独立于任何公司或国家）_  
> * _不可变性（无法伪造硬币）_

比特币允许向世界任何地方的人支付为任何事物任意金额。此外，比特币作为一种货币具有一些属性，使其适合作为支付工具，也可能在某些时候成为财富储存手段。


### 比特币价格是如何确定的？

我们认为对加密货币积极吸引许多人的关注的主要原因是它们的价格上涨。最初的问题之一是这个价格实际上怎么确定。比特币的价格被严格按照买家与卖家之间的供需法则确定。没有任何实体决定比特币今天的价格将是X，明天将是Y。

大多数情况下，价格是在交易所上确定的，这些交易所允许人们使用订单簿购买或出售硬币，就像他们为股票与其他金融工具所做的那样。全球范围内有许多不同的交易平台，拥有不同的用户和订单簿。因此，比特币的价格可能因为特定站点的用户所创造的供需比例而在不同交易所间存在差异（图 2–5）。

![图 2–5](/resources/img/volume-1/2.1-what-is-bitcoin/2.5-demand-and-supply.png "图 2–5")

在图 2–6 中，展示了比特币（1 BTC）从比特币启动日期即2009年至 2018 年[22]的价格走势图。

![图 2–6](/resources/img/volume-1/2.1-what-is-bitcoin/2.6-value-change.png "图 2–6")

比特币早期的价格并不是由市场决定的，因为当时还没有公开的交易所。后来，人们开始按特定比例用着比特币交换其他货币。比特币首次用于购买真实产品（两份披萨）是在 2010 年进行的[23]，当时比特币价格为几美分一个。价格开始上涨，在 2011 年达到了33美元的早期峰值，但后来下跌至2美元。2014 年的最高记录价格约为 1,100 美元。经历又一次下跌至 200 美元后，2015 年价格基本上保持稳定，然后开始逐渐增长。2017 年，其指数增长期开始，价格达到了 20,000 美元。

关于价格的形成，值得注意的是，那些无法访问或由于某些原因未使用的比特币，在整体格局中可以发挥重要作用。例如，截至 2018 年 11 月，由于密钥丢失大约为 3 到 4 百万比特币被阻止了，这对价格有重大影响[24]。众所周知，中本聪拥有大约一百万比特币（BTC），但从没有耗费过。如果有证据表明私钥已被销毁且相应的比特币已经流出流通领域，比特币的价格可能会发生显著变化。

我们无法确定中本聪是否已经阻止了花费他的比特币的可能性。如果他仍然可以访问这些比特币，那么他可以使用它们，如果密钥丢失，也可能有人找到并使用它们。只有中本聪能够证实或否定这一点。他仍然可能会突然出现并宣布他将利用自己丰富的比特币供应来控制比特币的价格，类似于中央银行管理法定货币供应与价值的原则。

值得注意的是，在某些用例中，比特币的价格并不重要。例如，如果有人需要从乌克兰向中国转账，他可以使用比特币作为过渡的“层”——在基辅用格里夫纳（当地货币）购买比特币，然后在上海以人民币出售。在这种情况下，1 比特币的价格是 200 美元还是 10,000 美元并不重要。

> **_注意：_** _并非总是可行将比特币用作实际业务的支付或结算方式（主要是由于价格波动性），但在国际交易的背景下，它们可能非常有帮助。_

比特币的优势是在于支付的不可逆转性与“编程”行为的能力。在买家不信任卖家的情况下，这些特性至关重要。例如，考虑在线拍卖：卖家不愿在买家付款之前将物品发运给买家，另一方面，买家也不愿在发运货物之前付款。

对他们来说一个简单的解决方案是买家不使用银行转账支付全部金额，而是通过比特币进行部分预付款（这是即时的，并支持无需信任的托管，参见4.5），然后再通过银行转账支付剩余金额。一旦卖家收到了比特币的预付款（作为选择，它可以涵盖运输成本），他就会发货。物品到达并且买家进行银行转账后，卖家会退还预付款。

在例子中，比特币的价格与波动性都不是问题。最终，如果你想象一个世界，在这个世界中许多加密货币都提供了相同级别的抗审查与交易不可逆转性，那么对于使用它们的人来说，加密货币的价格就变得无关紧要了。

> **_注意：_** _抗审查是源自真正的分散性，也是比特币作为一种资产产生真正需求的原因。
很容易复制比特币的代码库并创建另一种加密货币，该货币也可能在发行量上受限，甚至可能有更高级别的匿名性。然而，它不一定会像比特币那样有价值，因为唯一的区别因素是抗审查的程度，而不是存在的硬币数量或某些额外功能。_


### 比特币中的信任概念

比特币的关键特征是所有用户的无需信任的互动。每个人都可以验证系统的最终状态达到了，否在不违反协议规则。系统参与者的信任是被排除的。

_只信任数学_ 是加密货币的关键进步之一。在本书中，我们会多次重复这个说法。然而，这并不是全面的，实际情况是稍微复杂一些。

关于特定用户与比特币网络的互动，有一些方面需要考虑，这些方面让用户相信某人。例如，当你相信你的比特币钱包余额是正确的时候，这意味着你信任：  
* 那些建议你安装特定钱包的人（朋友、互联网论坛等）  
* 你使用的钱包被正确开发而实施  
* 你的操作系统没有被黑客  
* 你计算机的硬件没有被黑客  
* 你的钱包连接到真实的比特币节点（你未连接到恶意节点）  
* 加密库的实现没有后门  
* 加密算法没有内置后门

上述所有内容并非想象出来的（实际上可能存在更多潜在威胁）。在每一项，都有一个在某个时间向某人发生的真实案例。这表明在系统中 _绝对安全与完全无需信任_ 等这些概念只是理论上的。分散只是增加系统不受损害的可能性。在比特币的背景下，这意味着每个用户都可以独立验证任何交易或区块的正确性，他不需要信任第三方提供的数据。


### 比特币的局限性

除了优势外，与以集中方式管理的数字货币相比，比特币也存在一些局限性。

> * _有限的容量_  
> * _高昂的系统维护成本_  
> * _长时间的交易确认_  
> * _交易数据的公开可用性_  
> * _高额费用与波动_

在接下来的子章节中，我们将详细考虑每个限制，并描述相应的解决方案（参见4.6–4.8）。

> **_注意：_** _上述的限制并不使比特币变得不完整。它们是效率、安全性而抗审查等属性之间的权衡结果。出于同样的原因，将比较运行在不同安全假设下的数字货币（例如以太坊和瑞波）是不正确的。_


### 比特币中的分散指什么？

那么，你现在基本了解了分散的概念以及比特币运作的一些关键方面。因此，在继续阅读后续章节之前，我们想再次强调比特币的一些特殊特点，也就是当说比特币是分散时指的是什么。基本上，这意味着在系统中没有特定的一方负责特定的流程。

> * _没有指定的一方或组织_  
> * _负责比特币的运作_  
> * _主导系统管理_  
> * _收取费用_  
> * _处理交易_  
> * _专门存储交易历史记录_  
> * _进行退款_  
> * _执行法院命令_


### \*\*\*常见问题\*\*\*

_“二千一百万比特币足够实现大规模采用吗？”_

有人可能会认为二千一百万枚硬币不足以满足大量用户的需求。然而，每枚硬币可以分割成至少一亿个部分，如果有必要，潜在地可以发布更新并增加硬币的可分性。

_“能否“停用”比特币？”_

在理论上，比特币有这种可能性。实际上，比特币的运行由位于世界各地的参与者维护。为参加需要一台计算机与互联网接入。因此，为进行“关闭”，就需要禁止使用计算设备与数据传输通道。此外，还需要执行这一禁令。这将需要各种政治力量的协调而迅速行动，包括相互对立的力量。这是特别困难的。

_“如果我想修改比特币协议会发生什么？”_

这是相当常见的，因此有一种常规的方法来提出协议改进的建议。相应的存储库称为“比特币改进提案”（Bitcoin Improvement Proposal; BIP）；那里社区成员讨论新的提案。任何人都可以到存储库中将他们的提案添加，如果社区与验证者同意更新，他们将切换到协议的新版本。

_“发行货币是否取决于它们的需求？”_

并没有这种依赖关系。值得一提的是，硬币的市场价格是否取决于其挖矿难度：总的来说，它并不会。唯一可以确定的是，一个硬币的成本（挖掘的价格）不大可能高于其市场价格。


## 2.2 比特币怎么用？

在这个子章节中，我们探讨数字钱包为使用比特币的核心属性：它们的类型、使用的特殊方面、实现的特点以及这些特点对安全级别的影响。

> **_钱包最常见的操作_**  
> * _余额检查_  
> * _用户密钥的生成与存储_  
> * _支付发送与接收_

为了说明数字钱包的概念，请参见图 2–7；这里你可以看到一个运行比特币钱包实现的移动应用程序的截图。在主屏幕（图中左侧）上，你可以看到当前余额、交易列表、每笔支付的金额以及其确认状态。你还可以切换到另一个视图（右侧）来接受和发送支付。

![图 2–7](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.7-user-interface.png "图 2–7")


### 比特币中的地址

比特币地址是接收方的标识符。为了发送付款，发送方需要知道目标地址。因此，对于接收方提前提供自己的地址是很重要的。一个常规的比特币地址看起来像这样：

**1BooKnbm48Eabw3FdPgTSudt9u4YTWKBvf**

在某种意义上，比特币地址是用户的别名，它并不与任何身份数据相关联—它（地址）相对匿名。然而，使用比特币的时候，这不意味着你总是保持匿名（欲了解更多，请参阅第7.1节）。

比特币的一个重要特点是用户自行创建他们的比特币地址（其他加密货币也是如此），通过启动一个特殊的软件生成新地址。一个用户可以创建的地址数量是无限的，这意味着你可以生成甚至十亿个地址，并且每个地址都可以用于接收与支付货币。

_每个地址都有一定的机密数据值，私钥，只有钱包所有者才能获得。_ 它用于在发送货币时证明对货币的所有权。

一个地址可以从私钥进行数学计算，因此如果有人掌握了你的私钥，他甚至可以在不知道地址的情况下访问货币。

加密货币与传统金融系统的一个关键区别在于地址的数量几乎是无限的。你可以向其中任何一个地址发送货币，反之在银行系统中，账户始终属于某个机构，并且必须有一个所有者。


### 比特币中的交易

_一笔交易是一组数字数据，它启动了数据库的更新（将比特币(BTC)从一个地址发送到另一个地址）。_ 这是一个简化的定义；实际上，交易结构更加复杂（更多细节请参阅 2.3）。请注意，交易是由用户的数字钱包直接创建而发送的，因此即使是数字货币开发者也不会干预这个过程。图 2–8 展示了一个特定移动钱包接口的截图部分，分别允许提供你的要求和发送付款。

![图 2–8](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.8-spend-and-receive.png "图 2–8")

> **_基本的比特币钱包类型_**  
> * _软件钱包_  
> * _硬件钱包_  
> * _集中式存储_


### 软件钱包

有些人使用软件钱包来存储比特币。软件钱包可以在智能手机、笔记本电脑或台式电脑上运行。 _软件钱包是一个处理密钥与交易的应用程序。_ 应用程序通过 _可信节点或集中式服务_ 连接到比特币网络，或者这该应用程序就是一个网络节点。

请注意，建议仅使用你信任的开发人员开发的软件钱包。这个警告是由于开发人员可能会在应用程序代码中引入漏洞，使他们以后能够封锁或窃取硬币。他们的代码也可能存在意外的错误，黑客以后可能会利用这些错误。

因此，建议使用开源软件钱包。这种解决方案允许你审计钱包的源代码并准备在你的设备上运行。

然而，软件开发者并不是唯一需要得到软件钱包用户信任的人。此外，用户需要信任分发该软件的服务（应用商店等），操作系统的开发人员以及用户设备的开发人员：在这些阶段任何地方都有可能潜在地实施后门。


### 硬件钱包

我们特别关注硬件钱包。这样的钱包是一台只能执行有限操作且控制界面有限的计算机。这样做的目的是最大限度地防止设备受到病毒注入，以及总体上消除设备被黑客的可能性。通常，其基本功能包括：私钥生成、私钥存储与交易签名。

基本配置的钱包没有额外的接口，只是一个小巧的设备。通常情况下，它可以连接到普通的个人电脑，并通过特殊软件进行操作。目前还有更先进的型号，硬件钱包可能配备有屏幕、键盘、电池、指纹扫描仪与无线通信模块（见图 2–9）。有些情况下甚至还有用于扫描收款地址的摄像头。这种钱包可最大程度地减少私钥被盗的风险，但并不能防止所有者遗失私钥。因此，许多硬件钱包提供私钥的备份功能。

![图 2–9](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.9-hardware-wallets.png "图 2–9")

还有很有意思的一则故事：有个人在 eBay 上从一个未知卖家那里购买了一个二手的 Ledger 硬件钱包[26]。在钱包盒子里，有一张纸（见图 2–10），上面记录着一个助记短语，附带一条说明："使用这个短语来恢复你的钱包。" 设备的新主人输入了建议的单词，几天后发现他所有的比特币都丢失了。这是怎么回事呢？钱包的卖家（之前的所有者）知道这个助记短语。因此，他可以访问钱包新主人使用的地址。换句话说，前所有者说的是："把你的钱放在我有钥匙的保险箱里。" 因此，设备买家已经永久性地失去了所有的硬币。这个错误发生在设备买家没有生成新的密钥。

![图 2–10](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.10-mnemonic.png "图 2–10")

理论上，你可以想象一个情况，即一个用户的私钥与另一个用户的私钥相同。但实际上，这几乎是不可能的。是因为可能的私钥数量是  2<sup>256</sup>。这个数字大于宇宙中的原子数量。因此，对于一个长度为 24 个单词的助记短语，这种巧合的概率几乎为零。

> **_注意：_** _如果生成私钥的软件是基于一些明显的数据初始化的，比如用户的密码或当前时间，那么猜测与匹配密钥的概率会增加。_


### 集中式存储

有一些在线服务实现数字钱包的基本功能，但是在其自己的服务器上存储私钥。他们的用户会产生一种错误的感觉，认为自己拥有比特币钱包，而实际上是一个特定的远程服务来执行操作与存储货币，而不是用户自己。显然，使用这种服务，你不控制你的货币，必须完全信任第三方组织。

有一家最大的集中式存储提供商是 Coinbase。事实上，它是一种比特币银行，用户注册就像注册 PayPal 一样（登录、密码等）。然后，用户会得到一个比特币存款地址以及一个用于远程管理他的货币的应用程序。实际上，用户只是从集中式服务得到保护资金的承诺。使用集中式钱包，你管理资金的能力是有限的：你只能发送比特币提现请求，然后“希望”它会被处理。

大多数交易所都按照集中式存储的原则存储用户的数字货币，因此它们需要用户最高程度的信任。


### 钱包备份

由于私钥是证明拥有加密货币并花费它们的唯一方式， _因此拥有加密货币的所有者取决于对私钥的掌握_ 。所有比特币钱包都实现了以下功能：生成接收货币的地址、显示余额和交易历史、发送支付、创建钱包备份以及从备份中恢复钱包。

有一天在一个名叫詹姆斯的人的生活中发生了很有趣的一件事。他有一个硬盘存储着可以访问 7,500 BTC 的密钥。由于当时比特币的价格很低，詹姆斯把硬盘扔掉了。当这种加密货币的价格上涨时，詹姆斯意识到自己失去了多少钱，并开始在垃圾堆中寻找他的硬盘。他甚至向市政当局提出请求，以允许他在垃圾堆中搜寻，但被拒绝了。最终，詹姆斯花了很长时间追寻各种办法寻找存有他加密货币的硬盘，但所有的努力都没有成功[27]。

我们特意强调备份钱包的重要性，即使在你收到第一笔付款之前，这也是你应该执行的操作。针对此功能，有得到了不同钱包软件开发人员的支持一项技术规范。在不同开发者的钱包里通常可以还原备份副本。

如果用户在每次付款后是否有必要备份钱包感到困惑，答案将取决于特定钱包的执行。通常情况下，钱包会为每次付款生成新的地址和相应的密钥，这意味着你需要每次重新将它们到备份副本中转移。不过，有些钱包使用所谓的确定性密钥生成（ _确定性钱包_ ）。在这种情况下，一次备份就足够了。

对于确定性钱包，存在着钱包的主要密钥的概念。所有新密钥都是从该主要密钥数学生成的。这意味着用户只需一次性制作钱包的主要密钥备份，然后可以随时使用它，在其他设备和/或其他软件中恢复对硬币的访问。通常，钱包会使用特殊的编码方式，让用户能够用易记的助记短语表示主要密钥。

一个助记短语的例子如图 2–11 所示。在实际操作中，将助记短语写在纸上并存放在非常安全的地方是很方便的，需要时可以将其输入到另一个钱包中。为了方便存储密钥，你可以使用密码管理器。密码管理器允许用户记住 4 到 6 个单词，而不是将整个助记短语都记录下来。用户随后需要这些特定单词来打开密码管理器并访问他的所有私钥。

![图 2–11](/resources/img/volume-1/2.2-how-to-use-bitcoin/2.11-mnemonic-example.png "图 2–11")

### \*\*\*常见的误区\*\*\*

_如果将私钥存储在设备上，它们就不会被窃取。_

最常见的窃取硬币的方式是使用软件病毒窃取私钥。因此，不建议将大量硬币绑定到不受保护的设备上存储私钥。

_如果将私钥存储在没有互联网访问权限的设备上，就不必担心安全问题。_

这种方法其实可以提高密钥存储的安全性并防范大多数远程攻击，但这并不意味着以这种方式存储的私钥就是绝对安全的。

_量子计算机可以轻易破解比特币的加密系统。_

事实上，比特币根本不使用加密。它使用数字签名和哈希函数的组合，使它们不易受到量子计算机的攻击（参见3.2）。

### \*\*\*常见的问题\*\*\*

_“有没有处理交易纠纷的机构？”_

没有这样的中央组织。有关交易的纠纷是在比特币协议层面解决的。但在其使用过程中可能会发生协议外的争议。为了解决这些问题，使用所谓的托管代理人。这意味着在交易过程中，货币会在发送方与接收方之间被冻结。关于如何分配这些货币的决定是由调解人员参与进行的。在这种情况下，调解人员必须得到交易双方的信任。

_“你为什么不能个性化一个钱包——将其绑定到特定的人？”_

比特币作为支付系统协议并不要求用户进行身份验证。而且，这不是验证交易的独家要求（对于此，数字签名足够了）。所有者是生成这样的签名的。因此，签名可以属于一个人，几个人，甚至是一个机器人等。至于个性化，比特币数据库中没有身份数据，但整个交易历史是公开可见的。意思是如果你设法将特定地址与特定个人关联起来，那么你就能以一定的概率对有些用户进行无法匿名。

_“如果有数十亿新用户拥有钱包，比特币会减速吗？”_

如果你只是打开一个钱包并创建许多地址，这不会影响网络与数据库。重要的是交易的数量。因此，重要的不是用户的数量，而是他们活动的规模。

_“是否可能创建无需服务器与中心（点对点）的钱包？”_

是可能的。然而，在这种情况下，移动设备的要求增加：互联网连接性、在另一设备上的长时间恢复、能耗以及设备内存。


## 2.3 比特币中的交易概念

在本小节中，我们描述了有关比特币交易概念的一些基本思想：比特币交易的定义，它在共享数据库中如何验证，用户如何证明他拥有即将想花费的硬币，比特币中费用是如何确定而设定的，以及冲突交易是什么。


### 比特币交易是什么？

正如我们先前指出的， _交易是一组数字数据，用于更新特定数据库（反映了硬币从一个地址转移到另一个地址）_ 。交易特别确定了转移金额、接收者地址以及访问转移硬币所需的条款。

> **_交易的生命周期_**  
> * _创建_  
> * _传播_  
> * _验证_  
> * _包含在区块中（验证）_  
> * _拒绝（如果后来的区块被无效化）_

让我们探讨构成比特币交易的数据。比特币中的任何交易都包含正在花费的硬币的来源（即，指向接收这些硬币的交易的引用），硬币所有权的证明，新所有者的地址（更广义地说，硬币可以被花费的条件），以及转移金额。

> **_交易主体中的数据_**  
> * _正在花费硬币的来源_  
> * _硬币所有权的证明_  
> * _转移的地址（支付条件）_  
> * _转移金额_

> **_注意：_** _在最简单的情况下，一个地址与一对密钥（公钥和私钥）相关联，用于生成和验证数字签名。私钥用于验证交易，并且只有地址所有者知道。所有可能地址的数量是巨大的，而可能的私钥数量更大。因此，猜测某人地址的私钥几乎是不可能的（考虑到密钥生成是真正随机的过程）。重要的是不要混淆地址的概念与账户的概念，因为比特币协议中没有账户。_

使用常规收据的类比可能有助于更好地理解比特币交易的概念。从某种意义上说，普通货币就是一张收据。每张收据包含数据：收款人是谁，付款人是谁，用途是什么，支付金额，日期与签名（图 2–12）。

![图 2–12](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.12-traditional-receipt.png "图 2–12")

> **_图里的文本：_**  
> _“收据_
> 
> _签署者特此确认收到约翰·史密斯先生支付的五千（$5,000）美元，作为2018年5月13日所欠款项的全部支付、满意与解除。_
> 
> _签字盖章于2018年5月30日。	见证人”。_

比特币交易就像合法的收据一样，必须满足特定要求才能被视为正确。第一，它必须转移发送者所拥有的硬币。第二，这些硬币只能被花费一次。

_验证是根据协议规则检查数据（交易、区块等）的过程。_

在验证过程中，每笔交易都会被检查，以确保发送者拥有他试图花费的硬币。通常情况下，交易发起者通过使用数字签名来证明硬币的所有权。此外，需要验证一笔交易是首次且仅一次地花费现有的硬币。

纸质收据的真实性很容易验证，但可以说数字收据可能被复制多次，使得难以确定原始收据。假设爱丽丝给了鲍勃一张收据。如果鲍勃被证明是个骗子，你可以假设他可能会带着他的，比如说，五个朋友，所有人都有相同的收据，并且所有五人都向爱丽丝要钱。因此，如果每张收据都具有与原始收据相同的真实性，那么爱丽丝肯定会陷入尴尬的境地。在纸质形式中，相对容易区分副本与原件；在数字形式中，却并非如此。这些类似的问题显然需要它们的解决方案。

在比特币中，解决方案是将交易组合的结构单元成称为区块。区块是由标头与表示一组交易的主体数据组成的数据单元（通常是非空的）。区块通过哈希值相互链接（更多细节请参考3.1节），并以这种方式存储在共享数据库中。这种方法确保了所有交易数据库的不可变性。


### 交易验证

纸质支票（见图 2–13）在美国与许多其他国家仍然很常见：人们会收到支票作为工资，支付房租，把它们兑现到银行等等。在支票上，你可以看到其序列号（如图 2–13 中的 12982），这对每张支票都是唯一的（不能兑现两张相同序列号的支票）。

![图 2–13](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.13-paper-check.png "图 2–13")

比特币如何解决对原始“收据”（在其情况下称为交易）进行复制保护的问题呢？在支票簿中，每张支票都有一个顺序号，这是其唯一标识符。但在比特币所在 _分散环境_ 中，由于所有参与者都是异步工作的，因此不可能对交易进行枚举。因此，在比特币中，为了区分一个交易与另一个交易，存在着一个全局唯一的交易标识符（ _txid/wtxid_ )，即从交易数据计算出的所谓 _哈希值_ （更多细节请参见3.1）。如果多个交易具有相同的哈希值，只有其中一个会被认为是正确的。但是，可能存在例外情况，这将会单独描述。

比特币的一个有趣特性是，在任何交易中都可以展示“硬币来自哪里”（有对前一笔交易及其哈希值的引用）。这就是比特币中验证传输硬币来源的方式。可以从 图2–14 中以示意方式看到，新交易如何花费来自前一笔交易的硬币。

![图 2–14](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.14-how-transactions-work.png "图 2–14")

> **_交易验证的基本阶段_**  
> * _验证已花费的硬币在会计系统中存在的条件_  
> * _验证硬币首次花费且不超过一次的条件_  
> * _验证发送者（交易发起者）提交的硬币所有权证明_

以下是工作原理：为了花费硬币，用户必须说明他从哪里获得了硬币并证明所有权。如果硬币的来源没有引起额外的问题——没有其他交易花费了相同的硬币且用户已经证明了所有权——那么剩下的就是等待系统中其他成员对此交易的确认。

交易确认的过程要求参与者首先检查这些交易，然后相互达成一致，确定他们认为哪些交易是正确的。这意味着为了被确认，一笔交易应该得到大多数活跃参与者的同意（见2.5节）。在比特币中任何人都可以参与确认交易的过程（见图 2–15）。

![图 2–15](/resources/img/volume-1/2.3-concept-of-transaction-in-bitcoin/2.15-nodes-iteraction.png "图 2–15")


### 比特币中的手续费概念

比特币中的交易模型规定以比特币支付的交易手续费。发送者在创建交易时包含手续费，并且默认情况下应该高于某个阈值。尽管在实践中，用户可以设置零手续费，这样的交易也会被视为正确。手续费在技术上是给予确认交易的参与者的额外奖励。

随着比特币的日益流行，网络中新交易的流量显著增加。在比特币中，区块大小受协议规则限制（一个区块的最大基本大小为 1 MB）。有时候会出现新交易流量超出比特币容量的情况。在这种情况下，每个网络节点将所有未确认的交易排列成一个队列，支付更高手续费的交易排在前面。实际上，比特币中的交易可以被视为共享数据库中的数据记录。这个数据记录的价格是交易中定义的手续费与交易字节大小的比值（或 _其权重单位大小_ ；见4.6节）。因此，队列末尾的交易可能会长时间未被确认。因此，这引发了一个难以预测的市场，即在比特币数据库中添加数据单元的价格问题，也就是你应该支付多少费用才能在合理的时间内确认你的交易（见4.7节）。

应用于比特币交易中定义费用的分散原则可以通过一个例子来说明：你可以将在比特币中可能确认的交易比作想要进入议会的政党。哪位议员能进入选举名单的前列取决于他的“贡献”数量（可惜这种做法在许多国家都很流行）。议员们将根据这种“贡献”的总额进行“排序”；那些提供较少的人将无法成功。很可能他们不得不等待下一次的议会选举，再次尝试。由于比特币中手续费的高波动性，这成为一个问题，因为发送到网络的交易可能长时间未被确认（甚至永远未被确认）。然而，这个问题后来被解决了（有关手续费波动性与解决此问题的更多细节，请参见4.7节）。

> * _交易根据其权重单位支付手续费。_  
> * _一个区块的最大基本大小为 1 MB。_  
> * _验证者按数据记录价格降序排列交易。_  
> * _数据记录价格较低的交易可能会长时间未被确认（甚至永远）。_


### 冲突交易的概念

一条良好形成的区块链包含彼此不冲突的交易。你可能想知道什么是冲突交易。如果约翰在一笔交易中向玛丽转移了 5 个硬币，后来又在另一笔交易中将相同的 5 个硬币发送给了保罗，那么显然这两笔交易不能同时记录在同一版本的历史中。因此，只有其中一笔交易会得到完全确认。问题是：这 5 个硬币会给谁—玛丽还是保罗？在完全确认之前，无法确定哪笔交易肯定会被接受。你只能假设那笔更有可能被确认的交易是先在网络中传播的，或者更可能是支付了更高手续费的交易。

### \*\*\*常见的误区\*\*\*

_比特币协议源代码是封闭的，只有创建者才能进行更改。_

恰恰相反：在不同的编程语言中有多个对同一协议的实现；大部分的源代码是开放的，可供学习、修改等。

_普通的工程师与开发者不能提出改进比特币协议或开发自己的钱包。_

任何人都可以提出协议修改，甚至编写自己的网络客户端或应用程序。现有的比特币社区对新提议持开放态度，主要由独立的热心人组成。尽管通常是更有经验的参与者提出最有价值的协议修改。

### \*\*\*常见问题\*\*\*

_“生成新地址是否需要连接到比特币网络？”_

不，你不需要网络连接。数字签名密钥与地址的生成是在本地进行的。这个过程不依赖于其他用户。

_“如果两个不同用户的私钥匹配那怎么办？”_

这样的巧合概率非常小，但确实存在，因此通常被忽略。但如果由于生成错误或其他不太可能的原因发生了这种情况，那么实际上两个用户将在资产表上看到相同的金额，并且能够访问相同的硬币，这些硬币只能被花费一次。

_“谁确定交易的手续费？”_

手续费的金额在交易主体中指定。由创建并签署交易的人确定。根据比特币协议规则，零手续费交易是正确的。但是，大多数网络节点的软件会在交易低于必要最低值（随时间变化）时简单地忽略该交易。

_“是否确实可以以某种方式分析所有硬币的来源历史，从而侵犯比特币中某些交易的隐私？”_

是的，确实有这样的机构，它们分析比特币交易的大量直接与间接数据。这些机构可以以某种概率确定哪些硬币属于谁，以及它们被用于何种目的。反过来，接受比特币的服务，例如集中式交易所，可以向这些机构申请信息。像Kraken这样看重声誉的服务，如果 _硬币来源_ 的历史令人怀疑，就不会接受支付（见4.1节）。然而，有些方法可以增加比特币的隐私级别：像 Monero 与 ZCash 这样的加密货币更加注重用户匿名性（见7.2节）。


## 2.4 比特币的高层架构

在这个小节中，我们将讨论比特币的工作原理，审查共享数据库与交易的集体处理特性，描述比特币达成共识的基本原则，并将比特币与传统支付系统进行比较。

比特币的架构受到在极具敌意的互联网环境中运行的需要的严重影响。这个环境是匿名的，在法律执法几乎不起作用，充满了黑客，没有负责任的方，也没有任何保证。因此，它的推出证明了可以创建一个开放数据库的金融系统，任何人都可以在没有注册的情况下使用。基本原则如下：所有用户都存储数据库的副本；用户遵循相同的规则，并且只信任他们自己可以验证的内容。 _这就是会计系统分散性的本质所在。_


### 比特币的架构

每个用户都有他们的本地数据库的副本，以严格有序组织的的交易集合链即区块。在比特币中，交易一直被视为未证实到在区块加入了。区块被诚实参与者确认以后，无法未被察觉地修改或删除共享数据库中的交易。示意性的，这种数据组织形式可以被表现为区块的链（chain of blocks），其中每个区块是一组交易（见图 2–16）。中本聪将这种数据存储格式称为 _“区块的链”_ （ _“block chain”_ ）；后来它被称为了 _“区块链”_ （ _“blockchain”_ ）。

![图 2–16](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.16-blockchain-based-database.png "图 2–16")

区块链技术允许以一种方式组织数据库，使得所有区块相互连接（图 2–16 中的绿色区块是所谓的 _创世区块_ ；有关更多细节，请参阅第4.3节）。由于区块彼此链接，无法更改一个区块的内容而不影响所有后续的区块。

谁验证交易以及它们如何进入区块链？任何用户都可以创建一个符合协议的正确交易，将其发送到网络，它将被传输给所有其他参与者。然后，每个验证者都会独立验证交易的有效性，并将其添加到他们的区块中进行确认；当交易被添加到新区块之一时，它可以被视为已确认。链中的每个新区块都是每个参与者并行而独立工作的结果（图 2–17）。

![图 2–17](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.17-users-work-on-the-chain.png "图 2–17")

谁创建区块并选择其中包含哪些交易？在图 2–18 中，可以看到每个区块是由其中一个用户创建的，因此延伸了主链。创建者向其他网络节点提议她的区块。它们验证此区块，并将其添加到其数据库副本中，如果此区块符合协议规则。如果大多数参与者添加了提议的区块，它就进入链中，并且区块中的交易将被确认。需要理解的是，只有一个区块被添加到链中。由其他参与者生成但未进入链的所有其他区块都将被丢弃。被丢弃的区块（ _孤立区块_ ）的交易未被确认，并可用于未来确认。这些操作步骤序列是在 _分散环境_ 中实现共识所必需的。

![图 2–18](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.18-how-users-create-block.png "图 2–18")

> **_比特币会计系统中的流程_**  
> * _会计系统的审计_  
> * _交易验证_  
> * _更新管理（治理）_

_审计_ 是验证当前数据库状态与已进行交易完全符合的过程。

_交易验证_ （也称为挖矿或区块创建过程）是验证交易是否符合协议规则，并将其添加到一个区块（随后添加到系统数据库）的过程。

_更新管理_ （治理）是确认系统功能的过程，并在最佳情况下将系统的所有节点转化为统一的运行模型。


### 比特币会计系统中参与者的角色

比特币允许每个参与者管理上述提到的过程，因此可以承担以下任何角色之一。

> * _用户_  
> * _审计员_  
> * _验证者_  
> * _开发者_  
> * _质量工程师_

比特币的另一个特点是每个系统参与者自行决定（ _无需权限_ ）要扮演哪种角色。


### 比特币达成共识的条件

如上所述，对区块链的整体状态进行任何更改之前，参与者必须达成一致。如果参与者已经检查了区块的正确性，并且每个人都同意将其添加到他们的链中，那么该区块就会被添加，并且所有随后的区块将以其为基础创建。达成一致往往是一个非常困难但至关重要的任务。没有解决方案，无法实现 _分散系统_ 的可靠运行。因此，其关键组成部分之一是 _共识机制_ 。

_共识是用户对于他们认为正确的交易达成的一种一致状态，这种是在“讨论”状态_ （关于交易、区块、节点状态的消息交换）期间形成的。在比特币中，达成共识是所有诚实参与者的目标，但显然，并不能盲目地指望大多数比特币参与者是诚实的这一事实。因此，比特币协议设计得可以在系统中即使在以下情况下也能达成共识。

> * _网络节点数量未知_  
> * _参与者可以匿名_  
> * _验证者可以匿名_  
> * _系统参与者彼此不信任_  
> * _没有单一的管理机构_  
> * _恶意节点数量未知_

理想情况下，每个人都应同意已确认交易的清单。然而，在实践中，当进行协调时存在许多困难。正如我们已经提到的，比特币旨在在极其恶劣的互联网环境中安全运行。在这里，所有参与者都是匿名的，彼此不信任；他们的数量通常是未知的，多半很大；每个用户的投票可以轻易伪造（如果考虑传统的投票方式）。在网络上直接存在一台计算机程序，通常由一个人控制。但是，可能这个特定的软件并非由诚实的参与者运行，而是由恶意个人控制的机器人。而且，甚至可能出现对于一百或一千个用户只有一个真实人物的情况。


### 比特币中如何达成共识？

确定了任务复杂性——在一个不信任且任何参与者可能潜在恶意的环境中达成整体共识，我们可以探讨关键问题，即如何做到这一点。

在分散系统中达成共识的原则可以通过以下例子来解释。想象一场纸牌游戏。在这个游戏中，没有“庄家”负责控制游戏：所有参与者都知道规则，并有义务遵守它们。所有的动作（在我们的案例中是交易）都是公开的，并由游戏的所有参与者检查。如果有一个玩家作弊，其他玩家会立即注意到，作弊者将被排除在外（见图 2–19）。从牌堆中发放新牌也是按照同样的原则进行的。规则决定玩家拿牌的顺序以及这些牌的数量。

![图 2–19](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.19-poker.png "图 2–19")

让我们以图表形式绘制共识（见图 2–20）。所有用户都存储着他们本地的数据库副本，这些副本是使用区块链技术组织的。一致认可的状态意味着在同步后所有诚实用户的副本是相同的（即所有参与者的数据库副本具有形成相同链的同一数据的区块）。

![图 2–20](/resources/img/volume-1/2.4-high-level-architecture-of-bitcoin/2.20-consensus-reaching.png "图 2–20")

> **_注意：_** _在比特币的语境中，共享数据库、区块链与交易历史这些概念具有相同的含义。_

> **_比特币与传统支付系统相比_**  
> * _比特币不需要注册_  
> * _交易不包含任何用户个人数据_  
> * _支付地址只能使用一次_

许多人经常想知道他们的比特币交易有多隐私。事实上，每个人都可以看到所有地址之间的所有交易，但很难确定是谁在每个比特币地址背后，以及追踪特定用户的交易历史。为了更好地理解比特币中的隐私性，让我们用传统金融系统来做个类比（见表 2–1）。

表 2–1 传统支付系统与比特币相比  
| 传统支付系统 | 比特币 |
|---|---------|
| 非透明的交易历史与受限审计访问 | 透明的交易历史；所有更改对所有人都是明显的 |
| 关于更改的集中决策（治理） | 交易数据库的集体更新 |
| 对负责机构需要完全信任 | 仅对数学与程序代码进行信任 |
| 恢复账户访问的可能性 | 自我管理访问密钥 |
| 破产风险与服务拒绝 | 每个用户承担与其密钥和软件管理相关的所有风险 |

银行承担着存储与记账的职能。它接收客户的钱而贵重物品，并承诺记住欠多少钱，欠钱给谁。总的来说，这种方式很方便，因为可以通过信用卡访问资金，只有持卡人才能使用这张卡。这样可以避免客户携带现金，而且遗失的卡可以轻松替换。然而，客户的资金完全由银行管理，并受制于它们的集中决策。如果银行“忘记”欠多少钱给有人，客户将会遇到问题。这是 _便利而安全之间的典型权衡案例_ 。

在比特币出现之前，这基本上是社会进行金融关系的唯一可能方式——用户只能希望银行履行其义务。因此，银行越来越多地采用了这种特定的方案，并随着时间的推移，开发了许多各种的实现方式。

比特币运行时不受传统支付系统常见的限制。从某种意义上说，比特币补充设立的金融系统；它展示替代架构的可能性，以及一个没有任何管理机构的会计系统。

### \*\*\*常见的误区\*\*\*

_比特币的创造者可以改变货币规则或窃取用户的硬币。_

这是不正确的。比特币的创造者拥有与其他用户相同的能力。

_要在比特币中发送与接收付款，你不需要注册。_

在比特币中，没有注册用户的数据库，也没有决策中心。每个交易都是单独验证的，任何人都可以验证数字签名。通常，集中式系统使用会话认证，这意味着一旦用户经过验证，他不需要为每个下一个动作重新进行此过程。同时，在比特币中，用户被假设为为每笔新支付生成一个新地址。

### \*\*\*常见问题\*\*\*

_“比特币硬币是什么样子的？”_

比特币硬币没有实际的物理形态，而是抽象定义的。这个抽象概念相当清晰地表明了数字货币的特性，因为共享数据库记录了其中所有执行的操作——物理硬币的需求根本不存在。

_“如果法院对一笔交易提出异议，并下令取消该交易会发生什么？”_

比特币没有全球的司法管辖权，因为没有法律规定开源协议。由于比特币的决策是通过共识方式分散进行的，什么操作也不会影响数据库的整体状态。法院当然可以决定取消交易，但很可能无法执行。唯一的例外是大多数参与者支持法院命令的情况。尽管在当今情况下很难想象这样的仲裁做法。


## 2.5 比特币中交易的确认

我们之前提到过，鉴于参与者的匿名性与可能存在未知数量的网络犯罪分子，比特币可以可靠运行。在本节中，我们将尝试详细描述这是如何实现的。此外，我们将解释与交易全确认相关的问题（即先前确认的交易如何再次变为未确认状态），以及为何在这种情况下无法实现交易的最终性[28]。此外，我们将探讨比特币在 _分散环境_ 中如何实现交易确认。

在未确认的交易中，任何用户都可以选择他认为正确的交易，然后将它们合并成一个区块，并将此区块提供给网络中的所有其他节点。区块可以被多数节点通过或拒绝。如果验证者按照协议规则诚实地工作，并且比其他人更早提出了通用链的下一个区块，那么其他诚实的参与者将接受此区块。


### 区块的创建与交易

一个正确创建的区块包含了之前未经确认的交易，且这些交易之间没有冲突。每个区块必然包含前一个区块的哈希值。这样，每个新的区块不仅确认了其中的交易是正确与已确认的，还确认了它所指向的前一区块中的交易的正确性。另一个特点是协议调节了一个资源密集型问题的难度用于区块的创建，使得平均每10分钟就能向共享数据库添加一个新的区块。

> **_一个正确创建的区块_**  
> * _包含正确的交易，这些交易到目前为止还没有被确认，并且彼此之间没有冲突_  
> * _包含了前一个区块的哈希值_

新的区块是如何创建的？特定用户的计算机存储着整个区块链，该链已经通过比特币软件进行验证并被视为正确。系统中用户之间的货币转账不断发生，并且新的未确认交易被传播到所有节点。每个用户的计算机验证新交易的流动，并将其认为正确的交易添加到区块中（见图 2–21）。随后，它通过指示到前一个区块，来表明链的连续性，以便操作历史清晰可见——这就是数据库完整性维持。然后，计算机将其创建的区块建议为通用链的延续，提供给其他节点。

![图 2–21](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.21-transaction-verification.png "图 2–21")

如果一个用户运行一个作弊的网络节点，并向其他用户提供虚假区块，会发生什么？更糟糕的是，如果这是一组入侵者启动了一整个修改网络节点的僵尸网络，这些节点忽略了协议规则，那会怎么样？在这种情况下，诚实用户如何达成共识？这个明显的风险是由中本聪解决的，接下来我们会解释是如何解决的。

> **_关于新交易的共识_**  
> * _任何用户都可以从未经确认的交易中选择正确的交易，并将其添加到一个块中_  
> * _大多数验证者的决定将接受或拒绝所提出的块_

### 新区块的要求

对于潜在的虚假区块问题的解决方案如下：如果在创建区块时消耗了一定数量的计算资源，则该区块被视为正确。这意味着用户必须提供一个解决资源密集型任务的方案，以便所有其他参与者可以检查而接受他的区块。

通过这种方式，一个恶意行为者无法用大量的虚假区块欺骗其他参与者。需要执行的任务还解决了其他两个考虑因素：新区块应该以多快的频率出现，以及如何确定将区块按照什么顺序添加到共享数据库中。工作原理是这样的：每个人都开始创建一个新的区块，但只有第一个解决 _资源密集型任务_ 的人才有权将他的区块提供给其他人。

因此，拥有更多计算能力的用户更有可能第一个完成任务。特定参与者成为第一个完成的概率是该参与者拥有的总系统计算资源的百分比。

> **_区块创建流程_**  
> * _需要提供一个资源密集型任务的解决方案_  
> * _首先解决任务的人通过向其他人发送他的提议区块来通知所有人_  
> * _成为第一个的概率取决于参与者资源在系统所有资源中所占的份额，以及数据传输通道的延迟_

这就是比特币中挖矿的核心所在，实际上意味着解决一个资源密集型的任务。这个任务对网络中的所有节点来说难度都是一样的。挖矿对比特币至关重要：诚实的用户参与挖矿以维护交易确认过程的可靠性。掌控更多计算能力的人更频繁地创建区块。让我们通过下面的例子来看看它是如何运作的。


### 用户之间的竞争原理

假设系统中有 10 个验证者在运行。每个验证者都有一台挖矿计算机，在单位时间内计算相同数量的哈希值（见图 2–22）。我们将这个计算能力定义为1，因此系统的总能力为 10。因此，每个验证者控制着这个容量的 1/10，并且有 0.1 的概率首先创建区块。

![图 2–22](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.22-ten-validators.png "图 2–22")

现在，让我们假设爱丽丝注意到挖矿似乎比以往胜从前时候都更有利可图，因此她购买了另外几台计算机（见图 2–23）。在那之后，系统的总计算能力将会是 12（10 + 2 = 12）。她现在的份额是 3/12（或 1/4），而其他每个验证者的份额仍然是1/12。因此，爱丽丝首先发现新区块的概率为 0.25，而其他验证者的概率将等于 0.08(3)。因此，即使拥有较小比例的处理能力，验证者仍然有可能首先创建新区块，但概率会更低。

![图 2–23](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.23-ten-validators-with-diff-power.png "图 2–23")

不过，如果攻击者解决了资源密集型任务会发生什么呢？如果他的区块包含了按照协议规定正确的交易，但诚实的用户仍然不同意这个区块呢？听起来很混乱，对吧？毕竟，网络中的成员是匿名的，你无法预先知道谁是诚实的，谁是恶意的。


### 区块的传播

回答关于特定区块的争议如何解决之前，让我们观察一下区块如何在网络中传播。这样，网络中的一个节点找到了问题的解决方案并创建了一个区块。接着，这个区块被广播到网络中。也就是说，创建了区块的节点将其传输给它连接的所有节点。

之后，接收到区块的节点验证它是否符合协议规则。有两种可能的情况。第一种情况是节点认为该区块有效，可以添加到区块链中；它会保存区块的一个副本并将其进一步传播到网络上。而在第二种情况中，节点不同意所接收的区块是有效的，那会发生什么？


### 解决分歧

为了回答上述问题，我们将考虑如何解决关于交易确认的分歧。如果一个参与者不同意另一个区块，根据协议规则，可以在区块链的相同高度创建另一个备选区块。

> * _反对的参与者创建一个备选区块_  
> * _备选区块可以包含相同的交易_  
> * _网络节点保留两个备选版本_  
> * _每个参与者创建区块，延伸其中一个特定版本的链_  
> * _最长的链"获胜"（即创建所需工作量最大的链）_

_区块的高度是从创世区块（图 2–24）开始计算的区块在链中的序列号。_

_创世区块是高度为零的区块。_

![图 2–24](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.24-block-num.png "图 2–24")

因此，至少两个参与者之间的分歧可能会导致一种情况我们拥有两个区块，它们都指向相同的前一个区块。这些区块可以包含相同的或冲突的交易。在这种情况下，如果所有其他网络节点都认为这两个区块都是正确的，它们可以保存这两个建议的选项，但每个节点仍然需要确定哪个区块作为创建下一个区块的基础。这样，不同的参与者做出自己的选择，基于现有区块之一创建后续区块，并在他们的新区块中指定一个链接，扩展链的特定版本。协议规则规定，在两个正确的版本中，应该优先考虑那个花费了更多计算资源来创建的版本（即，由大多数参与者支持的版本）。

解决分歧的过程可以通过图表（图 2–25）来展示。这里有一个节点网络。这些节点在它们的本地数据库副本中可能存储了相同高度的两个备选区块。假设图中左侧的用户选择了顶部的区块作为主要区块，而右侧的用户选择了底部的区块。每个人都继续努力创建下一个区块来支持不同的版本。

![图 2–25](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.25-disagreement.png "图 2–25")

然后，某个用户创建并提出了一个新的区块，它指向两个备选区块中处于顶部位置的区块（根据上图）。他的提议被网络中的所有其他参与者接受。即使最初选择了另一个备选区块的人，也经过了检查并接受了更长的链（图 2–26）。

![图 2–26](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.26-disagreement-resolved.png "图 2–26")

这就是所谓的 _最长链规则_ 。它指出，在所有参与者认为正确的链中，他必须选择最长的那个。换句话说，他选择在创建过程中投入更多工作的链。

此外，一个诚实的参与者只会转向最长的链，前提是该链是根据协议规则创建的。这意味着任何试图破坏链条的人都将被阻止违反比特币规则，即使拥有大量计算能力也无法逃脱。


### 完整交易确认的概念

在比特币中，可能最重要的事情是确认交易的过程。 _如果一笔交易被包含在最长的链中，并且在包含该交易的区块之后还有5个区块，那么该交易就可以被认为是完全确认的。_ 换句话说，你需要等待至少6个确认，而不是1个确认。由于平均每10分钟创建一个新的区块，一笔交易的完全确认大约需要一个小时（然而，在某些情况下，人们可能希望等待更长的时间来降低遭受攻击的风险）。

为什么要等待6个确认的答案在于数学计算：如果存在两条备选链，其中一条领先另一条5个区块，并且在两条链中投入了相同的计算能力，那么较短的链超越较长链的概率非常小。在他的文章[15]中，中本聪基于以下命题进行了数学证明。

$$ q_{z}= 
\begin{cases}
1 & \text{ if } p \leq q \cr \\ 
(q/p)^{z} & \text{ if } p \gt q 
\end{cases} $$ 

其中， _p_ 是下一个区块由诚实节点创建的概率； _q_ 是下一个区块由攻击者创建的概率；而 _q<sub>z</sub>_ 是攻击者在某一时刻追上主链的概率，假设攻击者在其备选链的位置 _z_ 个区块以前。

例如，如果攻击者拥有所有验证者计算能力的10％，成功攻击的概率小于0.1％（假设诚实节点在网络中以同样快速的消息传递运行）。


### 区块创建的奖励

另一个重要问题是激励用户解决资源密集型任务、创建新区块并确认交易的动机，从而消除入侵者的机会。

我们已经描述了区块创建、货币发行和交易确认费用等过程。在比特币中，这些过程之间关系紧密。根据协议规则，区块的创建者可以将一定数量的硬币发送到自己的地址，这些硬币实际上是从无处来的，意味着这些硬币之前并不存在；这就是货币发行的工作原理。奖励的总额是根据发行的硬币加上区块中所有交易的费用来计算的。

**奖励 = 新（发行）硬币 + 费用**

2018 年，创建一个区块的奖励是 12.5 个硬币加上费用。需要注意的是，出于安全考虑，验证者在区块创建后并不会立即收到这个奖励。这里有一个特殊的参数叫作 _coinbase 成熟度_ [29]。它表示验证者获得奖励所需的最小交易确认次数。在比特币中，该参数的值为 100，这意味着在区块创建后，奖励（费用 + 发行的硬币）仅在后续 99 个区块确认该区块后才可用。

如前所述，新区块的平均出现时间是每 10 分钟一次，不受系统总计算能力。这是通过使用 _困难度参数_ 来实现的，每个节点都会独立计算该参数，使用已知的算法来规定解决资源密集型任务的要求。随着系统计算能力的变化，难度参数会随时间重新计算。

所有网络节点共同在 10 分钟内创建一个新区块。对于单个参与者，创建一个区块可能需要几小时、几天，甚至几年时间。但根据概率理论，假设所有验证者都在一个区块链上工作，平均每 10 分钟就会创建一个区块。这也意味着在某个时刻关闭系统一半的计算能力将把平均区块创建时间延长到大约 20 分钟。直到重新计算难度参数之前，这种延长状态将保持不变。

据信，只有控制超过 50% 的计算能力的人才能影响交易的处理。当系统中大部分计算能力由诚实的验证者控制时，比特币被认为是安全的。因此，对比特币作为一个会计系统的信心取决于成千上万的人难以合谋对抗一个特定用户（这与中心化系统相反，其中容易实施与隐藏审查）。这意味着信任比特币的用户可以确信成千上万的人不会同时与他意见不合。一个对手控制系统超过一半计算能力的攻击被称为 _51%攻击_ （有关更多细节，请参见4.2）。(截至 2020 年)比特币从未在实践中遭受过这种攻击。不过，有一些引人注目的例子，比如比特币黄金或 ZenCash 等几种数字货币遭受了 51%攻击，共造成了超过一千八百万美元的损失。


### 网络中断对比特币的影响

让我们先想象一个虚构的情景。有一天，海狸喝了海盗朗姆酒，割断了连接所有大陆的海底光纤电缆，这些电缆构成了全球网络。大陆间的数据传输通道停止运作，但每个大陆的节点在其子网中继续正常工作。然而，不同子网的用户无法进行同步，无法交换交易与区块。因此，每个大陆的验证者形成了不同版本的区块链。

显而易见，比特币网络的大多数节点使用全球网络进行通信，而矿工的分布在各大陆表面是不均匀的（见图 2–27）。如果六大洲之间的互联网出现故障，对比特币会发生什么？

![图 2–27](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.27-network-connection.png "图 2–27")

在博士爱博力特为防止海狸再次断开电缆而磨牙的同时，神探加杰特正在用电气胶带修补光纤电缆，验证者们继续着创建区块（见图 2–28）。由于不同大陆的验证者组的计算能力不同，且难度参数尚未更新，因此每个子网的区块创建周期显著超过了默认的 10 分钟参数。此外，这个周期对于每个大陆都不同，导致了创建不同长度的备选区块链。

![图 2–28](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.28-non-uniformity.png "图 2–28")

在博士爱博力特与神探加杰特完成工作并恢复了数据传输通道的时候，来自不同大陆的比特币网络节点开始互相同步。结果发现了几个不同长度的区块链版本（见图 2–29）。此外，不同的区块链现在包含不同的交易，而且只有这些交易的子集能够部分重叠。

根据比特币协议规则，所有节点最终将选择最长的链，并将其视为主要链（ _主链_ ）。另一个有趣的事儿，已经确认的交易但包含在备用链中的交易已经失去了它们的确认状态。尽管如此，全节点继续存储并同步它们，而验证者节点则像往常一样有兴趣将它们包含在自己的区块中，并获得奖励，前提是这些交易与主链中已确认的交易不冲突。

![图 2–29](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.29-choosing-the-longest-chain.png "图 2–29")

因此， _孤立区块_ 中的交易进入未确认交易列表，但很有可能稍后会得到确认。尽管一些验证者无法获得解决资源密集任务的奖励，因为有从孤立区块（是他们建制的）的交易被向别的验证者确认在主链中的可能性。因此，尽管两者都同样努力工作，但只有一个验证者会获得奖励。

在描述的情况下，不仅是比特币验证者（失去了创建区块的奖励而交易费用），而且普通用户接受比特币支付也存在失去货币的风险。这些风险是因为比特币的计算能力只部分用于维护货币的可靠性。例如，用户可能没有注意到全球网络分割成子网，继续接收比特币支付，这意味着他们太可能后来发现他们的余额为零。

加勒比海盗也可能进行类似的欺骗行为。假设杰克·斯派洛船长某种方式获得了一个私钥的表示。在被海盗教导海狸喝酒而发疯之前，某人将一些比特币发送到由此私钥控制的地址，并且一直未被使用。一旦海狸们将全球网络分割成六个局部网络，杰克船长立即决定在最近的大陆港口给他的黑珍珠安装柴油发动机，并用比特币进行支付。然后，船只在有利的风下迅速驶向第二个大陆进行柴油加油。

海盗们在通信恢复之前并没有太多时间来实施他们的欺骗行为；在第二个大陆上，没有人知道杰克·斯派洛船长的第一笔交易。到达第二个大陆后，杰克再次使用私钥支付比特币给海盗船进行加油（见图 2–30）。当地的油轮等待第一个确认，并接受了实际在第一个大陆上花费的比特币，购买了柴油发动机。

![图 2–30](/resources/img/volume-1/2.5-confirmation-of-transactions-in-bitcoin/2.30-captain-jack-sparrow.png "图 2–30")

同时，博士爱博力特与神探加杰特正在承诺尽快消除威胁并解决通信问题。了解到博士爱博力特与神探加杰特在工作中的坚持，海盗们提前准备了一个快速环游世界的行程表。他们手握私钥的表示，并搭载满油的快速船只，准备前往其他大陆，装满货舱的朗姆酒，并购买一本量子计算学习手册。

显然，在节点同步后，只有杰克的一笔交易被确认了——这笔交易是支付给比特币计算能力最大的大陆上的商人的那一笔。海盗们给被骗的商家上了一课：在接受交易之前要检查网络的健康状况。船长跟他的团队正在分析这些事件，并考虑改进他们的策略，他们现在使用着量子计算机考虑。

### \*\*\*常见的误区\*\*\*

_比特币中创建一个区块始终需要 10 分钟。_

在实践中，一个区块可能在一瞬间被创建，也可能需要一个半小时。下一个区块的创建时间几乎是不可预测的。但是，有一个调整难度的算法，使得平均每 10 分钟出现一个区块。

_如果某人控制了大部分的挖矿算力，那么他可能会违反协议的规则。_

最大的危害是掌握大部分算力的持有者可能会成功地双重支付他的硬币，也可以在确认时过滤或阻止别人的交易。这只有在攻击者拥有适当的设备时才有这个可能性。他不能窃取硬币或进行任意发行。

### \*\*\*常见问题\*\*\*

_“什么是交易应该获得的最小确认数才能被添加到区块链中？”_

一次确认。但为了认为交易完全确认，通常需要更多确认：默认情况下是 6 次确认。一些服务可能接受两到三次确认的支付。总的来说，确认的次数取决于支付金额（以及双花攻击的风险；有关详细信息，请参见4.2节），有时甚至可能超过 100 次。

_“正确创建的交易被发送到网络后被确认的概率是多少？”_

如果一笔正确创建的交易包含足够的手续费，并且创建新区块的过程是真正分散的（没有被审查），那么这笔交易被确认的概率接近于1。

_“是否需要设置完整节点，以及在什么情况下是必要的？”_

如果你想要接受并发送支付，并查看当前版本的数据库而无需信任其他节点，那么就需要一个完整的比特币节点。不存储完整的区块链的方式的轻客户端、网络钱包、移动钱包等使用可信节点来获取最新的数据。换句话说，由服务本身启动的节点跟踪所有交易的当前状态与硬币的当前分配情况，而信任该节点的轻客户端则接收该状态以进行支付。在某些情况下，依赖受托人是不可接受的；因此，您将建立自己的完整节点，对其软件进行审核，并不再依赖第三方服务。

_“什么是分叉？有哪些种类的分叉？”_

分叉有两个不同的含义：区块链的分支与源代码的复制。在区块链的背景下，分叉可能是计划的或未经计划的。源代码的分叉通常是为了发展一个独立的项目或者为了对协议进行某些变更以进行测试。同时，分叉不应与软分叉和硬分叉等概念混淆：这些是协议更新的类型（有关详细信息，见6.1节）。

_“在比特币系统中，由谁来决定增加或减少难度？”_

谁也不决定。难度是由相同的规则确定的，这些规则被写入网络每个节点的软件中。每个参与者根据这些规则在他们的软件中更新难度参数。因此，这个参数对于所有人都是相同的；不需要决策中心。这是分散系统运作中最重要的原则。

_“如果系统最初设置了1小时的交易确认时间，比特币如何能被用作支付手段？”_

实际上，1小时只是一个默认建议的时间，最好遵循。如果更深入地了解后，会发现接收方决定接受支付前的等待时间。交易金额越大，接收方的等待时间就越长。据粗略估计，对于接受1美元的支付，一个交易确认就足够了；对于 100 万美元的金额，需要16次确认（更多细节请参见4.2）[30]。此外，还有通过所谓的支付通道进行支付的方法，这种方法的确认速度比通常的（链上）交易要快得多，确认时间不依赖于支付金额与设定的手续费（更多细节请参见4.8）。

# [3 密码学与密钥管理](/chapters/volume-1/cn/3-密码学与密钥管理.md)
