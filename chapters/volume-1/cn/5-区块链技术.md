# 5 区块链技术


## 
    5.1 区块链技术与其能力

区块链技术作为一个独立的主题，脱离比特币的背景的讨论开始在 2014 年初。那时人们开始意识到比特币的分散方法可以应用于其他领域，并且底层的区块链技术是关键所在。例如，将这种技术用于会计系统可以保护数据免受未经授权的更改。在系统中提供_不可变性、完整性、无需信任、可靠的对账_等特性在社区中引起了广泛共鸣。

在比特币出现之前，所有的金融系统都使用“传统”的方法来保护，比如防火墙、访问控制系统与安全管理员。很少有组织支持开放式 API 或允许第三方开发者创建扩展或替代应用。比特币首次向世界展示了一个强大的金融系统并不需要一个单一的决策中心。它还表明这样的系统可以对每个人都透明，并且可以接受审计，提供更高级别的用户隐私。

_区块链技术所实现的是在不相互信任的各方之间存储和同步数据的方式。_需要注意，这里参与者之间的不信任并非强制性。你可以信任特定的网络节点。然而，区块链的主要优势在于即使在没有可以信任的人的情况下，你也可以完全使用系统。与依靠可信的参与方并通信来实现和保持完整性不同，区块链技术通过将所有关于现有交易（或其他记录）的数据分组成区块来实现完整性，每个区块都与前一个区块进行了密码学链接。

在日常用语中，“区块链”一词可以具有完全不同的含义。因此，这种差异应该被明确并理解。我们将观察三种最常见的含义。 “区块链”一词可以用来指代特定的会计系统（例如比特币）。另一种使用“区块链”的方式是描述技术本身在特定用例中的实施。最准确的“区块链”术语用法是指一种一般数据组织和决策方法。考虑到可能的含义范围，应该在使用这个术语时谨慎，并注意上下文。

事实上，关于区块链为何有用的数百万讨论可以用一句话概括：不同于传统的会计系统，那些完全依赖盲目信任的数据，无论是系统内获得的还是外部获取的数据，_在基于区块链技术的会计系统中可以验证数据的完整性和时间顺序_。因此，数据对于最终用户甚至系统所有者都可能更加可靠。


```
注意："更可靠"应该理解为在依赖某些外部数据（例如公钥证书、第三方加密库等）的情况下，能够独立存储并验证数据的完整性和顺序。这也意味着存在着严格确定的规则，可通过这些规则验证交易的数学正确性。
区块链并非一个能使系统内所有数据都变得真实可靠的灵丹妙药。
```


**_分散化的程度_**

系统的分散化程度并不总是容易衡量的。对于任何安全系统来说，最终目标并非仅仅是分散化，而是实现所需属性的最佳组合，如隐私、完整性、可访问性、韧性、可信度和性能。分散化在促进这些结果方面是有益的。例如，如果一个系统完全匿名，它可以更轻松地实现抗审查、数据的无需信任验证以及分散决策的经济激励。

如果我们尝试在线性尺度上绘制系统分散化的可能程度，它可能类似于图  5–1。


![alt_text](images/image1.png "image_tooltip")


图  5–1

这些所有的情况都可以通过几个标准进行评估、比较与对比。第一个标准是验证者的数量；第二个是验证者需要保持匿名性的要求；第三个是验证者需要维护其声誉，并且他们的声誉需要为系统参与者所知。

_数字所有权分类帐_。在尺度的左侧，是一个由单一所有者管理企业所有资产的系统。这样的所有者做出企业的所有决策。因此，在这样的系统中并不需要达成共识，但信任的问题不仅是相关的，而且是相当关键的。这个（最左侧的）点可以被描述为在集中化环境中应用区块链技术（实际上，它可能提供某些好处；参见第 6.4 节）。

如果有两个合作伙伴共同管理一个公司账户，但彼此不相信对方能够正确地进行支付、授权交易并维护准确的交易历史记录，那么情况就大不相同了。他们必须共同签署每笔交易，并将每笔交易的记录存储在自己的分类帐副本中。区块链技术可以帮助自动化这个过程。在这种情况下，最简单的达成共识的方式是使用多重签名。每笔交易都将相应地由两个签名进行签署。因为两位合作伙伴都必须看到他们签署的交易，所以不需要匿名性。交易的对账非常迅速，并且可以很容易地按时间戳排序。这种情况下不需要防止审查制度。此外，合作伙伴没有必要被激励来维护他们的节点。

_和解_。此案例将在下文中进行详细讨论。与前一个案例相比，其关键特征是需要达成共识的参与者数量众多，可能高达数十年（在大多数情况下，它们的数量是有限的并且在开始时已知）。在这种情况下，系统变得更加分散化，而多重签名的方法已不足以达成共识。相反，像 BFT、FBA、PoI和PoA这样的共识算法变得适用（有关详细信息，请参见第 5.2 节）。

_代币化平台_。在这里，可以实现更高程度的分散化，并且涉及到达成共识的参与方数量可能不限且多样化。这种情况需要应用FBA共识机制。

_投票平台_。公共投票意味着所有参与者都必须达成共识，并且能够独立验证选举结果。尽管所有参与者都有一个可验证的身份，但所有人不可能全都互相认识（因此无法完全信任）。对于这种情况，FBA共识算法是最佳选择。

_加密货币_。第一代加密货币的设计暗示了参与者数量未被定义，他们都是匿名的，且没有声誉。为了实现这一点，只有一种现有的方法可以达成共识——基于工作量证明。在这种情况下，与适用于参与者知道彼此身份的环境的算法相比，容量是有限的。此外，为了确保网络随着时间的推移保持分散化，需要一种激励参与者行为的经济机制。这实质上导致了拥有相同属性的支付手段的责任（到目前为止，这个问题正在通过内部货币的存在来解决）。比特币架构固有一些问题。首先，交易并不是完全私密的，而可以被追踪（实际上，其他加密货币如 Monero 与 Zcash 部分解决了这个问题，请参见第 6.2 节）。其次，大量的计算能力倾向于集中在少数几个集体池中。

_“?”或新的加密货币_（尚未发明）。在这个尺度上的最后一个点显示出了分散化和隐私性达到了最高水平的情况。关于它们的特征，这些系统是理想的，目前只存在于理论层面，但我们可以制定一些类似这种系统的新模型的要求。这将实现_交易的完全隐私性_（类似于 ZCash，但无需信任设置），这意味着外部人甚至无法观察到交易的事实。这种加密货币将支持完全分散化的挖矿，但没有激励去创建矿池，因此形成共识（类似于 DAG 所提供的，但无需中心化协调器）。此外，用户将能够通过网格网络方式进行完全的点对点通信，而不是通过今天阻碍用户与分散化环境之间联系的中心化互联网提供商。

总的来说，任何需要在一组或很少变化的参与者之间达成一致的系统很可能会使用 BFT 共识算法的某个版本。例如，任何形式的投票都是一个例子：从董事会到全国委员会（显然在这种情况下不需要内部货币）。审查问题不是通过技术上防止其可能性来解决，就像比特币那样，而是通过立即披露事实本身，因为“人人什么都知道”。

根据会计系统需要解决的任务，其数据库将因特性而广泛变化。在社区中，有几个术语用于区分每种类型的可用性水平。

_Permissionless（中文：无需许可）_。任何人都可以在系统的任何过程中参与，没有任何限制或权限要求。如果某系统声称是无需许可的，那么这个声明应适用于该系统中的每一个过程。有时这些系统被称为_公共区块链（英文：public blockchains）_。

_Permissioned（中文：需要许可）_。为参与某个过程，需要获得许可。如果某个系统被宣称为需要许可，这意味着至少一个或多个过程需要额外的授权。有时这些系统被称为_私有区块链（英文：private blockchains）_。

**_区块链架构_**

在区块链中，每个后续的区块都包含前一个区块的哈希值（见图  5–2）。因此，试图更改已记录在历史区块上的数据将导致所有后续区块的变化。其他参与者（网络节点）将注意到这种变化，并且如果不恰当的话可能会予以拒绝，确保数据库的完整性。


![alt_text](images/image2.png "image_tooltip")


图  5–2

因此形成了一个区块序列，即一条链（因此得名“区块链”），其中每个新区块都包含自前一区块导出的哈希值。当然，连接所有这些区块的哈希函数必须是一致的。如果你更改以前的区块，那么每个后续的现有区块都将变得不正确，这意味着必须重新创建所有区块。这个特性使得在不被所有其他参与者注意到的情况下回溯历史变得不可能。

**_区块链的属性_**

理论上，区块链技术可以用于组织任何数据库管理系统（DBMS）中的数据。区块链可以在抽象层面上进行组织，软件不必将交易存储在区块中，只需确保区块头正确格式化即可。因此，网络节点可以以任何方便的方式组织存储并处理交易，以及与其他节点进行同步；数据被序列化为特定格式的区块，并通过网络传输。


```
可以通过使用区块链提供的会计系统的属性
数据库历史的完整性
最小化与同步和备份相关的延迟
能够与一组验证者同时工作的能力
能够进行实时审计
能够使用轻客户端和SPV节点
时间戳（锚定和基于时间的数据固定）
无需信任（对用户信任的要求水平最低）
```




针对不同环境实现区块链属性的特点如表 5.1 所示。


![alt_text](images/image3.png "image_tooltip")


当会计系统的分散化程度提高，即验证者的数量增加时，就会出现需要一种达成共识的机制，以确定系统状态是否正确。

完整节点的所有者能够独立验证完整的交易历史的准确性。这进而使得系统操作对审计员是透明的。如果用户创建并提交到网络的交易尝试花费不存在的硬币，这种不正确的交易会立即被所有诚实的用户注意到并丢弃。如果恶意的验证者创建了一个包含不正确交易的区块，那么这个区块也会被所有诚实的用户注意到并完全丢弃。

区块链提供的另一种可能性是会计系统验证者欺诈的可证明性。如果系统中曾被接受的交易后来被验证者取消，用户将有无可争议的证据表明他受到了欺骗。相应的区块包含一个证明（数字签名或 PoW），证明了验证者曾经投票支持这笔交易。因此，用户有机会证明验证者参与了欺诈行为，比如重写某些区块的历史。

以这种方式，即使在中心化系统的情况下（由于某些原因区块链被重新编写）用户在其数字钱包中将会有以组织的数字签名进行认证的交易形式的证据。

因此，在基于区块链的系统中，各方之间的信任问题不再那么紧迫。其操作可靠性可以由协议规则保证。

用户有选择安装轻客户端应用程序，这样就可以查看数据库的当前实际状态，而无需运行完整节点。然而，这种属性在无需许可的环境中才是最有意义的，但前提是用户相信系统正常运行可靠（例如，在比特币的情况下，这意味着用户相信大部分哈希算力由诚实的验证者控制）。

当一个会计系统达到足够的分散化和记录不可更改性时，时间戳变得非常有价值。时间戳允许在特定时间点记录特定数据知识的事实，最重要的是随后向任何人证明这个事实。因此，用户可以非常有信心地认为数据库状态的变化很可能与这些变化被发起的顺序相匹配。

**_区块链技术的应用_**

现在，让我们讨论一下何种情况适合应用区块链技术。毕竟，区块链可以设计出一个可靠的系统，将人为因素降至最低。让我们考虑一下区块链技术最适合并最有趣的五个应用领域。


```
电子投票
供应链
分散化交易
公共登记
相互结算
```


_电子投票_。每个选民都可以确信自己的投票会被计入。只允许制定数量的投票，并且很难窃取某人的选票。网络上的所有交易都可以保密，这降低了确定选民身份的可能性。在投票期间，任何人都可以检查包含投票的所有交易的正确性，以确保它们全部被计入（见图  5–3）。


![alt_text](images/image4.png "image_tooltip")


图  5–3

一个选民必须能够证明自己有权投票，并且只能进行允许的投票（通常是一票）。这很可能需要创建认证中心，选民在这里注册他们的公钥。这些中心可以由一个管理该组织将验证一个人是否注册了多个密钥的组织。因此，信任的重点从选举机构转移到了认证中心，这些中心也必须接受审计。数字身份在某些国家（如爱沙尼亚）部分解决了这个问题。

需要选择一种共识达成算法，使得每个参与者都能统计选票并将其结果与其他参与者的结果进行匹配。适合此类情况的算法包括 PoS、FBA、BFT 等（更多细节请参见第 5.2 节）。

另一个问题是找到一种分发投票和审计软件的方式，因为威胁可能出现在各个阶段：从设计到安装和执行。

因此，通过区块链应用，电子投票系统获得了宝贵的特性。但是，为了成功和安全地实施此类项目，需要解决一些问题。

_供应链_。从生产者到消费者，商品经历了一系列中间商环节，即所谓的供应链。然而，产品上有制造商的标志并不一定意味着产品本身是原装的。途中存在许多风险，包括替代风险。

将区块链应用于供应链会计系统可以保护商品（即其状态、位置等数据）在运输过程中的安全性。买家可以获取与产品相关的详尽数据。这些数据由负责生产、组装、装载到船舶、运输至下一个地点等指定人员录入数据库。

为了伪造已添加到区块链的交易，入侵者需要迫使验证者加入阴谋或侵入多个运行节点验证器的不同服务器。此外，使用可靠的链中参与者数据同步的机制有助于防止会计系统的不一致性。这种方法将为买家提供一定的保证，并使供应链管理系统更加安全。适合此任务的共识算法有 FBA、BFT。

最终，如果发现了伪劣产品，消费者可以提出警示。基于区块链的供应管理系统可以轻松验证哪个产品（具有唯一条形码）应该通过哪个商店交付和销售。因此，如果消费者在罗马购买了一盒药丸，但通过扫描条形码访问验证系统的手机应用显示该盒药丸被交付到巴黎，这至少引起了对进口商诚信的明显担忧（基本上，如果条形码是唯一的，这意味着被交付到巴黎的药盒是假冒的）。

_分散化交易_。利用区块链技术和分散化方法，可以在许多小型交易平台上进行拍卖。在其中一个交易网站上出售的产品将在所有其他网站上都可见（见图  5–4）。因此，它允许卖方到更广泛的买方受众介绍产品。


![alt_text](images/image5.png "image_tooltip")


图  5–4

卖家节省了大量时间，因为无需在每个网站上手动复制商品信息。此外，交易同时在多个网站上进行，并且对出价的数据进行实时同步。因此，每个网站都不断接收有关每个批次出价的信息。此外，赢家对所有用户都是明确可见的。

因此，你获得了一个人为因素被最小化的系统，进行审计既不困难也不费时，整个交易历史数据也不会在不注意的被更改。适用于此任务的合适共识算法取决于对匿名性和防审查的要求 — 如 PoW、PoS、FBA、BFT。

_公共登记_。公共登记册从定义上就是对所有人都是可访问的。如果这样的注册由一个组织管理，那么显然无法保证数据是否被回溯；你信任这些数据的跟同你信任这个组织的程度一样。

公共登记册由政府机构维护的主要原因是他们的用户不想商业机构控制一个黑匣子系统（用户只知道输入和输出数据的系统，却不知道内部运行的所有过程）。基于区块链的登记册可以通过分散数据库和同步过程来解决信任问题，防止任何单个组织进行隐藏更改。数据库副本可以由几个组织或广泛的公众维护（图  5–5）。因此，单一方的审查变得不可能，因为有许多登记所有者验证所有更改。

因此，公共登记册的维护可以转移到非政府组织，这将减少国家支出并增加公民满意度。这项任务最适合的共识算法是FBA。


![alt_text](images/image6.png "image_tooltip")


图  5–5

_相互结算_。让我们假设有十家银行想要建立合作伙伴关系，以更快、更便宜地为其客户提供服务。为此，它们需要创建一个共享的支付系统，以安排与其合作的企业和个人进行直接结算。因此，它们可以建立一个基于私有区块链的系统，其中存储所有必要的数据并进行相互结算。

每家银行都可以维护自己的网络节点并检查整个交易历史。由于每家银行都有自己的利益，系统内部串通的可能性较低（比单一公司提供结算的情况要低得多）。此外，这样的会计系统可以使结算过程变得更加便宜和安全，主要是因为涉及的银行无需支付第三方提供结算服务。交易历史记录存储在区块链上，由多家公司管理，使篡改变得非常困难。与传统系统相比，进行相当可靠与自动化的审计也更容易。为这项任务的共识算法最合适是 FBA、BFT。

**_摘要_**

在分析了技术应用案例后，基于区块链的系统优势变得更加明显：



* 数据库完整性的简单验证
* 所有更改的时间戳
* 简单的实时备份
* 在分散环境中安全同步数据
* 实时简单审计会计系统

区块链技术可以提供可靠的数据存储，并赋予系统许多有价值的特性。然而，设计、配置和维护的复杂性通常比集中式替代方案要高得多，因此有必要审慎地处理这个问题。

值得注意的是，上述列出的所有优点并非百分之百保证，区块链并非灵丹妙药；成功取决于特定基于区块链系统规则与实施的正确性。

*****常见的误区*****

_区块链可以验证存储在其中的任何数据。_

这个特定的误解在于表述本身，有些人默认认为可以这样。甚至有人想要构建一个其中股票指数将被检查并记录在区块链上的会计系统。在我们提出的问题：“在这里为什么需要区块链？”时，公司答道了：“我们需要让我们的数据可信赖。”

当创建新区块时，验证者只能依赖先前区块的数据，并且他们唯一依据的是协议规则，这些规则验证交易的正确性。无法以其他方式验证某人在区块链中记录的数据的真实性和正确性。信任转移到那个人身上，因为显然，就像股票指数的例子一样，验证者无法知道价格，何况它是否正确了（这不是他们的工作）。验证者能确保的唯一事实是区块链中记录的数据在过去的某个特定时刻没有被更改。

_区块链是缓慢且需要大量能源。_

如果你指的是比特币，这可能是正确的，但不适用于区块链技术本身。比特币使用基于工作量证明的共识机制，确实存在这种限制。一般采用区块链技术的会计系统可以具备一个提供足够高容量的共识机制，使得交易能够在几秒内完全确认。此外，这种共识机制不一定需要验证者拥有丰富的计算资源。这意味着，恰当设计的共识机制可以使得基于区块链的系统达到所需的规格（在我们这种情况下是容量规格）。

_区块链确保数据的可靠性与透明性。_

事实上，交易历史是无法更改的。但是，为了改变实际数据状态，并不一定需要更改现有的区块及其连接。只需创建另一条链，并强制其他网络参与者将其视为主要链即可。因此，这完全取决于达成共识的各方的一致同意。

假设有五家银行决定创建基于区块链的支付系统。在这样的系统中，银行需要协商以进行支付。为了方便协商，它们确定了达成协议的规则。每家银行都根据自身利益或共同决定行事：如果银行勾结，它们可以很容易地重写区块链，即用替代链取代原有链。因此，使用区块链并不一定能够保证对于外部人士会计系统的透明性和可靠性。然而，具有交易历史访问权限的审计员甚至客户会注意到这种攻击，并能够毫无疑问地证明其事实。

比特币区块链是加密的。

尽管表述有误，但有一种共享数据库已加密的观点是广泛且常见的：有些人甚至声称比特币是加密货币。当然，这是不正确的。区块链技术本身可以用于组织任何数据（包括加密数据）。然而，如果数据用于完全透明的币的账务，交易数据必须是公开的，以便任何人都可以验证其正确性。我们还需要提到一些扩展，例如机密交易机制，允许将特定交易的数据保密化（参见第7.2节）。

_区块链将取代服务器。_

这种观点在对区块链了解不多的人中相当普遍。即使某些业务逻辑将由区块链节点实现（例如智能合约的执行），还是有一个简单的事实不能绕过：“节点”就是服务器。在云计算蓬勃发展期间，也有类似的错误观念，即不再需要服务器。但实际上仍然存在服务器，只是可能在另一个地方（例如亚马逊、IBM、谷歌等云服务提供商处）。

_区块链将取代公证员。_

这个谬误不仅涉及到公证员，实际上也涉及到任何中介人。事实并非如此。如果你的会计系统涉及来自外部世界的任何数据，区块链不会排除那些验证数据并记录在主数据库中的人。

想象一下，爱丽丝将她的房子卖给鲍勃。区块链技术可以优化这个过程，但它不会取代公证员等中介人。验证者无法确认是真的是爱丽丝使用她的密钥创建了出售房屋的交易、鲍勃实际上是真实的人、Alice是出于自愿进行这笔交易（而不是被胁迫）、等等。

在区块链中，验证者只知道数学计算正确。但它从未由数据库外部发生的事情负责。事实上，将外部世界的数据传输到数据库中的一方被称为“预言机”（有关详细信息，请见第 6.3 节）。

*****常见问题*****

_“区块链作为一项技术需要标准化吗？”_

在分散系统协议中，标准化可能不会带来预期的结果，因为每个系统都是按照其自身的方式设计的。但是，对于解决大多数系统普遍存在的问题，标准化将会是有益的。例如，密钥的生成、存储和备份程序。

_“是否有任何区块链技术允许用户获得不同级别的访问权限的版本或模型？”_

例如，如果公证人能够访问有关交易的所有数据，而其他用户只能访问直接关系到他们的数据，那肯定是非常方便的。然而，区块链技术仅确定了数据组织的方式，与管理对这些数据的访问级别没有直接关系。显然，通过结合不同的技术，可以创建一个全面的解决方案来完成此任务（但描述这样的解决方案并非这本书的主要目标）。


## 
    5.2 在共识方法中的差异

这样说并不为过，共识机制是任何分散化会计系统的基石。若不了解这些机制的工作原理，就无法设计出安全有效的系统。有时，即使使用不同的共识机制，也会将不同的分散系统盲目地按照性能参数进行比较。然而，如果这些机制在根本上有所不同，那么会计系统在可靠性、资源使用效率、限制、安全水平和性能等多种标准上也会有所不同。这反过来又会极大地影响系统的应用范围。让我们找出典型分散系统中最重要的特征，以及它们与达成共识方式之间的关系。


![alt_text](images/image7.png "image_tooltip")


图  5–6

**_工作量证明_**

共识机制基于 PoW 由于加密货币而变得流行。在完全去分散化和匿名性的情况下，这是最简单且最可靠的方法。然而，PoW 的操作原理通常向于未经培训的人很难解释。我们将尝试通过一个简单的例子来解释它。

让我们假设为了确定房子应该涂成什么颜色，房主们决定举办一场比赛。根据规则，每个人都乘坐电车来购买车票。拿到最小号码的车票的参与者将决定房子应该涂成什么颜色。假设车票是以随机顺序出售的。显然，拥有最多车票的房主有_相应地更大的概率赢得幸运_。

决策的后果越重要，所有者购买更多票以获取下一次投票的动机越高。这就演变成了一种“军备竞赛”。事实上，在比特币网络参与者之间计算能力的增加也是以类似的方式进行的。然而，如果有人怀疑别人串通卖家提供所需的票据，那么一些所有者可以建造新的房子，在那里按照其他规则做决定。

**_权益证明_**

PoS（Proof-of-stake；中文：权益证明）的理念类似于公司股东的投票：持有更多股份的人在做出最终决定时有更大的发言权。因此，在这个系统中，决策并不完全由投票的数量决定，而更多地由它们的权重决定（见图  5–7）。


![alt_text](images/image8.png "image_tooltip")


图  5–7

这权重的特定阈值可以差别并完全取决于在特殊班的规则：有些可能需要简单多数（即 51%），其他可能需要三分之二（66%）；甚至可能有90%的选民必须支持某个决定才能使其生效。

基于 PoS 的区块创建时间可能会比 PoW 要短得多。然而，为了设计一个足够可靠的基于 PoS 的共识机制，用于任何人都可以成为验证者的去中心化会计系统，是相当复杂的。

**_委托权益证明_**

这种共识达成方法是对上述提到的方法的另一种选择。委托权益证明（DPoS）的主要理念在于这里的决策只由代表来执行[79; 80]。通常情况下，成为代表的人从一开始就是众所周知的。他们往往是在某个特定行业取得成就的人。在系统中，他们有与其身份相关联的账户。代表是由用户自己选择的。

投票权重仅取决于仅在选择代表阶段生效用户账户余额中的代币数量。代表们自己以平等条件投票，即投票结果由多数代表（验证者）决定。由于代表的数量是有限的，他们的活动更容易优化，因此这种共识算法使系统能够实现较高的容量。

DPoS 的发展和实施理念归功于 Bitshares 分散化平台的开发团队。

**_重要性证明_**

为了增强决策制定的民主性，PoS 算法被深入研究，最终演变成了现在所称的重要性证明（PoI）[81]。PoI 的不同之处在于，与 PoS 不同，其中重量是由堆栈测量的，参与者投票的权重取决于多种因素。该算法考虑了用户参与系统运作的程度，因此一切都很重要：用户的互动性质、发送对象的代币来源、甚至是用户在系统中的整体行为。因此，排除了富者愈富的情况。PoI 的第一个实际应用是在 NEM 协议中使用的。

**_BFT_**

BFT（Byzantine Fault Tolerance；中文：拜占庭容错）这个名称源自对高度可靠系统协议的开发中 1980 年代实施的一个问题的喜剧性描述[82]，该描述基于拜占庭将军的故事，他们组织对某座城市的进攻。将军们的任务是达成共同解决方案，因为事先已知在将军中存在几名可能行为随意的叛徒（以破坏系统运作）。此外，必须考虑到叛徒有能力影响诚实将军之间消息的传递，对于他们来说，同时进攻或同时撤退至关重要。如果部分诚实将军撤退，那么敌人将逐部击败军队。因此，所有将军都必须达成一致的决定。上述问题的陈述在一篇科学论文中发表。在此之后，用于达成共识的算法名称 BFT 被公布[111]。现在这样的问题不仅可能与将军有关，还可能涉及到例如足球队等其他场景（图  5–8）。


![alt_text](images/image9.png "image_tooltip")


图  5–8


```
BFT 级共识达成机制的工作条件
节点之间的互动权利平等
部分参与者可能是以协调方式行动的对手
未知哪些验证者是对手
诚实参与者占总数的 ⅔ 以上
网络可能会遇到中断与延迟
```


我们还要注意到参与者的数量是预先知道的，并他们彼此认识。解决问题有两个选择：进攻或撤退。假设诚实节点占所有参与者的 ⅔ 以上。

然而，在实施 BFT 思想时，对所有诚实验证者必须达成共识的步数有限制。另一个重要的事实是，BFT 协议的参与者保证会达成一个无法在之后改变或取消的共同解决方案。对于非 BFT 协议（在严格定义上），解决方案被取消的概率会呈指数级减少，但永远不会降为零。

**_FBA_**

联合拜占庭协议（英文：Federated Byzantine Agreement；FBA）最初在Ripple 中提出，后来在 Stellar 中得到了最终确定[83]。它允许在一个庞大的（潜在地未知的）参与者群体中（大约几千人）达成共识，其中每个参与者都不认识其他任何参与者。

每个参与者只信任有限数量的其他参与者（3-10 人），因此只在这个狭窄的圈子里达成共识。但由于社会关系的重叠，整个系统也能够达成共识（图  5–9)。


![alt_text](images/image10.png "image_tooltip")


图  5–9

这种方法在现实中的实施或类似方法非常少见。例如，革命性的思想传播方式类似——人们分享新闻并用思想感染其他人。在这样的系统中，做出最终决定需要比每个验证者都彼此了解的系统更多的时间。

**_DAG 基础上的达成共识协议_**

有向无环图（英文：Directed Acyclic Graph ；DAG）不是一种达成共识的方法，但是使用这种数据组织方法可以改进现有的机制。它主要用于需要大量验证者异步参与的系统中。

这个想法首先被提议用于两个协议：SPECTRE [84] 与 PHANTOM [85]。

其核心思想是，验证者在他的区块头中包含了他认为正确的区块的链接，而这些区块并没有被其他验证者链接（根据他所观察到的当前系统状态）。然后，验证者将他的区块提交到网络中。这样创建了一个结构，其中包含了验证者当前时间看到的所有区块。因此，所有本来可能成为孤块的区块现在都被包含在图中（见图  5–10）。这意味着诚实验证者的投票不会被浪费。潜在来说，这是组织大量同时工作的验证者互动最有效的方法之一。这对会计可靠性和系统防止双重支付攻击和类似攻击的保护水平都有积极影响。


![alt_text](images/image11.png "image_tooltip")


图  5–10

目前使用 DAG 的系统实现存在一个问题，即解决冲突（双花交易）的过程集中化。在 ByteBall 中由_见证节点_执行，而在 IOTA 中由协调员执行。不过，DAG 是一种相对较新的方法，具有在许可系统中广泛应用的潜力。

**_共识机制分类的基本标准_**

考虑到每种达成共识机制的具体特点，可以确定对其进行分类的标准：



* 对验证者的信任需求
* 验证者的匿名性
* 验证者需具备声誉的要求
* 成为验证者的权利
* 容量
* 完全确认交易所需时间

请参考下表（表 5.2）。表中显示有些机制不需要对验证者的信任。这是由于一些特定情况的影响，比如系统规则激励验证者保持诚实，以及这些验证者的可互换性——即谁参与确认并不重要。


![alt_text](images/image12.png "image_tooltip")


另一个重要的标准是成为验证者的权利。这个过程可以公开进行，也可以要求现有验证者组的批准。

在实践中，共识算法可以提供不同的容量。理论上，如果需要，可以增加任何机制的容量（例如，通过增加节点验证者的计算资源或增加区块大小）。副作用是这可能会显著降低系统的分散程度。在某些情况下，这样的修改大约是一个缺点。

应该明白，对于 PoW 和 PoS，基本上很难缩短交易确认时间。与此同时，DPoS 和 PBFT 算法被设计成让足够数量的验证者能够在短时间内达成一致。

**_摘要_**

共识达成的适当机制对于分散化会计系统的可靠运作至关重要。在根据特定业务案例的需求和任务选择会计系统时，会考虑特定的机制。基于此，系统拥有其独特属性。

在各种机制的多样性中，达成共识的机制旨在寻求所需信任水平、做出决策所需时间、所做决策的不可逆转程度以及系统容量之间的适当权衡。选择特定共识算法的决定应基于对系统安全要求进行全面分析的结果。

*****常见的误区*****

_比特币的源代码可以针对任何系统进行优化。_

显然，有一个普遍的误解，即你可以拿取比特币或以太坊的源代码，自由地应用于任何新项目。实际上，有一些例子，开发者试图设计支持资产的数字货币，并创建一个比特币分叉（其中初始提供挖矿）。然而，在这种情况下，不清楚谁会充当验证者；而且，在这种类型的系统中，并不总是需要挖矿这样的存在。

_基于区块链的集中式会计系统毫无意义。_

让我们举个例子。人们将瑞波（XRP）称为中心化数字货币。实际上，在发行货币和交易验证方面，他们是正确的，但在审计和分类账管理方面是错误的。任何人都可以启动瑞波网络节点并验证交易，但只有指定的参与方才能创建区块并发行新的XRP货币。

此外，将一个分散化但受限制访问的会计系统视为集中式系统是错误的。实际上，当所有验证者都受到一个实体控制时，达成共识几乎没有意义。但即便是在拥有许多分支机构的银行案例中，适当使用BFT共识可以防止对单点故障（这是许多银行存在的问题）的欺诈或黑客攻击。此外，正确使用区块链功能可以帮助系统向用户提供以下基本安全服务：完整性、不可否认性和可访问性。

_PoW 意味着毫无意义地消耗能源。_

实际上，满足比特币环境的需求的唯一合适方式是 PoW（我们在 2.3 和 4.2 中提到过它们）。这种机制使网络垃圾信息无利可图，也使确认无效交易的尝试变得不划算。这是因为矿工企业家为参与这个过程付出了高昂的代价，并且冒着如果他们试图确认不符合协议规则的交易而无法获得奖励的风险。这并不是毫无意义的能源消耗，而是我们为了看到比特币的真实面目，一个独立的、抗审查的支付系统所付出的代价。

*****常见问题*****

_“混合的工作量证明和权益证明是否可能？”_

当然可以。工作方式类似的系统有 Peercoin 和 Decred。

_“是否可以组织两级共识以改善会计系统的特性？”_

可以的，这本质上就是 DPoS 的情况。某些系统已经在使用这种方法；比特股就是一个例子，它与比特币有不同的安全模型。其核心思想是，参与者根据 PoS 原则选择其他参与者作为验证节点，被选中的参与者随后创建区块。因此，比特股中新区块的创建频率要高出数百倍。

_“在 PoS 的情况下，持有最高余额的用户能否收集大多数硬币并破坏共识？”_

首先，用户并非单独收集硬币。所有用户都根据其余额按比例收集硬币。其次，每个人都有支出硬币的需求。第三，对验证者来说，违反共识达成过程是不划算的，因为他们所有的硬币储存在这个系统中。

当一个用户根本没有硬币但参与挖矿的情况值得单独考虑。他有机会吗？通常情况下，如果系统使用 PoS 共识机制，其初始发行是集中化的。在这种情况下，用户需要购买硬币。另一种构建系统的方法采用混合方案（PoW 与 PoS），在这种方案中，每个用户可以最初挖矿获取硬币，然后切换到 PoS 共识达成算法。


## 
    5.3 区块链技术的局限性及其应用挑战

在现有受监管基础设施的实施角度看，区块链与智能合约因其被视为有前景的技术。然而，实际情况比初看起来要复杂一些。

首先，我们讨论的是受监管环境，在这种环境中，风险责任由特定方管理。这通常是当今事务运作的方式。转向数字互动时代需要应用最可靠和强大的技术来确保数据的真实性。存储在数字登记册中的信息应有未经授权的更改的保护。

区块链技术可以创建这样的系统。此外，它不一定要求参与者互相信任或信任第三方。然而，要将这样的系统融入日常生活，需要解决一系列复杂的任务。


```
补充引入基于区块链的会计系统的任务
数字身份执行
所有流程的数字化
采用通用的数据处理的规则
在一个系统中记录所有资产
组织分散的决策制定
```


**_数字身份执行_**

_数字身份_的实施是必要的，因为它允许将用户的行为与他们的身份关联起来。

在一个组织内（集中环境）实施数字身份并不是一项复杂的任务。但是，当涉及到一组公司或一个国家时，情况变得非常复杂。这是因为存在一个根本的问题：用户的身份与他们在数字世界中执行的行为之间的关系必须具有法律约束力。这是因为需要防止对某些用户互动历史的争议。

爱沙尼亚在这方面取得了积极的进展。几年来，政府一直在积极推广数字护照，这已经使公民能够使用数字护照进行投票。

最后，数字身份是数字世界互动的关键元素。

**_所有流程的数字化_**

这个要求和数字身份实施一样重要。任何创新通常都意味着逐步过渡与一些阶段性。然而，当使用区块链时，显而易见的是，除非公司的所有内部会计流程都数字化，否则什么都行不通。想象一下这样的情况：组织需要检查在于某个外部数据库中某个特定客户是否存：目前，这通常是通过电话查询来完成的。最理想的情况是在对应于决策的预期时间的时间表内实施自动请求（见图  5–11）。


![alt_text](images/image13.png "image_tooltip")


图  5–11

**_采用通用的数据处理的规则_**

首先，应制定共同的规则来解决与确认交易、系统更新、确定在意外后果事件中的责任等相关问题。所有这些规则必须事先批准的。

接下来，应建立统一的法律框架。更新的方法应考虑到分散系统的存在，包括其所有特点，如分布式责任和决策。加密货币是一个很好的例子，显示了这个任务本质上是多么复杂。许多监管机构已经开始更新他们的法律法规，以考虑到加密货币在世界经济中的交易。然而，社区目前对这个问题提出了更多的问题而不多答案。

**_在一个系统中记录所有资产_**

某种程度上，区块链技术的实施意味着所有资产的自主权都在同一个会计系统中处理。事实上，这正是其使用如此有效的原因。

关键在于基于区块链的系统（其中操作规则被明确定义）可以保证操作的正确性和安全性。然而，这仅在系统本身是自给自足的情况下才可能实现。

这里，自给自足的概念可以通过比特币进行说明。它不使用任何外部信息资源来验证交易。这是因为从比特币的一开始关于地址和 UTXO 的所有信息都存储在比特币的内部数据库中。从这些信息获取的数据可以被视为相当可靠；数学与密码学不需要信任。无论哪种情况，它们都能始终如一地工作，因此用户可以确信他正在使用一个透明且正确的系统。

以智能合约平台以太坊为例，它允许在其上发行的任何代币化资产进行交易。例如如果我们拿任何可能被政府认可的单独的会计系统（例如土地所有权会计），那么两个系统之间同步数据的挑战就出现了。目前唯一的解决办法是使用可信赖的第三方——即“预言机”（有关详细信息，请参见第 6.3 节）。

**_组织分散的决策制定_**

第五个方面是分散化的决策制定，即所有各方就如何做出决策达成的一致。实际上，要达成一致非常困难。当涉及到个人取决于所做决定的利益时，人们通常很难达成共识。这可能是由于各种原因，从政治野心到个人利益。在一个企业内部，可能可以做出一个协商一致的决定，但一旦出现竞争和不同的观点，它就开始变得像一场政治角力比赛。这可能是为什么在企业世界中很少有成功的分散系统实施的最主要原因。


```
阻碍了区块链技术应用的因素
高度冗余
节点同步延迟
治理问题
责任问题
```


这些限制是根本的，因为它们源自分散化的方法本身。让我们更详细地审视它们。

**_会计系统的容量_**

会计系统的_容量_通常以单位时间内确认的交易数量或这些交易中的总数据量来确定。因此，容量通常以 tps（每秒交易数）或 B/s（每秒字节数）来衡量。与分散系统的性能限制和可扩展性有关的问题是相互关联的，两者之间联系非常紧密。然而，这些是抽象的量，无法直接测量的，因此把它们使用是没有意义的。相反，存在更准确的指标：容量、交易确认所需的时间以及同时参与达成共识的最大验证者数量。

为了更容易理解容量，请考虑图  5–12。这个概念是，两个不同的交付服务在同一时间段内可以处理不同数量的货物。它们的传输容量将受到所选运输方式的影响。


![alt_text](images/image14.png "image_tooltip")


图  5–12

系统的容量受共识机制和同时工作的验证者数量的影响。总体而言，分散系统的容量比单一控制中心的系统要低，是因为在这种情况下进行更改需要更多时间。需要将数据分发给所有参与者，并且关于信息他们必须达成共识：决策不再在一个地方做出，而是在多个地方。这些延迟导致系统响应时间增加。

**_交易确认时间_**

为了了解确认时间的限制，你可以参考图  5–13 中的示例。相同体积的任务可以根据所选择的解决方案方式而在短时间或长时间内完成。在货物交付的情况下，运输方式将影响持续时间。而在分散式会计系统的情况下，交易确认时间受到选择验证者的规则与达成共识的机制的影响。


![alt_text](images/image15.png "image_tooltip")


图  5–13

存储全部数据的问题也会增加额外的限制。通常，每个参与者都必须拥有系统数据库的副本，并通过与网络中其他节点同步来不断更新（见图  5–14）。


![alt_text](images/image16.png "image_tooltip")


图  5–14

在 2018 年 2 月至 8 月期间，根据比特币网络的条件（新交易的流量、哈希率、难度参数等），区块确认的平均时间在 6 至 18 分钟之间变动，而最高延迟几乎高达 30 分钟。

**_治理_**

一个公司内部的软件开发过程具有负责任的参与方和明确的计划，并且以集中化的方式进行管理。任何关于变更的建议都被在系统规则的发展参与的狭窄的人际圈子确认了。

对于正确应用的分散会计系统，治理的民主化是有益的。讨论和提出解决方案的机会的开放社区越大，有价值的改进机会越多。如果大多数人投票支持某种改进，它将被添加到下一个更新中。因此，每个人都可以提出自己的更新，并公开讨论其优缺点（见图  5–15）。


![alt_text](images/image17.png "image_tooltip")


图  5–15

然而，问题在于联合管理总是比个人管理更加困难；人们很难迅速达成共识。在这样的系统中，决策总是更慢，因为参与者需要时间来协商。

**_分布式责任_**

在实施分布式技术的实际过程中，社会心态不愿接受分布式方法的后果是一个巨大问题。这表现在我们习惯于有一个具体的负责人。这是在中央集权管理体系中的运作方式，对我们来说是司空见惯的。

在与中央集权组织合作的时候，如果出现任何误解，我们总是能够确定一个负责人并要求解决问题。例如，如果你购买了一辆汽车，在一周后它拒绝启动，你可以打电话给公司并获得退款。即使这家公司没有回应，你也可以去法院，法官将依法解决争端，迫使公司退款并赔偿你的损失。无论如何，你都会找到那个有罪的人，对所做的决定负责。

不同于中央管理中心，责任在分布式系统中显得比较模糊。事实上，用“风险”取代“责任”可能更为合适，因为这确切地描述了参与者所承担的风险。实际上，系统正确运行的唯一保证是其操作规则。所有参与者都了解这些规则：每个人都可以检查其他人的行为，以及是否符合协议规则。

风险存在于用户自身的行为或可能影响规则的漏洞中（例如，对协议的攻击）。顺便说一句，在最后一种情况下，分散系统比集中式系统更为稳定。鉴于系统真正地分散，任何人，包括开发人员，都不可以在自己做出更改。因此，没有法院可以执行违反协议规则的决定。你改变系统状态的唯一途径是获得大多数参与者的同意；也就是说，这种同意应该在不违反事先设定的规则的情况下达成。

在这种情况下，应该采取不同立法的方法。社会需要承认这些系统的存在新的法律框架。可能的一种方式是，在某个特定时刻之前，确保安全性与满足特定要求仅由这个系统的创建者负责。一旦这个“时刻”到来，责任就转移到接受规则和可能风险的用户身上。

**_协议更新_**

分散系统的另一个重要特点是对采纳新更新的方法。对于系统规则改进的任何新提议都可能导致参与者之间的坚决接受或分歧。这本质上是分散会计系统中治理的问题。

如果这些分歧相当严重，情况可能会以分叉告终，即链的分裂，从而产生基于旧系统但具有不同规则的另一个系统。

于2017年这种情况在比特币上发生了；把比特币分叉 Bcash 产生了。建议将比特币网络中的区块大小从 1 MB 增加到 8 MB 以增加容量。支持此举的参与者更新了其软件并开始根据新规则运作。因此，目前存在两个系统：比特币，其中参与者按照旧规则（1 MB 的区块）运作，以及具有不同规则的 Bcash，其区块大小为 8 MB（有关详细信息，请参阅 6.1）。

另一个例子是以太坊发生的事件。于 2016 年，网络犯罪分子窃取了约 6000 万美元，这些资金投资于以太坊平台上开发的 DAO 项目[86]。开发团队决定进行干预，并执行了回滚系统并撤销参与窃案的智能合约的更新，因为存在漏洞。结果，所有资金都被退还到该项目的余额中，但这样的课程并没有受到所有人的赞赏。反对此更新和由此导致的分叉的人继续在旧系统中运作，并将其命名为以太坊经典，而支持回滚的人则开始在新系统中运作，所谓的以太坊。

**_摘要_**

区块链技术如果得到正确实施，可以实现透明的商业模式，并具备透明审计的可能性。这为合作伙伴公司的业务发展打开了新的前景，因为用户之间的增加信任。然而，在实现这一理念的过程中，我们首先必须考虑并克服一系列困难：设计、配置并维护分散化的会计系统通常比集中式替代方案要复杂得多。

要将区块链技术应用于实体经济，需要为其实际实施创造条件。计划是数字化社会大多数交互过程、明确数字身份识别标准、并制定解决责任问题的法律框架。
