# Робота з децентралізованим сховищем даних IPFS

-> У першому розділі частини другої навчального посібника «Блокчейн і децентралізовані системи» ми ознайомили читачів з 
архітектурою й особливостями протоколу IPFS, з основними його принципами роботи та його використання [...].

Цей розділ буде присвячений тому, як на практиці використати переваги цієї технології.

IPFS (InterPlanetary File System) – це мережевий протокол зв'язку, який реалізує контентно-адресовану, однорангову 
гіпермедійну систему децентралізованого зберігання даних. IPFS є проектом із відкритим вихідним кодом, розробленим 
Protocol Labs за участі спільноти з відкритим кодом. Спочатку він був розроблений Хуаном Бенетом (Juan Benet). IPFS 
являє собою однорангову розподілену файлову систему, яка об'єднує всі обчислювальні пристрої єдиної системи файлів. 
IPFS поєднує в собі розподілену геш-таблицю, блоки децентралізованого обміну, а також простір імен, які 
самосертифікуються. При цьому IPFS не має точек відмови, і узли не зобов'язані довіряти один одному. Відмінність від 
інших децентралізованих мереж у тому, що самостійною одиницею, яка передається в мережу, є блок. Блок може містити як 
частину файлу так і посилання на інші блоки. З блоків виробляється направлений ациклічний граф, з якого в подальшому 
збирається файл або каталог. Пошук за назвою файлу або каталогу в IPFS відсутній також як і в мережі BitTorrent. Така 
система дозволяє більш гибко підійти до зберігання та передачі даних у мережі.

## Контентно-адресні гіперсилки.
Протокол IPFS використовує посилання на контент, які дозволяють однозначно адресувати цей контент у мережі. Такі 
посилання включають в себе хеш-значення контенту іншого виду, де задається алгоритм хешування і довжина хеш-значення. 
Протокол для роботи з такими хэш-значеннями називається Multihash. Мультихеш – це структура, що складається з трьох 
частин: ID геш-функції, довжина хеш-значення в байтах, геш-значення цільного контенту.

![Img](/resources/img/practical-volume/15/1-hyperlink.png)

## Сервіс імен IPNS.
IPFS має ім’я сервісу під назвою IPNS, ім’я глобального простору на основі відкритих ключів, сумісне з іншими 
просторами ім’я та має можливість інтегрувати DNS, .onion, .bit тощо  в IPNS.

Для детального ознайомлення з протоколом IPFS необхідно мати встановлений будь-який дистрибутив операційної системи 
Linux (як віртуально, так і фактично) і відповідне програмне забезпечення - конфігураційний скрипт автоматичного 
запуску.

Під конфігураційним скриптом автоматичного запуску є утиліта dlab, яка була спеціально розроблена для виконання цього 
практичного блоку і доступна для завантаження за [посиланням](https://github.com/OlKurbatov/dlab_tool) (`git pull`).

Скрипт виконує наступні функції:
* автоматична конфігурація приватних мереж для різних протоколів, що використовують технологію блокчейн (з кількома 
варіантами розвертання); 
* автоматичний запуск і підключення додаткових вузлів в приватну мережу за бажанням студента; 
* виконання навантажувальних тестів для максимального наближення до умов функціонування реальної децентралізованої 
навчальної системи.

Фактично цей скрипт дозволяє запустити етап ручного налаштування мережі і відразу приступити до знайомства з 
протоколом.

Після того, як у вас буде робочий дистрибутив системи Linux зі встановленим ПЗ (dlab), слід виконати наступні кроки:
1. Відкрити термінал 
2. Викликати конфігураційний скрипт команди “dlab” **УВАГА: ДЛЯ КОРЕКТНОГО ВИМКНЕННЯ ВУЗЛІВ У КОНСОЛЬНОМУ ВІКНІ 
КОНФІГУРАЦІЙНОГО СКРИПТУ ВИКОРИСТОВУЙТЕ КОМБІНАЦІЮ КЛАВІШ ctrl+C.**
3. Обрати тип мережі (у цьому випадку ipfs)

![Img](/resources/img/practical-volume/15/2-config.png)

4. Обрати тип розгортки мережі (start ipfs console with console)

![Img](/resources/img/practical-volume/15/3-depltype.png)

5. Перед вами відкриється консоль з двома вкладками: в одній будуть виводитися логі daemon процесу ipfs, в іншому ви 
звертатиметеся безпосередньо до ipfs і виконуватимете такі операції, як завантаження (add), скачування (get), 
закріплення (pin), а також управління локальним сховищем та поточними налаштуваннями.

![Img](/resources/img/practical-volume/15/4-consolas.png)

При першому запуску ipfs daemon процес створить папку .ipfs в директорії користувача, від імені якого був запущений 
процес, в цій директорії будуть розміщуватися блоки, які були синхронізовані з мережею, DHT і налаштування вузла.

![Img](/resources/img/practical-volume/15/5-daemon.png)

При запуску ipfs виведе інформацію про адреси, на які він чекатиме вхідних з'єднань.
6. Перейдіть на вкладку cli_console і введіть команду `id` - вона виведе інформацію про сайт

![Img](/resources/img/practical-volume/15/6-id.png)

Де:

`ID` – унікальний ідентифікатор вузла

`PublicKey` - відкритий ключ (RSA)

`Addresses` - адреси на яких вузол чекає на вхідні з'єднання

`AgentVersion` – версія агента (go-ipfs – реалізація інтерфейсу командного рядка, написана на Go)

`ProtocolVersion` - версія протоколу

7. Використовуйте команду `repo stat`, яка відображатиме поточний стан сховища вузла.

![Img](/resources/img/practical-volume/15/7-repostat.png)

Де:

`NumObjects` - кількість блоків, що зберігаються

`RepoSize` - загальний обсяг даних, що знаходяться в репозиторії

`StorageMax` – максимальний обсяг даних, які можуть зберігатися

`RepoPath` - шлях до сховища

`Version` - версія сховища

8. Як ви знаєте, ipfs не зберігає блоки даних інших вузлів вічно (якщо ви не закріпили будь-який файл). Через деякий 
проміжок часу автоматично відбувається процедура збирання сміття (garbage collection). Але ми можемо вручну запустити 
цей процес за допомогою команди `repo gc`. У виведенні команди з'явиться мультихеш файлу, що видаляється (або частини 
цього файлу)

![Img](/resources/img/practical-volume/15/8-remove.png)

Після виконання цієї команди, знову перегляньте інформацію про сховище (`repo stat`) і переконайтеся, що значення 
`NumObjects` стало близьким до нуля.

9. Тепер завантажимо щось у мережу. Для цього виберіть файл (наприклад, якесь зображення) і виконайте команду 
`add <path to image>`

![Img](/resources/img/practical-volume/15/9-upload.png)

У відповідь команда вам вивела мультихеш щойно завантаженого файлу та його розмір. Разом з додаванням файлу в мережу, 
вузол також закріплює його у себе в сховищі (щоб garbage collection не видалив його). Після того, як файл завантажений 
у мережу, ви можете скинути його мультихеш своєму другові, щоб він його скачав і став хостом для цього файлу.
10. Ipfs daemon складається не тільки з набору консольних інструментів, але і з веб-панелі, яка надає менший функціонал, 
але дозволяє візуалізувати дані, отримані з мережі. Для того, щоб отримати доступ до неї, необхідно перейти в будь-який 
веб-браузер і ввести в рядок адресу localhost:5001/webui.

![Img](/resources/img/practical-volume/15/10-browser.png)

Тут ви можете побачити швидкість скачування та завантаження файлів у мережу (через вузол постійно проходять блоки інших 
вузлів), переглянути інформацію про файл у мережі (за його мультихешем), побачити піри, з якими ви з'єднані, а також 
завантажувати файли в мережу та робити над ними маніпуляції.
11. Перевіримо швидкість завантаження цільових файлів у мережу за допомогою `upload test`. Перейдіть в консольне вікно, 
з якого ви завантажували вузол ipfs та оберіть `upload test`.

![Img](/resources/img/practical-volume/15/11-upload-test.png)

12. Перед вами відкриється консольне вікно, в якому ви маєте вибрати параметри запуску тесту:
* Choose folder for import files – вибрати папку на локальній машині, всі файли з якої будуть завантажені в мережу IPFS 
* Generate files to import - згенерувати файли для завантаження у заданій кількості та заданого діапазону розміру.

Ми радимо згенерувати файли, тому що в цьому випадку вибірка наочніше показуватиме залежність часу завантаження цільових 
файлів від їх розміру. Оберіть перший пункт (ввести 2 та натиснути Enter). Виберіть кількість файлів для створення.

![Img](/resources/img/practical-volume/15/12-files.png)

Оберіть максимальний розмір файлу для створення

![Img](/resources/img/practical-volume/15/13-maxsize.png)

Ваші значення для запуску тесту можуть відрізнятися від значень на скріншотах. Після генерації файлів почнеться їх 
завантаження в мережу.

![Img](/resources/img/practical-volume/15/14-files-generation.png)

Дочекайтеся завершення процесу завантаження. Перед вами відкриється вікно із графіком, де кожна точка позначає файл. 

![Img](/resources/img/practical-volume/15/15-chart.png)

Тут чітко простежується залежність часу завантаження цільового файлу з його розміру. Насправді поняття "завантаження" в 
мережу в контексті IPFS носить абстрактний характер, так як файли, що завантажуються, по суті продовжують зберігається 
на вашому комп'ютері. Але вони проходячи процедуру отримання мультихеш і залежно від розміру, можуть розділитися на 
кілька пов'язаних блоків.

13. Завантаження цільових файлів з мережі відбувається інакше. По-перше, для того, щоб завантажити будь-що з мережі вам 
потрібно мати мультихеш файлу, який ви хочете завантажити. У мережі можна знайти різну кількість файлів, які можна 
завантажити використовуючи IPFS, але давайте попрацюємо з цим мультихеш: QmR7GSQM93Cx5eAg6a6yRzNde1FQv7uL6X1o4k7zrJa3LX. 
Для початку вставимо його в Explorer мережі IPFS: перейдіть до веб-інтерфейсу (див. Пункт 10) і вставте мультихеш в 
пошуковий рядок Explorer`a

![Img](/resources/img/practical-volume/15/16-search.png)

Натисніть Enter та перегляньте інформацію, отриману від Explorer`a. Ви можете побачити розмір та кількість блоків даних, 
на які ділиться цільові дані. У цьому випадку це директорія, в якій знаходяться файли.

![Img](/resources/img/practical-volume/15/17-datablocks.png)

Також можна подивитися на візуалізоване дерево розділення цільових даних. В даному випадку дані представлені одним 
блоком даних.

![Img](/resources/img/practical-volume/15/18-oneblock.png)

14. Тепер давайте скачаємо директорію з мультихеш і дізнаємося про її вміст. Для цього перейдіть в консоль вузла мережі 
IPFS у вкладку cli_console і введіть команду: `get <hash>`, де <hash> - це мультихеш цільових даних у мережі IPFS. 

![Img](/resources/img/practical-volume/15/19-get-file.png)

Директорія завантажена, тепер можна переглянути її вміст за допомогою команди “ls <hash>”, де <hash> - мультихеш 
цільових даних. 

![Img](/resources/img/practical-volume/15/20-lshash.png)

Видно, що у директорії знаходиться файл ipfs.draft3.pdf. Давайте перенесемо його на локальну машину за допомогою 
команди `cat HASH/file.extension > destination folder/file.extension`, де:
* cat - команда виведення вмісту цільових даних 
* HASH - мультихеш директорії (якби мультихеш відображав файл, ми б виводили його вміст)
* HASH/file.extension – файл, який виводиться (так як у нас HASH – директорія, то ми звертаємося до файлу, який знаходиться під нею)
* > - оператор виведення
* > - destination folder/file.extension - шлях і назва файлу, в який буде записуватися вміст цільових даних

У нашому випадку команда матиме такий вигляд: `cat QmR7GSQM93Cx5eAg6a6yRzNde1FQv7uL6X1o4k7zrJa3LX/ipfs.draft3.pdf > /your/path/whitepaper.pdf`  
(замініть /your/path на ваш шлях на локальній машині).

15. Тепер перейдіть по шляху, вказаному в /your/path і відкрийте файл whitepaper.pdf. Перед вами має відкритися 
whitepaper IPFS
16. Якщо у вас є доступ до іншої машини з запущеним вузлом мережі IPFS, здійснить  обмін будь-яким файлом між цими двома 
вузлами.
Для цього:
* Виберіть цільовий файл (бажано зображення або документ невеликого розміру)
* За допомогою команди add /path/to/file.extension зробіть цільовий файл доступним для інших користувачів мережі 
* Скопіюйте отриманий мультихеш і передайте його на інший вузол мережі будь-яким способом 
* На іншому вузлі за допомогою команди get <file_hash> завантажте цільовий файл та за аналогією (п.14) збережіть файл 
на локальну машину. Існує параметр --output=/some/path, за допомогою якого можна вказати вузлу IPFS зберегти цільовий 
файл безпосередньо по вказаному шляху на локальній машині. Використання: `get --output=/home/user/Documents <HASH>`
* Відкрийте цільовий файл другого вузла. Тепер другий вузол є хостом для цільового файлу. Це можна перевірити за 
допомогою команди dht findprovs (пошук вузлів, які надають даний файл займе якийсь час)

![Img](/resources/img/practical-volume/15/21-findproves.png)