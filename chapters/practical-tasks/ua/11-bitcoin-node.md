# 11. Основи взаємодії з інтерфейсом Bitcoin вузла

Для виконання цієї лабораторної роботи, на вашому ПК повинен бути встановлений будь-який дистрибутив операційної системи 
Linux (як віртуально, так і фактично) та відповідне програмне забезпечення (конфігураційний скрипт автоматичного 
запуску).

Під конфігураційним скриптом автоматичного запуску мається на увазі утиліта dlab, яка була спеціально написана для 
даного курсу лабораторних робіт і доступна для завантаження за посиланням (`git pull`). Вищезгаданий скрипт виконує такі 
функції:
* автоматична конфігурація приватних мереж для різних протоколів, що використовують технологію блокчейн (з кількома 
варіантами розгортання); 
* автоматичний запуск та підключення додаткових вузлів до приватної мережі за бажанням студента; 
* виконання навантажувальних тестів для максимального наближення до умов функціонування реальної децентралізованої 
облікової системи.

https://github.com/OlKurbatov/dlab_tool

Фактично цей скрипт дозволяє пропустити етап ручного налаштування мережі і відразу приступити безпосередньо до 
знайомства з протоколом.

Після того, як у вас буде робочий дистрибутив системи Linux із встановленим ПЗ (dlab), слід виконати наступні кроки для 
конфігурації приватної bitcoin мережі:
1. Відкрити термінал 
2. Викликати конфігураційний скрипт командою `dlab` 
*УВАГА: ДЛЯ КОРЕКТНОГО ВИМКНЕННЯ ВУЗЛІВ У КОНСОЛЬНОМУ ВІКНЕ КОНФІГУРАЦІЙНОГО СКРИПТУ ВИКОРИСТОВУЙТЕ КОМБІНАЦІЮ КЛАВІШ 
ctrl+C.*
3. Обрати тип мережі (в даному випадку Bitcoin) та натиснути "Enter"

![Тип мережі](/resources/img/practical-volume/11/4-network_type.png)

4. Обрати тип конфігурації (у даному випадку Multiple nodes on the local machine)

![Тип конфігурації](/resources/img/practical-volume/11/5-configtype.png)

5. Скрипт конфігурує два вузли та відкриє їх консолі (кожне термінальне вікно представляє інтерфейс одного вузла, у 
кожному термінальному вікні ви можете знайти дві вкладки: консоль вузла – “node_console” та консоль клієнта – 
“cli-console”). Тепер перед вами повністю робоча "Bitcoin private test network" мережа Bitcoin, що складається із двох 
вузлів (full node). Пізніше, щоб додати вузли, вам потрібно повернутися в конфігураційний скрипт і вибрати опцію “1. Add 
new node”. Усі команди, наведені нижче, ви повинні виконувати у вкладці консолі клієнта (консоль вузла несе чисто 
інформативний характер)

> Увага! Мережа працює в режимі regtest (Regression test mode), тобто всі операції (транзакції тощо) застосовуються до 
тестової версії ланцюжка блоків. А це означає:
> 1. Всі видобуті вами монети не можна витратити в mainet (основний ланцюжок блоків криптовалюти bitcoin).
> 2. Коли ви відправляєте тестові монети на іншу адресу (іншому вузлу/гаманцю), то ви матеріально не страждаєте від цієї 
операції 
> 3. Складність видобутку монет настільки мала, що ви маєте право створити і 1000 блоків (цей процес займе близько 15-20 
секунд) і розпоряджатися видобутими коштами. Але на жаль тільки у вашій regtest мережі)

6. Після того, як мережа буде налаштована, перейдіть в консоль клієнта будь-якого вузла і перевірте стан локального 
ланцюжка блоків за допомогою команди `getblockchaininfo`. 

У відповідь на цю команду, ви отримаєте висновок такого типу:

![Висновок](/resources/img/practical-volume/11/6-summary.png)

З наступним вмістом (у вас може трохи відрізнятися):

```json
{
  "chain": "regtest",
  "blocks": 0,
  "headers": 0,
  "bestblockhash": "0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206",
  "difficulty": 4.656542373906925e-10,
  "mediantime": 1296688602,
  "verificationprogress": 1,
  "initialblockdownload": true,
  "chainwork": "0000000000000000000000000000000000000000000000000000000000000002",
  "size_on_disk": 293,
  "pruned": false,
  "softforks": [
	{
  	"id": "bip34",
  	"version": 2,
  	"reject": {
    	"status": false
  	}
	},
	{
  	"id": "bip66",
  	"version": 3,
  	"reject": {
    	"status": false
  	}
	},
	{
  	"id": "bip65",
  	"version": 4,
  	"reject": {
    	"status": false
  	}
	}
  ],
  "bip9_softforks": {
	"csv": {
  	"status": "defined",
  	"startTime": 0,
  	"timeout": 9223372036854775807,
  	"since": 0
	},
	"segwit": {
  	"status": "active",
  	"startTime": -1,
  	"timeout": 9223372036854775807,
  	"since": 0
	}
  },
  "warnings": ""
}
```
Основні елементи:

`chain` - режим роботи мережі;

`blocks` – кількість блоків у вашому локальному ланцюжку;

`headers` – кількість заголовків підтверджених блоків у локальному ланцюжку;

`bestblockhash` - hash значення заголовка останнього підтвердженого блоку;

`difficulty` - поточна складність формування блоку;

`mediantime` - середній час підтвердження 11 блоків перед останнім блоком в блокчейні. Використовується для перевірки 
часу підтвердження транзакції відповідно до BIP113;

`Verificationprogress` – оцінка якого відсотка від ланцюжка блоків угод були перевірена досі, починаючи з 0.0 і зі 
збільшенням до 1,0 для повної перевірки. Може трохи перевищувати 1.0 при повній синхронізації для обліку транзакцій у 
mempool, які були перевірені перед включенням до блоку;

`chainwork` – передбачувана кількість хешів заголовків блоків, перевірених від блоку генези до цього блоку, закодованих 
як big-endian hex;

`initialblockdownload` – метод синхронізації мережею що використовує вузол;

`pruned` – вказує, що блоки підлягають обрізанню. 

7. Для того, щоб ознайомитися зі станом підключення до інших бенкетів (вузлів, які з вами з'єднані) за допомогою 
команди  “getaddednodeinfo”.

![Стан підключення](/resources/img/practical-volume/11/7-connection-state.png)

Основні елементи:

`addednode` – IP-адреса доданого вузла

`connected` - статус підключення (true, якщо вузол в даний момент підключений, і false, якщо це не так)

`address` - одна з адрес гаманця на цьому вузлі;

`connected` - можливі значення: false (підключення немає), inbound (якщо якийсь вузол має вхідне підключення до цього 
вузла), outbound (якщо цей вузол має вихідне підключення).

8. Отримання інформації про сайт. За допомогою команди `-getinfo` ви отримаєте інформацію про базові параметри вузла.

![Get info](/resources/img/practical-volume/11/8-getinfo.png)

Основні елементи, що повертаються:

`version` - версія програмного забезпечення Bitcoin (Bitcoin Core);

`protocolversion` - версія протоколу, яку використовує цей вузол;

`walletversion` - версія гаманця цього вузла. Відображається лише якщо програмне забезпечення вузла підтримує цю функцію;

`blocks` - число сформованих блоків у локальному ланцюжку блоків;

`timeoffset` – розбіжність із системним годинником у секундах;

`connections` - кількість відкритих підключень (вхідних та вихідних);

`proxy` - address:port proxy сервера;

`difficulty` - складність створення блоку;

`testnet` – повертає true якщо вузол перебуває у testnet і false якщо у mainnet чи regtest;

`keypoololdest` – дата, коли було створено найстаріший ключ у пулі ключів гаманця; корисно лише для сканування блоків, 

створених із цієї дати для транзакцій;

`keypoolsize` - кількість ключів у кулі ключів гаманця;

`paytxfee` - мінімальна комісія за кілобайт транзакції;

`relayfee` – мінімальна плата, яку має сплатити транзакція з низьким пріоритетом, щоб цей вузол прийняв її у свій mempool.

9. Формування нової адреси. 

За допомогою команди `getnewaddress` формуємо адресу. Результатом буде повернуто адресу для прийому платежів. Платежі, 
відправлення на цю адресу, будуть зараховані на гаманець цього вузла.

![Генерація адреси](/resources/img/practical-volume/11/9-getnewaddress.png)

10. Створення 1 блоку.

Для створення блоку використовуємо команду `bitcoin-cli generate [n]`, де n – кількість блоків, яку необхідно створити. 
У відповідь команда виведе вам масив hash значень заголовків створених блоків (за допомогою hash можна співвіднести 
відповідні транзакції з певним блоком). 

![Створення блоку](/resources/img/practical-volume/11/10-blockgen.png)

Перейдіть в консоль іншого вузла (інше консольне вікно, перша вкладка `node_consoleX`) та простежте, що він прийняв 
блок, створений на першому вузлі.

![Підтвердження блоку](/resources/img/practical-volume/11/11-block-receiving.png)

11. Перевірка інформації про щойно створений блок.

За допомогою команди `getblock <block header hash>` отримуємо уявлення про блок із заданим hash, який виводиться при 
використанні `generate <n>`.

![Отримання блоку](/resources/img/practical-volume/11/12-getblock.png)

Основні елементи:

`hash` - хеш-значення заголовка блоку;

`confirmations` - кількість блоків, підтверджених з моменту опублікування транзакції;

`size` - розмір даного блоку в байтах;

`strippedsize` - розмір даного блоку без witness даних;

`weight` - вага блоку, є мірою об'єму блоку, включаючи дані segwit (детальніше дивіться на Block_weight);

`height` - висота блоку в ланцюжку блоків;

`version` - версія блоку, що використовується;

`versionHex` – версія цього блоку закодована у шістнадцятковому форматі;

`merkleroot` - корінь Merkle для цього блоку, закодований у шістнадцятковому форматі;

`tx:[]` – масив транзакцій, що містить блок;

`time` – час, коли блок було сформовано;

`nonce` - вирішення завдання PoW саме для цього блоку;

`bits` - вказуючи цільовий поріг, який мав пройти заголовок цього блоку;

`difficulty` - складність для створення цього блоку;

`chainwork` - передбачувана кількість хешів заголовків блоків, які майнери повинні були перевіряти від генезу блоку до 
цього блоку, закодованого в шістнадцятковому форматі;

`Previousblouckhash` - хеш заголовка попереднього блоку. Не повертається для генезу блоку;

`nextblockhash` - хеш наступного блоку в кращому ланцюжку блоків, якщо він відомий, закодований у шістнадцятковому 
форматі.

12. Для отримання винагороди за створення першого блоку протоколу Bitcoin потрібно 100 підтверджень. Для цього потрібно 
сформувати 100 блоків. Зробіть це (див. пункт 5). Після цього перевірте:
* чи прийняв другий вузол ваші створені блоки;

![Перевірка блоку](/resources/img/practical-volume/11/13-accept-100-blocks.png)

* за допомогою команди `getbalance` перевірте, чи ви отримали винагороду за створення блоку (виконувати команду потрібно 
на вузлі, з якого був створений блок).

![Перевірка блоку](/resources/img/practical-volume/11/14-getbalance.png)

13. Для відправки транзакції необхідний Bitcoin-address з сторони, що приймає, і хоч якийсь баланс на відправляючій 
стороні. Щоб задовольнити ці умови, виконайте такі кроки:
* Оберіть вузол, який прийматиме монети і виконайте на ньому команду з пункту 4 (запам'ятайте отриману адресу); 
* Оберіть вузол, який буде відправляти монети (фактично монети є лише на адресі одного вузла, але ви завжди можете 
повторити пункти 5, 7 і отримати монети на адресу іншого вузла); 
* На вузлі, що відправляє, виконайте команду “sendtoaddress <bitcoin address>”, де <bitcoin address> - адреса приймаючої 
сторони. 
* Отриманий hash (TXID транзакції) запам'ятовуємо, він нам знадобиться надалі.

![Перевірка блоку](/resources/img/practical-volume/11/15-tx.png)

14. Створення одного блоку (на будь-якому вузлі) для підтвердження транзакції (див. пункт 5) та перевірка балансу на 
стороні, що приймає, за допомогою команди `getbalance`.

![Перевірка блоку](/resources/img/practical-volume/11/16-getbalance-after-tx.png)

15. Переглянути інформацію про транзакцію за допомогою команди `gettransaction <TXID>` (на будь-якому вузлі) 
використовуючи TXID, отриманий під час проведення транзакції. (TXID із пункту 8)

![Перевірка блоку](/resources/img/practical-volume/11/17-gettx.png)

`amount` – кількість витрачених монет;

`confirmations` – кількість підтверджень транзакцій;

`blockhash` - hash блоку в локальному ланцюзі, до якого належить транзакція;

`blockindex` – index транзакції у блоці;

`blocktime` - час у заголовку блоку (тільки для транзакцій, які підтверджені);

`txid` – унікальний ідентифікатор транзакції;

`address` – адреса на яку були надіслані кошти;

`category` – категорія транзакції щодо ноди (у разі “send”).

16. Для перевірки процесу синхронізації, переходимо в консольне вікно, в якому запущено конфігураційний скрипт, 
вибираємо опцію “1.Add new node” та натискаємо “Enter”. З'явиться консольне вікно нового вузла (з такими ж вкладками 
“node_console” та “cli-console”). 

Перейдіть у щойно створене консольне вікно нового вузла:
* Перейдіть у вкладку “node_console” та простежте процес синхронізації; 
* Перейдіть на вкладку “cli-console” та виконайте команду `getblockchaininfo | grep blocks`. Висота має бути такою 
самою, як і на інших вузлах.

17. Для того, щоб подивитися роботу mempool, потрібно провести кілька транзакцій між будь-якими вузлами (можете 
створювати нові вузли в будь-якій кількості) не підтверджуючи ці транзакції, тобто не створюючи блоків. І виконати 
команду getmempoolinfo

![Перевірка блоку](/resources/img/practical-volume/11/18-getmempool.png)

`size` - число транзакцій, що знаходяться в mempool;

`bytes` – сумарна кількість байт транзакцій;

`usage` – використано пам'яті для зберігання даних mempool (включаючи всі дані транзакцій та службові дані);

`maxmempool` – максимальне використання пам'яті для mempool у байтах;

`mempoolminfee` – найнижча комісія за кілобайт, сплачена будь-якою транзакцією до mempool.

18. За допомогою команди `generate 1` створюємо один блок для підтвердження транзакції та знову перевіряємо стан 
mempool.

![Перевірка блоку](/resources/img/practical-volume/11/19-getmempool2.png)

Як бачимо транзакції з mempool'а зникли. Можете виконати команду `getbalance` для того, щоб переконатися, що транзакції 
потрапили в блок і підтвердилися.